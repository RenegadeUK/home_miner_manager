import{c as B,l as G,r as h,a as M,j as e,C as T,d as L,e as P,f as q,B as l,Z as W,R as X,x as Y,y as ee,z as se,E as te,F as ne,o as ae,p as ie,q as re,s as le,t as H,k as de,M as ce}from"./index-Cw5JvtJ_.js";import{u as m}from"./useMutation-CE1HzA7S.js";import{L as j}from"./loader-2-DPIbUHXL.js";import{T as oe}from"./trash-2-BHPXMfGz.js";import{S as me}from"./shield-alert-Cjlelr69.js";import{C as ue}from"./check-circle-2-zqZpQSvT.js";import{A as xe}from"./alert-triangle-DKdjcXuU.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=B("Link",[["path",{d:"M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71",key:"1cjeqo"}],["path",{d:"M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71",key:"19qd67"}]]);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=B("Plug",[["path",{d:"M12 22v-5",key:"1ega77"}],["path",{d:"M9 8V2",key:"14iosj"}],["path",{d:"M15 8V2",key:"18g5xt"}],["path",{d:"M18 8v5a4 4 0 0 1-4 4h-4a4 4 0 0 1-4-4V8Z",key:"osxo6l"}]]);async function r(a,p){const g=await fetch(a,p);if(!g.ok){let t="Request failed";try{const d=await g.json();t=d.detail||d.message||t}catch{}throw new Error(t)}return g.json()}const ge=a=>a!=null&&a.configured?a.last_test_success===!0?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-emerald-500/15 px-2 py-0.5 text-xs font-medium text-emerald-300",children:[e.jsx(ue,{className:"h-3.5 w-3.5"})," Connected"]}):a.last_test_success===!1?e.jsxs("span",{className:"inline-flex items-center gap-1 rounded-full bg-red-500/15 px-2 py-0.5 text-xs font-medium text-red-300",children:[e.jsx(xe,{className:"h-3.5 w-3.5"})," Connection failed"]}):e.jsx("span",{className:"inline-flex items-center rounded-full bg-amber-500/10 px-2 py-0.5 text-xs text-amber-200",children:"Not tested"}):e.jsx("span",{className:"inline-flex items-center rounded-full bg-muted px-2 py-0.5 text-xs",children:"Not configured"});function we(){var K,Q;const a=G(),[p,g]=h.useState(null),[t,d]=h.useState({name:"Home Assistant",base_url:"",access_token:"",enabled:!0,keepalive_enabled:!1}),[y,$]=h.useState(!1),[u,E]=h.useState({device:null,minerId:""}),[z,b]=h.useState(!1),c=M({queryKey:["ha-config"],queryFn:()=>r("/api/integrations/homeassistant/config")}),o=((K=c.data)==null?void 0:K.configured)??!1,v=M({queryKey:["ha-devices",y],queryFn:()=>r(`/api/integrations/homeassistant/devices${y?"":"?enrolled_only=true"}`),enabled:o,refetchInterval:o?3e4:!1}),D=M({queryKey:["miners-basic"],queryFn:()=>r("/api/miners/")});h.useEffect(()=>{var s;(s=c.data)!=null&&s.configured&&d(n=>{var x,f,F,I;return{...n,name:((x=c.data)==null?void 0:x.name)||"Home Assistant",base_url:((f=c.data)==null?void 0:f.base_url)||"",enabled:!!((F=c.data)!=null&&F.enabled),keepalive_enabled:!!((I=c.data)!=null&&I.keepalive_enabled),access_token:""}})},[c.data]);const i=(s,n)=>{g({tone:s,message:n}),setTimeout(()=>g(null),5e3)},k=m({mutationFn:async()=>{const s={name:t.name,base_url:t.base_url,access_token:t.access_token?t.access_token:null,enabled:t.enabled,keepalive_enabled:t.keepalive_enabled};return r("/api/integrations/homeassistant/config",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)})},onSuccess:s=>{a.invalidateQueries({queryKey:["ha-config"]}),i(s.success?"success":"error",s.message||"Configuration saved")},onError:s=>i("error",s.message)}),w=m({mutationFn:()=>r("/api/integrations/homeassistant/test",{method:"POST"}),onSuccess:s=>{a.invalidateQueries({queryKey:["ha-config"]}),i(s.success?"success":"error",s.message||"Test completed")},onError:s=>i("error",s.message)}),C=m({mutationFn:()=>r("/api/integrations/homeassistant/config",{method:"DELETE"}),onSuccess:s=>{a.invalidateQueries({queryKey:["ha-config"]}),a.invalidateQueries({queryKey:["ha-devices"]}),i("success",s.message||"Configuration deleted")},onError:s=>i("error",s.message)}),S=m({mutationFn:()=>r("/api/integrations/homeassistant/discover",{method:"POST"}),onSuccess:s=>{a.invalidateQueries({queryKey:["ha-devices"]}),i(s.success?"success":"error",s.message||"Discovery finished")},onError:s=>i("error",s.message)}),R=m({mutationFn:({deviceId:s,enrolled:n})=>r(`/api/integrations/homeassistant/devices/${s}/enroll`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({enrolled:n})}),onSuccess:()=>a.invalidateQueries({queryKey:["ha-devices"]}),onError:s=>i("error",s.message)}),N=m({mutationFn:({deviceId:s,action:n})=>r(`/api/integrations/homeassistant/devices/${s}/control?action=${n}`,{method:"POST"}),onSuccess:s=>{a.invalidateQueries({queryKey:["ha-devices"]}),i(s.success?"success":"error",s.message||"Command sent")},onError:s=>i("error",s.message)}),O=m({mutationFn:s=>r(`/api/integrations/homeassistant/devices/${s}/state`),onSuccess:s=>{a.invalidateQueries({queryKey:["ha-devices"]}),i(s.success?"success":"error",s.message||"State refreshed")},onError:s=>i("error",s.message)}),_=m({mutationFn:({deviceId:s,minerId:n})=>r(`/api/integrations/homeassistant/devices/${s}/link`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({miner_id:n?Number(n):null})}),onSuccess:s=>{a.invalidateQueries({queryKey:["ha-devices"]}),i(s.success?"success":"error",s.message||"Link updated"),b(!1)},onError:s=>i("error",s.message)}),A=h.useMemo(()=>{var n;return(((n=v.data)==null?void 0:n.devices)??[]).filter(x=>x.domain==="switch")},[v.data]),V=s=>{s.preventDefault(),k.mutate()},J=()=>{window.confirm("Delete Home Assistant configuration?")&&C.mutate()},U=s=>{E({device:s,minerId:s.miner_id?String(s.miner_id):""}),b(!0)},Z=()=>{u.device&&_.mutate({deviceId:u.device.id,minerId:u.minerId||""})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs uppercase tracking-[0.3em] text-blue-300",children:"Integrations"}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Home Assistant"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Connect smart switches and routers so energy automation can turn miners on or off based on pricing and safety."})]}),p&&e.jsx("div",{className:`rounded-md border px-4 py-3 text-sm ${p.tone==="success"?"border-emerald-500/40 bg-emerald-500/10 text-emerald-100":p.tone==="error"?"border-red-500/40 bg-red-500/10 text-red-100":"border-blue-500/40 bg-blue-500/10 text-blue-100"}`,children:p.message}),e.jsxs("div",{className:"grid gap-4 lg:grid-cols-[2fr,1fr]",children:[e.jsxs(T,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(P,{children:"Configuration"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Use a long-lived access token from your Home Assistant profile."})]}),ge(c.data)]}),e.jsx(q,{children:e.jsxs("form",{className:"space-y-4",onSubmit:V,children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Name"}),e.jsx("input",{className:"mt-1 w-full rounded-md border border-border bg-background px-3 py-2 text-sm",value:t.name,onChange:s=>d({...t,name:s.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Base URL"}),e.jsx("input",{className:"mt-1 w-full rounded-md border border-border bg-background px-3 py-2 text-sm",placeholder:"http://homeassistant.local:8123",value:t.base_url,onChange:s=>d({...t,base_url:s.target.value}),required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Access Token"}),e.jsx("input",{className:"mt-1 w-full rounded-md border border-border bg-background px-3 py-2 text-sm",placeholder:o?"••••••••••••••••••••••••••••":"Paste long-lived token",value:t.access_token,onChange:s=>d({...t,access_token:s.target.value}),type:"password"}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Leave blank to keep the existing token."})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm font-medium",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-border",checked:t.enabled,onChange:s=>d({...t,enabled:s.target.checked})}),"Enable integration"]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm font-medium",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-border",checked:t.keepalive_enabled,onChange:s=>d({...t,keepalive_enabled:s.target.checked})}),"Keep-alive monitoring"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(l,{type:"submit",disabled:k.isPending,children:[k.isPending&&e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}),"Save Configuration"]}),e.jsxs(l,{type:"button",variant:"secondary",onClick:()=>w.mutate(),disabled:!o||w.isPending,children:[w.isPending&&e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}),"Test Connection"]}),e.jsxs(l,{type:"button",variant:"destructive",onClick:J,disabled:!o||C.isPending,children:[C.isPending&&e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}),e.jsx(oe,{className:"mr-2 h-4 w-4"}),"Delete"]})]})]})})]}),e.jsxs(T,{className:"bg-muted/40",children:[e.jsx(L,{children:e.jsx(P,{children:"Setup Guide"})}),e.jsxs(q,{className:"space-y-4 text-sm text-muted-foreground",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-foreground",children:"Generate token"}),e.jsxs("ol",{className:"mt-2 list-inside list-decimal space-y-1",children:[e.jsx("li",{children:"Open Home Assistant and click your profile."}),e.jsx("li",{children:"Create a Long-Lived Access Token."}),e.jsx("li",{children:"Copy the token and paste it here."})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-foreground",children:"Best practices"}),e.jsxs("ul",{className:"list-inside list-disc space-y-1",children:[e.jsx("li",{children:"Only enroll switches that directly control miner power."}),e.jsx("li",{children:"Keep the keep-alive watchdog on so outages alert you."}),e.jsx("li",{children:"Link each switch to its miner for targeted automation."})]})]})]})]})]}),e.jsxs(T,{children:[e.jsxs(L,{className:"flex flex-row items-center justify-between",children:[e.jsxs("div",{children:[e.jsx(P,{children:"Miner Power Switches"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Only switch entities are shown. Enroll the ones automation should control."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"inline-flex items-center gap-2 text-xs uppercase tracking-wide text-muted-foreground",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-border",checked:y,onChange:s=>$(s.target.checked),disabled:!o}),"Show all devices"]}),e.jsxs(l,{type:"button",onClick:()=>S.mutate(),disabled:!o||S.isPending,children:[S.isPending&&e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}),"Discover Devices"]})]})]}),e.jsx(q,{children:o?v.isLoading?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-muted-foreground",children:e.jsx(j,{className:"h-5 w-5 animate-spin"})}):A.length===0?e.jsxs("div",{className:"flex min-h-[200px] flex-col items-center justify-center text-center text-sm text-muted-foreground",children:[e.jsx(pe,{className:"mb-2 h-8 w-8"}),y?"No switches discovered yet. Run discovery to import entities.":'No enrolled switches. Enable "Show all" to review candidates.']}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-muted/40 text-left text-xs uppercase tracking-wide text-muted-foreground",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3",children:"Device"}),e.jsx("th",{className:"px-4 py-3",children:"Entity"}),e.jsx("th",{className:"px-4 py-3",children:"State"}),e.jsx("th",{className:"px-4 py-3",children:"Linked Miner"}),e.jsx("th",{className:"px-4 py-3",children:"Controls"}),e.jsx("th",{className:"px-4 py-3",children:"Enrolled"})]})}),e.jsx("tbody",{children:A.map(s=>{var n,x;return e.jsxs("tr",{className:"border-b border-border/60",children:[e.jsxs("td",{className:"px-4 py-4 text-foreground",children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Switch"})]}),e.jsx("td",{className:"px-4 py-4 text-xs text-muted-foreground",children:s.entity_id}),e.jsx("td",{className:"px-4 py-4",children:s.current_state?e.jsx("span",{className:`inline-flex items-center rounded-full px-2 py-0.5 text-xs font-semibold ${s.current_state==="on"?"bg-emerald-500/15 text-emerald-200":"bg-slate-700/40 text-slate-200"}`,children:s.current_state}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Unknown"})}),e.jsx("td",{className:"px-4 py-4",children:s.miner_id?e.jsx("span",{className:"inline-flex items-center rounded-full bg-primary/10 px-2 py-0.5 text-xs text-primary",children:((x=(n=D.data)==null?void 0:n.find(f=>f.id===s.miner_id))==null?void 0:x.name)||"Linked"}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Not linked"})}),e.jsx("td",{className:"px-4 py-4",children:e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(l,{size:"sm",variant:"secondary",className:"gap-1",onClick:()=>N.mutate({deviceId:s.id,action:"turn_on"}),disabled:N.isPending,children:[e.jsx(W,{className:"h-4 w-4"})," On"]}),e.jsxs(l,{size:"sm",variant:"outline",className:"gap-1",onClick:()=>N.mutate({deviceId:s.id,action:"turn_off"}),disabled:N.isPending,children:[e.jsx(me,{className:"h-4 w-4"})," Off"]}),e.jsx(l,{size:"sm",variant:"ghost",className:"gap-1",onClick:()=>O.mutate(s.id),disabled:O.isPending,children:e.jsx(X,{className:"h-4 w-4"})}),e.jsxs(l,{size:"sm",variant:"outline",className:"gap-1",onClick:()=>U(s),children:[e.jsx(he,{className:"h-4 w-4"})," Link"]})]})}),e.jsx("td",{className:"px-4 py-4",children:e.jsxs("label",{className:"inline-flex items-center gap-2 text-xs font-medium",children:[e.jsx("input",{type:"checkbox",className:"h-4 w-4 rounded border-border",checked:s.enrolled,onChange:f=>R.mutate({deviceId:s.id,enrolled:f.target.checked})}),"Enrolled"]})})]},s.id)})})]})}):e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-sm text-muted-foreground",children:"Configure Home Assistant first to pull devices."})})]}),e.jsx(Y,{open:z,onOpenChange:s=>b(s),children:e.jsxs(ee,{children:[e.jsxs(se,{children:[e.jsx(te,{children:"Link Device to Miner"}),e.jsx(ne,{children:"Select which miner this switch controls so automation can target it directly."})]}),u.device&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-md border border-border bg-muted/30 px-3 py-2 text-sm",children:[e.jsx("p",{className:"font-medium",children:u.device.name}),e.jsx("p",{className:"text-xs text-muted-foreground",children:u.device.entity_id})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Miner"}),e.jsxs(ae,{value:u.minerId,onValueChange:s=>E(n=>({...n,minerId:s})),children:[e.jsx(ie,{children:e.jsx(re,{placeholder:"Not linked"})}),e.jsxs(le,{children:[e.jsx(H,{value:"",children:"Not linked"}),(Q=D.data)==null?void 0:Q.map(s=>e.jsx(H,{value:String(s.id),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium leading-tight",children:s.name}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:de(s.miner_type)})]}),e.jsx(ce,{type:s.miner_type,size:"sm"})]})},s.id))]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(l,{variant:"outline",onClick:()=>b(!1),children:"Cancel"}),e.jsxs(l,{onClick:Z,disabled:_.isPending,children:[_.isPending&&e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}),"Save Link"]})]})]})]})})]})}export{we as default};
