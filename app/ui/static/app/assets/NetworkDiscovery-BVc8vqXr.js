import{c as O,k as re,r as x,a as Q,j as e,O as h,a2 as K,C as _,d as M,e as I,R as L,f as S,B as u,J as V,N as ne,a0 as de,a3 as y,a4 as oe}from"./index-VzWaYuAX.js";import{u as k}from"./useMutation-CHxe1Kj1.js";import{C as le}from"./check-circle-2-CnRhwNrP.js";import{A as X}from"./alert-triangle-CQF1XYlg.js";import{L as j}from"./loader-2-DgEMcv1_.js";import{S as ie}from"./save-CiB0BsIu.js";import{T as ce}from"./trash-2-TrgHCTAF.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const U=O("Globe2",[["path",{d:"M21.54 15H17a2 2 0 0 0-2 2v4.54",key:"1djwo0"}],["path",{d:"M7 3.34V5a3 3 0 0 0 3 3v0a2 2 0 0 1 2 2v0c0 1.1.9 2 2 2v0a2 2 0 0 0 2-2v0c0-1.1.9-2 2-2h3.17",key:"1fi5u6"}],["path",{d:"M11 21.95V18a2 2 0 0 0-2-2v0a2 2 0 0 1-2-2v-1a2 2 0 0 0-2-2H2.05",key:"xsiumc"}],["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}]]);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=O("ScanSearch",[["path",{d:"M3 7V5a2 2 0 0 1 2-2h2",key:"aa7l1z"}],["path",{d:"M17 3h2a2 2 0 0 1 2 2v2",key:"4qcy5o"}],["path",{d:"M21 17v2a2 2 0 0 1-2 2h-2",key:"6vwrx8"}],["path",{d:"M7 21H5a2 2 0 0 1-2-2v-2",key:"ioqczr"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}],["path",{d:"m16 16-1.9-1.9",key:"1dq9hf"}]]),ue={enabled:!1,autoAdd:!1,scanIntervalHours:24,networks:[]},me=/^(\d{1,3}\.){3}\d{1,3}\/\d{1,2}$/;function ke(){var B;const n=re(),[a,d]=x.useState(ue),[o,p]=x.useState(""),[f,E]=x.useState(null),[b,R]=x.useState(null),[D,N]=x.useState(null),[J,P]=x.useState(null),l=Q({queryKey:["discovery-config"],queryFn:y.getConfig}),c=Q({queryKey:["discovery-network-info"],queryFn:y.getNetworkInfo,retry:!1});x.useEffect(()=>{l.data&&d({enabled:l.data.enabled,autoAdd:l.data.auto_add,scanIntervalHours:l.data.scan_interval_hours,networks:l.data.networks??[]})},[l.data]);const T=x.useMemo(()=>xe(a.networks),[a.networks]),W=x.useMemo(()=>{if(!l.data)return null;const s=l.data.enabled;return e.jsxs("span",{className:h("inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold",s?"bg-emerald-500/15 text-emerald-300":"bg-amber-500/15 text-amber-200"),children:[s?e.jsx(le,{className:"h-4 w-4"}):e.jsx(X,{className:"h-4 w-4"}),s?"Enabled":"Disabled"]})},[l.data]),m=(s,t)=>{E({tone:s,message:t}),window.setTimeout(()=>E(null),5e3)},w=s=>{if(s instanceof de){if(s.data&&typeof s.data=="object"){const t=s.data.detail;if(typeof t=="string")return t}return s.message}return s instanceof Error?s.message:"Something went wrong"},C=k({mutationFn:s=>y.updateConfig(s),onSuccess:()=>{m("success","Discovery configuration saved"),n.invalidateQueries({queryKey:["discovery-config"]})},onError:s=>m("error",w(s))}),A=k({mutationFn:()=>y.triggerAutoScan(),onSuccess:s=>{const t=s.auto_add_enabled?`, ${s.total_added} auto-added`:"";m("info",`Auto-scan completed – ${s.total_found} miners detected${t}`)},onError:s=>m("error",w(s))}),v=k({mutationFn:s=>y.scanNetwork({network_cidr:s.network_cidr,timeout:5}),onMutate:()=>N(null),onSuccess:s=>{R(s),m("info",`Scan complete – ${s.total_found} miner${s.total_found===1?"":"s"} found`)},onError:s=>N(w(s))}),F=k({mutationFn:s=>oe.create(s),onSuccess:(s,t)=>{m("success",`${t.name} added to your fleet`),R(r=>{if(!r)return r;const g=r.miners.map(i=>i.ip===t.ip_address&&i.port===(t.port??i.port)?{...i,already_added:!0}:i);return{...r,miners:g,new_miners:Math.max(0,r.new_miners-1),existing_miners:r.existing_miners+1}}),n.invalidateQueries({queryKey:["miners"]})},onError:s=>m("error",w(s))}),H=s=>{d(t=>({...t,[s]:s==="enabled"?!t.enabled:!t.autoAdd}))},q=(s,t,r)=>{d(g=>{const i=[...g.networks];return i[s]={...i[s],[t]:r},{...g,networks:i}})},Y=()=>{d(s=>({...s,networks:[...s.networks,{cidr:"",name:""}]}))},Z=s=>{d(t=>({...t,networks:t.networks.filter((r,g)=>g!==s)}))},ee=()=>{var s;if((s=c.data)!=null&&s.network_cidr){if(a.networks.some(t=>{var r;return t.cidr===((r=c.data)==null?void 0:r.network_cidr)})){m("info","Suggested network already added");return}d(t=>({...t,networks:[...t.networks,{cidr:c.data.network_cidr,name:"Auto-detected"}]}))}},se=()=>{if(a.scanIntervalHours<1||a.scanIntervalHours>168){m("error","Scan interval must be between 1 and 168 hours");return}const s={enabled:a.enabled,auto_add:a.autoAdd,scan_interval_hours:a.scanIntervalHours,networks:T};C.mutate(s)},z=s=>{const t=(s??o).trim();if(p(t),!t){N("Enter a network CIDR to scan (e.g., 192.168.1.0/24)");return}if(!me.test(t)){N("CIDR format is invalid. Use notation like 192.168.1.0/24");return}v.mutate({network_cidr:t})},te=async()=>{var t,r;if((t=c.data)!=null&&t.network_cidr){p(c.data.network_cidr);return}const s=await c.refetch();(r=s.data)!=null&&r.network_cidr?p(s.data.network_cidr):s.error&&N("Unable to auto-detect your local network")},ae=s=>{const t=`${s.type.replace("_","-")}-${s.ip.split(".").pop()}`,r=window.prompt(`Name for ${s.type} at ${s.ip}`,t);if(!r)return;const g={name:r.trim(),miner_type:s.type,ip_address:s.ip,port:s.port},i=`${s.ip}:${s.port}`;P(i),F.mutate(g,{onSettled:()=>P(null)})};return l.isLoading?e.jsx(he,{}):l.isError?e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 text-2xl font-semibold",children:[e.jsx(K,{className:"h-8 w-8 text-blue-400"}),"Network Discovery"]}),e.jsx(pe,{message:w(l.error),onRetry:()=>l.refetch()})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-3xl font-semibold text-foreground",children:[e.jsx(K,{className:"h-8 w-8 text-blue-400"}),e.jsx("span",{children:"Network Discovery"}),W]}),e.jsx("p",{className:"text-base text-muted-foreground",children:"Automatically scan your home networks for Avalon Nanos, Bitaxe/NerdQaxe rigs, and XMRig hosts. Configure auto-add rules or run ad-hoc scans when new hardware comes online."})]}),f&&e.jsx("div",{className:h("rounded-xl border px-4 py-3 text-sm",f.tone==="success"&&"border-emerald-500/40 bg-emerald-500/10 text-emerald-100",f.tone==="error"&&"border-red-500/40 bg-red-500/10 text-red-100",f.tone==="info"&&"border-blue-500/40 bg-blue-500/10 text-blue-100"),children:f.message}),e.jsxs("div",{className:"grid gap-6 xl:grid-cols-[1.4fr,1fr]",children:[e.jsxs(_,{children:[e.jsx(M,{children:e.jsxs(I,{className:"flex items-center gap-2 text-lg",children:[e.jsx(L,{className:"h-5 w-5 text-blue-300"})," Auto-discovery controls"]})}),e.jsxs(S,{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4 rounded-xl border border-border/60 bg-muted/5 px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Enable automatic discovery"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"When enabled, the scheduler scans every configured network on the defined interval."})]}),e.jsx("button",{type:"button",onClick:()=>H("enabled"),className:h("flex h-6 w-12 items-center rounded-full border border-border px-0.5 transition-colors",a.enabled?"bg-blue-500/80 border-blue-400":"bg-gray-800"),"aria-pressed":a.enabled,children:e.jsx("span",{className:h("h-5 w-5 rounded-full bg-white shadow transition-transform",a.enabled?"translate-x-6":"translate-x-0")})})]}),e.jsxs("div",{className:"flex items-center justify-between gap-4 rounded-xl border border-border/60 bg-muted/5 px-4 py-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:"Auto-add discovered miners"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Automatically enroll anything new that responds on your network ranges."})]}),e.jsx("button",{type:"button",onClick:()=>H("autoAdd"),className:h("flex h-6 w-12 items-center rounded-full border border-border px-0.5 transition-colors",a.autoAdd?"bg-emerald-500/80 border-emerald-400":"bg-gray-800"),"aria-pressed":a.autoAdd,children:e.jsx("span",{className:h("h-5 w-5 rounded-full bg-white shadow transition-transform",a.autoAdd?"translate-x-6":"translate-x-0")})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",htmlFor:"scan-interval",children:"Scan interval (hours)"}),e.jsx("input",{id:"scan-interval",type:"number",min:1,max:168,value:a.scanIntervalHours,onChange:s=>d(t=>({...t,scanIntervalHours:Number(s.target.value)})),className:"w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-blue-500/40 md:w-48"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Between 1 and 168 hours. Default: once per day."})]}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[e.jsxs(u,{onClick:se,disabled:C.isPending,children:[C.isPending?e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ie,{className:"mr-2 h-4 w-4"}),"Save configuration"]}),e.jsxs(u,{type:"button",variant:"secondary",disabled:!a.enabled||T.length===0||A.isPending,onClick:()=>A.mutate(),children:[A.isPending?e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(L,{className:"mr-2 h-4 w-4"}),"Run auto-scan now"]})]})]})]}),e.jsxs(_,{children:[e.jsx(M,{children:e.jsxs(I,{className:"flex items-center gap-2 text-lg",children:[e.jsx(U,{className:"h-5 w-5 text-blue-300"})," Network ranges"]})}),e.jsxs(S,{className:"space-y-4",children:[((B=c.data)==null?void 0:B.network_cidr)&&e.jsxs("div",{className:"rounded-xl border border-blue-500/40 bg-blue-500/10 p-4 text-sm text-blue-50",children:[e.jsxs("p",{className:"font-semibold",children:["Suggested CIDR: ",c.data.network_cidr]}),e.jsx("p",{className:"text-xs text-blue-100/80",children:"Auto-detected from your current interface."}),e.jsx(u,{size:"sm",variant:"secondary",className:"mt-3",onClick:ee,children:"Use this range"})]}),a.networks.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground",children:"No networks configured. Add at least one CIDR block."}),e.jsx("div",{className:"space-y-3",children:a.networks.map((s,t)=>e.jsx("div",{className:"rounded-2xl border border-border/60 bg-muted/5 p-4",children:e.jsxs("div",{className:"grid gap-3 md:grid-cols-[1.3fr,1fr,auto] md:items-center",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:"CIDR"}),e.jsx("input",{type:"text",value:s.cidr,onChange:r=>q(t,"cidr",r.target.value),className:"mt-1 w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-blue-500/40",placeholder:"192.168.1.0/24"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:"Label"}),e.jsx("input",{type:"text",value:s.name??"",onChange:r=>q(t,"name",r.target.value),className:"mt-1 w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-blue-500/40",placeholder:"Garage, Office, etc."})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(u,{type:"button",size:"sm",variant:"secondary",onClick:()=>z(s.cidr),children:[e.jsx(G,{className:"mr-1.5 h-4 w-4"})," Scan"]}),e.jsx(u,{type:"button",size:"sm",variant:"ghost",onClick:()=>Z(t),children:e.jsx(ce,{className:"h-4 w-4"})})]})]})},`${s.cidr}-${t}`))}),e.jsxs(u,{type:"button",variant:"outline",onClick:Y,children:[e.jsx(V,{className:"mr-2 h-4 w-4"})," Add network"]})]})]})]}),e.jsxs(_,{children:[e.jsx(M,{children:e.jsxs(I,{className:"flex items-center gap-2 text-lg",children:[e.jsx(ne,{className:"h-5 w-5 text-blue-300"})," Manual discovery scan"]})}),e.jsxs(S,{className:"space-y-5",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-[1.2fr,auto]",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"Network CIDR"}),e.jsx("input",{type:"text",value:o,onChange:s=>p(s.target.value),className:"mt-1 w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-blue-500/40",placeholder:"192.168.1.0/24"}),D&&e.jsx("p",{className:"mt-1 text-xs text-red-300",children:D}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground",children:"Each scan tests Avalon cgminer ports, Bitaxe/NerdQaxe HTTP APIs, and XMRig endpoints."})]}),e.jsxs("div",{className:"flex flex-col gap-2 md:items-end",children:[e.jsxs(u,{onClick:()=>z(),disabled:v.isPending,className:"w-full md:w-auto",children:[v.isPending?e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(G,{className:"mr-2 h-4 w-4"}),"Scan network"]}),e.jsxs(u,{type:"button",variant:"secondary",onClick:te,disabled:c.isFetching,className:"w-full md:w-auto",children:[c.isFetching?e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(U,{className:"mr-2 h-4 w-4"}),"Detect local network"]})]})]}),v.isPending&&e.jsxs("div",{className:"flex items-center gap-3 rounded-xl border border-border/60 bg-muted/5 px-4 py-3 text-sm",children:[e.jsx(j,{className:"h-4 w-4 animate-spin text-blue-300"}),"Scanning hosts… this can take up to a minute for /24 ranges."]}),b&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-3",children:[e.jsx($,{label:"Total found",value:b.total_found,tone:"primary"}),e.jsx($,{label:"New miners",value:b.new_miners,tone:"success"}),e.jsx($,{label:"Already added",value:b.existing_miners,tone:"muted"})]}),e.jsx("div",{className:"space-y-3",children:b.miners.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No miners responded on this network."}):b.miners.map(s=>e.jsx(ge,{miner:s,onAdd:()=>ae(s),isAdding:J===`${s.ip}:${s.port}`&&F.isPending},`${s.ip}:${s.port}`))})]})]})]})]})}function xe(n){return n.map(a=>{var d,o;return{cidr:((d=a.cidr)==null?void 0:d.trim())??"",name:((o=a.name)==null?void 0:o.trim())||void 0}}).filter(a=>a.cidr.length>0)}function $({label:n,value:a,tone:d}){const o={primary:"text-blue-300",success:"text-emerald-300",muted:"text-muted-foreground"};return e.jsxs("div",{className:"rounded-2xl border border-border/60 bg-muted/5 px-4 py-3",children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:n}),e.jsx("p",{className:h("text-3xl font-semibold",o[d]),children:a})]})}function ge({miner:n,onAdd:a,isAdding:d}){const o=Object.entries(n.details??{}).slice(0,4);return e.jsxs("div",{className:h("rounded-2xl border border-border/60 bg-muted/5 p-4",n.already_added&&"opacity-60"),children:[e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:n.name}),e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:n.type})]}),!n.already_added&&e.jsxs(u,{size:"sm",onClick:a,disabled:d,children:[d?e.jsx(j,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(V,{className:"mr-2 h-4 w-4"}),"Add miner"]})]}),e.jsxs("div",{className:"mt-4 grid gap-3 text-sm md:grid-cols-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:"Address"}),e.jsxs("p",{className:"font-semibold text-foreground",children:[n.ip,":",n.port]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:"Status"}),e.jsx("p",{className:"font-semibold text-foreground",children:n.already_added?"Already enrolled":"New device"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-wide text-muted-foreground",children:"Details"}),e.jsx("p",{className:"font-semibold text-foreground",children:o.length>0?`${o.length} field${o.length===1?"":"s"}`:"—"})]})]}),o.length>0&&e.jsx("div",{className:"mt-3 grid gap-2 text-xs text-muted-foreground md:grid-cols-2",children:o.map(([p,f])=>e.jsxs("div",{children:[e.jsxs("span",{className:"font-semibold text-foreground",children:[p,":"]})," ",String(f)]},p))})]})}function he(){return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"h-8 w-56 animate-pulse rounded bg-muted/20"}),e.jsx("div",{className:"grid gap-6 xl:grid-cols-[1.4fr,1fr]",children:[1,2].map(n=>e.jsxs("div",{className:"space-y-3 rounded-2xl border border-border/40 bg-muted/5 p-6",children:[e.jsx("div",{className:"h-5 w-1/3 animate-pulse rounded bg-muted/30"}),[...Array(4)].map((a,d)=>e.jsx("div",{className:"h-10 animate-pulse rounded bg-muted/20"},d))]},n))}),e.jsxs("div",{className:"rounded-2xl border border-border/40 bg-muted/5 p-6",children:[e.jsx("div",{className:"h-5 w-1/4 animate-pulse rounded bg-muted/30"}),e.jsx("div",{className:"mt-4 space-y-3",children:[...Array(3)].map((n,a)=>e.jsx("div",{className:"h-12 animate-pulse rounded bg-muted/20"},a))})]})]})}function pe({message:n,onRetry:a}){return e.jsx(_,{className:"border-red-500/40 bg-red-500/10",children:e.jsxs(S,{className:"flex flex-col gap-4 py-6",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-red-100",children:[e.jsx(X,{className:"h-5 w-5"}),n]}),e.jsx("div",{children:e.jsx(u,{variant:"secondary",onClick:a,children:"Retry"})})]})})}export{ke as default};
