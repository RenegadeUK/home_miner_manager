import{k as Q,r as g,a as b,j as e,Z as W,B as f,M as j,C as o,d as N,f as x,T as X,n as Z,o as J,p as U,q as Y,s as ee}from"./index-dpZMgYSb.js";import{u as _}from"./useMutation-C7Gzzs_-.js";import{L as se,C as te,a as ae,b as re,P as ne,c as ie,p as le,d as ce,e as de,T as oe}from"./chartjs-adapter-date-fns.esm-DY26ADy9.js";import{L as P}from"./loader-2-NWJ6z9ak.js";import{P as z}from"./play-circle-CQXc-dwa.js";import{A as xe}from"./alert-triangle-u5qIVwJi.js";import{C as me}from"./clock-B3Yf4xJA.js";import{I as pe}from"./info-BDMHXscs.js";te.register(ae,re,ne,ie,le,ce,de,oe);async function u(a,c){const i=await fetch(a,{headers:{"Content-Type":"application/json",...(c==null?void 0:c.headers)||{}},...c});if(!i.ok){const h=await i.json().catch(()=>({})),E=h.detail||h.message||`Request failed (${i.status})`;throw new Error(E)}if(i.status!==204)return i.json()}function v(a){return a==null?"£0.00":new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(a)}function ge(a){return a==null?"—":`${a.toFixed(1)} p/kWh`}function ue(a){switch(a){case"CHEAP":return"text-green-300";case"MODERATE":return"text-amber-300";case"EXPENSIVE":return"text-red-300";default:return"text-gray-300"}}function he(a){switch(a){case"CHEAP":return"bg-green-500/10 text-green-300";case"MODERATE":return"bg-amber-500/10 text-amber-300";case"EXPENSIVE":return"bg-red-500/10 text-red-300";default:return"bg-gray-600/20 text-gray-300"}}function Ce(){var F;const a=Q(),[c,i]=g.useState(null),[h,E]=g.useState("12"),[m,A]=g.useState(""),[d,w]=g.useState(null),{data:n,isLoading:k,error:I}=b({queryKey:["auto-optimization-status"],queryFn:()=>u("/api/energy/auto-optimization/status")}),{data:r,isLoading:q,error:R}=b({queryKey:["energy-overview"],queryFn:()=>u("/api/energy/overview"),refetchInterval:6e4}),{data:y,isLoading:H,error:B}=b({queryKey:["energy-forecast"],queryFn:()=>u("/api/energy/price-forecast?hours=24"),refetchInterval:3e5}),{data:l,isLoading:T}=b({queryKey:["miners"],queryFn:()=>u("/api/miners/")});g.useEffect(()=>{l&&l.length>0&&m===""&&A(l[0].id)},[l,m]);const L=_({mutationFn:s=>u("/api/energy/auto-optimization/toggle",{method:"POST",body:JSON.stringify({enabled:s})}),onSuccess:(s,p)=>{i({type:"success",message:p?"Auto optimization enabled":"Auto optimization disabled"}),a.invalidateQueries({queryKey:["auto-optimization-status"]})},onError:s=>{i({type:"error",message:s.message})}}),C=_({mutationFn:()=>u("/api/energy/auto-optimization/trigger",{method:"POST"}),onSuccess:()=>{i({type:"success",message:"Auto optimization job triggered. Check miner modes shortly."}),a.invalidateQueries({queryKey:["energy-overview"]})},onError:s=>i({type:"error",message:s.message})}),S=_({mutationFn:({minerId:s,hours:p})=>u(`/api/energy/miners/${s}/schedule-recommendation?target_hours=${p}`),onSuccess:s=>{w(s)},onError:s=>{w(null),i({type:"error",message:s.message})}}),O=g.useMemo(()=>{var s;return(s=y==null?void 0:y.forecast)!=null&&s.length?{labels:y.forecast.map(p=>new Date(p.timestamp)),datasets:[{label:"Price (p/kWh)",data:y.forecast.map(p=>p.price_pence),borderColor:"rgba(59, 130, 246, 1)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.3,pointRadius:0}]}:null},[y]),D=g.useMemo(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:s=>`${s.parsed.y.toFixed(2)} p/kWh`}}},scales:{x:{type:"time",time:{unit:"hour"},ticks:{maxRotation:0},grid:{color:"rgba(255,255,255,0.05)"}},y:{beginAtZero:!0,title:{display:!0,text:"p/kWh"},grid:{color:"rgba(255,255,255,0.05)"}}}}),[]),V=()=>{k||!n||L.mutate(!n.enabled)},$=()=>{C.mutate()},K=()=>{if(!m||!h.trim()){i({type:"error",message:"Select a miner and number of hours first."});return}const s=Number(h);if(Number.isNaN(s)||s<1||s>24){i({type:"error",message:"Target hours must be between 1 and 24."});return}S.mutate({minerId:m,hours:s})},G=(d==null?void 0:d.recommended_slots)??[],t=r==null?void 0:r.current_recommendation,M=[I,R,B].filter(Boolean);return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(W,{className:"h-5 w-5"}),e.jsx("span",{children:"Energy Optimization"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Energy Optimization"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Combine Octopus Agile pricing with real-time miner telemetry to keep profitability positive and power usage smart."}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-4",children:[e.jsx(f,{onClick:V,disabled:k||L.isPending,variant:n!=null&&n.enabled?"default":"outline",className:"min-w-[190px]",children:n!=null&&n.enabled?"Disable Auto Optimization":"Enable Auto Optimization"}),e.jsxs(f,{variant:"secondary",onClick:$,disabled:!(n!=null&&n.enabled)||C.isPending,className:"flex items-center gap-2",children:[C.isPending?e.jsx(P,{className:"h-4 w-4 animate-spin"}):e.jsx(z,{className:"h-4 w-4"}),"Run Now"]})]})]}),c&&e.jsx("div",{className:j("rounded-md border px-4 py-3 text-sm",c.type==="success"?"border-green-500/40 bg-green-500/10 text-green-200":"border-red-500/40 bg-red-500/10 text-red-200"),children:c.message}),M.length>0&&e.jsxs("div",{className:"flex items-center gap-3 rounded-md border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200",children:[e.jsx(xe,{className:"h-4 w-4"}),e.jsx("span",{children:M.map(s=>s instanceof Error?s.message:"Unknown error").join(" • ")})]}),e.jsxs(o,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Automation Bands"}),e.jsx("p",{className:"text-sm text-gray-400",children:"CHEAP (<15p) runs miners in High/OC mode, MODERATE (15-25p) shifts to Low/Eco, EXPENSIVE (≥25p) powers down linked Home Assistant devices to avoid negative ROI."})]})}),e.jsx(x,{children:n!=null&&n.enabled?e.jsxs("div",{className:"space-y-3 text-sm text-gray-300",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"text-green-300",children:"Enabled:"})," Scheduler reconciles miners every 5 minutes, applying band logic to Bitaxe, NerdQaxe++, and Avalon Nano devices plus their associated switches."]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-amber-300",children:"Tip:"})," Disable conflicting automation rules that also touch miner modes or HA devices."]})]}):e.jsx("div",{className:"rounded-md border border-dashed border-gray-700 bg-gray-900/40 px-4 py-3 text-sm text-gray-400",children:"Enable automatic optimization to orchestrate miners based on live Agile pricing."})})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(o,{children:e.jsxs(x,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"24h Energy Cost"}),e.jsx("p",{className:"mt-2 text-2xl font-semibold",children:v(r==null?void 0:r.total_energy_cost_24h)})]})}),e.jsx(o,{children:e.jsxs(x,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"24h Net Profit"}),e.jsx("p",{className:j("mt-2 text-2xl font-semibold",((r==null?void 0:r.total_profit_24h)??0)>=0?"text-green-300":"text-red-300"),children:v(r==null?void 0:r.total_profit_24h)})]})}),e.jsx(o,{children:e.jsxs(x,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Current Price"}),e.jsx("p",{className:j("mt-2 text-2xl font-semibold",ue(t==null?void 0:t.band)),children:ge(t==null?void 0:t.current_price_pence)}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Valid until ",(t==null?void 0:t.valid_until)&&new Date(t.valid_until).toLocaleTimeString()]})]})}),e.jsx(o,{children:e.jsxs(x,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Recommendation"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:j("rounded-full px-2 py-0.5 text-xs font-semibold",he(t==null?void 0:t.band)),children:(t==null?void 0:t.band)||"—"}),e.jsx("span",{className:"text-sm text-gray-300",children:(t==null?void 0:t.recommendation)||"Waiting for data…"})]})]})})]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs(o,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-3 text-base font-semibold",children:[e.jsx(X,{className:"h-5 w-5 text-blue-300"})," 24-Hour Price Forecast"]})}),e.jsxs(x,{children:[H?e.jsx("div",{className:"flex min-h-[240px] items-center justify-center text-gray-400",children:e.jsx(P,{className:"h-5 w-5 animate-spin"})}):O?e.jsx("div",{className:"h-[260px]",children:e.jsx(se,{data:O,options:D})}):e.jsx("p",{className:"text-sm text-gray-500",children:"No forecast data available."}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-4 text-xs text-gray-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-green-400"})," Cheap < 15p"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-400"})," Moderate 15-25p"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-red-400"})," Expensive ≥ 25p"]})]})]})]}),e.jsxs(o,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-3 text-base font-semibold",children:[e.jsx(me,{className:"h-5 w-5 text-blue-300"})," Smart Schedule"]})}),e.jsxs(x,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase",children:"Target Miner"}),e.jsxs(Z,{disabled:T||!(l!=null&&l.length),value:m?String(m):"",onValueChange:s=>A(Number(s)),children:[e.jsx(J,{children:e.jsx(U,{placeholder:T?"Loading miners…":"Select miner"})}),e.jsx(Y,{children:l==null?void 0:l.map(s=>e.jsx(ee,{value:String(s.id),children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase",children:"Target Hours"}),e.jsx("input",{type:"number",min:1,max:24,value:h,onChange:s=>E(s.target.value),className:"w-full rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-blue-500 focus:outline-none"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(f,{onClick:K,disabled:S.isPending||!m,className:"flex items-center gap-2",children:[S.isPending?e.jsx(P,{className:"h-4 w-4 animate-spin"}):e.jsx(z,{className:"h-4 w-4"}),"Generate Schedule"]}),e.jsx(f,{variant:"outline",disabled:!d,onClick:()=>w(null),children:"Clear"})]}),d&&e.jsxs("div",{className:"space-y-3 rounded-md border border-blue-500/30 bg-blue-500/5 p-4 text-sm text-blue-100",children:[e.jsxs("p",{children:["Expected savings: ",e.jsxs("strong",{children:[d.savings_percent.toFixed(1),"%"]})," vs random schedule · Avg price",` ${d.avg_price_pence.toFixed(2)}p`]}),e.jsx("div",{className:"max-h-[200px] space-y-2 overflow-y-auto pr-2",children:G.map(s=>e.jsxs("div",{className:"flex items-center justify-between rounded bg-gray-900/40 px-3 py-2 text-xs",children:[e.jsx("span",{children:new Date(s.timestamp).toLocaleString(void 0,{hour:"2-digit",minute:"2-digit",weekday:"short"})}),e.jsxs("span",{className:"font-semibold",children:[s.price_pence.toFixed(2),"p"]})]},s.timestamp))})]}),!d&&e.jsx("div",{className:"rounded-md border border-dashed border-gray-700 bg-gray-900/40 px-4 py-3 text-sm text-gray-400",children:"Pick a miner and desired runtime to see the cheapest 30-minute slots for the next 24 hours."})]})]})]}),e.jsxs(o,{children:[e.jsx(N,{children:e.jsxs("div",{className:"flex items-center gap-3 text-base font-semibold",children:[e.jsx(pe,{className:"h-5 w-5 text-blue-300"})," Per-Miner Profitability"]})}),e.jsx(x,{children:q?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-gray-400",children:"Loading profitability…"}):(F=r==null?void 0:r.miners)!=null&&F.length?e.jsx("div",{className:"max-h-[420px] overflow-auto rounded-lg border border-gray-800",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-gray-950/80",children:e.jsxs("tr",{className:"text-left text-xs uppercase text-gray-500",children:[e.jsx("th",{className:"px-4 py-3",children:"Miner"}),e.jsx("th",{className:"px-4 py-3",children:"Coin"}),e.jsx("th",{className:"px-4 py-3",children:"Energy Cost"}),e.jsx("th",{className:"px-4 py-3",children:"Profit"}),e.jsx("th",{className:"px-4 py-3",children:"ROI"})]})}),e.jsx("tbody",{children:r.miners.map(s=>e.jsxs("tr",{className:"border-t border-gray-900/60",children:[e.jsx("td",{className:"px-4 py-3 text-gray-200",children:s.miner_name}),e.jsx("td",{className:"px-4 py-3 text-gray-400",children:s.coin||"—"}),e.jsx("td",{className:"px-4 py-3 text-gray-200",children:v(s.energy_cost_gbp)}),e.jsx("td",{className:j("px-4 py-3 font-semibold",s.profit_gbp>=0?"text-green-300":"text-red-300"),children:v(s.profit_gbp)}),e.jsx("td",{className:"px-4 py-3 text-gray-400",children:s.roi_percent!=null?`${s.roi_percent.toFixed(1)}%`:"—"})]},s.miner_id))})]})}):e.jsx("div",{className:"rounded-md border border-dashed border-gray-700 p-6 text-center text-sm text-gray-500",children:"No profitability records yet. Ensure telemetry is flowing for each enrolled miner."})})]})]})}export{Ce as default};
