import{c as v,r as g,a as S,j as e,a0 as D,C as o,d as b,e as N,o as A,p as L,q as R,s as M,t as P,B as F,R as B,f as m,m as I,U as T}from"./index-CExZIXGI.js";import{L as $,C as E,a as G,b as U,P as q,c as W,p as O,d as V,e as H,T as z}from"./chartjs-adapter-date-fns.esm-DDgbaDAh.js";import{L as w}from"./loader-2-C8glyB0y.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=v("ArrowDownRight",[["path",{d:"m7 7 10 10",key:"1fmybs"}],["path",{d:"M17 7v10H7",key:"6fjiku"}]]);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=v("ArrowUpRight",[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]]);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=v("CalendarRange",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",ry:"2",key:"eu3xkr"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["path",{d:"M17 14h-6",key:"bkmgh3"}],["path",{d:"M13 18H7",key:"bb0bb7"}],["path",{d:"M7 14h.01",key:"1qa3f1"}],["path",{d:"M17 18h.01",key:"1bdyru"}]]);E.register(G,U,q,W,O,V,H,z);async function Y(a,n){const s=await fetch(a,{headers:{"Content-Type":"application/json"},...n});if(!s.ok){const r=await s.json().catch(()=>({})),d=r.detail||r.message||`Request failed (${s.status})`;throw new Error(d)}if(s.status!==204)return s.json()}const Z=[{value:"3",label:"3 days"},{value:"5",label:"5 days"},{value:"7",label:"7 days"}];function j(a){var x;if(!a)return"—";const n=new Date(a.start),s=n.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}),r=n.toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"});return`${((x=a.price_pred_pence)==null?void 0:x.toFixed(2))??"—"} p/kWh • ${r} ${s}`}function X(a){return a?new Date(a).toLocaleString("en-GB",{weekday:"short",hour:"2-digit",minute:"2-digit",day:"numeric",month:"short"}):"—"}function ee(a){const n=a.map(r=>r.price_pred_pence).filter(r=>typeof r=="number");if(!n.length)return null;const s=n.reduce((r,d)=>r+d,0);return Number((s/n.length).toFixed(2))}function re(){const[a,n]=g.useState("7"),{data:s,isLoading:r,isFetching:d,error:x,refetch:k}=S({queryKey:["agile-forecast",a],queryFn:()=>Y(`/api/energy/agile-forecast?days=${a}`),refetchInterval:3e5}),u=g.useMemo(()=>{var t;return(t=s==null?void 0:s.days)!=null&&t.length?s.days.flatMap(l=>l.slots.filter(i=>typeof i.price_pred_pence=="number").map(i=>({timestamp:i.start,price:i.price_pred_pence}))):[]},[s]),f=g.useMemo(()=>u.length?{labels:u.map(t=>new Date(t.timestamp)),datasets:[{label:"Predicted price",data:u.map(t=>t.price),borderColor:"rgba(59, 130, 246, 1)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.35,pointRadius:0}]}:null,[u]),_=g.useMemo(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:t=>{var i;return`${(typeof((i=t.parsed)==null?void 0:i.y)=="number"?t.parsed.y:0).toFixed(2)} p/kWh`}}}},scales:{x:{type:"time",time:{unit:"hour"},ticks:{maxRotation:0},grid:{color:"rgba(255,255,255,0.05)"}},y:{beginAtZero:!1,title:{display:!0,text:"p/kWh"},grid:{color:"rgba(255,255,255,0.05)"}}}}),[]),y=(s==null?void 0:s.days)??[],p=s==null?void 0:s.summary;return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(D,{className:"h-5 w-5"}),e.jsx("span",{children:"Agile Predict"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"7-Day Agile Forecast"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Ingested directly from AgilePredict.com with daily refresh windows at 04:30. Use the forecast to pre-stage automation rules, power plans, and miner bands."})]}),e.jsxs(o,{children:[e.jsxs(b,{className:"flex flex-col gap-4 border-b border-border/50 bg-muted/10 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-widest text-blue-300",children:"Forecast Controls"}),e.jsxs(N,{className:"text-xl",children:["Region ",(s==null?void 0:s.region)??"—"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Last updated ",X(s==null?void 0:s.forecast_created_at)]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[e.jsxs(A,{value:a,onValueChange:n,children:[e.jsx(L,{className:"w-full sm:w-32",children:e.jsx(R,{placeholder:"Days"})}),e.jsx(M,{children:Z.map(t=>e.jsx(P,{value:t.value,children:t.label},t.value))})]}),e.jsxs(F,{onClick:()=>k(),variant:"secondary",disabled:d,className:"gap-2",children:[d?e.jsx(w,{className:"h-4 w-4 animate-spin"}):e.jsx(B,{className:"h-4 w-4"}),"Refresh"]})]})]}),e.jsxs(m,{className:"py-6",children:[x&&e.jsxs("div",{className:"flex items-center gap-3 rounded-md border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200",children:[e.jsx(I,{className:"h-4 w-4"}),e.jsx("span",{children:x instanceof Error?x.message:"Unable to load Agile Predict forecast."})]}),r?e.jsxs("div",{className:"flex items-center gap-3 text-muted-foreground",children:[e.jsx(w,{className:"h-4 w-4 animate-spin"}),"Loading forecast…"]}):null]})]}),p&&e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(o,{children:e.jsxs(m,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Average price"}),e.jsx("p",{className:"mt-2 text-3xl font-semibold",children:p.average_price_pence?`${p.average_price_pence.toFixed(2)} p/kWh`:"—"})]})}),e.jsx(o,{children:e.jsxs(m,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Total slots"}),e.jsx("p",{className:"mt-2 text-3xl font-semibold",children:p.slot_count})]})}),e.jsx(o,{children:e.jsxs(m,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Cheapest slot"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:j(p.cheapest_slot)})]})}),e.jsx(o,{children:e.jsxs(m,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Most expensive"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:j(p.most_expensive_slot)})]})})]}),f&&e.jsxs(o,{children:[e.jsxs(b,{children:[e.jsx(N,{children:"Price trajectory"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Predicted half-hour slots over the selected window."})]}),e.jsx(m,{children:e.jsx("div",{className:"h-80",children:e.jsx($,{data:f,options:_,"aria-label":"Agile forecast chart"})})})]}),f&&y.length>0&&e.jsx("div",{className:"rounded-md border border-border/40 bg-muted/5 p-4",children:e.jsx("div",{className:"flex divide-x divide-border/30",children:y.map(t=>{const l=new Date(t.date).toLocaleDateString("en-GB",{weekday:"long"});return e.jsxs("div",{className:"flex-1 px-3 text-center text-sm",children:[e.jsx("div",{className:"mb-2 h-4 w-px bg-blue-500/70 mx-auto"}),e.jsx("p",{className:"font-medium text-gray-200",children:l}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(t.date).toLocaleDateString("en-GB",{day:"numeric",month:"short"})})]},t.date)})})}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(Q,{className:"h-5 w-5"}),e.jsx("span",{children:"Daily breakdown"})]}),e.jsx("div",{className:"grid gap-4 lg:grid-cols-2",children:y.map(t=>{const l=ee(t.slots),i=[...t.slots].sort((c,h)=>(c.price_pred_pence??1/0)-(h.price_pred_pence??1/0))[0],C=[...t.slots].sort((c,h)=>(h.price_pred_pence??-1/0)-(c.price_pred_pence??-1/0))[0];return e.jsxs(o,{className:"border-border/60",children:[e.jsxs(b,{children:[e.jsx(N,{className:"text-lg",children:new Date(t.date).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Average ",l?`${l.toFixed(2)} p/kWh`:"—"]})]}),e.jsxs(m,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"rounded-md border border-emerald-500/40 bg-emerald-500/5 p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-300",children:[e.jsx(J,{className:"h-4 w-4"}),"Cheapest"]}),e.jsx("p",{className:"mt-1 text-muted-foreground",children:j(i)})]}),e.jsxs("div",{className:"rounded-md border border-rose-500/40 bg-rose-500/5 p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-rose-300",children:[e.jsx(K,{className:"h-4 w-4"}),"Expensive"]}),e.jsx("p",{className:"mt-1 text-muted-foreground",children:j(C)})]})]}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-2",children:t.slots.slice(0,8).map(c=>{var h;return e.jsxs("div",{className:T("flex items-center justify-between rounded-md border px-3 py-2 text-sm",(c.price_pred_pence??0)<=(l??0)?"border-emerald-500/40 bg-emerald-500/5":"border-amber-500/40 bg-amber-500/5"),children:[e.jsx("span",{children:new Date(c.start).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})}),e.jsxs("span",{className:"font-medium",children:[(h=c.price_pred_pence)==null?void 0:h.toFixed(2),"p"]})]},c.start)})}),t.slots.length>8&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["+",t.slots.length-8," more half-hour slots"]})]})]},t.date)})})]})]})}export{re as default};
