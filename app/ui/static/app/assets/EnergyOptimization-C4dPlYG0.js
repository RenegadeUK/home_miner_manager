import{k as X,r as m,a as j,j as e,Z,B as b,O as y,C as d,d as f,f as o,T as J,n as U,o as Y,p as ee,q as se,s as te}from"./index-BDHxGOPF.js";import{u as A}from"./useMutation-B23Z8kbb.js";import{L as re,C as ae,a as ne,b as ie,P as le,c as ce,p as de,d as oe,e as xe,T as me}from"./chartjs-adapter-date-fns.esm-CpVwA_Df.js";import{L as P}from"./loader-2-Cb4Ena7C.js";import{P as q}from"./play-circle-BznCiSVg.js";import{A as pe}from"./alert-triangle-DsxjIK8D.js";import{C as ge}from"./clock-DFQqy2ko.js";import{I as he}from"./info-fKaxJOD7.js";ae.register(ne,ie,le,ce,de,oe,xe,me);async function p(r,c){const i=await fetch(r,{headers:{"Content-Type":"application/json",...(c==null?void 0:c.headers)||{}},...c});if(!i.ok){const g=await i.json().catch(()=>({})),v=g.detail||g.message||`Request failed (${i.status})`;throw new Error(v)}if(i.status!==204)return i.json()}function N(r){return r==null?"£0.00":new Intl.NumberFormat("en-GB",{style:"currency",currency:"GBP"}).format(r)}function ue(r){return r==null?"—":`${r.toFixed(1)} p/kWh`}function ye(r){switch(r){case"CHEAP":return"text-green-300";case"MODERATE":return"text-amber-300";case"EXPENSIVE":return"text-red-300";default:return"text-gray-300"}}function je(r){switch(r){case"CHEAP":return"bg-green-500/10 text-green-300";case"MODERATE":return"bg-amber-500/10 text-amber-300";case"EXPENSIVE":return"bg-red-500/10 text-red-300";default:return"bg-gray-600/20 text-gray-300"}}function Se(){var I;const r=X(),[c,i]=m.useState(null),[g,v]=m.useState("12"),[x,k]=m.useState(""),[l,E]=m.useState(null),{data:n,isLoading:T,error:H}=j({queryKey:["auto-optimization-status"],queryFn:()=>p("/api/energy/auto-optimization/status")}),{data:a,isLoading:R,error:B}=j({queryKey:["energy-overview"],queryFn:()=>p("/api/energy/overview"),refetchInterval:6e4}),{data:h,isLoading:D,error:V}=j({queryKey:["energy-forecast"],queryFn:()=>p("/api/energy/price-forecast?hours=24"),refetchInterval:3e5}),{data:L,isLoading:O}=j({queryKey:["miners"],queryFn:()=>p("/api/miners/")}),u=Array.isArray(L)?L:[],w=Array.isArray(h==null?void 0:h.forecast)?h.forecast:[],$=Array.isArray(l==null?void 0:l.recommended_slots)?l==null?void 0:l.recommended_slots:[];m.useEffect(()=>{u.length>0&&x===""&&k(u[0].id)},[u,x]);const F=A({mutationFn:s=>p("/api/energy/auto-optimization/toggle",{method:"POST",body:JSON.stringify({enabled:s})}),onSuccess:(s,S)=>{i({type:"success",message:S?"Auto optimization enabled":"Auto optimization disabled"}),r.invalidateQueries({queryKey:["auto-optimization-status"]})},onError:s=>{i({type:"error",message:s.message})}}),C=A({mutationFn:()=>p("/api/energy/auto-optimization/trigger",{method:"POST"}),onSuccess:()=>{i({type:"success",message:"Auto optimization job triggered. Check miner modes shortly."}),r.invalidateQueries({queryKey:["energy-overview"]})},onError:s=>i({type:"error",message:s.message})}),_=A({mutationFn:({minerId:s,hours:S})=>p(`/api/energy/miners/${s}/schedule-recommendation?target_hours=${S}`),onSuccess:s=>{E(s)},onError:s=>{E(null),i({type:"error",message:s.message})}}),M=m.useMemo(()=>w.length?{labels:w.map(s=>new Date(s.timestamp)),datasets:[{label:"Price (p/kWh)",data:w.map(s=>s.price_pence),borderColor:"rgba(59, 130, 246, 1)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.3,pointRadius:0}]}:null,[h]),K=m.useMemo(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:s=>`${s.parsed.y.toFixed(2)} p/kWh`}}},scales:{x:{type:"time",time:{unit:"hour"},ticks:{maxRotation:0},grid:{color:"rgba(255,255,255,0.05)"}},y:{beginAtZero:!0,title:{display:!0,text:"p/kWh"},grid:{color:"rgba(255,255,255,0.05)"}}}}),[]),G=()=>{T||!n||F.mutate(!n.enabled)},Q=()=>{C.mutate()},W=()=>{if(!x||!g.trim()){i({type:"error",message:"Select a miner and number of hours first."});return}const s=Number(g);if(Number.isNaN(s)||s<1||s>24){i({type:"error",message:"Target hours must be between 1 and 24."});return}_.mutate({minerId:x,hours:s})},t=a==null?void 0:a.current_recommendation,z=[H,B,V].filter(Boolean);return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(Z,{className:"h-5 w-5"}),e.jsx("span",{children:"Energy Optimization"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Energy Optimization"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Combine Octopus Agile pricing with real-time miner telemetry to keep profitability positive and power usage smart."}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-4",children:[e.jsx(b,{onClick:G,disabled:T||F.isPending,variant:n!=null&&n.enabled?"default":"outline",className:"min-w-[190px]",children:n!=null&&n.enabled?"Disable Auto Optimization":"Enable Auto Optimization"}),e.jsxs(b,{variant:"secondary",onClick:Q,disabled:!(n!=null&&n.enabled)||C.isPending,className:"flex items-center gap-2",children:[C.isPending?e.jsx(P,{className:"h-4 w-4 animate-spin"}):e.jsx(q,{className:"h-4 w-4"}),"Run Now"]})]})]}),c&&e.jsx("div",{className:y("rounded-md border px-4 py-3 text-sm",c.type==="success"?"border-green-500/40 bg-green-500/10 text-green-200":"border-red-500/40 bg-red-500/10 text-red-200"),children:c.message}),z.length>0&&e.jsxs("div",{className:"flex items-center gap-3 rounded-md border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx("span",{children:z.map(s=>s instanceof Error?s.message:"Unknown error").join(" • ")})]}),e.jsxs(d,{children:[e.jsx(f,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Automation Bands"}),e.jsx("p",{className:"text-sm text-gray-400",children:"CHEAP (<15p) runs miners in High/OC mode, MODERATE (15-25p) shifts to Low/Eco, EXPENSIVE (≥25p) powers down linked Home Assistant devices to avoid negative ROI."})]})}),e.jsx(o,{children:n!=null&&n.enabled?e.jsxs("div",{className:"space-y-3 text-sm text-gray-300",children:[e.jsxs("p",{children:[e.jsx("strong",{className:"text-green-300",children:"Enabled:"})," Scheduler reconciles miners every 5 minutes, applying band logic to Bitaxe, NerdQaxe++, and Avalon Nano devices plus their associated switches."]}),e.jsxs("p",{children:[e.jsx("strong",{className:"text-amber-300",children:"Tip:"})," Disable conflicting automation rules that also touch miner modes or HA devices."]})]}):e.jsx("div",{className:"rounded-md border border-dashed border-gray-700 bg-gray-900/40 px-4 py-3 text-sm text-gray-400",children:"Enable automatic optimization to orchestrate miners based on live Agile pricing."})})]}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(d,{children:e.jsxs(o,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"24h Energy Cost"}),e.jsx("p",{className:"mt-2 text-2xl font-semibold",children:N(a==null?void 0:a.total_energy_cost_24h)})]})}),e.jsx(d,{children:e.jsxs(o,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"24h Net Profit"}),e.jsx("p",{className:y("mt-2 text-2xl font-semibold",((a==null?void 0:a.total_profit_24h)??0)>=0?"text-green-300":"text-red-300"),children:N(a==null?void 0:a.total_profit_24h)})]})}),e.jsx(d,{children:e.jsxs(o,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Current Price"}),e.jsx("p",{className:y("mt-2 text-2xl font-semibold",ye(t==null?void 0:t.band)),children:ue(t==null?void 0:t.current_price_pence)}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Valid until ",(t==null?void 0:t.valid_until)&&new Date(t.valid_until).toLocaleTimeString()]})]})}),e.jsx(d,{children:e.jsxs(o,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Recommendation"}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("span",{className:y("rounded-full px-2 py-0.5 text-xs font-semibold",je(t==null?void 0:t.band)),children:(t==null?void 0:t.band)||"—"}),e.jsx("span",{className:"text-sm text-gray-300",children:(t==null?void 0:t.recommendation)||"Waiting for data…"})]})]})})]}),e.jsxs("div",{className:"grid gap-6 lg:grid-cols-2",children:[e.jsxs(d,{children:[e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-3 text-base font-semibold",children:[e.jsx(J,{className:"h-5 w-5 text-blue-300"})," 24-Hour Price Forecast"]})}),e.jsxs(o,{children:[D?e.jsx("div",{className:"flex min-h-[240px] items-center justify-center text-gray-400",children:e.jsx(P,{className:"h-5 w-5 animate-spin"})}):M?e.jsx("div",{className:"h-[260px]",children:e.jsx(re,{data:M,options:K})}):e.jsx("p",{className:"text-sm text-gray-500",children:"No forecast data available."}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-4 text-xs text-gray-500",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-green-400"})," Cheap < 15p"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-amber-400"})," Moderate 15-25p"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"h-2 w-2 rounded-full bg-red-400"})," Expensive ≥ 25p"]})]})]})]}),e.jsxs(d,{children:[e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-3 text-base font-semibold",children:[e.jsx(ge,{className:"h-5 w-5 text-blue-300"})," Smart Schedule"]})}),e.jsxs(o,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase",children:"Target Miner"}),e.jsxs(U,{disabled:O||u.length===0,value:x?String(x):"",onValueChange:s=>k(Number(s)),children:[e.jsx(Y,{children:e.jsx(ee,{placeholder:O?"Loading miners…":"Select miner"})}),e.jsx(se,{children:u.map(s=>e.jsx(te,{value:String(s.id),children:s.name},s.id))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs text-gray-400 uppercase",children:"Target Hours"}),e.jsx("input",{type:"number",min:1,max:24,value:g,onChange:s=>v(s.target.value),className:"w-full rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm text-gray-100 focus:border-blue-500 focus:outline-none"})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(b,{onClick:W,disabled:_.isPending||!x,className:"flex items-center gap-2",children:[_.isPending?e.jsx(P,{className:"h-4 w-4 animate-spin"}):e.jsx(q,{className:"h-4 w-4"}),"Generate Schedule"]}),e.jsx(b,{variant:"outline",disabled:!l,onClick:()=>E(null),children:"Clear"})]}),l&&e.jsxs("div",{className:"space-y-3 rounded-md border border-blue-500/30 bg-blue-500/5 p-4 text-sm text-blue-100",children:[e.jsxs("p",{children:["Expected savings: ",e.jsxs("strong",{children:[l.savings_percent.toFixed(1),"%"]})," vs random schedule · Avg price",` ${l.avg_price_pence.toFixed(2)}p`]}),e.jsx("div",{className:"max-h-[200px] space-y-2 overflow-y-auto pr-2",children:$.map(s=>e.jsxs("div",{className:"flex items-center justify-between rounded bg-gray-900/40 px-3 py-2 text-xs",children:[e.jsx("span",{children:new Date(s.timestamp).toLocaleString(void 0,{hour:"2-digit",minute:"2-digit",weekday:"short"})}),e.jsxs("span",{className:"font-semibold",children:[s.price_pence.toFixed(2),"p"]})]},s.timestamp))})]}),!l&&e.jsx("div",{className:"rounded-md border border-dashed border-gray-700 bg-gray-900/40 px-4 py-3 text-sm text-gray-400",children:"Pick a miner and desired runtime to see the cheapest 30-minute slots for the next 24 hours."})]})]})]}),e.jsxs(d,{children:[e.jsx(f,{children:e.jsxs("div",{className:"flex items-center gap-3 text-base font-semibold",children:[e.jsx(he,{className:"h-5 w-5 text-blue-300"})," Per-Miner Profitability"]})}),e.jsx(o,{children:R?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-gray-400",children:"Loading profitability…"}):(I=a==null?void 0:a.miners)!=null&&I.length?e.jsx("div",{className:"max-h-[420px] overflow-auto rounded-lg border border-gray-800",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"sticky top-0 bg-gray-950/80",children:e.jsxs("tr",{className:"text-left text-xs uppercase text-gray-500",children:[e.jsx("th",{className:"px-4 py-3",children:"Miner"}),e.jsx("th",{className:"px-4 py-3",children:"Coin"}),e.jsx("th",{className:"px-4 py-3",children:"Energy Cost"}),e.jsx("th",{className:"px-4 py-3",children:"Profit"}),e.jsx("th",{className:"px-4 py-3",children:"ROI"})]})}),e.jsx("tbody",{children:a.miners.map(s=>e.jsxs("tr",{className:"border-t border-gray-900/60",children:[e.jsx("td",{className:"px-4 py-3 text-gray-200",children:s.miner_name}),e.jsx("td",{className:"px-4 py-3 text-gray-400",children:s.coin||"—"}),e.jsx("td",{className:"px-4 py-3 text-gray-200",children:N(s.energy_cost_gbp)}),e.jsx("td",{className:y("px-4 py-3 font-semibold",s.profit_gbp>=0?"text-green-300":"text-red-300"),children:N(s.profit_gbp)}),e.jsx("td",{className:"px-4 py-3 text-gray-400",children:s.roi_percent!=null?`${s.roi_percent.toFixed(1)}%`:"—"})]},s.miner_id))})]})}):e.jsx("div",{className:"rounded-md border border-dashed border-gray-700 p-6 text-center text-sm text-gray-500",children:"No profitability records yet. Ensure telemetry is flowing for each enrolled miner."})})]})]})}export{Se as default};
