import{c as Y,l as D,r as g,a as Q,j as e,C as h,f as u,A as K,Q as z,B as b,U as R,d as v,Z as ee,m as se,I as ae,o as S,p as w,q as C,s as _,t as B,O as te,K as le}from"./index-l4FVxNnM.js";import{u as y}from"./useMutation-DoMZb3N0.js";import{R as U}from"./refresh-ccw-CoeHlXS5.js";import{I as re}from"./info-Cr9EG-ds.js";import{T as ne}from"./trash-2-DL6eM_ZX.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=Y("Layers",[["path",{d:"m12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83Z",key:"8b97xw"}],["path",{d:"m22 17.65-9.17 4.16a2 2 0 0 1-1.66 0L2 17.65",key:"dd6zsq"}],["path",{d:"m22 12.65-9.17 4.16a2 2 0 0 1-1.66 0L2 12.65",key:"ep9fru"}]]),de=[{value:"OFF",label:"OFF (devices off)"},{value:"DGB",label:"DGB · DigiByte Solo"},{value:"BC2",label:"BC2 · DigiByte Turbo"},{value:"BCH",label:"BCH · Bitcoin Cash Solo"},{value:"BTC",label:"BTC · Bitcoin Solo"},{value:"BTC_POOLED",label:"BTC · Braiins Pool"}],O={bitaxe:[{value:"managed_externally",label:"HA Off / External"},{value:"eco",label:"Eco"},{value:"standard",label:"Standard"},{value:"turbo",label:"Turbo"},{value:"oc",label:"OC"}],nerdqaxe:[{value:"managed_externally",label:"HA Off / External"},{value:"eco",label:"Eco"},{value:"standard",label:"Standard"},{value:"turbo",label:"Turbo"},{value:"oc",label:"OC"}],avalon_nano:[{value:"managed_externally",label:"HA Off / External"},{value:"low",label:"Low"},{value:"med",label:"Medium"},{value:"high",label:"High"}]};async function p(r,n){const d=await fetch(r,{headers:{"Content-Type":"application/json",...(n==null?void 0:n.headers)||{}},...n});if(!d.ok){const c=await d.json().catch(()=>({})),f=c.detail||c.message||`Request failed (${d.status})`;throw new Error(f)}if(d.status!==204)return d.json()}const ce=[{key:"bitaxe",label:"Bitaxe 601",icon:ee,helper:"Full control (eco/standard/turbo/oc)"},{key:"nerdqaxe",label:"NerdQaxe++",icon:z,helper:"Supports aggressive tuning profiles"},{key:"avalon_nano",label:"Avalon Nano 3/3S",icon:ie,helper:"Uses low / med / high workmodes"},{key:"nmminer",label:"NMMiner ESP32",icon:se,helper:"Lottery miners for extreme variance plays"}];function oe(r){if(!r)return"Never";const n=new Date(r);return`${n.toLocaleDateString()} · ${n.toLocaleTimeString()}`}function me(r){return r==null?"—":`${r.toFixed(2)} p/kWh`}function be(){const r=D(),[n,d]=g.useState(new Set),[c,f]=g.useState(!1),[E,i]=g.useState(null),{data:t,isLoading:V,error:k}=Q({queryKey:["agile-strategy"],queryFn:()=>p("/api/settings/agile-solo-strategy")}),{data:A,isLoading:$,error:T}=Q({queryKey:["agile-strategy-bands"],queryFn:()=>p("/api/settings/agile-solo-strategy/bands")});g.useEffect(()=>{t&&(f(t.enabled),d(new Set(t.enrolled_miners.map(s=>s.id))))},[t]);const M=y({mutationFn:s=>p("/api/settings/agile-solo-strategy",{method:"POST",body:JSON.stringify(s)}),onSuccess:()=>{i({type:"success",message:"Strategy settings saved"}),r.invalidateQueries({queryKey:["agile-strategy"]})},onError:s=>{i({type:"error",message:s.message})}}),P=y({mutationFn:({bandId:s,body:l})=>p(`/api/settings/agile-solo-strategy/bands/${s}`,{method:"PATCH",body:JSON.stringify(l)}),onSuccess:()=>{r.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{i({type:"error",message:s.message})}}),F=y({mutationFn:()=>p("/api/settings/agile-solo-strategy/bands/reset",{method:"POST"}),onSuccess:()=>{i({type:"success",message:"Bands reset to defaults"}),r.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{i({type:"error",message:s.message})}}),j=g.useMemo(()=>({status:c?"Enabled":"Disabled",currentBand:(t==null?void 0:t.current_price_band)||"—",lastAction:oe((t==null?void 0:t.last_action_time)||null),currentPrice:me((t==null?void 0:t.last_price_checked)??null),enrolled:n.size,hysteresis:(t==null?void 0:t.hysteresis_counter)??0}),[t==null?void 0:t.current_price_band,t==null?void 0:t.hysteresis_counter,t==null?void 0:t.last_action_time,t==null?void 0:t.last_price_checked,n.size,c]),G=s=>{d(l=>{const a=new Set(l);return a.has(s)?a.delete(s):a.add(s),a})},J=(s,l)=>{d(a=>{const o=new Set(a);return s.forEach(m=>{l?o.add(m):o.delete(m)}),o})},W=()=>{M.mutate({enabled:c,miner_ids:Array.from(n)})},q=(s,l,a)=>{const o=a.trim(),m=o===""?null:Number(o);if(m!==null&&Number.isNaN(m)){i({type:"error",message:"Price thresholds must be numeric"});return}P.mutate({bandId:s,body:{[l]:m}})},N=(s,l,a)=>{P.mutate({bandId:s,body:{[l]:a}})},L=y({mutationFn:s=>p(`/api/settings/agile-solo-strategy/bands/${s}`,{method:"DELETE"}),onSuccess:()=>{i({type:"success",message:"Band removed"}),r.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{i({type:"error",message:s.message})}}),H=y({mutationFn:s=>p("/api/settings/agile-solo-strategy/bands",{method:"POST",body:JSON.stringify(s)}),onSuccess:()=>{i({type:"success",message:"New band inserted"}),r.invalidateQueries({queryKey:["agile-strategy-bands"]})},onError:s=>{i({type:"error",message:s.message})}}),Z=s=>{H.mutate({insert_after_band_id:s})},X=s=>{window.confirm("Delete this price band? This cannot be undone (use reset to restore defaults).")&&L.mutate(s)},I=(s,l)=>e.jsx("tr",{className:"border-t border-gray-900/60",children:e.jsx("td",{colSpan:6,className:"py-2",children:e.jsxs(b,{variant:"ghost",size:"sm",className:"w-full justify-center text-blue-300 hover:text-white",disabled:H.isPending,onClick:()=>Z(l),children:[e.jsx(le,{className:"mr-2 h-4 w-4"})," Add price band here"]})})},s);return V?e.jsx("div",{className:"flex min-h-[60vh] items-center justify-center text-gray-400",children:e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[e.jsx(U,{className:"h-6 w-6 animate-spin"}),e.jsx("p",{children:"Loading Agile Strategy…"})]})}):k?e.jsx("div",{className:"p-6",children:e.jsx(h,{className:"border-red-500/40 bg-red-500/10",children:e.jsxs(u,{className:"flex items-center gap-3 p-6 text-red-200",children:[e.jsx(K,{className:"h-5 w-5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Unable to load strategy settings"}),e.jsx("p",{className:"text-sm opacity-80",children:k instanceof Error?k.message:"Unknown error"})]})]})})}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(z,{className:"h-5 w-5"}),e.jsx("span",{children:"Agile Strategy"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"Octopus Agile Solo Strategy"}),e.jsx("p",{className:"text-gray-400 text-sm",children:"Enroll miners, map Octopus Agile price bands to mining targets, and let HMM orchestrate pool switching, tuning, and Home Assistant device control."}),e.jsxs("div",{className:"flex flex-wrap gap-3 pt-4",children:[e.jsx(b,{variant:c?"default":"outline",onClick:()=>f(s=>!s),className:"w-32",children:c?"Enabled":"Enable"}),e.jsx(b,{variant:"outline",disabled:M.isPending,onClick:W,children:"Save Settings"})]})]}),E&&e.jsx("div",{className:R("rounded-md border px-4 py-3 text-sm",E.type==="success"?"border-green-500/40 bg-green-500/10 text-green-200":"border-red-500/40 bg-red-500/10 text-red-200"),children:E.message}),e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(h,{children:e.jsxs(u,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Status"}),e.jsx("p",{className:R("mt-2 text-xl font-semibold",c?"text-green-300":"text-gray-300"),children:j.status})]})}),e.jsx(h,{children:e.jsxs(u,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Current Band"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:j.currentBand})]})}),e.jsx(h,{children:e.jsxs(u,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Last Action"}),e.jsx("p",{className:"mt-2 text-sm text-gray-200",children:j.lastAction})]})}),e.jsx(h,{children:e.jsxs(u,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Enrolled Miners"}),e.jsx("p",{className:"mt-2 text-xl font-semibold",children:j.enrolled})]})})]}),e.jsxs(h,{children:[e.jsx(v,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Strategy Primer"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Understand how pricing bands, solo vs pooled modes, and hysteresis interact before enabling automation."})]})}),e.jsxs(u,{className:"space-y-4",children:[e.jsxs("div",{className:"rounded-lg border border-blue-500/30 bg-blue-500/5 p-4 text-sm text-blue-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-blue-200",children:[e.jsx(re,{className:"h-4 w-4"})," What happens when prices spike?"]}),e.jsx("p",{className:"mt-2 text-blue-100/80",children:'When the OFF band threshold is reached the orchestration layer pauses miner tuning/pool changes and sends "off" commands to linked Home Assistant switches. As soon as prices settle into a cheaper band the strategy resumes normal operation.'})]}),e.jsxs("div",{className:"rounded-lg border border-amber-500/30 bg-amber-500/5 p-4 text-sm text-amber-100",children:[e.jsxs("h3",{className:"flex items-center gap-2 text-base font-semibold text-amber-200",children:[e.jsx(K,{className:"h-4 w-4"})," Avoid rule conflicts"]}),e.jsx("p",{className:"mt-2 text-amber-100/80",children:"Automation rules that touch enrolled miners (mode changes, pool overrides, HA commands) may conflict with the strategy engine. Disable conflicting rules or scope them to miners not enrolled here."})]})]})]}),e.jsxs(h,{children:[e.jsx(v,{children:e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Enroll Miners"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Only enabled ASIC miners appear. Use group toggles to speed up selection."})]})}),e.jsx(u,{className:"space-y-6",children:ce.map(s=>{var m;const l=((m=t==null?void 0:t.miners_by_type)==null?void 0:m[s.key])??[],a=l.filter(x=>n.has(x.id)).length,o=l.length>0&&a===l.length;return e.jsxs("div",{className:"rounded-lg border border-gray-800 bg-gray-900/40 p-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(s.icon,{className:"h-4 w-4 text-blue-300"})," ",s.label]}),e.jsx("p",{className:"text-sm text-gray-500",children:s.helper})]}),l.length>0&&e.jsxs(b,{variant:"ghost",size:"sm",className:"text-xs",onClick:()=>J(l.map(x=>x.id),!o),children:[o?"Clear":"Select all"," (",a,"/",l.length,")"]})]}),l.length===0?e.jsx("p",{className:"mt-4 rounded-md border border-dashed border-gray-700 p-3 text-sm text-gray-500",children:"No miners available."}):e.jsx("div",{className:"mt-4 grid gap-3 md:grid-cols-2",children:l.map(x=>e.jsxs("label",{className:"flex cursor-pointer items-center gap-3 rounded-md border border-gray-800 bg-gray-950/60 p-3 hover:border-blue-500/40",children:[e.jsx(ae,{checked:n.has(x.id),onCheckedChange:()=>G(x.id)}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm text-gray-100",children:x.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["ID #",x.id]})]})]},x.id))})]},s.key)})})]}),e.jsxs(h,{children:[e.jsx(v,{children:e.jsx("div",{className:"flex flex-col gap-1",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Price Band Strategy"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Map Agile price windows to coins and tuning modes."})]}),e.jsxs(b,{variant:"outline",size:"sm",disabled:F.isPending,onClick:()=>F.mutate(),className:"gap-2",children:[e.jsx(U,{className:"h-4 w-4"})," Reset to defaults"]})]})})}),e.jsx(u,{className:"overflow-x-auto",children:$?e.jsx("div",{className:"flex min-h-[200px] items-center justify-center text-gray-400",children:"Loading bands…"}):T?e.jsx("div",{className:"rounded-md border border-red-500/40 bg-red-500/10 p-4 text-sm text-red-200",children:T.message||"Failed to load price bands"}):e.jsxs("table",{className:"w-full min-w-[800px] text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-xs uppercase text-gray-500",children:[e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Price band (p/kWh)"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Coin"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Bitaxe Mode"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"NerdQaxe Mode"}),e.jsx("th",{className:"py-3 pr-4 font-medium",children:"Avalon Nano Mode"}),e.jsx("th",{className:"py-3 font-medium",children:"Notes"}),e.jsx("th",{className:"py-3 text-right font-medium",children:"Actions"})]})}),e.jsxs("tbody",{children:[I("insert-top",null),A==null?void 0:A.bands.map(s=>{const l=s.target_coin==="OFF";return e.jsxs(g.Fragment,{children:[e.jsxs("tr",{className:"border-t border-gray-800",children:[e.jsx("td",{className:"py-3 pr-4",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",defaultValue:s.min_price??"",placeholder:"min",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:a=>q(s.id,"min_price",a.target.value)}),e.jsx("span",{className:"text-gray-500",children:"–"}),e.jsx("input",{type:"number",defaultValue:s.max_price??"",placeholder:"max",className:"w-24 rounded-md border border-gray-700 bg-gray-900 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none",onBlur:a=>q(s.id,"max_price",a.target.value)})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(S,{value:s.target_coin,onValueChange:a=>N(s.id,"target_coin",a),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"Select coin"})}),e.jsx(_,{children:de.map(a=>e.jsx(B,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(S,{disabled:l,value:s.bitaxe_mode,onValueChange:a=>N(s.id,"bitaxe_mode",a),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"Bitaxe mode"})}),e.jsx(_,{children:O.bitaxe.map(a=>e.jsx(B,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(S,{disabled:l,value:s.nerdqaxe_mode,onValueChange:a=>N(s.id,"nerdqaxe_mode",a),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"NerdQaxe mode"})}),e.jsx(_,{children:O.nerdqaxe.map(a=>e.jsx(B,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 pr-4",children:e.jsxs(S,{disabled:l,value:s.avalon_nano_mode,onValueChange:a=>N(s.id,"avalon_nano_mode",a),children:[e.jsx(w,{children:e.jsx(C,{placeholder:"Avalon mode"})}),e.jsx(_,{children:O.avalon_nano.map(a=>e.jsx(B,{value:a.value,children:a.label},a.value))})]})}),e.jsx("td",{className:"py-3 text-gray-500",children:l?"Turns off all linked HA devices":"Applies pool + mode changes (or HA off if selected)"}),e.jsx("td",{className:"py-3",children:e.jsx("div",{className:"flex justify-end",children:e.jsx(b,{variant:"ghost",size:"icon",className:"text-gray-400 hover:text-red-300",disabled:L.isPending,onClick:()=>X(s.id),children:e.jsx(ne,{className:"h-4 w-4"})})})})]}),I(`insert-after-${s.id}`,s.id)]},s.id)})]})]})})]}),e.jsxs(h,{children:[e.jsx(v,{children:e.jsxs("div",{className:"flex items-center gap-2 text-base font-semibold",children:[e.jsx(te,{className:"h-5 w-5 text-green-300"})," Hysteresis & Recovery"]})}),e.jsx(u,{children:e.jsxs("ul",{className:"list-disc space-y-2 pl-5 text-sm text-gray-300",children:[e.jsx("li",{children:"Upgrades into cheaper bands require the next 30-minute slot to confirm the same or better price."}),e.jsx("li",{children:"Downgrades into expensive bands happen immediately to avoid negative profitability."}),e.jsx("li",{children:"The scheduler executes every 30 minutes plus an additional reconciliation run when prices change suddenly."}),e.jsxs("li",{children:["Current hysteresis counter: ",e.jsx("span",{className:"font-semibold text-white",children:j.hysteresis})]})]})})]})]})}export{be as default};
