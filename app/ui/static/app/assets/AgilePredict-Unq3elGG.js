import{c as b,r as u,a as S,j as e,Y as A,C as c,d as j,e as y,n as R,o as D,p as L,q as M,s as P,B as F,R as I,f as d,l as T,M as $}from"./index-DcYJbmVw.js";import{L as B,C as E,a as q,b as G,P as U,c as W,p as O,d as H,e as V,T as Y}from"./chartjs-adapter-date-fns.esm-lPAl1ypK.js";import{L as v}from"./loader-2-pxCQXokX.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const z=b("ArrowDownRight",[["path",{d:"m7 7 10 10",key:"1fmybs"}],["path",{d:"M17 7v10H7",key:"6fjiku"}]]);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=b("ArrowUpRight",[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]]);/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const K=b("CalendarRange",[["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",ry:"2",key:"eu3xkr"}],["line",{x1:"16",x2:"16",y1:"2",y2:"6",key:"m3sa8f"}],["line",{x1:"8",x2:"8",y1:"2",y2:"6",key:"18kwsl"}],["line",{x1:"3",x2:"21",y1:"10",y2:"10",key:"xt86sb"}],["path",{d:"M17 14h-6",key:"bkmgh3"}],["path",{d:"M13 18H7",key:"bb0bb7"}],["path",{d:"M7 14h.01",key:"1qa3f1"}],["path",{d:"M17 18h.01",key:"1bdyru"}]]);E.register(q,G,U,W,O,H,V,Y);async function Q(r,i){const s=await fetch(r,{headers:{"Content-Type":"application/json"},...i});if(!s.ok){const a=await s.json().catch(()=>({})),l=a.detail||a.message||`Request failed (${s.status})`;throw new Error(l)}if(s.status!==204)return s.json()}const Z=[{value:"3",label:"3 days"},{value:"5",label:"5 days"},{value:"7",label:"7 days"}];function f(r){var o;if(!r)return"—";const i=new Date(r.start),s=i.toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"}),a=i.toLocaleDateString("en-GB",{weekday:"short",day:"numeric",month:"short"});return`${((o=r.price_pred_pence)==null?void 0:o.toFixed(2))??"—"} p/kWh • ${a} ${s}`}function X(r){return r?new Date(r).toLocaleString("en-GB",{weekday:"short",hour:"2-digit",minute:"2-digit",day:"numeric",month:"short"}):"—"}function ee(r){const i=r.map(a=>a.price_pred_pence).filter(a=>typeof a=="number");if(!i.length)return null;const s=i.reduce((a,l)=>a+l,0);return Number((s/i.length).toFixed(2))}function ae(){const[r,i]=u.useState("7"),{data:s,isLoading:a,isFetching:l,error:o,refetch:w}=S({queryKey:["agile-forecast",r],queryFn:()=>Q(`/api/energy/agile-forecast?days=${r}`),refetchInterval:3e5}),g=u.useMemo(()=>{var t;return(t=s==null?void 0:s.days)!=null&&t.length?s.days.flatMap(h=>h.slots.filter(p=>typeof p.price_pred_pence=="number").map(p=>({timestamp:p.start,price:p.price_pred_pence}))):[]},[s]),N=u.useMemo(()=>g.length?{labels:g.map(t=>new Date(t.timestamp)),datasets:[{label:"Predicted price",data:g.map(t=>t.price),borderColor:"rgba(59, 130, 246, 1)",backgroundColor:"rgba(59, 130, 246, 0.1)",tension:.35,pointRadius:0}]}:null,[g]),k=u.useMemo(()=>({responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:t=>`${t.parsed.y.toFixed(2)} p/kWh`}}},scales:{x:{type:"time",time:{unit:"hour"},ticks:{maxRotation:0},grid:{color:"rgba(255,255,255,0.05)"}},y:{beginAtZero:!1,title:{display:!0,text:"p/kWh"},grid:{color:"rgba(255,255,255,0.05)"}}}}),[]),_=(s==null?void 0:s.days)??[],m=s==null?void 0:s.summary;return e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(A,{className:"h-5 w-5"}),e.jsx("span",{children:"Agile Predict"})]}),e.jsx("h1",{className:"text-2xl font-semibold",children:"7-Day Agile Forecast"}),e.jsx("p",{className:"text-sm text-gray-400",children:"Ingested directly from AgilePredict.com with daily refresh windows at 04:30. Use the forecast to pre-stage automation rules, power plans, and miner bands."})]}),e.jsxs(c,{children:[e.jsxs(j,{className:"flex flex-col gap-4 border-b border-border/50 bg-muted/10 md:flex-row md:items-center md:justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase tracking-widest text-blue-300",children:"Forecast Controls"}),e.jsxs(y,{className:"text-xl",children:["Region ",(s==null?void 0:s.region)??"—"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Last updated ",X(s==null?void 0:s.forecast_created_at)]})]}),e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center",children:[e.jsxs(R,{value:r,onValueChange:i,children:[e.jsx(D,{className:"w-full sm:w-32",children:e.jsx(L,{placeholder:"Days"})}),e.jsx(M,{children:Z.map(t=>e.jsx(P,{value:t.value,children:t.label},t.value))})]}),e.jsxs(F,{onClick:()=>w(),variant:"secondary",disabled:l,className:"gap-2",children:[l?e.jsx(v,{className:"h-4 w-4 animate-spin"}):e.jsx(I,{className:"h-4 w-4"}),"Refresh"]})]})]}),e.jsxs(d,{className:"py-6",children:[o&&e.jsxs("div",{className:"flex items-center gap-3 rounded-md border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-200",children:[e.jsx(T,{className:"h-4 w-4"}),e.jsx("span",{children:o instanceof Error?o.message:"Unable to load Agile Predict forecast."})]}),a?e.jsxs("div",{className:"flex items-center gap-3 text-muted-foreground",children:[e.jsx(v,{className:"h-4 w-4 animate-spin"}),"Loading forecast…"]}):null]})]}),m&&e.jsxs("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-4",children:[e.jsx(c,{children:e.jsxs(d,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Average price"}),e.jsx("p",{className:"mt-2 text-3xl font-semibold",children:m.average_price_pence?`${m.average_price_pence.toFixed(2)} p/kWh`:"—"})]})}),e.jsx(c,{children:e.jsxs(d,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Total slots"}),e.jsx("p",{className:"mt-2 text-3xl font-semibold",children:m.slot_count})]})}),e.jsx(c,{children:e.jsxs(d,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Cheapest slot"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:f(m.cheapest_slot)})]})}),e.jsx(c,{children:e.jsxs(d,{className:"p-5",children:[e.jsx("p",{className:"text-xs uppercase text-gray-500",children:"Most expensive"}),e.jsx("p",{className:"mt-2 text-sm text-muted-foreground",children:f(m.most_expensive_slot)})]})})]}),N&&e.jsxs(c,{children:[e.jsxs(j,{children:[e.jsx(y,{children:"Price trajectory"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Predicted half-hour slots over the selected window."})]}),e.jsx(d,{children:e.jsx("div",{className:"h-80",children:e.jsx(B,{data:N,options:k,"aria-label":"Agile forecast chart"})})})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm uppercase tracking-widest text-blue-300",children:[e.jsx(K,{className:"h-5 w-5"}),e.jsx("span",{children:"Daily breakdown"})]}),e.jsx("div",{className:"grid gap-4 lg:grid-cols-2",children:_.map(t=>{const h=ee(t.slots),p=[...t.slots].sort((n,x)=>(n.price_pred_pence??1/0)-(x.price_pred_pence??1/0))[0],C=[...t.slots].sort((n,x)=>(x.price_pred_pence??-1/0)-(n.price_pred_pence??-1/0))[0];return e.jsxs(c,{className:"border-border/60",children:[e.jsxs(j,{children:[e.jsx(y,{className:"text-lg",children:new Date(t.date).toLocaleDateString("en-GB",{weekday:"long",day:"numeric",month:"long"})}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Average ",h?`${h.toFixed(2)} p/kWh`:"—"]})]}),e.jsxs(d,{className:"space-y-4",children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("div",{className:"rounded-md border border-emerald-500/40 bg-emerald-500/5 p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-emerald-300",children:[e.jsx(z,{className:"h-4 w-4"}),"Cheapest"]}),e.jsx("p",{className:"mt-1 text-muted-foreground",children:f(p)})]}),e.jsxs("div",{className:"rounded-md border border-rose-500/40 bg-rose-500/5 p-3 text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-rose-300",children:[e.jsx(J,{className:"h-4 w-4"}),"Expensive"]}),e.jsx("p",{className:"mt-1 text-muted-foreground",children:f(C)})]})]}),e.jsx("div",{className:"grid gap-2 sm:grid-cols-2",children:t.slots.slice(0,8).map(n=>{var x;return e.jsxs("div",{className:$("flex items-center justify-between rounded-md border px-3 py-2 text-sm",(n.price_pred_pence??0)<=(h??0)?"border-emerald-500/40 bg-emerald-500/5":"border-amber-500/40 bg-amber-500/5"),children:[e.jsx("span",{children:new Date(n.start).toLocaleTimeString("en-GB",{hour:"2-digit",minute:"2-digit"})}),e.jsxs("span",{className:"font-medium",children:[(x=n.price_pred_pence)==null?void 0:x.toFixed(2),"p"]})]},n.start)})}),t.slots.length>8&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["+",t.slots.length-8," more half-hour slots"]})]})]},t.date)})})]})]})}export{ae as default};
