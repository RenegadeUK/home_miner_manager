import{c as Z,l as J,r as u,a as S,j as e,aa as X,U as N,C as k,d as _,e as T,f as A,L as Y,B as j,ab as x,a2 as ee,A as te}from"./index-l4FVxNnM.js";import{u as E}from"./useMutation-DoMZb3N0.js";import{h as p}from"./textFormatters-NadoA3a2.js";import{L as F}from"./loader-2-CvfV_zVc.js";import{R as se}from"./refresh-ccw-CoeHlXS5.js";/**
 * @license lucide-react v0.303.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const re=Z("SendHorizontal",[["path",{d:"m3 3 3 9-3 9 19-9Z",key:"1aobqy"}],["path",{d:"M6 12h16",key:"s4cdu5"}]]),ne=[{type:"telegram",label:"Telegram",description:"Send alerts through your Telegram bot",emoji:"ðŸ“±",fields:[{name:"bot_token",label:"Bot Token",placeholder:"123456789:ABCdefGHIjklMNOpqrsTUVwxyz",hint:"Create and manage tokens via @BotFather"},{name:"chat_id",label:"Chat ID",placeholder:"123456789",hint:"Send a message to your bot and call getUpdates to find the chat ID"}]},{type:"discord",label:"Discord",description:"Send alerts to a Discord channel via webhook",emoji:"ðŸ’¬",fields:[{name:"webhook_url",label:"Webhook URL",placeholder:"https://discord.com/api/webhooks/...",hint:"Create a webhook in Server Settings â†’ Integrations â†’ Webhooks"}]}],ae={high_temperature:{label:"High Temperature",description:"Alert when a miner exceeds its safe thermal threshold."},block_found:{label:"Block Found ðŸŽ‰",description:"Celebrate whenever any configured pool reports a block."},aggregation_status:{label:"Telemetry Aggregation",description:"Get notified when async aggregation succeeds or fails during off periods."},ha_offline:{label:"Home Assistant Offline",description:"Alert when the Home Assistant bridge cannot be reached."}},Q=()=>({telegram:{enabled:!1,config:{bot_token:"",chat_id:""}},discord:{enabled:!1,config:{webhook_url:""}}});function ge(){const r=J(),[o,i]=u.useState(null),[h,g]=u.useState(Q),[b,L]=u.useState(null),[R,q]=u.useState(null),[U,M]=u.useState(null),f=S({queryKey:["notification-channels"],queryFn:x.getChannels}),d=S({queryKey:["notification-alerts"],queryFn:x.getAlerts}),l=S({queryKey:["notification-logs"],queryFn:()=>x.getLogs(50),refetchInterval:3e4});u.useEffect(()=>{f.data&&g(()=>{var s;const t=Q();return(s=f.data)==null||s.forEach(n=>{const a=t[n.channel_type];a&&(t[n.channel_type]={enabled:n.enabled,config:Object.keys(a.config).reduce((m,I)=>{var D;const v=(D=n.config)==null?void 0:D[I];return m[I]=v==null?"":String(v),m},{})})}),t})},[f.data]);const y=E({mutationFn:x.upsertChannel,onSuccess:(t,s)=>{c("success",`${p(s.channel_type)} notifications saved`),r.invalidateQueries({queryKey:["notification-channels"]})},onError:t=>c("error",C(t)),onSettled:()=>L(null)}),w=E({mutationFn:x.testChannel,onSuccess:(t,s)=>c("success",`Test notification sent to ${p(s)}`),onError:t=>c("error",C(t)),onSettled:()=>q(null)}),B=E({mutationFn:({alertType:t,enabled:s})=>x.updateAlert(t,{enabled:s}),onSuccess:()=>r.invalidateQueries({queryKey:["notification-alerts"]}),onError:t=>c("error",C(t)),onSettled:()=>M(null)}),P=u.useMemo(()=>{const t=d.data??[];return t.length===0?t:t.sort((s,n)=>s.alert_type.localeCompare(n.alert_type))},[d.data]),H=l.data??[],c=(t,s)=>{i({tone:t,message:s}),window.setTimeout(()=>i(null),5e3)},C=t=>{var s;return t instanceof ee?((s=t.data)==null?void 0:s.detail)||t.message:t instanceof Error?t.message:"Something went wrong"},$=(t,s)=>{g(n=>({...n,[t]:{...n[t],enabled:s}}))},O=(t,s,n)=>{g(a=>({...a,[t]:{...a[t],config:{...a[t].config,[s]:n}}}))},W=t=>{const s=h[t.type];if(s){if(s.enabled){const n=t.fields.find(a=>{var m;return!((m=s.config[a.name])!=null&&m.trim())});if(n){c("error",`Please fill ${n.label} before enabling ${t.label}`);return}}L(t.type),y.mutate({channel_type:t.type,enabled:s.enabled,config:s.config})}},G=t=>{const s=h[t];if(!(s!=null&&s.enabled)){c("error",`${p(t)} channel must be enabled before testing`);return}q(t),w.mutate(t)},V=(t,s)=>{M(t.alert_type),B.mutate({alertType:t.alert_type,enabled:s})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-3 text-3xl font-semibold text-foreground",children:[e.jsx(X,{className:"h-8 w-8 text-blue-400"}),e.jsx("span",{children:"Notifications"})]}),e.jsx("p",{className:"text-base text-muted-foreground",children:"Manage Telegram and Discord delivery, toggle alert types, and review recent notification attempts."})]}),o&&e.jsx("div",{className:N("rounded-xl border px-4 py-3 text-sm",o.tone==="success"&&"border-emerald-500/40 bg-emerald-500/10 text-emerald-100",o.tone==="error"&&"border-red-500/40 bg-red-500/10 text-red-100",o.tone==="info"&&"border-blue-500/40 bg-blue-500/10 text-blue-100"),children:o.message}),e.jsxs(k,{className:"border-border/60 bg-muted/5",children:[e.jsx(_,{children:e.jsx(T,{className:"text-lg",children:"Notification Channels"})}),e.jsx(A,{className:"space-y-6",children:ne.map(t=>{const s=h[t.type],n=f.isLoading;return e.jsxs("div",{className:"rounded-2xl border border-border/70 bg-background/60 p-4",children:[e.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"text-lg font-semibold text-foreground",children:[t.emoji," ",t.label]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.description})]}),e.jsx(z,{checked:(s==null?void 0:s.enabled)??!1,disabled:n||y.isPending,onCheckedChange:a=>$(t.type,a)})]}),(s==null?void 0:s.enabled)&&e.jsxs("div",{className:"mt-4 space-y-4",children:[t.fields.map(a=>e.jsxs("div",{className:"space-y-2",children:[e.jsx(Y,{className:"text-sm text-muted-foreground",children:a.label}),e.jsx("input",{type:a.type||"text",value:s.config[a.name]??"",onChange:m=>O(t.type,a.name,m.target.value),className:"w-full rounded-lg border border-border/70 bg-background px-3 py-2 text-sm text-foreground focus:outline-none focus:ring-2 focus:ring-blue-500/40",placeholder:a.placeholder}),a.hint&&e.jsx("p",{className:"text-xs text-muted-foreground",children:a.hint})]},a.name)),e.jsxs("div",{className:"flex flex-wrap gap-2 pt-2",children:[e.jsxs(j,{onClick:()=>W(t),disabled:b===t.type&&y.isPending,children:[b===t.type&&y.isPending&&e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}),"Save configuration"]}),e.jsxs(j,{type:"button",variant:"secondary",onClick:()=>G(t.type),disabled:R===t.type&&w.isPending,children:[R===t.type&&w.isPending?e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(re,{className:"mr-2 h-4 w-4"}),"Send test"]})]})]})]},t.type)})})]}),e.jsxs(k,{className:"border-border/60 bg-muted/5",children:[e.jsx(_,{children:e.jsx(T,{className:"text-lg",children:"Alert Types"})}),e.jsxs(A,{className:"space-y-3",children:[d.isLoading&&e.jsx(oe,{count:4}),d.isError&&e.jsx(K,{message:"Failed to load alert configuration",onRetry:()=>d.refetch()}),!d.isLoading&&!d.isError&&P.length===0&&e.jsx("p",{className:"rounded-xl border border-dashed border-border/60 p-6 text-sm text-muted-foreground",children:"No alert definitions found. Ensure the backend seeded default alerts."}),P.map(t=>{const s=ae[t.alert_type]??{label:t.alert_type,description:"Custom alert"};return e.jsxs("div",{className:"flex flex-col gap-3 rounded-2xl border border-border/70 bg-background/60 p-4 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold text-foreground",children:s.label}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s.description})]}),e.jsx(z,{checked:t.enabled,disabled:U===t.alert_type&&B.isPending,onCheckedChange:n=>V(t,n)})]},t.alert_type)})]})]}),e.jsxs(k,{className:"border-border/60 bg-muted/5",children:[e.jsxs(_,{className:"flex flex-row items-center justify-between",children:[e.jsx(T,{className:"text-lg",children:"Recent Notifications"}),e.jsxs(j,{type:"button",variant:"ghost",size:"sm",onClick:()=>l.refetch(),disabled:l.isFetching,children:[l.isFetching?e.jsx(F,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(se,{className:"mr-2 h-4 w-4"}),"Refresh"]})]}),e.jsxs(A,{children:[l.isError&&e.jsx(K,{message:"Unable to load notification logs",onRetry:()=>l.refetch()}),!l.isError&&e.jsx("div",{className:"overflow-x-auto rounded-xl border border-border/70",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"bg-background/70 text-xs uppercase tracking-wide text-muted-foreground",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Time"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Channel"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Alert"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Message"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Status"})]})}),e.jsxs("tbody",{children:[H.length===0&&!l.isLoading&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"px-4 py-6 text-center text-muted-foreground",children:"No notifications sent yet."})}),l.isLoading&&e.jsx(le,{rows:3,columns:5}),!l.isLoading&&H.map(t=>e.jsxs("tr",{className:"border-t border-border/50 text-sm",children:[e.jsx("td",{className:"px-4 py-3 text-foreground",children:ce(t.timestamp)}),e.jsx("td",{className:"px-4 py-3",children:p(t.channel_type)}),e.jsx("td",{className:"px-4 py-3 text-muted-foreground",children:p(t.alert_type)}),e.jsxs("td",{className:"px-4 py-3 text-muted-foreground",children:[de(t.message,80),t.error&&e.jsxs("span",{className:"ml-2 text-xs text-red-300",children:["(",t.error,")"]})]}),e.jsx("td",{className:"px-4 py-3",children:e.jsx(ie,{success:t.success})})]},t.id))]})]})})]})]})]})}function z({checked:r,onCheckedChange:o,disabled:i}){return e.jsx("button",{type:"button",onClick:()=>!i&&o(!r),className:N("relative inline-flex h-7 w-12 items-center rounded-full border border-border/60 bg-gray-800 transition",r&&"border-blue-500 bg-blue-600/60",i&&"cursor-not-allowed opacity-50"),"aria-pressed":r,"aria-label":"Toggle",disabled:i,children:e.jsx("span",{className:N("inline-block h-5 w-5 rounded-full bg-white transition-all",r?"translate-x-6":"translate-x-1")})})}function oe({count:r}){return e.jsx("div",{className:"space-y-3",children:Array.from({length:r}).map((o,i)=>e.jsx("div",{className:"h-14 animate-pulse rounded-2xl bg-muted/20"},i))})}function le({rows:r,columns:o}){return e.jsx(e.Fragment,{children:Array.from({length:r}).map((i,h)=>e.jsx("tr",{className:"border-t border-border/50",children:Array.from({length:o}).map((g,b)=>e.jsx("td",{className:"px-4 py-3",children:e.jsx("div",{className:"h-4 w-full animate-pulse rounded bg-muted/20"})},b))},h))})}function K({message:r,onRetry:o}){return e.jsxs("div",{className:"flex items-center justify-between rounded-xl border border-red-500/40 bg-red-500/10 px-4 py-3 text-sm text-red-100",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(te,{className:"h-4 w-4"}),e.jsx("span",{children:r})]}),e.jsx(j,{size:"sm",variant:"secondary",onClick:o,children:"Retry"})]})}function ie({success:r}){return e.jsx("span",{className:N("inline-flex items-center rounded-full px-3 py-1 text-xs font-semibold uppercase",r?"bg-emerald-500/20 text-emerald-200":"bg-red-500/20 text-red-200"),children:r?"Sent":"Failed"})}function de(r,o){return r.length<=o?r:`${r.slice(0,o)}â€¦`}function ce(r){const o=new Date(r);return Number.isNaN(o.getTime())?r:o.toLocaleString()}export{ge as default};
