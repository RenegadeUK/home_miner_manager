{% extends "base.html" %}

{% block title %}Backup & Restore{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <a href="/">Dashboard</a>
    <span>/</span>
    <a href="/settings">Settings</a>
    <span>/</span>
    <span>Backup & Restore</span>
</nav>
{% endblock %}

{% block content %}
<div class="backup-container">
    <h1>üóÑÔ∏è Backup & Restore</h1>
    <p class="subtitle">Export your configuration for disaster recovery or migration</p>

    <!-- System Info -->
    <div class="info-card">
        <h3>üìä Current System Data</h3>
        <div id="systemInfo" class="system-stats">
            <div class="stat-loading">Loading system information...</div>
        </div>
        <button onclick="loadSystemInfo()" class="btn-secondary">
            <span class="icon">üîÑ</span> Refresh
        </button>
    </div>

    <!-- Backup Section -->
    <div class="section-card">
        <h2>üì§ Export Backup</h2>
        <p>Create a backup of your system configuration</p>

        <div class="backup-options">
            <div class="backup-option">
                <div class="option-header">
                    <span class="icon">üìã</span>
                    <h3>Standard Backup</h3>
                </div>
                <p>Export configuration only (miners, pools, automation, profiles, dashboards)</p>
                <ul class="feature-list">
                    <li>‚úÖ All system settings</li>
                    <li>‚úÖ Small file size (~50KB)</li>
                    <li>‚úÖ Quick export</li>
                    <li>‚ùå No telemetry history</li>
                </ul>
                <button onclick="exportBackup('standard')" class="btn-primary">
                    <span class="icon">‚¨áÔ∏è</span> Export Standard Backup
                </button>
            </div>

            <div class="backup-option">
                <div class="option-header">
                    <span class="icon">üì¶</span>
                    <h3>Full Backup</h3>
                </div>
                <p>Export everything including recent telemetry and energy prices</p>
                <ul class="feature-list">
                    <li>‚úÖ All system settings</li>
                    <li>‚úÖ Energy prices (30 days)</li>
                    <li>‚úÖ Telemetry (7 days)</li>
                    <li>‚ö†Ô∏è Larger file size</li>
                </ul>
                <button onclick="exportBackup('full')" class="btn-primary">
                    <span class="icon">‚¨áÔ∏è</span> Export Full Backup (ZIP)
                </button>
            </div>
        </div>
    </div>

    <!-- Restore Section -->
    <div class="section-card danger-zone">
        <h2>üì• Restore Backup</h2>
        <p>Import a previously exported backup file</p>

        <div class="restore-options">
            <div class="restore-mode">
                <input type="radio" id="mode-merge" name="restore-mode" value="merge" checked>
                <label for="mode-merge">
                    <strong>Merge Mode (Safe)</strong>
                    <span class="mode-desc">Add new items and update existing ones. Preserves data not in backup.</span>
                </label>
            </div>

            <div class="restore-mode">
                <input type="radio" id="mode-replace" name="restore-mode" value="replace">
                <label for="mode-replace">
                    <strong>Replace Mode (Destructive)</strong>
                    <span class="mode-desc">‚ö†Ô∏è Delete all existing data and import backup. Cannot be undone!</span>
                </label>
            </div>
        </div>

        <div class="file-upload-area">
            <input type="file" id="backupFile" accept=".json" style="display: none;" onchange="handleFileSelect(event)">
            <div id="dropZone" class="drop-zone" onclick="document.getElementById('backupFile').click()">
                <span class="icon">üìÅ</span>
                <p><strong>Click to select backup file</strong></p>
                <p class="hint">or drag and drop here</p>
                <p class="file-types">Supports: .json files</p>
            </div>
            <div id="selectedFile" class="selected-file" style="display: none;"></div>
        </div>

        <button id="restoreBtn" onclick="restoreBackup()" class="btn-danger" disabled>
            <span class="icon">‚ö†Ô∏è</span> Restore Backup
        </button>
    </div>

    <!-- Best Practices -->
    <div class="info-card">
        <h3>üí° Best Practices</h3>
        <ul class="tips-list">
            <li><strong>Regular Backups:</strong> Export a backup weekly or before major changes</li>
            <li><strong>Test Restores:</strong> Verify your backups can be restored successfully</li>
            <li><strong>Store Securely:</strong> Keep backups in a safe location (external drive, cloud storage)</li>
            <li><strong>Version Control:</strong> Keep multiple backup versions dated by timestamp</li>
            <li><strong>Before Restore:</strong> Always export a current backup before restoring an old one</li>
        </ul>
    </div>
</div>

<style>
.backup-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.subtitle {
    color: var(--text-secondary, #666);
    margin-bottom: 2rem;
}

.info-card {
    background: var(--card-bg, #fff);
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.section-card {
    background: var(--card-bg, #fff);
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 8px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.danger-zone {
    border-color: var(--warning-color, #ffc107);
    background: var(--card-bg, #fff);
    border-width: 2px;
}

.system-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin: 1rem 0;
}

.stat-item {
    padding: 1rem;
    background: var(--bg-secondary, #f5f5f5);
    border-radius: 6px;
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--primary-color, #3b82f6);
}

.stat-label {
    font-size: 0.85rem;
    color: var(--text-secondary, #666);
    margin-top: 0.25rem;
}

.backup-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.backup-option {
    border: 2px solid var(--border-color, #e0e0e0);
    border-radius: 8px;
    padding: 1.5rem;
    transition: border-color 0.3s;
}

.backup-option:hover {
    border-color: var(--primary-color, #3b82f6);
}

.option-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.option-header .icon {
    font-size: 1.5rem;
}

.feature-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0;
}

.feature-list li {
    padding: 0.5rem 0;
    font-size: 0.9rem;
}

.restore-options {
    margin: 1.5rem 0;
}

.restore-mode {
    margin-bottom: 1rem;
}

.restore-mode label {
    display: block;
    padding: 1rem;
    border: 2px solid var(--border-color, #e0e0e0);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s;
    background: var(--card-bg, #fff);
    color: var(--text-primary, #333);
}

.restore-mode input[type="radio"] {
    margin-right: 0.5rem;
}

.restore-mode input[type="radio"]:checked + label {
    border-color: var(--primary-color, #3b82f6);
    background: var(--primary-bg-light, rgba(59, 130, 246, 0.1));
}

.mode-desc {
    display: block;
    font-size: 0.85rem;
    color: var(--text-secondary, #666);
    margin-top: 0.25rem;
}

.drop-zone {
    border: 3px dashed var(--border-color, #ccc);
    border-radius: 8px;
    padding: 3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    margin: 1rem 0;
}

.drop-zone:hover {
    border-color: var(--primary-color, #3b82f6);
    background: rgba(59, 130, 246, 0.05);
}

.drop-zone .icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
}

.drop-zone .hint {
    color: var(--text-secondary, #666);
    font-size: 0.9rem;
}

.file-types {
    font-size: 0.8rem;
    color: var(--text-secondary, #999);
    margin-top: 0.5rem;
}

.selected-file {
    padding: 1rem;
    background: var(--bg-secondary, #f5f5f5);
    border-radius: 6px;
    margin: 1rem 0;
}

.tips-list {
    list-style: none;
    padding: 0;
}

.tips-list li {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--border-color, #e0e0e0);
}

.tips-list li:last-child {
    border-bottom: none;
}

.btn-primary, .btn-secondary, .btn-danger {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.btn-primary {
    background: var(--primary-color, #3b82f6);
    color: white;
    width: 100%;
    justify-content: center;
    margin-top: 1rem;
}

.btn-primary:hover:not(:disabled) {
    background: #2563eb;
}

.btn-secondary {
    background: var(--bg-secondary, #f5f5f5);
    color: var(--text-primary, #333);
}

.btn-secondary:hover {
    background: #e0e0e0;
}

.btn-danger {
    background: #dc2626;
    color: white;
    width: 100%;
    justify-content: center;
    margin-top: 1rem;
}

.btn-danger:hover:not(:disabled) {
    background: #b91c1c;
}

.btn-danger:disabled {
    background: #ccc;
    cursor: not-allowed;
}

.stat-loading {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary, #666);
}
</style>

<script>
let selectedBackupFile = null;

// Load system info on page load
document.addEventListener('DOMContentLoaded', () => {
    loadSystemInfo();
    setupDragDrop();
});

async function loadSystemInfo() {
    try {
        const response = await fetch('/api/backup/info');
        const data = await response.json();
        
        const statsHtml = Object.entries(data.record_counts)
            .map(([key, value]) => `
                <div class="stat-item">
                    <div class="stat-value">${value.toLocaleString()}</div>
                    <div class="stat-label">${formatLabel(key)}</div>
                </div>
            `).join('');
        
        document.getElementById('systemInfo').innerHTML = statsHtml;
    } catch (error) {
        console.error('Failed to load system info:', error);
        document.getElementById('systemInfo').innerHTML = '<div class="stat-loading">‚ùå Failed to load system info</div>';
    }
}

function formatLabel(key) {
    return key.replace(/_/g, ' ')
        .split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

async function exportBackup(type) {
    try {
        const endpoint = type === 'full' ? '/api/backup/export-full' : '/api/backup/export';
        const response = await fetch(endpoint);
        
        if (!response.ok) throw new Error('Export failed');
        
        // Get filename from Content-Disposition header
        const contentDisposition = response.headers.get('Content-Disposition');
        const filename = contentDisposition?.match(/filename=(.+)/)?.[1] || 
                        `backup_${Date.now()}.${type === 'full' ? 'zip' : 'json'}`;
        
        // Download file
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showToast(`‚úÖ Backup exported successfully: ${filename}`, 'success');
    } catch (error) {
        console.error('Export failed:', error);
        showToast('‚ùå Failed to export backup', 'error');
    }
}

function setupDragDrop() {
    const dropZone = document.getElementById('dropZone');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.style.borderColor = 'var(--primary-color, #3b82f6)';
            dropZone.style.background = 'rgba(59, 130, 246, 0.1)';
        });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, () => {
            dropZone.style.borderColor = '';
            dropZone.style.background = '';
        });
    });
    
    dropZone.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    });
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        handleFile(file);
    }
}

function handleFile(file) {
    if (!file.name.endsWith('.json')) {
        showToast('‚ö†Ô∏è Please select a JSON backup file', 'warning');
        return;
    }
    
    selectedBackupFile = file;
    document.getElementById('selectedFile').innerHTML = `
        <strong>üìÑ Selected file:</strong> ${file.name} (${formatFileSize(file.size)})
    `;
    document.getElementById('selectedFile').style.display = 'block';
    document.getElementById('restoreBtn').disabled = false;
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

async function restoreBackup() {
    if (!selectedBackupFile) {
        showToast('‚ö†Ô∏è Please select a backup file first', 'warning');
        return;
    }
    
    const mode = document.querySelector('input[name="restore-mode"]:checked').value;
    
    // Confirm destructive operation
    if (mode === 'replace') {
        const confirmed = confirm(
            '‚ö†Ô∏è WARNING: Replace mode will DELETE ALL existing data!\n\n' +
            'This action cannot be undone. Make sure you have a current backup.\n\n' +
            'Continue with restore?'
        );
        if (!confirmed) return;
    }
    
    try {
        const formData = new FormData();
        formData.append('file', selectedBackupFile);
        
        const response = await fetch(`/api/backup/restore?mode=${mode}`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showToast(`‚úÖ Restore completed successfully!`, 'success');
            
            // Show import summary
            const summary = Object.entries(result.imported_counts)
                .map(([key, value]) => `${formatLabel(key)}: ${value}`)
                .join('\n');
            
            alert(`Restore Complete!\n\nImported:\n${summary}`);
            
            // Reload system info
            loadSystemInfo();
            
            // Clear selection
            selectedBackupFile = null;
            document.getElementById('selectedFile').style.display = 'none';
            document.getElementById('restoreBtn').disabled = true;
            document.getElementById('backupFile').value = '';
        } else {
            throw new Error(result.detail || 'Restore failed');
        }
    } catch (error) {
        console.error('Restore failed:', error);
        showToast(`‚ùå Restore failed: ${error.message}`, 'error');
    }
}

function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 5000);
}
</script>
{% endblock %}
