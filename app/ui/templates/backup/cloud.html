{% extends "base.html" %}

{% block title %}Cloud Backup{% endblock %}

{% block breadcrumb %}
<nav class="breadcrumb">
    <a href="/">Dashboard</a>
    <span>/</span>
    <a href="/settings">Settings</a>
    <span>/</span>
    <a href="/settings/backup">Backup & Restore</a>
    <span>/</span>
    <span>Cloud Backup</span>
</nav>
{% endblock %}

{% block content %}
<div class="cloud-backup-container">
    <h1>‚òÅÔ∏è Cloud Backup Configuration</h1>
    <p class="subtitle">Automatically backup your configuration to cloud storage</p>

    <!-- Provider Cards -->
    <div class="providers-grid">
        <!-- Google Drive -->
        <div class="provider-card" data-provider="google_drive">
            <div class="provider-header">
                <div class="provider-icon">üìä</div>
                <div class="provider-info">
                    <h3>Google Drive</h3>
                    <span class="provider-status" id="status-google_drive">Not Configured</span>
                </div>
                <div class="provider-toggle">
                    <label class="switch">
                        <input type="checkbox" id="enabled-google_drive" onchange="toggleProvider('google_drive')">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="provider-body">
                <button onclick="configureProvider('google_drive')" class="btn-secondary">
                    <span class="icon">‚öôÔ∏è</span> Configure
                </button>
                <button onclick="testProvider('google_drive')" class="btn-secondary" id="test-google_drive" disabled>
                    <span class="icon">üîç</span> Test
                </button>
                <button onclick="backupNow('google_drive')" class="btn-primary" id="backup-google_drive" disabled>
                    <span class="icon">üì§</span> Backup Now
                </button>
            </div>
            <div class="provider-schedule" id="schedule-google_drive" style="display: none;">
                <div class="schedule-info">
                    <strong>Schedule:</strong> <span id="schedule-desc-google_drive">Not scheduled</span>
                </div>
                <div class="schedule-info">
                    <strong>Last Backup:</strong> <span id="last-backup-google_drive">Never</span>
                </div>
            </div>
        </div>

        <!-- OneDrive -->
        <div class="provider-card" data-provider="onedrive">
            <div class="provider-header">
                <div class="provider-icon">üìÅ</div>
                <div class="provider-info">
                    <h3>OneDrive</h3>
                    <span class="provider-status" id="status-onedrive">Not Configured</span>
                </div>
                <div class="provider-toggle">
                    <label class="switch">
                        <input type="checkbox" id="enabled-onedrive" onchange="toggleProvider('onedrive')">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="provider-body">
                <button onclick="configureProvider('onedrive')" class="btn-secondary">
                    <span class="icon">‚öôÔ∏è</span> Configure
                </button>
                <button onclick="testProvider('onedrive')" class="btn-secondary" id="test-onedrive" disabled>
                    <span class="icon">üîç</span> Test
                </button>
                <button onclick="backupNow('onedrive')" class="btn-primary" id="backup-onedrive" disabled>
                    <span class="icon">üì§</span> Backup Now
                </button>
            </div>
            <div class="provider-schedule" id="schedule-onedrive" style="display: none;">
                <div class="schedule-info">
                    <strong>Schedule:</strong> <span id="schedule-desc-onedrive">Not scheduled</span>
                </div>
                <div class="schedule-info">
                    <strong>Last Backup:</strong> <span id="last-backup-onedrive">Never</span>
                </div>
            </div>
        </div>

        <!-- iCloud -->
        <div class="provider-card" data-provider="icloud">
            <div class="provider-header">
                <div class="provider-icon">‚òÅÔ∏è</div>
                <div class="provider-info">
                    <h3>iCloud Drive</h3>
                    <span class="provider-status" id="status-icloud">Not Configured</span>
                </div>
                <div class="provider-toggle">
                    <label class="switch">
                        <input type="checkbox" id="enabled-icloud" onchange="toggleProvider('icloud')">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="provider-body">
                <button onclick="configureProvider('icloud')" class="btn-secondary">
                    <span class="icon">‚öôÔ∏è</span> Configure
                </button>
                <button onclick="testProvider('icloud')" class="btn-secondary" id="test-icloud" disabled>
                    <span class="icon">üîç</span> Test
                </button>
                <button onclick="backupNow('icloud')" class="btn-primary" id="backup-icloud" disabled>
                    <span class="icon">üì§</span> Backup Now
                </button>
            </div>
            <div class="provider-schedule" id="schedule-icloud" style="display: none;">
                <div class="schedule-info">
                    <strong>Schedule:</strong> <span id="schedule-desc-icloud">Not scheduled</span>
                </div>
                <div class="schedule-info">
                    <strong>Last Backup:</strong> <span id="last-backup-icloud">Never</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Backup History -->
    <div class="section-card">
        <h2>üìã Backup History</h2>
        <div id="backupHistory" class="backup-history">
            <div class="loading">Loading backup history...</div>
        </div>
    </div>
</div>

<!-- Configuration Modal -->
<div id="configModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Configure Provider</h2>
            <span class="close" onclick="closeConfigModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="configForm" onsubmit="event.preventDefault(); saveConfig();">
                <input type="hidden" id="currentProvider">
                
                <!-- Provider-specific fields will be inserted here -->
                <div id="providerFields"></div>

                <!-- Schedule Settings -->
                <div class="form-section">
                    <h3>üìÖ Backup Schedule</h3>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="scheduleEnabled">
                            Enable Scheduled Backups
                        </label>
                    </div>

                    <div id="scheduleFields" style="display: none;">
                        <div class="form-group">
                            <label for="scheduleFrequency">Frequency:</label>
                            <select id="scheduleFrequency" onchange="updateScheduleFields()">
                                <option value="hourly">Hourly</option>
                                <option value="daily" selected>Daily</option>
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>

                        <div class="form-group" id="scheduleTimeGroup">
                            <label for="scheduleTime">Time (UTC):</label>
                            <input type="time" id="scheduleTime" value="02:00">
                        </div>

                        <div class="form-group" id="scheduleDayGroup" style="display: none;">
                            <label for="scheduleDay">Day:</label>
                            <select id="scheduleDay">
                                <option value="0">Monday</option>
                                <option value="1">Tuesday</option>
                                <option value="2">Wednesday</option>
                                <option value="3">Thursday</option>
                                <option value="4">Friday</option>
                                <option value="5">Saturday</option>
                                <option value="6">Sunday</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="backupType">Backup Type:</label>
                            <select id="backupType">
                                <option value="standard" selected>Standard (Configuration Only)</option>
                                <option value="full">Full (Include Telemetry)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="retentionDays">Retention (days):</label>
                            <input type="number" id="retentionDays" min="1" max="365" value="30">
                            <small>Keep backups for this many days</small>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" onclick="closeConfigModal()" class="btn-secondary">Cancel</button>
                    <button type="submit" class="btn-primary">Save Configuration</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.cloud-backup-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

.subtitle {
    color: var(--text-secondary, #666);
    margin-bottom: 2rem;
}

.providers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.provider-card {
    background: var(--card-bg, #fff);
    border: 2px solid var(--border-color, #e0e0e0);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s;
}

.provider-card.enabled {
    border-color: var(--primary-color, #3b82f6);
}

.provider-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.provider-icon {
    font-size: 2.5rem;
}

.provider-info {
    flex: 1;
}

.provider-info h3 {
    margin: 0 0 0.25rem 0;
    color: var(--text-primary, #333);
}

.provider-status {
    font-size: 0.85rem;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    background: var(--bg-secondary, #f5f5f5);
    color: var(--text-secondary, #666);
}

.provider-status.configured {
    background: #dcfce7;
    color: #166534;
}

.provider-status.enabled {
    background: #dbeafe;
    color: #1e40af;
}

.provider-toggle {
    margin-left: auto;
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-secondary, #ccc);
    transition: .4s;
    border-radius: 28px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--primary-color, #3b82f6);
}

input:checked + .slider:before {
    transform: translateX(22px);
}

.provider-body {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
}

.provider-schedule {
    border-top: 1px solid var(--border-color, #e0e0e0);
    padding-top: 1rem;
    margin-top: 1rem;
}

.schedule-info {
    padding: 0.5rem 0;
    font-size: 0.9rem;
    color: var(--text-primary, #333);
}

.section-card {
    background: var(--card-bg, #fff);
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 12px;
    padding: 2rem;
}

.backup-history {
    max-height: 400px;
    overflow-y: auto;
}

.history-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-bottom: 1px solid var(--border-color, #e0e0e0);
}

.history-item:last-child {
    border-bottom: none;
}

.history-status {
    font-size: 1.5rem;
}

.history-status.success {
    color: #10b981;
}

.history-status.failed {
    color: #ef4444;
}

.history-details {
    flex: 1;
}

.history-provider {
    font-weight: 600;
    color: var(--text-primary, #333);
}

.history-meta {
    font-size: 0.85rem;
    color: var(--text-secondary, #666);
    margin-top: 0.25rem;
}

.btn-primary, .btn-secondary {
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s;
}

.btn-primary {
    background: var(--primary-color, #3b82f6);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: #2563eb;
}

.btn-primary:disabled {
    background: var(--bg-secondary, #ccc);
    cursor: not-allowed;
    opacity: 0.6;
}

.btn-secondary {
    background: var(--bg-secondary, #f5f5f5);
    color: var(--text-primary, #333);
}

.btn-secondary:hover:not(:disabled) {
    background: #e5e7eb;
}

.btn-secondary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal.show {
    display: block;
}

.modal-content {
    background-color: var(--card-bg, #fff);
    margin: 5% auto;
    padding: 0;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color, #e0e0e0);
}

.modal-header h2 {
    margin: 0;
    color: var(--text-primary, #333);
}

.close {
    color: var(--text-secondary, #999);
    font-size: 2rem;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
}

.close:hover {
    color: var(--text-primary, #333);
}

.modal-body {
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1.5rem;
    border-top: 1px solid var(--border-color, #e0e0e0);
}

.form-section {
    margin-bottom: 2rem;
}

.form-section h3 {
    margin: 0 0 1rem 0;
    color: var(--text-primary, #333);
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary, #333);
}

.form-group input[type="text"],
.form-group input[type="password"],
.form-group input[type="time"],
.form-group input[type="number"],
.form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-color, #e0e0e0);
    border-radius: 6px;
    background: var(--card-bg, #fff);
    color: var(--text-primary, #333);
    font-size: 1rem;
}

.form-group small {
    display: block;
    margin-top: 0.25rem;
    font-size: 0.85rem;
    color: var(--text-secondary, #666);
}

.loading {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary, #666);
}
</style>

<script>
let providers = {};

document.addEventListener('DOMContentLoaded', () => {
    loadProviders();
    loadBackupHistory();
});

async function loadProviders() {
    try {
        const response = await fetch('/api/backup/cloud/providers');
        const data = await response.json();
        
        providers = {};
        data.forEach(provider => {
            providers[provider.provider] = provider;
            updateProviderCard(provider);
        });
    } catch (error) {
        console.error('Failed to load providers:', error);
    }
}

function updateProviderCard(provider) {
    const statusEl = document.getElementById(`status-${provider.provider}`);
    const enabledCheckbox = document.getElementById(`enabled-${provider.provider}`);
    const testBtn = document.getElementById(`test-${provider.provider}`);
    const backupBtn = document.getElementById(`backup-${provider.provider}`);
    const scheduleDiv = document.getElementById(`schedule-${provider.provider}`);
    const card = document.querySelector(`[data-provider="${provider.provider}"]`);
    
    // Update status
    if (provider.enabled) {
        statusEl.textContent = 'Enabled';
        statusEl.className = 'provider-status enabled';
        card.classList.add('enabled');
    } else {
        statusEl.textContent = 'Configured';
        statusEl.className = 'provider-status configured';
        card.classList.remove('enabled');
    }
    
    // Update toggle
    enabledCheckbox.checked = provider.enabled;
    
    // Enable buttons
    testBtn.disabled = false;
    backupBtn.disabled = !provider.enabled;
    
    // Show schedule info
    if (provider.schedule_enabled) {
        scheduleDiv.style.display = 'block';
        
        let scheduleDesc = formatSchedule(provider);
        document.getElementById(`schedule-desc-${provider.provider}`).textContent = scheduleDesc;
        
        if (provider.last_backup) {
            const lastBackup = new Date(provider.last_backup);
            const status = provider.last_backup_status === 'success' ? '‚úÖ' : '‚ùå';
            document.getElementById(`last-backup-${provider.provider}`).textContent = 
                `${status} ${lastBackup.toLocaleString()}`;
        } else {
            document.getElementById(`last-backup-${provider.provider}`).textContent = 'Never';
        }
    } else {
        scheduleDiv.style.display = 'none';
    }
}

function formatSchedule(provider) {
    const freq = provider.schedule_frequency;
    const time = provider.schedule_time;
    const day = provider.schedule_day;
    
    if (freq === 'hourly') {
        return 'Every hour';
    } else if (freq === 'daily') {
        return `Daily at ${time} UTC`;
    } else if (freq === 'weekly') {
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        return `Weekly on ${days[day]} at ${time} UTC`;
    } else if (freq === 'monthly') {
        return `Monthly on day ${day} at ${time} UTC`;
    }
    return 'Not scheduled';
}

async function toggleProvider(providerName) {
    const checkbox = document.getElementById(`enabled-${providerName}`);
    const provider = providers[providerName];
    
    if (!provider) {
        showToast('‚ö†Ô∏è Provider not configured yet', 'warning');
        checkbox.checked = false;
        return;
    }
    
    try {
        const response = await fetch('/api/backup/cloud/providers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                provider: providerName,
                enabled: checkbox.checked,
                credentials: provider.config || {},
                schedule_enabled: provider.schedule_enabled,
                schedule_frequency: provider.schedule_frequency,
                schedule_time: provider.schedule_time,
                schedule_day: provider.schedule_day,
                backup_type: provider.backup_type,
                retention_days: provider.retention_days
            })
        });
        
        if (response.ok) {
            showToast(`‚úÖ ${providerName} ${checkbox.checked ? 'enabled' : 'disabled'}`, 'success');
            await loadProviders();
        } else {
            throw new Error('Failed to toggle provider');
        }
    } catch (error) {
        console.error('Error toggling provider:', error);
        showToast('‚ùå Failed to update provider', 'error');
        checkbox.checked = !checkbox.checked;
    }
}

function configureProvider(providerName) {
    const provider = providers[providerName] || {
        provider: providerName,
        enabled: false,
        schedule_enabled: false,
        schedule_frequency: 'daily',
        schedule_time: '02:00',
        backup_type: 'standard',
        retention_days: 30,
        config: {}
    };
    
    document.getElementById('currentProvider').value = providerName;
    document.getElementById('modalTitle').textContent = `Configure ${formatProviderName(providerName)}`;
    
    // Build provider-specific fields
    const fieldsHtml = getProviderFields(providerName, provider.config);
    document.getElementById('providerFields').innerHTML = fieldsHtml;
    
    // Set schedule fields
    document.getElementById('scheduleEnabled').checked = provider.schedule_enabled;
    document.getElementById('scheduleFrequency').value = provider.schedule_frequency;
    document.getElementById('scheduleTime').value = provider.schedule_time || '02:00';
    document.getElementById('scheduleDay').value = provider.schedule_day || 0;
    document.getElementById('backupType').value = provider.backup_type;
    document.getElementById('retentionDays').value = provider.retention_days;
    
    document.getElementById('scheduleFields').style.display = provider.schedule_enabled ? 'block' : 'none';
    updateScheduleFields();
    
    document.getElementById('configModal').classList.add('show');
    
    // Add schedule enabled toggle listener
    document.getElementById('scheduleEnabled').onchange = function() {
        document.getElementById('scheduleFields').style.display = this.checked ? 'block' : 'none';
    };
}

function getProviderFields(providerName, config) {
    if (providerName === 'google_drive') {
        return `
            <div class="form-section">
                <h3>üîê Google Drive Credentials</h3>
                <div class="form-group">
                    <label for="access_token">OAuth2 Access Token:</label>
                    <input type="password" id="access_token" value="${config.access_token || ''}" required>
                    <small>Get from <a href="https://developers.google.com/oauthplayground" target="_blank">OAuth Playground</a></small>
                </div>
                <div class="form-group">
                    <label for="folder_id">Folder ID (optional):</label>
                    <input type="text" id="folder_id" value="${config.folder_id || ''}">
                    <small>Leave empty to save to root directory</small>
                </div>
            </div>
        `;
    } else if (providerName === 'onedrive') {
        return `
            <div class="form-section">
                <h3>üîê OneDrive Credentials</h3>
                <div class="form-group">
                    <label for="access_token">OAuth2 Access Token:</label>
                    <input type="password" id="access_token" value="${config.access_token || ''}" required>
                    <small>Get from Microsoft Azure AD</small>
                </div>
                <div class="form-group">
                    <label for="folder_path">Folder Path:</label>
                    <input type="text" id="folder_path" value="${config.folder_path || 'Backups'}">
                    <small>Path within OneDrive (e.g., Backups/MinerController)</small>
                </div>
            </div>
        `;
    } else if (providerName === 'icloud') {
        return `
            <div class="form-section">
                <h3>üîê iCloud Credentials</h3>
                <div class="form-group">
                    <label for="apple_id">Apple ID:</label>
                    <input type="text" id="apple_id" value="${config.apple_id || ''}" required>
                </div>
                <div class="form-group">
                    <label for="app_password">App-Specific Password:</label>
                    <input type="password" id="app_password" value="${config.app_password || ''}" required>
                    <small>Generate at <a href="https://appleid.apple.com" target="_blank">appleid.apple.com</a></small>
                </div>
                <div class="form-group">
                    <label for="folder_path">Folder Path:</label>
                    <input type="text" id="folder_path" value="${config.folder_path || 'MinerBackups'}">
                </div>
            </div>
        `;
    }
    return '';
}

function formatProviderName(provider) {
    const names = {
        'google_drive': 'Google Drive',
        'onedrive': 'OneDrive',
        'icloud': 'iCloud Drive'
    };
    return names[provider] || provider;
}

function updateScheduleFields() {
    const frequency = document.getElementById('scheduleFrequency').value;
    const timeGroup = document.getElementById('scheduleTimeGroup');
    const dayGroup = document.getElementById('scheduleDayGroup');
    const daySelect = document.getElementById('scheduleDay');
    
    if (frequency === 'hourly') {
        timeGroup.style.display = 'none';
        dayGroup.style.display = 'none';
    } else if (frequency === 'daily') {
        timeGroup.style.display = 'block';
        dayGroup.style.display = 'none';
    } else if (frequency === 'weekly') {
        timeGroup.style.display = 'block';
        dayGroup.style.display = 'block';
        daySelect.innerHTML = `
            <option value="0">Monday</option>
            <option value="1">Tuesday</option>
            <option value="2">Wednesday</option>
            <option value="3">Thursday</option>
            <option value="4">Friday</option>
            <option value="5">Saturday</option>
            <option value="6">Sunday</option>
        `;
    } else if (frequency === 'monthly') {
        timeGroup.style.display = 'block';
        dayGroup.style.display = 'block';
        daySelect.innerHTML = '';
        for (let i = 1; i <= 31; i++) {
            daySelect.innerHTML += `<option value="${i}">${i}</option>`;
        }
    }
}

async function saveConfig() {
    const providerName = document.getElementById('currentProvider').value;
    
    // Get provider-specific credentials
    const credentials = {};
    const fieldIds = {
        'google_drive': ['access_token', 'folder_id'],
        'onedrive': ['access_token', 'folder_path'],
        'icloud': ['apple_id', 'app_password', 'folder_path']
    };
    
    fieldIds[providerName].forEach(fieldId => {
        const value = document.getElementById(fieldId)?.value;
        if (value) credentials[fieldId] = value;
    });
    
    const config = {
        enabled: document.getElementById(`enabled-${providerName}`).checked,
        credentials: credentials,
        schedule_enabled: document.getElementById('scheduleEnabled').checked,
        schedule_frequency: document.getElementById('scheduleFrequency').value,
        schedule_time: document.getElementById('scheduleTime').value,
        schedule_day: parseInt(document.getElementById('scheduleDay').value) || null,
        backup_type: document.getElementById('backupType').value,
        retention_days: parseInt(document.getElementById('retentionDays').value)
    };
    
    try {
        const response = await fetch('/api/backup/cloud/providers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                provider: providerName,
                ...config
            })
        });
        
        if (response.ok) {
            showToast('‚úÖ Configuration saved successfully', 'success');
            closeConfigModal();
            await loadProviders();
        } else {
            throw new Error('Failed to save configuration');
        }
    } catch (error) {
        console.error('Error saving config:', error);
        showToast('‚ùå Failed to save configuration', 'error');
    }
}

function closeConfigModal() {
    document.getElementById('configModal').classList.remove('show');
}

async function testProvider(providerName) {
    const btn = document.getElementById(`test-${providerName}`);
    btn.disabled = true;
    btn.innerHTML = '<span class="icon">‚è≥</span> Testing...';
    
    try {
        const response = await fetch(`/api/backup/cloud/test/${providerName}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('‚úÖ Connection successful!', 'success');
        } else {
            showToast('‚ùå Connection failed', 'error');
        }
    } catch (error) {
        console.error('Test failed:', error);
        showToast('‚ùå Test failed', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="icon">üîç</span> Test';
    }
}

async function backupNow(providerName) {
    const btn = document.getElementById(`backup-${providerName}`);
    btn.disabled = true;
    btn.innerHTML = '<span class="icon">‚è≥</span> Backing up...';
    
    try {
        const provider = providers[providerName];
        const backupType = provider.backup_type || 'standard';
        
        const response = await fetch(`/api/backup/cloud/backup-now/${providerName}?backup_type=${backupType}`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(`‚úÖ Backup completed (${formatBytes(result.file_size)})`, 'success');
            await loadProviders();
            await loadBackupHistory();
        } else {
            showToast('‚ùå Backup failed', 'error');
        }
    } catch (error) {
        console.error('Backup failed:', error);
        showToast('‚ùå Backup failed', 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="icon">üì§</span> Backup Now';
    }
}

async function loadBackupHistory() {
    try {
        const response = await fetch('/api/backup/cloud/logs?limit=20');
        const logs = await response.json();
        
        const historyDiv = document.getElementById('backupHistory');
        
        if (logs.length === 0) {
            historyDiv.innerHTML = '<div class="loading">No backup history yet</div>';
            return;
        }
        
        historyDiv.innerHTML = logs.map(log => `
            <div class="history-item">
                <div class="history-status ${log.status}">
                    ${log.status === 'success' ? '‚úÖ' : '‚ùå'}
                </div>
                <div class="history-details">
                    <div class="history-provider">${formatProviderName(log.provider)}</div>
                    <div class="history-meta">
                        ${log.filename} ‚Ä¢ ${formatBytes(log.file_size)} ‚Ä¢ ${log.duration?.toFixed(2)}s
                        ${log.error_message ? `<br><span style="color: var(--error-color, #ef4444);">${log.error_message}</span>` : ''}
                    </div>
                </div>
                <div class="history-time">
                    ${new Date(log.timestamp).toLocaleString()}
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to load backup history:', error);
    }
}

function formatBytes(bytes) {
    if (!bytes) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10000;
        animation: slideIn 0.3s ease-out;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-out';
        setTimeout(() => document.body.removeChild(toast), 300);
    }, 5000);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('configModal');
    if (event.target === modal) {
        closeConfigModal();
    }
}
</script>
{% endblock %}
