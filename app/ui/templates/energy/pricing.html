{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Octopus Agile Pricing</h2>
    </div>
    
    <div class="form-group">
        <label class="form-label">Select Region</label>
        <select class="form-select" id="region">
            <option value="A">A - Eastern England</option>
            <option value="B">B - East Midlands</option>
            <option value="C">C - London</option>
            <option value="D">D - Merseyside and Northern Wales</option>
            <option value="E">E - West Midlands</option>
            <option value="F">F - North Eastern England</option>
            <option value="G">G - North Western England</option>
            <option value="H" selected>H - Southern England</option>
            <option value="J">J - South Eastern England</option>
            <option value="K">K - Southern Wales</option>
            <option value="L">L - South Western England</option>
            <option value="M">M - Yorkshire</option>
            <option value="N">N - Southern Scotland</option>
            <option value="P">P - Northern Scotland</option>
        </select>
    </div>
    
    <button class="btn btn-primary mt-4" onclick="saveRegion()">Save Region</button>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Current Price</h2>
        </div>
        <div id="current-price">
            <p class="text-muted">Loading...</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title">Next Price</h2>
        </div>
        <div id="next-price">
            <p class="text-muted">Loading...</p>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title" id="today-title">Today</h2>
        </div>
        <div id="today-prices">
            <p class="text-muted">Loading...</p>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 class="card-title" id="tomorrow-title">Tomorrow</h2>
        </div>
        <div id="tomorrow-prices">
            <p class="text-muted">Loading...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function loadPricing() {
    try {
        // Load config to get current region
        const configRes = await fetch('/api/dashboard/energy/config');
        const config = await configRes.json();
        
        // Set dropdown to current region
        const regionSelect = document.getElementById('region');
        if (regionSelect && config.region) {
            regionSelect.value = config.region;
        }
        
        // Load current price
        const currentRes = await fetch('/api/dashboard/energy/current');
        const current = await currentRes.json();
        
        document.getElementById('current-price').innerHTML = current.price_pence 
            ? `<div class="stat-value">${current.price_pence.toFixed(2)} p/kWh</div>
               <p class="text-muted">Valid until ${new Date(current.valid_to).toLocaleTimeString()}</p>`
            : '<p class="text-muted">No price data available</p>';
        
        // Load next price
        const nextRes = await fetch('/api/dashboard/energy/next');
        const next = await nextRes.json();
        
        document.getElementById('next-price').innerHTML = next.price_pence 
            ? `<div class="stat-value">${next.price_pence.toFixed(2)} p/kWh</div>
               <p class="text-muted">Starts at ${new Date(next.valid_from).toLocaleTimeString()}</p>`
            : '<p class="text-muted">No price data available</p>';
        
        // Load timeline
        const timelineRes = await fetch('/api/dashboard/energy/timeline');
        const timeline = await timelineRes.json();
        
        // Get current time
        const now = new Date();
        
        // Helper function to get color based on price
        function getPriceColor(price) {
            if (price < 0) return '#3b82f6'; // blue
            if (price < 20) return '#10b981'; // green
            if (price < 30) return '#f59e0b'; // orange
            return '#ef4444'; // red
        }
        
        // Helper function to create price table
        function createPriceTable(prices) {
            // Filter out past prices
            const futurePrices = prices.filter(p => new Date(p.valid_to) > now);
            
            if (futurePrices.length === 0) return '<p class="text-muted">No upcoming prices</p>';
            
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            
            // Process prices in pairs for 4-column layout
            for (let i = 0; i < futurePrices.length; i += 2) {
                const p1 = futurePrices[i];
                const time1 = new Date(p1.valid_from).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const color1 = getPriceColor(p1.price_pence);
                
                html += '<tr>';
                html += `<td style="padding: 0.5rem; border: 1px solid var(--border); font-weight: bold;">${time1}</td>`;
                html += `<td style="padding: 0.5rem; border: 1px solid var(--border); background-color: ${color1}; color: white; font-weight: bold;">${p1.price_pence.toFixed(2)} p</td>`;
                
                if (i + 1 < futurePrices.length) {
                    const p2 = futurePrices[i + 1];
                    const time2 = new Date(p2.valid_from).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                    const color2 = getPriceColor(p2.price_pence);
                    
                    html += `<td style="padding: 0.5rem; border: 1px solid var(--border); font-weight: bold;">${time2}</td>`;
                    html += `<td style="padding: 0.5rem; border: 1px solid var(--border); background-color: ${color2}; color: white; font-weight: bold;">${p2.price_pence.toFixed(2)} p</td>`;
                } else {
                    html += '<td colspan="2"></td>';
                }
                
                html += '</tr>';
            }
            
            html += '</table>';
            return html;
        }
        
        // Display today's prices
        const todayTitle = document.getElementById('today-title');
        const todayDiv = document.getElementById('today-prices');
        
        if (timeline.today && timeline.today.prices.length > 0) {
            todayTitle.textContent = `Today - ${timeline.today.date}`;
            todayDiv.innerHTML = createPriceTable(timeline.today.prices);
        } else {
            todayDiv.innerHTML = '<p class="text-muted">No pricing data available</p>';
        }
        
        // Display tomorrow's prices
        const tomorrowTitle = document.getElementById('tomorrow-title');
        const tomorrowDiv = document.getElementById('tomorrow-prices');
        
        if (timeline.tomorrow && timeline.tomorrow.prices.length > 0) {
            tomorrowTitle.textContent = `Tomorrow - ${timeline.tomorrow.date}`;
            tomorrowDiv.innerHTML = createPriceTable(timeline.tomorrow.prices);
        } else {
            tomorrowDiv.innerHTML = '<p class="text-muted">Tomorrow\'s prices not yet available</p>';
        }
    } catch (error) {
        console.error('Failed to load pricing:', error);
    }
}

async function saveRegion() {
    const region = document.getElementById('region').value;
    
    try {
        const response = await fetch(`/api/dashboard/energy/region?region=${region}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to save region');
        }
        
        alert('Region saved: ' + region + '\n\nFetching pricing data...');
        
        // Trigger immediate price fetch
        setTimeout(() => {
            loadPricing();
        }, 2000);
    } catch (error) {
        alert('Error saving region: ' + error.message);
    }
}

loadPricing();
setInterval(loadPricing, 60000); // Refresh every minute
</script>
{% endblock %}
