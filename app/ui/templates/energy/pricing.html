{% extends "base.html" %}

{% block extra_head %}
<style>
.pricing-container {
    max-width: 1400px;
    margin: 0 auto;
}

.detail-card {
    background: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    margin-bottom: 2rem;
}

.detail-card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem;
    background: #374151;
    border-bottom: 1px solid #4a5568;
}

.detail-card-icon {
    font-size: 2rem;
}

.detail-card-header h3 {
    flex: 1;
    margin: 0;
    font-size: 1.25rem;
    color: #f9fafb;
}

.detail-card-body {
    padding: 1.5rem;
}

.warning-banner {
    background: rgba(251, 191, 36, 0.15);
    border-left: 4px solid #fbbf24;
    padding: 1rem 1.25rem;
    border-radius: 6px;
    margin-bottom: 1.5rem;
}

.warning-banner-title {
    color: #fbbf24;
    font-weight: 700;
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
}

.warning-banner-text {
    color: #d1d5db;
    font-size: 0.875rem;
    margin: 0;
}

.status-row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
}

.status-label {
    font-weight: 600;
    color: #f9fafb;
}

.status-badge {
    padding: 0.375rem 0.875rem;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 700;
}

.form-row {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-weight: 600;
    color: #f9fafb;
    margin-bottom: 0.5rem;
}

.form-select {
    width: 100%;
    padding: 0.75rem;
    background: #1f2937;
    border: 1px solid #4a5568;
    border-radius: 6px;
    color: #f9fafb;
    font-size: 1rem;
}

.form-select:focus {
    outline: none;
    border-color: #3b82f6;
}

.button-row {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9375rem;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.price-card-content {
    padding: 1.5rem;
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: #3b82f6;
    margin-bottom: 0.5rem;
}

.text-muted {
    color: #9ca3af;
    font-size: 0.875rem;
}
</style>
{% endblock %}

{% block content %}
<div class="pricing-container">
    <!-- Configuration Card -->
    <div class="detail-card">
        <div class="detail-card-header">
            <div class="detail-card-icon">üá¨üáß üêô</div>
            <h3>Octopus Agile Pricing</h3>
        </div>
        <div class="detail-card-body">
            <div class="warning-banner">
                <p class="warning-banner-title">‚ö° UK Octopus Agile Customers Only</p>
                <p class="warning-banner-text">Half-hourly electricity prices from Octopus Energy's Agile tariff, updated automatically every 30 minutes.</p>
            </div>
            
            <div class="status-row">
                <span class="status-label">Status:</span>
                <span id="status-badge" class="status-badge"></span>
            </div>
            
            <div class="form-row">
                <label class="form-label">Select Region</label>
                <select class="form-select" id="region">
                    <option value="A">A - Eastern England</option>
                    <option value="B">B - East Midlands</option>
                    <option value="C">C - London</option>
                    <option value="D">D - Merseyside and Northern Wales</option>
                    <option value="E">E - West Midlands</option>
                    <option value="F">F - North Eastern England</option>
                    <option value="G">G - North Western England</option>
                    <option value="H" selected>H - Southern England</option>
                    <option value="J">J - South Eastern England</option>
                    <option value="K">K - Southern Wales</option>
                    <option value="L">L - South Western England</option>
                    <option value="M">M - Yorkshire</option>
                    <option value="N">N - Southern Scotland</option>
                    <option value="P">P - Northern Scotland</option>
                </select>
            </div>
            
            <div class="button-row">
                <button class="btn btn-primary" onclick="saveRegion()">Save Region</button>
                <button id="toggle-button" class="btn" onclick="toggleEnabled()">Loading...</button>
            </div>
        </div>
    </div>

    <!-- Current & Next Price -->
    <div class="pricing-grid">
        <div class="detail-card">
            <div class="detail-card-header">
                <div class="detail-card-icon">üí°</div>
                <h3>Current Price</h3>
            </div>
            <div class="price-card-content" id="current-price">
                <p class="text-muted">Loading...</p>
            </div>
        </div>

        <div class="detail-card">
            <div class="detail-card-header">
                <div class="detail-card-icon">‚è≠Ô∏è</div>
                <h3>Next Price</h3>
            </div>
            <div class="price-card-content" id="next-price">
                <p class="text-muted">Loading...</p>
            </div>
        </div>
    </div>

    <!-- Today's Prices -->
    <div class="detail-card">
        <div class="detail-card-header">
            <div class="detail-card-icon">üìÖ</div>
            <h3 id="today-title">Today</h3>
        </div>
        <div class="detail-card-body" id="today-prices">
            <p class="text-muted">Loading...</p>
        </div>
    </div>

    <!-- Tomorrow's Prices -->
    <div class="detail-card">
        <div class="detail-card-header">
            <div class="detail-card-icon">üìÜ</div>
            <h3 id="tomorrow-title">Tomorrow</h3>
        </div>
        <div class="detail-card-body" id="tomorrow-prices">
            <p class="text-muted">Loading...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function loadPricing() {
    try {
        // Load config to get current region
        const configRes = await fetch('/api/dashboard/energy/config');
        const config = await configRes.json();
        
        // Update status badge
        const statusBadge = document.getElementById('status-badge');
        const toggleButton = document.getElementById('toggle-button');
        
        if (config.enabled) {
            statusBadge.textContent = 'Enabled';
            statusBadge.style.background = '#10b981';
            statusBadge.style.color = '#ffffff';
            toggleButton.textContent = 'Disable';
            toggleButton.className = 'btn btn-danger';
        } else {
            statusBadge.textContent = 'Disabled';
            statusBadge.style.background = '#6b7280';
            statusBadge.style.color = '#ffffff';
            toggleButton.textContent = 'Enable';
            toggleButton.className = 'btn btn-success';
        }
        
        // Set dropdown to current region
        const regionSelect = document.getElementById('region');
        if (regionSelect && config.region) {
            regionSelect.value = config.region;
        }
        
        // Load current price
        const currentRes = await fetch('/api/dashboard/energy/current');
        const current = await currentRes.json();
        
        document.getElementById('current-price').innerHTML = current.price_pence 
            ? `<div class="stat-value">${current.price_pence.toFixed(2)} p/kWh</div>
               <p class="text-muted">Valid until ${new Date(current.valid_to).toLocaleTimeString()}</p>`
            : '<p class="text-muted">No price data available</p>';
        
        // Load next price
        const nextRes = await fetch('/api/dashboard/energy/next');
        const next = await nextRes.json();
        
        document.getElementById('next-price').innerHTML = next.price_pence 
            ? `<div class="stat-value">${next.price_pence.toFixed(2)} p/kWh</div>
               <p class="text-muted">Starts at ${new Date(next.valid_from).toLocaleTimeString()}</p>`
            : '<p class="text-muted">No price data available</p>';
        
        // Load timeline
        const timelineRes = await fetch('/api/dashboard/energy/timeline');
        const timeline = await timelineRes.json();
        
        // Get current time
        const now = new Date();
        
        // Helper function to get color based on price (green to red gradient)
        function getPriceColor(price) {
            if (price <= 0) return 'linear-gradient(135deg, #60a5fa, #3b82f6)'; // blue for 0 and negative
            if (price < 10) return 'linear-gradient(135deg, #10b981, #059669)'; // dark green
            if (price < 15) return 'linear-gradient(135deg, #34d399, #10b981)'; // green
            if (price < 20) return 'linear-gradient(135deg, #6ee7b7, #34d399)'; // light green
            if (price < 25) return 'linear-gradient(135deg, #fbbf24, #f59e0b)'; // yellow/amber
            if (price < 30) return 'linear-gradient(135deg, #fb923c, #f97316)'; // orange
            return 'linear-gradient(135deg, #f87171, #ef4444)'; // red
        }
        
        // Helper function to get text color based on price
        function getTextColor(price) {
            if (price < 20) return '#000000'; // black text for blue and green backgrounds
            return '#ffffff'; // white text for yellow/orange/red
        }
        
        // Helper function to create price table
        function createPriceTable(prices) {
            // Filter out past prices
            const futurePrices = prices.filter(p => new Date(p.valid_to) > now);
            
            if (futurePrices.length === 0) return '<p class="text-muted">No upcoming prices</p>';
            
            let html = '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem;">';
            
            // Simple 4-column grid with just colored price boxes
            for (let i = 0; i < futurePrices.length; i++) {
                const p = futurePrices[i];
                const date = new Date(p.valid_from);
                const dayName = date.toLocaleDateString('en-GB', { weekday: 'short' });
                const time = date.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                const color = getPriceColor(p.price_pence);
                const textColor = getTextColor(p.price_pence);
                
                html += `<div style="background: ${color}; color: ${textColor}; padding: 0.75rem; border-radius: 0.5rem; text-align: center;">`;
                html += `<div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">${dayName} ${time}</div>`;
                html += `<div style="font-size: 1.125rem; font-weight: 700;">${p.price_pence.toFixed(2)}p</div>`;
                html += `</div>`;
            }
            
            html += '</div>';
            return html;
        }
        
        // Display today's prices
        const todayTitle = document.getElementById('today-title');
        const todayDiv = document.getElementById('today-prices');
        
        if (timeline.today && timeline.today.prices.length > 0) {
            todayTitle.textContent = `Today - ${timeline.today.date}`;
            todayDiv.innerHTML = createPriceTable(timeline.today.prices);
        } else {
            todayDiv.innerHTML = '<p class="text-muted">No pricing data available</p>';
        }
        
        // Display tomorrow's prices
        const tomorrowTitle = document.getElementById('tomorrow-title');
        const tomorrowDiv = document.getElementById('tomorrow-prices');
        
        if (timeline.tomorrow && timeline.tomorrow.prices.length > 0) {
            tomorrowTitle.textContent = `Tomorrow - ${timeline.tomorrow.date}`;
            tomorrowDiv.innerHTML = createPriceTable(timeline.tomorrow.prices);
        } else {
            tomorrowDiv.innerHTML = '<p class="text-muted">Tomorrow\'s prices not yet available</p>';
        }
    } catch (error) {
        console.error('Failed to load pricing:', error);
    }
}

async function saveRegion() {
    const region = document.getElementById('region').value;
    
    try {
        const response = await fetch(`/api/dashboard/energy/region?region=${region}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to save region');
        }
        
        alert('Region saved: ' + region + '\n\nFetching pricing data...');
        
        // Trigger immediate price fetch
        setTimeout(() => {
            loadPricing();
        }, 2000);
    } catch (error) {
        alert('Error saving region: ' + error.message);
    }
}

async function toggleEnabled() {
    try {
        const configRes = await fetch('/api/dashboard/energy/config');
        const config = await configRes.json();
        const newState = !config.enabled;
        
        const response = await fetch(`/api/dashboard/energy/toggle?enabled=${newState}`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to toggle energy pricing');
        }
        
        alert(newState ? 'Energy pricing enabled' : 'Energy pricing disabled');
        loadPricing();
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

loadPricing();
setInterval(loadPricing, 60000); // Refresh every minute
</script>
{% endblock %}
