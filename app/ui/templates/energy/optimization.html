{% extends "base.html" %}

{% block extra_head %}
<style>
.optimization-container {
    max-width: 1600px;
    margin: 0 auto;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    margin-bottom: 2rem;
}

.detail-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    background: var(--card-header);
    border-bottom: 1px solid var(--border-color);
}

.detail-card-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.detail-card-header h3 {
    flex: 1;
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
}

.detail-card-body {
    padding: 1.5rem;
}

.header-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

#auto-status {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-box {
    background: var(--input-bg);
    padding: 1.5rem;
    border-radius: 8px;
    border: 1px solid #374151;
}

.stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 1.875rem;
    font-weight: 700;
    color: var(--text-primary);
}

.two-column-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
}

.info-banner {
    padding: 1rem;
    background: var(--input-bg);
    border-radius: 6px;
    border: 1px solid #374151;
    color: #d1d5db;
    font-size: 0.875rem;
}

.form-row {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.form-control {
    padding: 0.625rem;
    background: var(--input-bg);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.9375rem;
}

.form-control:focus {
    outline: none;
    border-color: #3b82f6;
}

.form-text {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.375rem;
}

.schedule-controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-bottom: 1rem;
}

.chart-legend {
    margin-top: 0.75rem;
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.table-container {
    max-height: 400px;
    overflow-y: auto;
    border-radius: 6px;
    border: 1px solid #374151;
}

#profitability-table {
    width: 100%;
    border-collapse: collapse;
}

#profitability-table thead {
    position: sticky;
    top: 0;
    background: var(--card-header);
    z-index: 1;
}

#profitability-table th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
}

#profitability-table td {
    padding: 0.75rem;
    font-size: 0.875rem;
    color: #d1d5db;
    border-bottom: 1px solid #374151;
}

.note-box {
    margin-top: 0.75rem;
    padding: 0.75rem;
    background: var(--input-bg);
    border-radius: 6px;
    font-size: 0.75rem;
    color: var(--text-secondary);
}

.note-box strong {
    color: var(--text-primary);
}

@media (max-width: 1024px) {
    .two-column-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    }
}
</style>
{% endblock %}

{% block content %}
<div class="optimization-container">
    <!-- Auto-Optimization Card -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">ü§ñ</span> Automatic Optimization</h3>
            <div class="header-controls">
                <span id="auto-status">Loading...</span>
                <button id="trigger-now-btn" class="btn btn-sm btn-secondary" onclick="triggerAutoOptimization()" style="display: none;">‚ö° Run Now</button>
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-toggle" onchange="toggleAutoOptimization()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
        </div>
        <div class="detail-card-body">
            <div id="auto-config" style="display: none;">
                <div class="form-row">
                    <label class="form-label">Price Threshold (p/kWh)</label>
                    <input type="number" id="price-threshold" value="15" step="0.5" class="form-control" style="max-width: 200px;">
                    <small class="form-text">Switch to high-power mode when below threshold, low-power mode when above</small>
                </div>
                <button class="btn btn-primary" onclick="saveAutoConfig()">Save Settings</button>
            </div>
            <div id="auto-disabled-msg" class="info-banner">
                Enable automatic optimization to let the system control miner modes based on energy prices. Miners will automatically switch to low-power modes during expensive periods and high-power modes during cheap periods.
            </div>
        </div>
    </div>

    <!-- Overview Stats -->
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-label">24h Energy Cost</div>
            <div class="stat-value" id="total-cost">¬£0.00</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">24h Net Profit/Loss</div>
            <div class="stat-value" id="total-profit">¬£0.00</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Current Price</div>
            <div class="stat-value" id="current-price-display">-</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Recommendation</div>
            <div class="stat-value" id="recommendation-status" style="font-size: 1.2rem;">-</div>
        </div>
    </div>

    <!-- Two Column Layout -->
    <div class="two-column-grid">
        <!-- Left Column -->
        <div>
            <!-- Price Forecast Chart -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <h3><span class="detail-card-icon">üìà</span> 24-Hour Price Forecast</h3>
                </div>
                <div class="detail-card-body">
                    <canvas id="price-forecast-chart" style="max-height: 250px;"></canvas>
                    <div class="chart-legend">
                        <div><span style="color: #10b981;">‚óè</span> Cheap</div>
                        <div><span style="color: #f59e0b;">‚óè</span> Moderate</div>
                        <div><span style="color: #ef4444;">‚óè</span> Expensive</div>
                    </div>
                </div>
            </div>
            
            <!-- Optimization Schedule -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <h3><span class="detail-card-icon">üìÖ</span> Smart Schedule</h3>
                </div>
                <div class="detail-card-body">
                    <div class="schedule-controls">
                        <input type="number" id="target-hours" value="12" min="1" max="24" class="form-control" style="max-width: 100px;">
                        <span style="font-size: 0.875rem; color: var(--text-secondary);">hours/day</span>
                        <button class="btn btn-primary btn-sm" onclick="generateSchedule()">Generate</button>
                    </div>
                    
                    <div id="schedule-result" style="display: none;">
                        <div id="schedule-savings" style="padding: 0.75rem; background: #10b981; color: white; border-radius: 6px; font-size: 0.875rem; margin-bottom: 1rem;"></div>
                        <div id="schedule-slots" class="schedule-grid" style="max-height: 200px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div>
            <!-- Per-Miner Profitability -->
            <div class="detail-card">
                <div class="detail-card-header">
                    <h3><span class="detail-card-icon">üí∞</span> Miner Profitability</h3>
                </div>
                <div class="detail-card-body">
                    <div class="table-container">
                        <table id="profitability-table">
                            <thead>
                                <tr>
                                    <th>Miner</th>
                                    <th>Coin</th>
                                    <th>Cost</th>
                                    <th>Profit</th>
                                </tr>
                            </thead>
                            <tbody id="profitability-body">
                                <tr>
                                    <td colspan="4" style="text-align: center;">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="note-box">
                        <strong>Note:</strong> Energy costs use actual power + Agile pricing. Solo mining revenue not estimated (probabilistic).
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let priceChart = null;

// Load current recommendation
async function loadRecommendation() {
    try {
        const response = await fetch('/api/energy/should-mine-now');
        const data = await response.json();
        
        const priceColor = data.current_price_pence < 10 ? '#10b981' : 
                          data.current_price_pence > 25 ? '#ef4444' : '#f59e0b';
        
        document.getElementById('current-price-display').innerHTML = `<span style="color: ${priceColor}">${data.current_price_pence.toFixed(1)}p</span>`;
        
        const statusEl = document.getElementById('recommendation-status');
        statusEl.textContent = data.should_mine ? '‚úÖ Mine' : '‚è∏Ô∏è Wait';
        statusEl.style.color = data.should_mine ? '#10b981' : '#ef4444';
    } catch (error) {
        console.error('Error loading recommendation:', error);
    }
}

// Load overview stats
async function loadOverview() {
    try {
        const response = await fetch('/api/energy/overview');
        const data = await response.json();
        
        document.getElementById('total-cost').textContent = `¬£${data.total_energy_cost_24h.toFixed(2)}`;
        document.getElementById('total-profit').textContent = `¬£${data.total_profit_24h.toFixed(2)}`;
        document.getElementById('total-profit').style.color = data.total_profit_24h >= 0 ? '#10b981' : '#ef4444';
        
        // Load profitability table
        const tbody = document.getElementById('profitability-body');
        if (data.miners && data.miners.length > 0) {
            tbody.innerHTML = data.miners.map(m => `
                <tr>
                    <td>${m.miner_name}</td>
                    <td>${m.coin || '-'}</td>
                    <td>¬£${m.energy_cost_gbp.toFixed(2)}</td>
                    <td style="color: ${m.profit_gbp >= 0 ? '#10b981' : '#ef4444'}">¬£${m.profit_gbp.toFixed(2)}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No data</td></tr>';
        }
    } catch (error) {
        console.error('Error loading overview:', error);
    }
}

// Load price forecast chart
async function loadPriceForecast() {
    try {
        const response = await fetch('/api/energy/price-forecast?hours=24');
        const data = await response.json();
        
        const ctx = document.getElementById('price-forecast-chart');
        
        if (priceChart) {
            priceChart.destroy();
        }
        
        // Color points based on price ranges
        const colors = data.forecast.map(p => {
            if (p.is_cheap) return 'rgba(16, 185, 129, 0.6)';
            if (p.is_expensive) return 'rgba(239, 68, 68, 0.6)';
            return 'rgba(245, 158, 11, 0.6)';
        });
        
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.forecast.map(p => new Date(p.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})),
                datasets: [{
                    label: 'Price (p/kWh)',
                    data: data.forecast.map(p => p.price_pence),
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.1,
                    fill: true,
                    pointBackgroundColor: colors,
                    pointBorderColor: colors,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxTicksLimit: 12,
                            color: '#9ca3af'
                        },
                        grid: {
                            color: '#374151'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Price (p/kWh)',
                            color: '#9ca3af'
                        },
                        ticks: {
                            color: '#9ca3af'
                        },
                        grid: {
                            color: '#374151'
                        }
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading price forecast:', error);
    }
}

// Load auto-optimization status
async function loadAutoStatus() {
    try {
        const response = await fetch('/api/energy/auto-optimization/status');
        const data = await response.json();
        
        document.getElementById('auto-toggle').checked = data.enabled;
        document.getElementById('auto-status').textContent = data.enabled ? 'Enabled' : 'Disabled';
        document.getElementById('auto-status').style.color = data.enabled ? '#10b981' : '#9ca3af';
        
        const triggerBtn = document.getElementById('trigger-now-btn');
        if (data.enabled) {
            document.getElementById('auto-config').style.display = 'block';
            document.getElementById('auto-disabled-msg').style.display = 'none';
            document.getElementById('price-threshold').value = data.price_threshold || 15;
            triggerBtn.style.display = 'inline-block';
        } else {
            document.getElementById('auto-config').style.display = 'none';
            document.getElementById('auto-disabled-msg').style.display = 'block';
            triggerBtn.style.display = 'none';
        }
    } catch (error) {
        console.error('Error loading auto status:', error);
    }
}

// Manually trigger auto-optimization now
async function triggerAutoOptimization() {
    const btn = document.getElementById('trigger-now-btn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '‚è≥ Running...';
    
    try {
        const response = await fetch('/api/energy/auto-optimization/trigger', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'}
        });
        
        const data = await response.json();
        
        if (!response.ok) {
            throw new Error(data.detail || 'Failed to trigger optimization');
        }
        
        alert('‚úÖ ' + data.message);
        
        // Reload profitability data
        await loadOverview();
        
    } catch (error) {
        console.error('Error triggering optimization:', error);
        alert('‚ùå Error: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// Toggle auto-optimization
async function toggleAutoOptimization() {
    const enabled = document.getElementById('auto-toggle').checked;
    
    try {
        const response = await fetch('/api/energy/auto-optimization/toggle', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({enabled: enabled})
        });
        
        if (!response.ok) {
            const data = await response.json();
            if (response.status === 409) {
                // Conflict with automation rules
                alert('‚ö†Ô∏è Cannot enable auto-optimization:\n\n' + data.detail + '\n\nDisable conflicting automation rules in Automation ‚Üí Manage Rules first.');
                document.getElementById('auto-toggle').checked = false;
                return;
            }
            throw new Error(data.detail || 'Failed to toggle');
        }
        
        await loadAutoStatus();
        
        if (enabled) {
            alert('‚úÖ Auto-optimization enabled!\n\nSystem will now control miners based on energy prices every 30 minutes.');
            // Trigger immediately on enable
            setTimeout(() => triggerAutoOptimization(), 500);
        } else {
            alert('‚è∏Ô∏è Auto-optimization disabled.\n\nManual control restored.');
        }
    } catch (error) {
        console.error('Error toggling auto-optimization:', error);
        alert('‚ùå Error: ' + error.message);
        document.getElementById('auto-toggle').checked = !enabled;
    }
}

// Save auto-optimization config
async function saveAutoConfig() {
    const priceThreshold = parseFloat(document.getElementById('price-threshold').value);
    
    try {
        const response = await fetch('/api/energy/auto-optimization/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({price_threshold: priceThreshold})
        });
        
        if (!response.ok) throw new Error('Failed to save config');
        
        alert('Settings saved successfully!');
    } catch (error) {
        console.error('Error saving config:', error);
        alert('Error: ' + error.message);
    }
}

// Generate smart schedule
async function generateSchedule() {
    const targetHours = parseInt(document.getElementById('target-hours').value);
    
    if (targetHours < 1 || targetHours > 24) {
        alert('Please enter a value between 1 and 24 hours');
        return;
    }
    
    try {
        // Use first enabled miner for demo
        const minersResponse = await fetch('/api/miners');
        const miners = await minersResponse.json();
        const enabledMiner = miners.find(m => m.enabled);
        
        if (!enabledMiner) {
            alert('No enabled miners found');
            return;
        }
        
        const response = await fetch(`/api/energy/miners/${enabledMiner.id}/schedule-recommendation?target_hours=${targetHours}`);
        const data = await response.json();
        
        // Display recommended slots
        const slotsContainer = document.getElementById('schedule-slots');
        slotsContainer.innerHTML = data.recommended_slots.map(slot => `
            <div style="padding: 0.5rem; background: var(--input-bg); border-radius: 4px; text-align: center; border: 1px solid #10b981; font-size: 0.75rem;">
                <div style="font-weight: 600; color: var(--text-primary);">${new Date(slot.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                <div style="font-size: 0.7rem; color: var(--text-secondary);">${slot.price_pence.toFixed(2)}p/kWh</div>
            </div>
        `).join('');
        
        slotsContainer.style.display = 'grid';
        slotsContainer.style.gridTemplateColumns = 'repeat(auto-fill, minmax(100px, 1fr))';
        slotsContainer.style.gap = '0.5rem';
        
        // Display savings
        const savingsContainer = document.getElementById('schedule-savings');
        savingsContainer.innerHTML = `
            <strong>üí∞ Potential Savings: ${data.savings_percent.toFixed(1)}%</strong><br>
            <small>Average price: ${data.avg_price_pence}p/kWh vs ${data.vs_random_avg}p/kWh (random timing)</small>
        `;
        
        document.getElementById('schedule-result').style.display = 'block';
    } catch (error) {
        console.error('Error generating schedule:', error);
        alert('Error generating schedule');
    }
}

// Initialize
loadAutoStatus();
loadRecommendation();
loadOverview();
loadPriceForecast();

// Refresh every 5 minutes
setInterval(() => {
    loadRecommendation();
    loadOverview();
    loadPriceForecast();
}, 300000);
</script>

<style>
/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-hover);
    transition: 0.3s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #10b981;
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}
</style>
{% endblock %}
