{% extends "base.html" %}

{% block extra_head %}
<style>
.performance-container {
    padding: 1.5rem;
}

.controls-section {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.time-range-buttons {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.time-btn {
    padding: 0.5rem 1rem;
    background: var(--card-header);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    cursor: pointer;
    transition: all 0.2s;
}

.time-btn:hover {
    background: var(--bg-hover);
}

.time-btn.active {
    background: var(--info);
    color: white;
    border-color: var(--info);
}

.comparison-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.chart-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.chart-card-header {
    background: var(--card-header);
    padding: 1.25rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.chart-card-header h3 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
}

.chart-card-icon {
    font-size: 1.5rem;
}

.chart-card-body {
    padding: 1.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-box {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.25rem;
    text-align: center;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
}

.stat-value {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-unit {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-left: 0.25rem;
}

.pool-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 4px;
}

.legend-name {
    font-size: 0.875rem;
    color: var(--text-primary);
}

.no-data {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .comparison-grid {
        grid-template-columns: 1fr;
    }
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
{% endblock %}

{% block content %}
<div class="performance-container">
    <div class="controls-section">
        <h3 style="margin-bottom: 1rem;">Time Range</h3>
        <div class="time-range-buttons">
            <button class="time-btn active" data-range="24h" onclick="changeTimeRange('24h')">24 Hours</button>
            <button class="time-btn" data-range="3d" onclick="changeTimeRange('3d')">3 Days</button>
            <button class="time-btn" data-range="7d" onclick="changeTimeRange('7d')">7 Days</button>
            <button class="time-btn" data-range="30d" onclick="changeTimeRange('30d')">30 Days</button>
        </div>
    </div>

    <div class="stats-grid" id="stats-grid">
        <!-- Stats will be populated by JavaScript -->
    </div>

    <div class="comparison-grid">
        <div class="chart-card">
            <div class="chart-card-header">
                <span class="chart-card-icon">üéØ</span>
                <h3>Pool Luck Comparison</h3>
            </div>
            <div class="chart-card-body">
                <canvas id="luckChart"></canvas>
                <div class="pool-legend" id="luckLegend"></div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-card-header">
                <span class="chart-card-icon">‚ö°</span>
                <h3>Response Time Trends</h3>
            </div>
            <div class="chart-card-body">
                <canvas id="latencyChart"></canvas>
                <div class="pool-legend" id="latencyLegend"></div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-card-header">
                <span class="chart-card-icon">üíö</span>
                <h3>Health Score Over Time</h3>
            </div>
            <div class="chart-card-body">
                <canvas id="healthChart"></canvas>
                <div class="pool-legend" id="healthLegend"></div>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-card-header">
                <span class="chart-card-icon">‚ùå</span>
                <h3>Reject Rate Comparison</h3>
            </div>
            <div class="chart-card-body">
                <canvas id="rejectChart"></canvas>
                <div class="pool-legend" id="rejectLegend"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let currentRange = '24h';
let charts = {};

const poolColors = [
    '#3b82f6', // Blue
    '#10b981', // Green
    '#f59e0b', // Orange
    '#ef4444', // Red
    '#8b5cf6', // Purple
    '#ec4899', // Pink
    '#14b8a6', // Teal
    '#f97316', // Orange-red
];

async function loadPerformanceData(range) {
    try {
        const response = await fetch(`/api/pools/performance?range=${range}`);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        const data = await response.json();
        
        console.log('Loaded performance data:', data);
        
        if (data.pools.length === 0) {
            document.getElementById('stats-grid').innerHTML = '<div class="no-data">No pool performance data available</div>';
            Object.keys(charts).forEach(key => {
                const canvas = document.getElementById(`${key}Chart`);
                if (canvas) {
                    canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                }
            });
            return;
        }
        
        renderStats(data);
        renderCharts(data);
    } catch (error) {
        console.error('Error loading performance data:', error);
        document.getElementById('stats-grid').innerHTML = `<div class="no-data">Error loading performance data: ${error.message}</div>`;
    }
}

function renderStats(data) {
    const statsHtml = data.pools.map(pool => `
        <div class="stat-box">
            <div class="stat-label">${pool.name}</div>
            <div class="stat-value">
                ${pool.avg_luck !== null ? pool.avg_luck.toFixed(1) : '--'}
                <span class="stat-unit">% luck</span>
            </div>
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.5rem;">
                ${pool.avg_latency !== null ? pool.avg_latency.toFixed(0) : '--'}ms avg latency
            </div>
        </div>
    `).join('');
    
    document.getElementById('stats-grid').innerHTML = statsHtml;
}

function renderCharts(data) {
    // Destroy existing charts
    Object.values(charts).forEach(chart => chart.destroy());
    charts = {};
    
    const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
    const borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim();
    
    // Luck Chart
    const luckDatasets = data.pools.map((pool, idx) => ({
        label: pool.name,
        data: pool.history.map(h => ({ x: h.timestamp, y: h.luck })),
        borderColor: poolColors[idx % poolColors.length],
        backgroundColor: poolColors[idx % poolColors.length] + '20',
        tension: 0.4,
        fill: false,
    }));
    
    charts.luck = new Chart(document.getElementById('luckChart'), {
        type: 'line',
        data: { datasets: luckDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)}%`
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: currentRange === '24h' ? 'hour' : 'day' },
                    ticks: { color: textColor },
                    grid: { color: borderColor }
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Luck %', color: textColor },
                    ticks: { color: textColor },
                    grid: { color: borderColor }
                }
            }
        }
    });
    
    // Latency Chart
    const latencyDatasets = data.pools.map((pool, idx) => ({
        label: pool.name,
        data: pool.history.map(h => ({ x: h.timestamp, y: h.latency })),
        borderColor: poolColors[idx % poolColors.length],
        backgroundColor: poolColors[idx % poolColors.length] + '20',
        tension: 0.4,
        fill: false,
    }));
    
    charts.latency = new Chart(document.getElementById('latencyChart'), {
        type: 'line',
        data: { datasets: latencyDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(0)}ms`
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: currentRange === '24h' ? 'hour' : 'day' },
                    ticks: { color: textColor },
                    grid: { color: borderColor }
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Response Time (ms)', color: textColor },
                    ticks: { color: textColor },
                    grid: { color: borderColor }
                }
            }
        }
    });
    
    // Health Chart
    const healthDatasets = data.pools.map((pool, idx) => ({
        label: pool.name,
        data: pool.history.map(h => ({ x: h.timestamp, y: h.health })),
        borderColor: poolColors[idx % poolColors.length],
        backgroundColor: poolColors[idx % poolColors.length] + '20',
        tension: 0.4,
        fill: false,
    }));
    
    charts.health = new Chart(document.getElementById('healthChart'), {
        type: 'line',
        data: { datasets: healthDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(0)}/100`
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: currentRange === '24h' ? 'hour' : 'day' },
                    ticks: { color: textColor },
                    grid: { color: borderColor }
                },
                y: {
                    min: 0,
                    max: 100,
                    title: { display: true, text: 'Health Score', color: textColor },
                    ticks: { color: textColor },
                    grid: { color: borderColor }
                }
            }
        }
    });
    
    // Reject Rate Chart
    const rejectDatasets = data.pools.map((pool, idx) => ({
        label: pool.name,
        data: pool.history.map(h => ({ x: h.timestamp, y: h.reject_rate })),
        borderColor: poolColors[idx % poolColors.length],
        backgroundColor: poolColors[idx % poolColors.length] + '20',
        tension: 0.4,
        fill: false,
    }));
    
    charts.reject = new Chart(document.getElementById('rejectChart'), {
        type: 'line',
        data: { datasets: rejectDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(2)}%`
                    }
                }
            },
            scales: {
                x: {
                    type: 'time',
                    time: { unit: currentRange === '24h' ? 'hour' : 'day' },
                    ticks: { color: textColor },
                    grid: { color: borderColor }
                },
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Reject Rate %', color: textColor },
                    ticks: { color: textColor },
                    grid: { color: borderColor }
                }
            }
        }
    });
    
    // Render legends
    renderLegend('luckLegend', data.pools);
    renderLegend('latencyLegend', data.pools);
    renderLegend('healthLegend', data.pools);
    renderLegend('rejectLegend', data.pools);
}

function renderLegend(elementId, pools) {
    const legendHtml = pools.map((pool, idx) => `
        <div class="legend-item">
            <div class="legend-color" style="background: ${poolColors[idx % poolColors.length]};"></div>
            <div class="legend-name">${pool.name}</div>
        </div>
    `).join('');
    
    document.getElementById(elementId).innerHTML = legendHtml;
}

function changeTimeRange(range) {
    currentRange = range;
    
    // Update button states
    document.querySelectorAll('.time-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.range === range);
    });
    
    loadPerformanceData(range);
}

// Load initial data
document.addEventListener('DOMContentLoaded', () => {
    loadPerformanceData('24h');
});
</script>
{% endblock %}
