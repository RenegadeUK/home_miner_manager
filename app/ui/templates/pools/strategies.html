{% extends "base.html" %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h1 style="margin: 0;">Pool Strategies</h1>
    <div style="display: flex; gap: 0.5rem;">
        <a href="/pools/strategies/add" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Strategy
        </a>
        <button class="btn btn-info" onclick="document.getElementById('strategyHelp').style.display='block'">
            <i class="fas fa-question-circle"></i> Strategy Guide
        </button>
    </div>
</div>

{% if strategies %}
<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th scope="col">Name</th>
                <th scope="col">Type</th>
                <th scope="col">Status</th>
                <th scope="col">Pools</th>
                <th scope="col">Last Switch</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for strategy in strategies %}
            <tr>
                <td>
                    <strong>{{ strategy.name }}</strong>
                </td>
                <td>
                    {% if strategy.strategy_type == 'round_robin' %}
                        <span class="badge badge-info">
                            <i class="fas fa-sync"></i> Round Robin
                        </span>
                    {% elif strategy.strategy_type == 'load_balance' %}
                        <span class="badge badge-primary">
                            <i class="fas fa-balance-scale"></i> Load Balance
                        </span>
                    {% else %}
                        <span class="badge badge-secondary">{{ strategy.strategy_type }}</span>
                    {% endif %}
                </td>
                <td>
                    {% if strategy.enabled %}
                        <span class="badge badge-success">
                            <i class="fas fa-check-circle"></i> Active
                        </span>
                    {% else %}
                        <span class="badge badge-secondary">
                            <i class="fas fa-pause-circle"></i> Inactive
                        </span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge badge-light">{{ strategy.pool_ids|length }} pools</span>
                    <br>
                    <span class="badge badge-light" style="margin-top: 0.25rem;">
                        {% if strategy.miner_ids %}
                            {{ strategy.miner_ids|length }} miners
                        {% else %}
                            All miners
                        {% endif %}
                    </span>
                </td>
                <td>
                    {% if strategy.last_switch %}
                        <span class="text-muted">{{ strategy.last_switch }}</span>
                    {% else %}
                        <span class="text-muted">Never</span>
                    {% endif %}
                </td>
                <td>
                    <div class="btn-group">
                        {% if strategy.enabled %}
                        <button class="btn btn-sm btn-primary" onclick="executeStrategy({{ strategy.id }})" aria-label="Execute {{ strategy.name }} now">
                            <i class="fas fa-play"></i> Execute Now
                        </button>
                        {% endif %}
                        <a href="/pools/strategies/{{ strategy.id }}/edit" class="btn btn-sm btn-secondary" aria-label="Edit {{ strategy.name }}">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <button class="btn btn-sm btn-danger" onclick="deleteStrategy({{ strategy.id }})" aria-label="Delete {{ strategy.name }}">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="card">
    <div style="text-align: center; padding: 3rem;">
        <i class="fas fa-random" style="font-size: 4rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
        <p style="font-size: 1.2rem; margin-bottom: 0.5rem; color: var(--text-primary);">No Pool Strategies</p>
        <p style="color: var(--text-secondary); margin-bottom: 2rem;">Create a strategy to automatically manage pool switching</p>
        <a href="/pools/strategies/add" class="btn btn-primary">
            <i class="fas fa-plus"></i> Add Your First Strategy
        </a>
    </div>
</div>
{% endif %}

<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h3>Strategy Types</h3>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div>
                <h4 style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-sync" style="color: var(--info);"></i>
                    Round Robin
                </h4>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                    Rotates through pools at fixed intervals. All miners switch to the same pool simultaneously.
                </p>
                <ul style="color: var(--text-secondary); margin-top: 0.5rem;">
                    <li>Equal distribution over time</li>
                    <li>Configurable switch interval</li>
                    <li>Predictable rotation</li>
                </ul>
            </div>
            <div>
                <h4 style="display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-balance-scale" style="color: var(--primary);"></i>
                    Load Balance
                </h4>
                <p style="color: var(--text-secondary); margin-top: 0.5rem;">
                    Distributes miners across pools based on health, latency, and reject rates.
                </p>
                <ul style="color: var(--text-secondary); margin-top: 0.5rem;">
                    <li>Dynamic miner distribution</li>
                    <li>Health-based allocation</li>
                    <li>Automatic rebalancing</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
async function executeStrategy(strategyId) {
    if (!confirm('Execute this strategy now? This will switch miners immediately.')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/pools/strategies/${strategyId}/execute`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(`Strategy executed successfully!\n\n${JSON.stringify(result, null, 2)}`);
            window.location.reload();
        } else {
            const error = await response.json();
            alert(`Failed to execute strategy: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error executing strategy:', error);
        alert('Failed to execute strategy');
    }
}

async function deleteStrategy(strategyId) {
    if (!confirm('Are you sure you want to delete this strategy?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/pools/strategies/${strategyId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            alert('Failed to delete strategy');
        }
    } catch (error) {
        console.error('Error deleting strategy:', error);
        alert('Failed to delete strategy');
    }
}
</script>

<!-- Help Modal -->
<div id="strategyHelp" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto;" onclick="if(event.target.id==='strategyHelp') this.style.display='none'">
    <div style="background: var(--background); max-width: 800px; margin: 2rem auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: var(--text-primary);">
                <i class="fas fa-book"></i> Pool Strategy Guide
            </h2>
            <button onclick="document.getElementById('strategyHelp').style.display='none'" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div style="padding: 2rem;">
            <!-- Round Robin -->
            <div style="margin-bottom: 2rem;">
                <h3 style="display: flex; align-items: center; gap: 0.5rem; color: var(--info); margin-bottom: 1rem;">
                    <i class="fas fa-sync"></i>
                    Round Robin
                </h3>
                <p style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <strong>What it does:</strong> Rotates all miners through your selected pools at fixed time intervals.
                </p>
                <div style="background: var(--surface); padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <h4 style="color: var(--text-primary); margin-top: 0;">When to use:</h4>
                    <ul style="color: var(--text-secondary); margin-bottom: 0;">
                        <li><strong>Equal distribution:</strong> When you want to split your hashrate evenly across multiple pools over time</li>
                        <li><strong>Solo mining rotation:</strong> Perfect for rotating between solo pools to try your luck at different pools</li>
                        <li><strong>Pool comparison:</strong> Testing multiple pools to see which performs best for your setup</li>
                        <li><strong>Reduce variance:</strong> Spreading risk across pools instead of concentrating on one</li>
                    </ul>
                </div>
                <div style="background: var(--info-background); border-left: 4px solid var(--info); padding: 1rem; border-radius: 4px;">
                    <p style="margin: 0; color: var(--text-primary);">
                        <i class="fas fa-lightbulb"></i> <strong>Example:</strong> If you have 3 pools and set a 60-minute interval, all your miners will switch to Pool 1, then after an hour they all switch to Pool 2, then Pool 3, then back to Pool 1.
                    </p>
                </div>
            </div>

            <!-- Load Balance -->
            <div style="margin-bottom: 2rem;">
                <h3 style="display: flex; align-items: center; gap: 0.5rem; color: var(--primary); margin-bottom: 1rem;">
                    <i class="fas fa-balance-scale"></i>
                    Load Balance
                </h3>
                <p style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <strong>What it does:</strong> Intelligently distributes your miners across pools based on real-time health, latency, and performance metrics.
                </p>
                <div style="background: var(--surface); padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <h4 style="color: var(--text-primary); margin-top: 0;">When to use:</h4>
                    <ul style="color: var(--text-secondary); margin-bottom: 0;">
                        <li><strong>Maximize efficiency:</strong> When you want the best performance and lowest reject rates</li>
                        <li><strong>Pool reliability:</strong> Automatically avoid pools with high latency or connection issues</li>
                        <li><strong>Multiple miners:</strong> Distribute miners dynamically instead of having them all on the same pool</li>
                        <li><strong>Set priority:</strong> Weight allocation toward higher-priority pools while keeping others as backup</li>
                    </ul>
                </div>
                <div style="background: var(--primary-background); border-left: 4px solid var(--primary); padding: 1rem; border-radius: 4px;">
                    <p style="margin: 0; color: var(--text-primary);">
                        <i class="fas fa-lightbulb"></i> <strong>Example:</strong> If you have 5 miners and 3 pools (priorities 10, 5, 3), the system might assign 3 miners to the highest priority pool, 1 to the medium, and 1 to the lowest - automatically adjusting if any pool's health degrades.
                    </p>
                </div>
            </div>

            <!-- Comparison -->
            <div style="border-top: 2px solid var(--border); padding-top: 1.5rem;">
                <h3 style="color: var(--text-primary); margin-bottom: 1rem;">
                    <i class="fas fa-balance-scale-right"></i> Quick Comparison
                </h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Round Robin</th>
                            <th>Load Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>All miners same pool?</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                        </tr>
                        <tr>
                            <td>Time-based switching</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                        </tr>
                        <tr>
                            <td>Health-based switching</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                        </tr>
                        <tr>
                            <td>Predictable rotation</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                        </tr>
                        <tr>
                            <td>Best for solo mining</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                        </tr>
                        <tr>
                            <td>Best for efficiency</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Important Notes -->
            <div style="background: var(--warning-background); border-left: 4px solid var(--warning); padding: 1rem; border-radius: 4px; margin-top: 1.5rem;">
                <h4 style="color: var(--text-primary); margin-top: 0;">
                    <i class="fas fa-exclamation-triangle"></i> Important Notes
                </h4>
                <ul style="color: var(--text-primary); margin-bottom: 0;">
                    <li><strong>Multiple strategies allowed:</strong> You can run multiple strategies simultaneously, but each miner can only be in one strategy at a time</li>
                    <li><strong>Miner selection:</strong> Select specific miners for each strategy, or leave unselected to apply to all miners not in other strategies</li>
                    <li><strong>Avalon Nano limitations:</strong> These miners can only switch between their 3 pre-configured pool slots</li>
                    <li><strong>Manual execution:</strong> You can trigger any enabled strategy immediately with the "Execute Now" button</li>
                    <li><strong>Strategy interval:</strong> The system checks and executes strategies every minute</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
