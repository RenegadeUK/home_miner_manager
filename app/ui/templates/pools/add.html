{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Add Mining Pool</h2>
    </div>
    
    <form id="add-pool-form">
        <div class="form-group">
            <label class="form-label">Quick Setup <button type="button" class="btn-icon" onclick="showPoolHelp()" title="Help">ℹ️</button></label>
            <select class="form-input" id="preset-pool" onchange="applyPreset()">
                <option value="">-- Manual Setup (fill all fields below) --</option>
                <optgroup label="Braiins Pool - Bitcoin (BTC)">
                    <option value="braiins-btc">Braiins Pool BTC</option>
                </optgroup>
                <optgroup label="Solopool.org - Bitcoin Cash (BCH)">
                    <option value="bch-eu2">Solopool.org BCH (EU2)</option>
                    <option value="bch-us1">Solopool.org BCH (US1)</option>
                </optgroup>
                <optgroup label="Solopool.org - DigiByte (DGB)">
                    <option value="dgb-eu1">Solopool.org DGB (EU1)</option>
                    <option value="dgb-us1">Solopool.org DGB (US1)</option>
                </optgroup>
                <optgroup label="Solopool.org - Bitcoin (BTC)">
                    <option value="btc-eu3">Solopool.org BTC (EU3)</option>
                </optgroup>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Pool Name</label>
            <input type="text" class="form-input" id="name" required placeholder="e.g., Public Pool">
            <span class="form-error" id="name-error"></span>
        </div>
        
        <div class="form-group">
            <label class="form-label">Pool URL / IP Address</label>
            <input type="text" class="form-input" id="url" required placeholder="e.g., pool.example.com or 192.168.1.100">
            <small>Enter hostname or IP address (without protocol or port)</small>
            <span class="form-error" id="url-error"></span>
        </div>
        
        <div class="form-group">
            <label class="form-label">Port</label>
            <input type="number" class="form-input" id="port" required placeholder="e.g., 3333" value="3333">
            <span class="form-error" id="port-error"></span>
        </div>
        
        <div class="form-group">
            <label class="form-label">Username/Worker</label>
            <input type="text" class="form-input" id="user" required placeholder="Your wallet address or username">
            <span class="form-error" id="user-error"></span>
        </div>
        
        <div class="form-group">
            <label class="form-label">Password</label>
            <input type="text" class="form-input" id="password" value="x" placeholder="x or worker password">
            <small>Default: x (most pools accept this)</small>
            <span class="form-error" id="password-error"></span>
        </div>
        
        <div class="flex gap-2 mt-4">
            <button type="submit" class="btn btn-primary" id="submit-btn">Add Pool</button>
            <a href="/pools" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<!-- Help Modal -->
<div id="poolHelpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-secondary); border-radius: 8px; padding: 2rem; max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0;">Pool Setup Help</h3>
            <button onclick="closePoolHelp()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary);">&times;</button>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: var(--primary); margin-bottom: 0.5rem;">Quick Setup</h4>
            <p>Select a preset pool from the dropdown to auto-fill pool details. You only need to enter your wallet address/username.</p>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: var(--primary); margin-bottom: 0.5rem;">Supported Preset Pools</h4>
            <ul style="line-height: 1.8;">
        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: var(--primary); margin-bottom: 0.5rem;">Supported Preset Pools</h4>
            <ul style="line-height: 1.8;">
                <li><strong>Braiins Pool BTC:</strong> Bitcoin pool mining with FPPS (port 3333)</li>
                <li><strong>Solopool.org BCH:</strong> Bitcoin Cash solo mining (ports 8002)</li>
                <li><strong>Solopool.org DGB:</strong> DigiByte SHA256 solo mining (ports 8004)</li>
                <li><strong>Solopool.org BTC:</strong> Bitcoin solo mining (port 8005)</li>
            </ul>
        </div>4 style="color: var(--primary); margin-bottom: 0.5rem;">Manual Setup</h4>
            <ol style="line-height: 1.8;">
                <li>Select "Manual Setup" from the dropdown</li>
                <li>Fill in all required fields:
                    <ul>
                        <li><strong>Pool Name:</strong> A friendly name for this pool</li>
                        <li><strong>Pool URL:</strong> The pool server address (no http:// or stratum://)</li>
                        <li><strong>Port:</strong> The pool's mining port number</li>
                        <li><strong>Username:</strong> Your wallet address or username</li>
                        <li><strong>Password:</strong> Usually "x" (preset for you)</li>
                    </ul>
                </li>
                <li>All fields must be filled before saving</li>
            </ol>
        </div>
        
        <button onclick="closePoolHelp()" class="btn btn-primary" style="width: 100%;">Got It</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Pool presets
const POOL_PRESETS = {
    'braiins-btc': {
        name: 'Braiins Pool BTC',
        url: 'stratum.braiins.com',
        port: 3333
    },
    'bch-eu2': {
        name: 'Solopool.org BCH (EU2)',
        url: 'eu2.solopool.org',
        port: 8002
    },
    'bch-us1': {
        name: 'Solopool.org BCH (US1)',
        url: 'us1.solopool.org',
        port: 8002
    },
    'dgb-eu1': {
        name: 'Solopool.org DGB (EU1)',
        url: 'eu1.solopool.org',
        port: 8004
    },
    'dgb-us1': {
        name: 'Solopool.org DGB (US1)',
        url: 'us1.solopool.org',
        port: 8004
    },
    'btc-eu3': {
        name: 'Solopool.org BTC (EU3)',
        url: 'eu3.solopool.org',
        port: 8005
    }
};

// Apply preset pool configuration
function applyPreset() {
    const presetKey = document.getElementById('preset-pool').value;
    
    if (!presetKey) {
        // Manual mode - clear preset values but keep password as 'x'
        return;
    }
    
    const preset = POOL_PRESETS[presetKey];
    if (preset) {
        document.getElementById('name').value = preset.name;
        document.getElementById('url').value = preset.url;
        document.getElementById('port').value = preset.port;
        document.getElementById('password').value = 'x';
        
        // Focus on username field
        document.getElementById('user').focus();
        
        // Clear any existing errors
        clearErrors();
    }
}

// Show pool help modal
function showPoolHelp() {
    document.getElementById('poolHelpModal').style.display = 'flex';
}

// Close pool help modal
function closePoolHelp() {
    document.getElementById('poolHelpModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('poolHelpModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'poolHelpModal') {
        closePoolHelp();
    }
});

// Validate field
function validateField(fieldId, errorId, fieldName) {
    const field = document.getElementById(fieldId);
    const error = document.getElementById(errorId);
    const value = field.value.trim();
    
    if (!value) {
        error.textContent = `${fieldName} is required`;
        error.style.display = 'block';
        field.style.borderColor = '#e74c3c';
        return false;
    }
    
    error.textContent = '';
    error.style.display = 'none';
    field.style.borderColor = '';
    return true;
}

// Clear all errors
function clearErrors() {
    ['name-error', 'url-error', 'port-error', 'user-error', 'password-error'].forEach(id => {
        const elem = document.getElementById(id);
        if (elem) {
            elem.textContent = '';
            elem.style.display = 'none';
        }
    });
    
    ['name', 'url', 'port', 'user', 'password'].forEach(id => {
        const field = document.getElementById(id);
        if (field) {
            field.style.borderColor = '';
        }
    });
}

// Real-time validation on blur
document.getElementById('name').addEventListener('blur', () => {
    validateField('name', 'name-error', 'Pool name');
});

document.getElementById('url').addEventListener('blur', () => {
    validateField('url', 'url-error', 'Pool URL');
});

document.getElementById('port').addEventListener('blur', () => {
    const field = document.getElementById('port');
    const error = document.getElementById('port-error');
    const value = field.value.trim();
    
    if (!value) {
        error.textContent = 'Port is required';
        error.style.display = 'block';
        field.style.borderColor = '#e74c3c';
    } else if (parseInt(value) < 1 || parseInt(value) > 65535) {
        error.textContent = 'Port must be between 1 and 65535';
        error.style.display = 'block';
        field.style.borderColor = '#e74c3c';
    } else {
        error.textContent = '';
        error.style.display = 'none';
        field.style.borderColor = '';
    }
});

document.getElementById('user').addEventListener('blur', () => {
    validateField('user', 'user-error', 'Username');
});

document.getElementById('password').addEventListener('blur', () => {
    validateField('password', 'password-error', 'Password');
});

// Form submission with validation
document.getElementById('add-pool-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Validate all fields
    const nameValid = validateField('name', 'name-error', 'Pool name');
    const urlValid = validateField('url', 'url-error', 'Pool URL');
    const userValid = validateField('user', 'user-error', 'Username');
    const passwordValid = validateField('password', 'password-error', 'Password');
    
    // Validate port
    const portField = document.getElementById('port');
    const portError = document.getElementById('port-error');
    const portValue = portField.value.trim();
    let portValid = false;
    
    if (!portValue) {
        portError.textContent = 'Port is required';
        portError.style.display = 'block';
        portField.style.borderColor = '#e74c3c';
    } else if (parseInt(portValue) < 1 || parseInt(portValue) > 65535) {
        portError.textContent = 'Port must be between 1 and 65535';
        portError.style.display = 'block';
        portField.style.borderColor = '#e74c3c';
    } else {
        portError.textContent = '';
        portError.style.display = 'none';
        portField.style.borderColor = '';
        portValid = true;
    }
    
    // If any validation fails, stop submission
    if (!nameValid || !urlValid || !portValid || !userValid || !passwordValid) {
        alert('Please fill in all required fields correctly');
        return;
    }
    
    const data = {
        name: document.getElementById('name').value.trim(),
        url: document.getElementById('url').value.trim(),
        port: parseInt(document.getElementById('port').value),
        user: document.getElementById('user').value.trim(),
        password: document.getElementById('password').value.trim()
    };
    
    // Disable submit button during submission
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';
    
    try {
        const res = await fetch('/api/pools/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            window.location.href = '/pools';
        } else {
            const error = await res.json();
            alert('Failed to add pool: ' + (error.detail || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Pool';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Pool';
    }
});
</script>
{% endblock %}
