{% extends "base.html" %}

{% block extra_head %}
<style>
.pool-container {
    max-width: 800px;
    margin: 0 auto;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.detail-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    background: var(--card-header);
    border-bottom: 1px solid var(--border-color);
}

.detail-card-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.detail-card-header h3 {
    flex: 1;
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
}

.detail-card-body {
    padding: 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    color: #60a5fa;
    margin-left: 0.5rem;
    padding: 0;
}

.btn-icon:hover {
    color: #93c5fd;
}

.form-input,
.form-select {
    width: 100%;
    padding: 0.625rem;
    background: var(--card-header);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.9375rem;
}

.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: #3b82f6;
}

.form-input::placeholder {
    color: var(--text-secondary);
}

small {
    display: block;
    margin-top: 0.375rem;
    color: var(--text-secondary);
    font-size: 0.75rem;
}

.warning-text {
    color: #f59e0b;
    display: block;
    margin-top: 0.5rem;
    font-size: 0.875rem;
}

.form-error {
    display: none;
    color: #ef4444;
    font-size: 0.75rem;
    margin-top: 0.375rem;
}

.button-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 2rem;
}
</style>
{% endblock %}

{% block content %}
<div class="pool-container">
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">üåä</span> Add Mining Pool</h3>
        </div>
        <div class="detail-card-body">
            <form id="add-pool-form">
        <div class="form-group">
            <label class="form-label">1Ô∏è‚É£ Select Pool Provider <button type="button" class="btn-icon" onclick="showPoolHelp()" title="Help">‚ÑπÔ∏è</button></label>
            <select class="form-input" id="preset-pool" onchange="applyPreset()" required>
                <option value="">-- Select an approved pool provider --</option>
                <optgroup label="Solopool.org - Bitcoin (BTC)">
                    <option value="btc-eu3">Solopool.org BTC (EU3)</option>
                </optgroup>
                <optgroup label="Solopool.org - Bitcoin Cash (BCH)">
                    <option value="bch-eu2">Solopool.org BCH (EU2)</option>
                    <option value="bch-us1">Solopool.org BCH (US1)</option>
                </optgroup>
                <optgroup label="Solopool.org - DigiByte (DGB)">
                    <option value="dgb-eu1">Solopool.org DGB (EU1)</option>
                    <option value="dgb-us1">Solopool.org DGB (US1)</option>
                </optgroup>
                <optgroup label="Braiins Pool - Bitcoin (BTC)">
                    <option value="braiins-btc">Braiins Pool BTC</option>
                </optgroup>
                <optgroup label="SupportXMR - Monero (XMR) [CPU ONLY]">
                    <option value="supportxmr">SupportXMR Pool (XMR)</option>
                </optgroup>
            </select>
            <small style="color: #60a5fa; display: block; margin-top: 0.5rem;">
                üëâ Select a pool provider above, then the username field will appear below
            </small>
        </div>
        
        <div class="form-group" id="pool-info-display" style="display: none;">
            <label class="form-label">Pool Details</label>
            <div style="background: var(--card-header); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.75rem;">
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 0.5rem; font-size: 0.875rem;">
                    <strong style="color: var(--text-secondary);">Pool:</strong>
                    <span id="display-name" style="color: var(--text-primary);"></span>
                    <strong style="color: var(--text-secondary);">URL:</strong>
                    <span id="display-url" style="color: var(--text-primary);"></span>
                    <strong style="color: var(--text-secondary);">Port:</strong>
                    <span id="display-port" style="color: var(--text-primary);"></span>
                </div>
            </div>
        </div>
        
        <div class="form-group" id="username-group" style="display: none;">
            <label class="form-label">2Ô∏è‚É£ Wallet Address / Username</label>
            <input type="text" class="form-input" id="user" required placeholder="Enter your wallet address or pool username">
            <small>This is the only information you need to provide - pool details are pre-configured</small>
            <span class="form-error" id="user-error"></span>
        </div>
        
        <div class="button-row" id="submit-row" style="display: none;">
            <button type="submit" class="btn btn-primary" id="submit-btn">Add Pool</button>
            <a href="/pools" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
        </div>
    </div>
</div>

<!-- Help Modal -->
<div id="poolHelpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 2rem; max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary);">Pool Setup Help</h3>
            <button onclick="closePoolHelp()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-primary);">&times;</button>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: #10b981; margin-bottom: 0.5rem;">How to Add a Pool</h4>
            <ol style="line-height: 1.8; color: var(--text-primary);">
                <li>Select an approved pool provider from the dropdown</li>
                <li>Enter your wallet address or pool username</li>
                <li>Click "Add Pool" - all other settings are configured automatically</li>
            </ol>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <h4 style="color: #10b981; margin-bottom: 0.5rem;">Approved Pool Providers</h4>
            <ul style="line-height: 1.8; color: var(--text-primary);">
                <li><strong>Solopool.org:</strong> Solo mining for BTC, BCH, and DGB</li>
                <li><strong>Braiins Pool:</strong> Bitcoin pool mining with FPPS rewards</li>
                <li><strong>SupportXMR:</strong> Monero pool mining (CPU miners only)</li>
            </ul>
            <p style="color: var(--text-secondary); margin-top: 1rem; font-size: 0.875rem;">
                For security and reliability, only these trusted pool providers are supported.
            </p>
        </div>
        
        <button onclick="closePoolHelp()" class="btn btn-primary" style="width: 100%;">Got It</button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Pool presets (approved providers only)
const POOL_PRESETS = {
    'braiins-btc': {
        name: 'Braiins Pool BTC',
        url: 'stratum.braiins.com',
        port: 3333
    },
    'supportxmr': {
        name: 'SupportXMR Pool (XMR)',
        url: 'pool.supportxmr.com',
        port: 3333
    },
    'bch-eu2': {
        name: 'Solopool.org BCH (EU2)',
        url: 'eu2.solopool.org',
        port: 8002
    },
    'bch-us1': {
        name: 'Solopool.org BCH (US1)',
        url: 'us1.solopool.org',
        port: 8002
    },
    'dgb-eu1': {
        name: 'Solopool.org DGB (EU1)',
        url: 'eu1.solopool.org',
        port: 8004
    },
    'dgb-us1': {
        name: 'Solopool.org DGB (US1)',
        url: 'us1.solopool.org',
        port: 8004
    },
    'btc-eu3': {
        name: 'Solopool.org BTC (EU3)',
        url: 'eu3.solopool.org',
        port: 8005
    }
};

// Apply preset pool configuration and show username field
function applyPreset() {
    const presetKey = document.getElementById('preset-pool').value;
    const poolInfoDisplay = document.getElementById('pool-info-display');
    const usernameGroup = document.getElementById('username-group');
    const submitRow = document.getElementById('submit-row');
    
    if (!presetKey) {
        // No pool selected - hide everything
        poolInfoDisplay.style.display = 'none';
        usernameGroup.style.display = 'none';
        submitRow.style.display = 'none';
        return;
    }
    
    const preset = POOL_PRESETS[presetKey];
    if (preset) {
        // Set hidden fields for form submission
        document.getElementById('display-name').textContent = preset.name;
        document.getElementById('display-url').textContent = preset.url;
        document.getElementById('display-port').textContent = preset.port;
        
        // Show pool info and username field
        poolInfoDisplay.style.display = 'block';
        usernameGroup.style.display = 'block';
        submitRow.style.display = 'flex';
        
        // Focus on username field
        document.getElementById('user').focus();
        
        // Clear any existing errors
        clearErrors();
    }
}

// Show pool help modal
function showPoolHelp() {
    document.getElementById('poolHelpModal').style.display = 'flex';
}

// Close pool help modal
function closePoolHelp() {
    document.getElementById('poolHelpModal').style.display = 'none';
}

// Close modal when clicking outside
document.getElementById('poolHelpModal')?.addEventListener('click', (e) => {
    if (e.target.id === 'poolHelpModal') {
        closePoolHelp();
    }
});

// Clear all errors
function clearErrors() {
    const userError = document.getElementById('user-error');
    if (userError) {
        userError.textContent = '';
        userError.style.display = 'none';
    }
    
    const userField = document.getElementById('user');
    if (userField) {
        userField.style.borderColor = '';
    }
}

// Validate username field
function validateUsername() {
    const field = document.getElementById('user');
    const error = document.getElementById('user-error');
    const value = field.value.trim();
    
    if (!value) {
        error.textContent = 'Wallet address / username is required';
        error.style.display = 'block';
        field.style.borderColor = '#e74c3c';
        return false;
    }
    
    error.textContent = '';
    error.style.display = 'none';
    field.style.borderColor = '';
    return true;
}

// Real-time validation on blur
document.getElementById('user').addEventListener('blur', validateUsername);

// Form submission with validation
document.getElementById('add-pool-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Check if pool is selected
    const presetKey = document.getElementById('preset-pool').value;
    if (!presetKey) {
        alert('Please select a pool provider');
        return;
    }
    
    // Validate username
    if (!validateUsername()) {
        alert('Please enter your wallet address or username');
        return;
    }
    
    // Get preset configuration
    const preset = POOL_PRESETS[presetKey];
    if (!preset) {
        alert('Invalid pool selection');
        return;
    }
    
    const data = {
        name: preset.name,
        url: preset.url,
        port: preset.port,
        user: document.getElementById('user').value.trim(),
        password: 'x'
    };
    
    // Disable submit button during submission
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Adding...';
    
    try {
        const res = await fetch('/api/pools/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            window.location.href = '/pools';
        } else {
            const error = await res.json();
            alert('Failed to add pool: ' + (error.detail || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Pool';
        }
    } catch (error) {
        alert('Error: ' + error.message);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Add Pool';
    }
});
</script>
{% endblock %}
