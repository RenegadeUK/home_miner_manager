{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <p class="page-description">Modify pool switching strategy</p>
    <button class="btn btn-info" onclick="document.getElementById('strategyHelp').style.display='block'" style="margin-left: auto;">
        <i class="fas fa-question-circle"></i> Strategy Guide
    </button>
</div>

<div class="card">
    <form id="strategyForm">
        <div class="form-section">
            <h3>Basic Information</h3>
            
            <div class="form-group">
                <label for="name">Strategy Name *</label>
                <input type="text" id="name" name="name" class="form-control" required 
                       value="{{ strategy.name }}">
            </div>
            
            <div class="form-group">
                <label for="strategy_type">Strategy Type *</label>
                <select id="strategy_type" name="strategy_type" class="form-control" required onchange="updateConfigFields()">
                    <option value="round_robin" {% if strategy.strategy_type == 'round_robin' %}selected{% endif %}>
                        Round Robin - Rotate pools at fixed intervals
                    </option>
                    <option value="load_balance" {% if strategy.strategy_type == 'load_balance' %}selected{% endif %}>
                        Load Balance - Distribute by health & performance
                    </option>
                </select>
            </div>
        </div>
        
        <div class="form-section">
            <h3>Pool Selection</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Select the pools to include in this strategy. Order matters for round-robin.
            </p>
            
            {% if slots_need_sync %}
            <div class="alert alert-warning" style="margin-bottom: 1rem;">
                <i class="fas fa-sync-alt"></i>
                <strong>Pool Slots Syncing:</strong> Avalon Nano miners detected but pool configurations haven't been synced yet.
                Please wait a few minutes for the system to query your miners' pool slots (happens automatically every 15 minutes).
            </div>
            {% elif has_nano_miners %}
            <div class="alert alert-info" style="margin-bottom: 1rem;">
                <i class="fas fa-info-circle"></i>
                <strong>Avalon Nano Miners Detected:</strong> Only pools configured in ALL Avalon Nano miners' 3 slots are shown.
                To add more pools, configure them on your Avalon Nano miners first.
            </div>
            {% endif %}
            
            <div id="poolSelection">
                {% for pool in pools %}
                <div class="checkbox-group">
                    <input type="checkbox" id="pool_{{ pool.id }}" name="pool_ids" value="{{ pool.id }}"
                           {% if pool.id in strategy.pool_ids %}checked{% endif %}
                           onchange="updateSelectedPools()">
                    <label for="pool_{{ pool.id }}">
                        <strong>{{ pool.name }}</strong> - {{ pool.url }}:{{ pool.port }}
                    </label>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="form-section">
            <h3>Miner Selection</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                Select specific miners for this strategy, or leave all unchecked to apply to all miners.
            </p>
            
            <div id="minerSelection">
                <p class="text-muted">Loading miners...</p>
            </div>
        </div>
        
        <div class="form-section" id="configSection">
            <h3>Strategy Configuration</h3>
            
            <!-- Round Robin Config -->
            <div id="roundRobinConfig" style="{% if strategy.strategy_type != 'round_robin' %}display: none;{% endif %}">
                <div class="form-group">
                    <label for="interval_minutes">Switch Interval (minutes)</label>
                    <input type="number" id="interval_minutes" name="interval_minutes" 
                           class="form-control" min="1" value="{{ strategy.config.get('interval_minutes', 60) }}">
                    <small class="form-text">How often to switch to the next pool</small>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="apply_to_all" name="apply_to_all" 
                           {% if strategy.config.get('apply_to_all', True) %}checked{% endif %}>
                    <label for="apply_to_all">
                        Apply to all miners (if unchecked, only affects new connections)
                    </label>
                </div>
            </div>
            
            <!-- Load Balance Config -->
            <div id="loadBalanceConfig" style="{% if strategy.strategy_type != 'load_balance' %}display: none;{% endif %}">
                <div class="form-group">
                    <label for="rebalance_interval">Rebalance Interval (minutes)</label>
                    <input type="number" id="rebalance_interval" name="rebalance_interval" 
                           class="form-control" min="1" value="{{ strategy.config.get('rebalance_interval_minutes', 30) }}">
                    <small class="form-text">How often to recalculate miner distribution</small>
                </div>
                
                <div class="form-group">
                    <label>Scoring Weights (must sum to 1.0)</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem;">
                        <div>
                            <label for="health_weight">Health</label>
                            <input type="number" id="health_weight" name="health_weight" 
                                   class="form-control" min="0" max="1" step="0.1" 
                                   value="{{ strategy.config.get('health_weight', 0.4) }}">
                        </div>
                        <div>
                            <label for="latency_weight">Latency</label>
                            <input type="number" id="latency_weight" name="latency_weight" 
                                   class="form-control" min="0" max="1" step="0.1" 
                                   value="{{ strategy.config.get('latency_weight', 0.3) }}">
                        </div>
                        <div>
                            <label for="reject_weight">Reject Rate</label>
                            <input type="number" id="reject_weight" name="reject_weight" 
                                   class="form-control" min="0" max="1" step="0.1" 
                                   value="{{ strategy.config.get('reject_weight', 0.3) }}">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="min_health_threshold">Minimum Health Threshold</label>
                    <input type="number" id="min_health_threshold" name="min_health_threshold" 
                           class="form-control" min="0" max="100" 
                           value="{{ strategy.config.get('min_health_threshold', 50) }}">
                    <small class="form-text">Pools below this health score won't be used</small>
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <div class="checkbox-group">
                <input type="checkbox" id="enabled" name="enabled" {% if strategy.enabled %}checked{% endif %}>
                <label for="enabled">
                    <strong>Enable strategy</strong>
                    <small style="display: block; color: var(--text-secondary);">
                        Strategy will only affect selected miners (or all miners if none selected)
                    </small>
                </label>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i> Save Changes
            </button>
            <a href="/pools/strategies" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
function updateConfigFields() {
    const strategyType = document.getElementById('strategy_type').value;
    const roundRobinConfig = document.getElementById('roundRobinConfig');
    const loadBalanceConfig = document.getElementById('loadBalanceConfig');
    
    if (strategyType === 'round_robin') {
        roundRobinConfig.style.display = 'block';
        loadBalanceConfig.style.display = 'none';
    } else if (strategyType === 'load_balance') {
        roundRobinConfig.style.display = 'none';
        loadBalanceConfig.style.display = 'block';
    }
}

function updateSelectedPools() {
    const checkboxes = document.querySelectorAll('input[name="pool_ids"]:checked');
    console.log(`Selected ${checkboxes.length} pools`);
}

// Load miners for selection
async function loadMiners() {
    try {
        const response = await fetch('/api/miners');
        const miners = await response.json();
        const strategyMinerIds = {{ strategy.miner_ids | tojson }};
        
        const minerSelection = document.getElementById('minerSelection');
        if (miners.length === 0) {
            minerSelection.innerHTML = '<p class="text-muted">No miners available</p>';
            return;
        }
        
        minerSelection.innerHTML = miners.map(m => `
            <div class="checkbox-group">
                <input type="checkbox" id="miner_${m.id}" name="miner_ids" value="${m.id}"
                       ${strategyMinerIds.includes(m.id) ? 'checked' : ''}>
                <label for="miner_${m.id}">
                    <strong>${m.name}</strong> - ${m.miner_type} (${m.ip_address})
                </label>
            </div>
        `).join('');
    } catch (error) {
        console.error('Failed to load miners:', error);
        document.getElementById('minerSelection').innerHTML = '<p class="text-danger">Failed to load miners</p>';
    }
}

// Load miners on page load
loadMiners();

document.getElementById('strategyForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const strategyType = formData.get('strategy_type');
    
    // Get selected pool IDs
    const poolIds = Array.from(document.querySelectorAll('input[name="pool_ids"]:checked'))
        .map(cb => parseInt(cb.value));
    
    if (poolIds.length < 2) {
        alert('Please select at least 2 pools for the strategy');
        return;
    }
    
    // Get selected miner IDs (empty array means all miners)
    const minerIds = Array.from(document.querySelectorAll('input[name="miner_ids"]:checked'))
        .map(cb => parseInt(cb.value));
    
    // Build config object based on strategy type
    let config = {};
    if (strategyType === 'round_robin') {
        config = {
            interval_minutes: parseInt(formData.get('interval_minutes') || 60),
            apply_to_all: formData.get('apply_to_all') === 'on'
        };
    } else if (strategyType === 'load_balance') {
        config = {
            rebalance_interval_minutes: parseInt(formData.get('rebalance_interval') || 30),
            health_weight: parseFloat(formData.get('health_weight') || 0.4),
            latency_weight: parseFloat(formData.get('latency_weight') || 0.3),
            reject_weight: parseFloat(formData.get('reject_weight') || 0.3),
            min_health_threshold: parseInt(formData.get('min_health_threshold') || 50)
        };
        
        // Validate weights sum to 1.0
        const weightSum = config.health_weight + config.latency_weight + config.reject_weight;
        if (Math.abs(weightSum - 1.0) > 0.01) {
            alert(`Weights must sum to 1.0 (current sum: ${weightSum.toFixed(2)})`);
            return;
        }
    }
    
    const data = {
        name: formData.get('name'),
        strategy_type: strategyType,
        pool_ids: poolIds,
        miner_ids: minerIds,
        config: config,
        enabled: formData.get('enabled') === 'on'
    };
    
    try {
        const response = await fetch('/api/pools/strategies/{{ strategy.id }}', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            window.location.href = '/pools/strategies';
        } else {
            const error = await response.json();
            alert(`Failed to update strategy: ${error.detail}`);
        }
    } catch (error) {
        console.error('Error updating strategy:', error);
        alert('Failed to update strategy');
    }
});
</script>

<style>
.form-section {
    margin-bottom: 2rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--border-color);
}

.form-section:last-of-type {
    border-bottom: none;
}

.form-section h3 {
    margin-bottom: 1rem;
    color: var(--text-primary);
}

.checkbox-group {
    display: flex;
    align-items: flex-start;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    padding: 0.75rem;
    background: var(--card-header);
    border-radius: 6px;
}

.checkbox-group input[type="checkbox"] {
    margin-top: 0.25rem;
}

.checkbox-group label {
    margin-bottom: 0;
    color: var(--text-primary);
}
</style>

<!-- Help Modal -->
<div id="strategyHelp" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; overflow-y: auto;" onclick="if(event.target.id==='strategyHelp') this.style.display='none'">
    <div style="background: var(--background); max-width: 800px; margin: 2rem auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; color: var(--text-primary);">
                <i class="fas fa-book"></i> Pool Strategy Guide
            </h2>
            <button onclick="document.getElementById('strategyHelp').style.display='none'" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div style="padding: 2rem;">
            <!-- Round Robin -->
            <div style="margin-bottom: 2rem;">
                <h3 style="display: flex; align-items: center; gap: 0.5rem; color: var(--info); margin-bottom: 1rem;">
                    <i class="fas fa-sync"></i>
                    Round Robin
                </h3>
                <p style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <strong>What it does:</strong> Rotates all miners through your selected pools at fixed time intervals.
                </p>
                <div style="background: var(--surface); padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <h4 style="color: var(--text-primary); margin-top: 0;">When to use:</h4>
                    <ul style="color: var(--text-secondary); margin-bottom: 0;">
                        <li><strong>Equal distribution:</strong> When you want to split your hashrate evenly across multiple pools over time</li>
                        <li><strong>Solo mining rotation:</strong> Perfect for rotating between solo pools to try your luck at different pools</li>
                        <li><strong>Pool comparison:</strong> Testing multiple pools to see which performs best for your setup</li>
                        <li><strong>Reduce variance:</strong> Spreading risk across pools instead of concentrating on one</li>
                    </ul>
                </div>
                <div style="background: var(--info-background); border-left: 4px solid var(--info); padding: 1rem; border-radius: 4px;">
                    <p style="margin: 0; color: var(--text-primary);">
                        <i class="fas fa-lightbulb"></i> <strong>Example:</strong> If you have 3 pools and set a 60-minute interval, all your miners will switch to Pool 1, then after an hour they all switch to Pool 2, then Pool 3, then back to Pool 1.
                    </p>
                </div>
            </div>

            <!-- Load Balance -->
            <div style="margin-bottom: 2rem;">
                <h3 style="display: flex; align-items: center; gap: 0.5rem; color: var(--primary); margin-bottom: 1rem;">
                    <i class="fas fa-balance-scale"></i>
                    Load Balance
                </h3>
                <p style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.1rem;">
                    <strong>What it does:</strong> Intelligently distributes your miners across pools based on real-time health, latency, and performance metrics.
                </p>
                <div style="background: var(--surface); padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                    <h4 style="color: var(--text-primary); margin-top: 0;">When to use:</h4>
                    <ul style="color: var(--text-secondary); margin-bottom: 0;">
                        <li><strong>Maximize efficiency:</strong> When you want the best performance and lowest reject rates</li>
                        <li><strong>Pool reliability:</strong> Automatically avoid pools with high latency or connection issues</li>
                        <li><strong>Multiple miners:</strong> Distribute miners dynamically instead of having them all on the same pool</li>
                        <li><strong>Set priority:</strong> Weight allocation toward higher-priority pools while keeping others as backup</li>
                    </ul>
                </div>
                <div style="background: var(--primary-background); border-left: 4px solid var(--primary); padding: 1rem; border-radius: 4px;">
                    <p style="margin: 0; color: var(--text-primary);">
                        <i class="fas fa-lightbulb"></i> <strong>Example:</strong> If you have 5 miners and 3 pools (priorities 10, 5, 3), the system might assign 3 miners to the highest priority pool, 1 to the medium, and 1 to the lowest - automatically adjusting if any pool's health degrades.
                    </p>
                </div>
            </div>

            <!-- Comparison -->
            <div style="border-top: 2px solid var(--border); padding-top: 1.5rem;">
                <h3 style="color: var(--text-primary); margin-bottom: 1rem;">
                    <i class="fas fa-balance-scale-right"></i> Quick Comparison
                </h3>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Feature</th>
                            <th>Round Robin</th>
                            <th>Load Balance</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>All miners same pool?</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                        </tr>
                        <tr>
                            <td>Time-based switching</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                        </tr>
                        <tr>
                            <td>Health-based switching</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                        </tr>
                        <tr>
                            <td>Predictable rotation</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                        </tr>
                        <tr>
                            <td>Best for solo mining</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                        </tr>
                        <tr>
                            <td>Best for efficiency</td>
                            <td><i class="fas fa-times text-danger"></i> No</td>
                            <td><i class="fas fa-check text-success"></i> Yes</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Important Notes -->
            <div style="background: var(--warning-background); border-left: 4px solid var(--warning); padding: 1rem; border-radius: 4px; margin-top: 1.5rem;">
                <h4 style="color: var(--text-primary); margin-top: 0;">
                    <i class="fas fa-exclamation-triangle"></i> Important Notes
                </h4>
                <ul style="color: var(--text-primary); margin-bottom: 0;">
                    <li><strong>Multiple strategies allowed:</strong> You can run multiple strategies simultaneously, but each miner can only be in one strategy at a time</li>
                    <li><strong>Miner selection:</strong> Select specific miners for each strategy, or leave unselected to apply to all miners not in other strategies</li>
                    <li><strong>Avalon Nano limitations:</strong> These miners can only switch between their 3 pre-configured pool slots</li>
                    <li><strong>Manual execution:</strong> You can trigger any enabled strategy immediately with the "Execute Now" button</li>
                    <li><strong>Strategy interval:</strong> The system checks and executes strategies every minute</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}
