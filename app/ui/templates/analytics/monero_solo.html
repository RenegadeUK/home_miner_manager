{% extends "base.html" %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
<style>
.analytics-container {
    max-width: 1400px;
    margin: 0 auto;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.detail-card-header {
    background: var(--card-header);
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
}

.detail-card-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.detail-card-icon {
    font-size: 1.75rem;
}

.detail-card-body {
    padding: 2rem;
}

.time-selector {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.time-selector .btn {
    padding: 0.5rem 1rem;
    background: var(--card-header);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.time-selector .btn:hover {
    background: var(--bg-hover);
}

.time-selector .btn.active {
    background: #ff6600;
    color: white;
    border-color: #ff6600;
}

.chart-container {
    position: relative;
    height: 300px;
    margin-top: 1rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-box {
    background: var(--card-header);
    padding: 1.25rem;
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
}

.stat-subtext {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

table thead {
    background: var(--card-header);
}

table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 2px solid var(--border-color);
}

table td {
    padding: 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-primary);
}

table tbody tr:hover {
    background: var(--card-header);
}

.badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
}

.badge-success {
    background: rgba(16, 185, 129, 0.2);
    color: #10b981;
}

.badge-warning {
    background: rgba(245, 158, 11, 0.2);
    color: #f59e0b;
}

.badge-danger {
    background: rgba(239, 68, 68, 0.2);
    color: #ef4444;
}

.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

.empty-state-text {
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
}

.empty-state-subtext {
    font-size: 0.875rem;
}

.monero-logo {
    color: #ff6600;
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- 24-Hour Hashrate Chart (Top) -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>
                <span class="detail-card-icon">ðŸ“ˆ</span>
                24-Hour Hashrate History
            </h3>
        </div>
        <div class="detail-card-body">
            <div class="chart-container">
                <canvas id="hashrate-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>
                <span class="detail-card-icon monero-logo">âŸ </span>
                Mining Statistics
            </h3>
        </div>
        <div class="detail-card-body">
            <div class="stats-grid" id="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Total Blocks (12mo)</div>
                    <div class="stat-value" id="stat-blocks">0</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Average Effort</div>
                    <div class="stat-value" id="stat-avg-effort">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Median Effort</div>
                    <div class="stat-value" id="stat-median-effort">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Best Effort</div>
                    <div class="stat-value" id="stat-best-effort">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Worst Effort</div>
                    <div class="stat-value" id="stat-worst-effort">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Avg Time to Block</div>
                    <div class="stat-value" id="stat-avg-time">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Total Rewards</div>
                    <div class="stat-value" id="stat-rewards">-</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Recent Activity</div>
                    <div class="stat-value" id="stat-recent">
                        <small><span id="blocks-24h">-</span> / <span id="blocks-7d">-</span> / <span id="blocks-30d">-</span></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Effort Over Time Chart -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>
                <span class="detail-card-icon">âš¡</span>
                Effort % Over Time (12 months)
            </h3>
        </div>
        <div class="detail-card-body">
            <div class="chart-container">
                <canvas id="effort-chart"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Blocks Table -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>
                <span class="detail-card-icon">ðŸŽ¯</span>
                Recent Blocks
            </h3>
        </div>
        <div class="detail-card-body">
            <div id="blocks-container">
                <div class="empty-state">
                    <div class="empty-state-icon">âŸ </div>
                    <div class="empty-state-text">No blocks found yet</div>
                    <div class="empty-state-subtext">Keep mining - your first block is coming!</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wallet Transactions -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>
                <span class="detail-card-icon">ðŸ’°</span>
                Wallet Transactions
            </h3>
        </div>
        <div class="detail-card-body">
            <div id="transactions-container">
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ’°</div>
                    <div class="empty-state-text">No transactions yet</div>
                    <div class="empty-state-subtext">Wallet transactions will appear here</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let hashrateChart = null;
let effortChart = null;
let xmrPriceGBP = 0;

// Initialize
async function initAnalytics() {
    await loadCryptoPrice();
    await loadAnalytics();
    
    // Auto-refresh every 30 seconds
    setInterval(loadAnalytics, 30000);
}

// Load crypto price
async function loadCryptoPrice() {
    try {
        const response = await fetch('/api/settings/crypto-prices');
        const data = await response.json();
        if (data.success) {
            xmrPriceGBP = data.monero || 0;
        }
    } catch (error) {
        console.error('Failed to load crypto price:', error);
    }
}

// Load analytics data
async function loadAnalytics() {
    try {
        const response = await fetch('/api/analytics/monero-solo');
        const data = await response.json();
        
        if (!data.enabled) {
            window.location.href = '/settings/monero-solo';
            return;
        }
        
        updateOverviewStats(data);
        updateHashrateChart(data.hashrate_history);
        updateEffortChart(data.effort_history);
        updateBlocksTable(data.blocks);
        updateTransactionsTable(data.transactions);
        
    } catch (error) {
        console.error('Failed to load analytics:', error);
    }
}

// Update overview stats
function updateOverviewStats(data) {
    // Calculate effort stats from blocks
    const blocks = data.blocks || [];
    const efforts = blocks.map(b => b.effort_percent).filter(e => e > 0);
    
    const avgEffort = efforts.length > 0 ? (efforts.reduce((a,b) => a+b, 0) / efforts.length) : 0;
    const medianEffort = efforts.length > 0 ? efforts.sort((a,b) => a-b)[Math.floor(efforts.length/2)] : 0;
    const bestEffort = efforts.length > 0 ? Math.min(...efforts) : 0;
    const worstEffort = efforts.length > 0 ? Math.max(...efforts) : 0;
    
    // Calculate average time between blocks
    let avgTime = '-';
    if (blocks.length >= 2) {
        const times = [];
        for (let i = 1; i < blocks.length; i++) {
            const diff = new Date(blocks[i-1].timestamp) - new Date(blocks[i].timestamp);
            times.push(Math.abs(diff) / 1000 / 3600); // hours
        }
        const avgHours = times.reduce((a,b) => a+b, 0) / times.length;
        avgTime = avgHours.toFixed(1) + 'h';
    }
    
    // Count blocks in time periods
    const now = new Date();
    const blocks24h = blocks.filter(b => (now - new Date(b.timestamp)) < 86400000).length;
    const blocks7d = blocks.filter(b => (now - new Date(b.timestamp)) < 604800000).length;
    const blocks30d = blocks.filter(b => (now - new Date(b.timestamp)) < 2592000000).length;
    
    // Update stats
    document.getElementById('stat-blocks').textContent = blocks.length;
    document.getElementById('stat-avg-effort').textContent = avgEffort > 0 ? avgEffort.toFixed(1) + '%' : '-';
    document.getElementById('stat-median-effort').textContent = medianEffort > 0 ? medianEffort.toFixed(1) + '%' : '-';
    document.getElementById('stat-best-effort').textContent = bestEffort > 0 ? bestEffort.toFixed(1) + '%' : '-';
    document.getElementById('stat-worst-effort').textContent = worstEffort > 0 ? worstEffort.toFixed(1) + '%' : '-';
    document.getElementById('stat-avg-time').textContent = avgTime;
    document.getElementById('stat-rewards').innerHTML = (data.total_earnings_xmr || 0).toFixed(2) + '<br><small>XMR</small>';
    document.getElementById('blocks-24h').textContent = blocks24h;
    document.getElementById('blocks-7d').textContent = blocks7d;
    document.getElementById('blocks-30d').textContent = blocks30d;
}

// Update hashrate chart
function updateHashrateChart(history) {
    const ctx = document.getElementById('hashrate-chart').getContext('2d');
    
    if (hashrateChart) {
        hashrateChart.destroy();
    }
    
    const isDark = !document.documentElement.getAttribute('data-theme') || document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#f9fafb' : '#111827';
    const gridColor = isDark ? '#4a5568' : '#d1d5db';
    
    hashrateChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: history.map(h => new Date(h.timestamp).toLocaleString()),
            datasets: [{
                label: 'Hashrate (H/s)',
                data: history.map(h => h.hashrate),
                borderColor: '#ff6600',
                backgroundColor: 'rgba(255, 102, 0, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: { color: textColor }
                }
            },
            scales: {
                x: {
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                },
                y: {
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                }
            }
        }
    });
}

// Update effort chart
function updateEffortChart(history) {
    const ctx = document.getElementById('effort-chart').getContext('2d');
    
    if (effortChart) {
        effortChart.destroy();
    }
    
    const isDark = !document.documentElement.getAttribute('data-theme') || document.documentElement.getAttribute('data-theme') === 'dark';
    const textColor = isDark ? '#f9fafb' : '#111827';
    const gridColor = isDark ? '#4a5568' : '#d1d5db';
    
    effortChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Block Effort %',
                data: history.map(b => ({
                    x: new Date(b.timestamp),
                    y: b.effort_percent
                })),
                backgroundColor: 'rgba(59, 130, 246, 0.5)',
                borderColor: 'rgba(59, 130, 246, 1)',
                pointRadius: 6,
                pointHoverRadius: 8
            }, {
                label: '100% Line',
                data: history.length > 0 ? [
                    { x: new Date(history[0].timestamp), y: 100 },
                    { x: new Date(history[history.length - 1].timestamp), y: 100 }
                ] : [],
                type: 'line',
                borderColor: 'rgba(239, 68, 68, 0.5)',
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: 'day'
                    },
                    title: {
                        display: true,
                        text: 'Date',
                        color: textColor
                    },
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Effort %',
                        color: textColor
                    },
                    beginAtZero: true,
                    ticks: { color: textColor },
                    grid: { color: gridColor }
                }
            },
            plugins: {
                legend: {
                    labels: { color: textColor }
                },
                annotation: {
                    annotations: {
                        greenZone: {
                            type: 'box',
                            yMin: 0,
                            yMax: 100,
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 0
                        },
                        orangeZone: {
                            type: 'box',
                            yMin: 100,
                            yMax: 200,
                            backgroundColor: 'rgba(251, 146, 60, 0.1)',
                            borderWidth: 0
                        },
                        redZone: {
                            type: 'box',
                            yMin: 200,
                            yMax: 500,
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 0
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            if (context.datasetIndex === 1) return null;
                            return `Effort: ${context.parsed.y.toFixed(1)}%`;
                        }
                    }
                }
            }
        }
    });
}

// Update blocks table
function updateBlocksTable(blocks) {
    const container = document.getElementById('blocks-container');
    
    if (!blocks || blocks.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âŸ </div>
                <div class="empty-state-text">No blocks found yet</div>
                <div class="empty-state-subtext">Keep mining - your first block is coming!</div>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Block Height</th>
                        <th>Timestamp</th>
                        <th>Reward (XMR)</th>
                        <th>Reward (GBP)</th>
                        <th>Hash</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    blocks.forEach(block => {
        const timestamp = new Date(block.timestamp).toLocaleString();
        const rewardGBP = (block.reward_xmr * xmrPriceGBP).toFixed(2);
        const hashShort = block.block_hash.substring(0, 16) + '...';
        
        html += `
            <tr>
                <td><strong>${block.block_height}</strong></td>
                <td>${timestamp}</td>
                <td>${block.reward_xmr.toFixed(6)} XMR</td>
                <td>Â£${rewardGBP}</td>
                <td><code style="font-size: 0.85rem;">${hashShort}</code></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// Update transactions table
function updateTransactionsTable(transactions) {
    const container = document.getElementById('transactions-container');
    
    if (!transactions || transactions.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ’°</div>
                <div class="empty-state-text">No transactions yet</div>
                <div class="empty-state-subtext">Wallet transactions will appear here</div>
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Amount (XMR)</th>
                        <th>Amount (GBP)</th>
                        <th>Confirmations</th>
                        <th>TX Hash</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    transactions.forEach(tx => {
        const timestamp = new Date(tx.timestamp).toLocaleString();
        const amountGBP = (tx.amount_xmr * xmrPriceGBP).toFixed(2);
        const hashShort = tx.tx_hash.substring(0, 16) + '...';
        const confClass = tx.confirmations >= 10 ? 'badge-success' : 'badge-warning';
        
        html += `
            <tr>
                <td>${timestamp}</td>
                <td>${tx.amount_xmr.toFixed(6)} XMR</td>
                <td>Â£${amountGBP}</td>
                <td><span class="badge ${confClass}">${tx.confirmations}</span></td>
                <td><code style="font-size: 0.85rem;">${hashShort}</code></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    container.innerHTML = html;
}

// Initialize on page load
initAnalytics();
</script>
{% endblock %}
