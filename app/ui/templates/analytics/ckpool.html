{% extends "base.html" %}

{% block title %}CKPool {{ coin }} Analytics - Home Miner Manager{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
<style>
.analytics-container {
    max-width: 1400px;
    margin: 0 auto;
}

.coin-selector {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
}

.coin-btn {
    padding: 0.5rem 1rem;
    border: 2px solid var(--border-color);
    background: var(--card-bg);
    color: var(--text-primary);
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.coin-btn:hover {
    background: var(--bg-hover);
    transform: translateY(-2px);
}

.coin-btn.active {
    background: var(--info);
    color: white;
    border-color: var(--info);
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
}

.stat-label {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-value small {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 400;
}

.chart-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.chart-card h3 {
    margin: 0 0 1.5rem 0;
    color: var(--text-primary);
    font-size: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.blocks-table {
    width: 100%;
    border-collapse: collapse;
    background: var(--card-bg);
    border-radius: 12px;
    overflow: hidden;
}

.blocks-table thead {
    background: var(--card-header);
}

.blocks-table th {
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
}

.blocks-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
}

.blocks-table tr:hover {
    background: var(--bg-hover);
}

.effort-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.875rem;
}

.effort-excellent { background: #10b981; color: white; }
.effort-good { background: #34d399; color: white; }
.effort-average { background: #fbbf24; color: black; }
.effort-poor { background: #fb923c; color: white; }
.effort-bad { background: #ef4444; color: white; }

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-secondary);
}

.empty-state-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <h1>üìä CKPool Mining Analytics</h1>
    
    <!-- Coin Selector -->
    <div class="coin-selector">
        <a href="/analytics/ckpool?coin=BTC" class="coin-btn {% if coin == 'BTC' %}active{% endif %}">
            <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="#f7931a"/><path fill="#fff" d="M23.189 14.02c.314-2.096-1.283-3.223-3.465-3.975l.708-2.84-1.728-.43-.69 2.765c-.454-.113-.92-.22-1.385-.326l.695-2.783L15.596 6l-.708 2.839c-.376-.086-.746-.17-1.104-.26l.002-.009-2.384-.595-.46 1.846s1.283.294 1.256.312c.7.175.826.638.805 1.006l-.806 3.235c.048.012.11.03.18.057l-.183-.045-1.13 4.532c-.086.212-.303.531-.793.41.018.025-1.256-.313-1.256-.313l-.858 1.978 2.25.561c.418.105.828.215 1.231.318l-.715 2.872 1.727.43.708-2.84c.472.127.93.245 1.378.357l-.706 2.828 1.728.43.715-2.866c2.948.558 5.164.333 6.097-2.333.752-2.146-.037-3.385-1.588-4.192 1.13-.26 1.98-1.003 2.207-2.538zm-3.95 5.538c-.533 2.147-4.148.986-5.32.695l.95-3.805c1.172.293 4.929.872 4.37 3.11zm.535-5.569c-.487 1.953-3.495.96-4.47.717l.86-3.45c.975.243 4.118.696 3.61 2.733z"/></svg>
            Bitcoin
        </a>
        <a href="/analytics/ckpool?coin=BCH" class="coin-btn {% if coin == 'BCH' %}active{% endif %}">
            <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="#8dc351"/><path fill="#fff" d="M23.189 14.02c.314-2.096-1.283-3.223-3.465-3.975l.708-2.84-1.728-.43-.69 2.765c-.454-.113-.92-.22-1.385-.326l.695-2.783L15.596 6l-.708 2.839c-.376-.086-.746-.17-1.104-.26l.002-.009-2.384-.595-.46 1.846s1.283.294 1.256.312c.7.175.826.638.805 1.006l-.806 3.235c.048.012.11.03.18.057l-.183-.045-1.13 4.532c-.086.212-.303.531-.793.41.018.025-1.256-.313-1.256-.313l-.858 1.978 2.25.561c.418.105.828.215 1.231.318l-.715 2.872 1.727.43.708-2.84c.472.127.93.245 1.378.357l-.706 2.828 1.728.43.715-2.866c2.948.558 5.164.333 6.097-2.333.752-2.146-.037-3.385-1.588-4.192 1.13-.26 1.98-1.003 2.207-2.538zm-3.95 5.538c-.533 2.147-4.148.986-5.32.695l.95-3.805c1.172.293 4.929.872 4.37 3.11zm.535-5.569c-.487 1.953-3.495.96-4.47.717l.86-3.45c.975.243 4.118.696 3.61 2.733z"/></svg>
            Bitcoin Cash
        </a>
        <a href="/analytics/ckpool?coin=DGB" class="coin-btn {% if coin == 'DGB' %}active{% endif %}">
            <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg"><circle cx="16" cy="16" r="16" fill="#006AD2"/><path fill="#fff" d="M16 6l-8 4v12l8 4 8-4V10l-8-4zm5.5 14.5l-5.5 2.75-5.5-2.75v-9l5.5-2.75 5.5 2.75v9z"/></svg>
            DigiByte
        </a>
    </div>

    <!-- Statistics Cards -->
    <div id="stats-grid" class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Total Blocks (12mo)</div>
            <div class="stat-value" id="stat-total">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Average Effort</div>
            <div class="stat-value" id="stat-avg-effort">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Median Effort</div>
            <div class="stat-value" id="stat-median-effort">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Best Effort</div>
            <div class="stat-value" id="stat-best-effort">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Worst Effort</div>
            <div class="stat-value" id="stat-worst-effort">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Avg Time to Block</div>
            <div class="stat-value" id="stat-avg-time">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Total Rewards</div>
            <div class="stat-value" id="stat-rewards">-</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Recent Activity</div>
            <div class="stat-value" id="stat-recent">
                <small><span id="blocks-24h">-</span> / <span id="blocks-7d">-</span> / <span id="blocks-30d">-</span></small>
            </div>
        </div>
    </div>

    <!-- Effort Over Time Chart -->
    <div class="chart-card">
        <h3>‚ö° Effort % Over Time (12 months)</h3>
        <canvas id="effortChart" height="80"></canvas>
    </div>

    <!-- Recent Blocks Table -->
    <div class="chart-card">
        <h3>üéØ Recent Blocks</h3>
        <div style="overflow-x: auto;">
            <table class="blocks-table" id="blocks-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Block Height</th>
                        <th>Block Hash</th>
                        <th>Effort %</th>
                        <th>Time to Block</th>
                    </tr>
                </thead>
                <tbody id="blocks-tbody">
                    <tr><td colspan="5" style="text-align: center; padding: 2rem;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const coin = "{{ coin }}";
let effortChart = null;

function getEffortClass(effort) {
    if (effort < 50) return 'effort-excellent';
    if (effort < 80) return 'effort-good';
    if (effort < 120) return 'effort-average';
    if (effort < 150) return 'effort-poor';
    return 'effort-bad';
}

function formatDuration(seconds) {
    if (!seconds) return 'Unknown';
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    if (hours > 0) return `${hours}h ${minutes}m`;
    return `${minutes}m`;
}

async function loadAnalytics() {
    try {
        const response = await fetch(`/api/analytics/ckpool/analytics?coin=${coin}`);
        const data = await response.json();

        // Update stats
        document.getElementById('stat-total').textContent = data.stats.total_blocks;
        document.getElementById('stat-avg-effort').textContent = data.stats.average_effort.toFixed(1) + '%';
        document.getElementById('stat-median-effort').textContent = data.stats.median_effort.toFixed(1) + '%';
        document.getElementById('stat-best-effort').textContent = data.stats.best_effort.toFixed(1) + '%';
        document.getElementById('stat-worst-effort').textContent = data.stats.worst_effort.toFixed(1) + '%';
        document.getElementById('stat-avg-time').textContent = data.stats.average_time_to_block_hours 
            ? data.stats.average_time_to_block_hours.toFixed(1) + 'h'
            : 'N/A';
        document.getElementById('stat-rewards').innerHTML = data.stats.total_rewards.toFixed(2) + `<br><small>${coin}</small>`;
        document.getElementById('blocks-24h').textContent = data.stats.blocks_24h;
        document.getElementById('blocks-7d').textContent = data.stats.blocks_7d;
        document.getElementById('blocks-30d').textContent = data.stats.blocks_30d;

        // Build chart
        if (data.blocks.length > 0) {
            const chartData = data.blocks.slice().reverse(); // Oldest first for chart
            
            if (effortChart) effortChart.destroy();
            
            const ctx = document.getElementById('effortChart').getContext('2d');
            effortChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Block Effort %',
                        data: chartData.map(b => ({
                            x: new Date(b.timestamp),
                            y: b.effort_percent
                        })),
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }, {
                        label: '100% Line',
                        data: [
                            { x: new Date(chartData[0].timestamp), y: 100 },
                            { x: new Date(chartData[chartData.length - 1].timestamp), y: 100 }
                        ],
                        type: 'line',
                        borderColor: 'rgba(239, 68, 68, 0.5)',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Effort %'
                            },
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.datasetIndex === 1) return null;
                                    return `Effort: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        } else {
            document.getElementById('effortChart').parentElement.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <h3>No blocks found</h3>
                    <p>No blocks have been mined for ${coin} in the last 12 months.</p>
                </div>
            `;
        }

        // Build table
        const tbody = document.getElementById('blocks-tbody');
        if (data.blocks.length > 0) {
            tbody.innerHTML = data.blocks.slice(0, 20).map(block => `
                <tr>
                    <td>${new Date(block.timestamp).toLocaleString()}</td>
                    <td><code>${block.block_height}</code></td>
                    <td><code style="font-size: 0.75rem;">${block.block_hash.substring(0, 16)}...</code></td>
                    <td><span class="effort-badge ${getEffortClass(block.effort_percent)}">${block.effort_percent.toFixed(1)}%</span></td>
                    <td>${formatDuration(block.time_to_block_seconds)}</td>
                </tr>
            `).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No blocks found for this coin</td></tr>';
        }

    } catch (error) {
        console.error('Failed to load analytics:', error);
        document.getElementById('stats-grid').innerHTML = `
            <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="empty-state-icon">‚ùå</div>
                <h3>Failed to load analytics</h3>
                <p>Error: ${error.message}</p>
            </div>
        `;
    }
}

// Load on page load
loadAnalytics();
</script>
{% endblock %}
