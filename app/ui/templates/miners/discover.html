{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Network Discovery</h2>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn btn-primary" onclick="startScan()" id="scan-btn">
                üîç Scan Network
            </button>
            <a href="/miners/add" class="btn btn-secondary">Manual Add</a>
        </div>
    </div>
    
    <div class="discovery-info" style="padding: 1.5rem; border-bottom: 1px solid var(--border-color); background-color: var(--bg-secondary);">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Network Range</div>
                <div style="font-weight: 600;" id="network-range">Loading...</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Total Found</div>
                <div style="font-weight: 600; font-size: 1.5rem; color: var(--primary-color);" id="total-found">‚Äî</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">New Miners</div>
                <div style="font-weight: 600; font-size: 1.5rem; color: var(--success-color);" id="new-miners">‚Äî</div>
            </div>
            <div>
                <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Already Added</div>
                <div style="font-weight: 600; font-size: 1.5rem; color: var(--text-secondary);" id="existing-miners">‚Äî</div>
            </div>
        </div>
    </div>
    
    <div id="scan-status" style="padding: 1.5rem; display: none;">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <div class="spinner"></div>
            <div>
                <div style="font-weight: 600;">Scanning network...</div>
                <div style="font-size: 0.875rem; color: var(--text-secondary);">This may take 30-60 seconds depending on network size</div>
            </div>
        </div>
    </div>
    
    <div id="results-container" style="padding: 1.5rem; display: none;">
        <h3 style="margin-bottom: 1rem;">Discovered Miners</h3>
        <div id="results-list"></div>
    </div>
    
    <div id="no-results" style="padding: 1.5rem; display: none;">
        <p class="text-muted">No miners found. Try:</p>
        <ul class="text-muted" style="margin-left: 1.5rem;">
            <li>Ensure miners are powered on and connected to the network</li>
            <li>Check that you're on the same network as the miners</li>
            <li>Manually add miners if discovery doesn't work</li>
        </ul>
    </div>
</div>

<style>
.spinner {
    width: 24px;
    height: 24px;
    border: 3px solid var(--border-color);
    border-top-color: var(--primary-color);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.discovered-miner {
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
    background-color: var(--bg-secondary);
}

.discovered-miner.already-added {
    opacity: 0.6;
}

.miner-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.miner-title {
    font-weight: 600;
    font-size: 1.125rem;
}

.miner-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 0.75rem;
    font-size: 0.875rem;
}

.detail-item {
    display: flex;
    flex-direction: column;
}

.detail-label {
    color: var(--text-secondary);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.detail-value {
    color: var(--text-primary);
    font-weight: 500;
}

@media (max-width: 768px) {
    .miner-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }
}
</style>

<script>
async function loadNetworkInfo() {
    try {
        const response = await fetch('/api/discovery/network-info');
        const data = await response.json();
        document.getElementById('network-range').textContent = data.network_cidr;
    } catch (error) {
        console.error('Failed to load network info:', error);
        document.getElementById('network-range').textContent = 'Auto-detect';
    }
}

async function startScan() {
    const scanBtn = document.getElementById('scan-btn');
    const scanStatus = document.getElementById('scan-status');
    const resultsContainer = document.getElementById('results-container');
    const noResults = document.getElementById('no-results');
    
    // Hide previous results
    resultsContainer.style.display = 'none';
    noResults.style.display = 'none';
    
    // Show scanning status
    scanStatus.style.display = 'block';
    scanBtn.disabled = true;
    scanBtn.textContent = '‚è≥ Scanning...';
    
    try {
        const response = await fetch('/api/discovery/scan', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({})
        });
        
        if (!response.ok) {
            throw new Error('Scan failed');
        }
        
        const data = await response.json();
        
        // Update stats
        document.getElementById('total-found').textContent = data.total_found;
        document.getElementById('new-miners').textContent = data.new_miners;
        document.getElementById('existing-miners').textContent = data.existing_miners;
        
        // Hide scanning status
        scanStatus.style.display = 'none';
        
        if (data.total_found === 0) {
            noResults.style.display = 'block';
        } else {
            renderResults(data.miners);
            resultsContainer.style.display = 'block';
        }
        
    } catch (error) {
        console.error('Scan error:', error);
        alert('Failed to scan network: ' + error.message);
        scanStatus.style.display = 'none';
    } finally {
        scanBtn.disabled = false;
        scanBtn.textContent = 'üîç Scan Network';
    }
}

function renderResults(miners) {
    const resultsList = document.getElementById('results-list');
    
    const html = miners.map(miner => `
        <div class="discovered-miner ${miner.already_added ? 'already-added' : ''}">
            <div class="miner-header">
                <div>
                    <div class="miner-title">
                        ${miner.name}
                        ${miner.already_added ? '<span class="badge badge-info" style="margin-left: 0.5rem;">Already Added</span>' : ''}
                    </div>
                    <div style="font-size: 0.875rem; color: var(--text-secondary); margin-top: 0.25rem;">
                        <span class="badge badge-${getTypeBadge(miner.type)}">${formatType(miner.type)}</span>
                    </div>
                </div>
                ${!miner.already_added ? `
                    <button class="btn btn-primary btn-sm" onclick="addMiner('${miner.ip}', ${miner.port}, '${miner.type}', '${miner.name.replace(/'/g, "\\'")}')">
                        + Add Miner
                    </button>
                ` : `
                    <span class="badge badge-success">‚úì Configured</span>
                `}
            </div>
            <div class="miner-details">
                <div class="detail-item">
                    <div class="detail-label">IP Address</div>
                    <div class="detail-value">${miner.ip}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Port</div>
                    <div class="detail-value">${miner.port}</div>
                </div>
                ${Object.entries(miner.details).map(([key, value]) => `
                    <div class="detail-item">
                        <div class="detail-label">${formatLabel(key)}</div>
                        <div class="detail-value">${value || '‚Äî'}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');
    
    resultsList.innerHTML = html;
}

function getTypeBadge(type) {
    const badges = {
        'avalon_nano': 'warning',
        'bitaxe': 'info',
        'nerdqaxe': 'success'
    };
    return badges[type] || 'secondary';
}

function formatType(type) {
    const types = {
        'avalon_nano': 'Avalon Nano',
        'bitaxe': 'Bitaxe',
        'nerdqaxe': 'NerdQaxe++'
    };
    return types[type] || type;
}

function formatLabel(key) {
    return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
}

async function addMiner(ip, port, type, name) {
    // Redirect to add miner page with pre-filled data
    const params = new URLSearchParams({
        ip: ip,
        port: port,
        type: type,
        name: name
    });
    window.location.href = `/miners/add?${params.toString()}`;
}

// Load network info on page load
loadNetworkInfo();
</script>
{% endblock %}
