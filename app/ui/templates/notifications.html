{% extends "base.html" %}

{% block extra_head %}
<style>
.notifications-container {
    max-width: 1400px;
    margin: 0 auto;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    margin-bottom: 2rem;
}

.detail-card-header {
    display: flex;
    align-items: center;
    padding: 1.5rem;
    background: var(--card-header);
    border-bottom: 1px solid var(--border-color);
}

.detail-card-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.detail-card-header h3 {
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
}

.detail-card-body {
    padding: 1.5rem;
}

.channel-section {
    background: var(--input-bg);
    border: 1px solid #374151;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.channel-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.channel-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.channel-title h4 {
    margin: 0;
    font-size: 1.125rem;
    color: var(--text-primary);
}

.channel-description {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.form-row {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.form-input {
    width: 100%;
    padding: 0.625rem;
    background: var(--card-header);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.9375rem;
}

.form-input:focus {
    outline: none;
    border-color: #3b82f6;
}

.form-hint {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.375rem;
}

.form-hint a {
    color: #60a5fa;
    text-decoration: none;
}

.form-hint a:hover {
    text-decoration: underline;
}

.button-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
}

.alert-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: var(--input-bg);
    border: 1px solid #374151;
    border-radius: 8px;
    margin-bottom: 0.75rem;
}

.alert-info strong {
    color: var(--text-primary);
    display: block;
    margin-bottom: 0.25rem;
}

.alert-description {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.table-container {
    border-radius: 6px;
    border: 1px solid #374151;
    overflow: hidden;
}

#notifications-log {
    width: 100%;
    border-collapse: collapse;
}

#notifications-log thead {
    background: var(--card-header);
}

#notifications-log th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.875rem;
    color: var(--text-primary);
    border-bottom: 1px solid var(--border-color);
}

#notifications-log td {
    padding: 0.75rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
    border-bottom: 1px solid #374151;
}

.badge {
    padding: 0.25rem 0.625rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-success {
    background: #10b981;
    color: white;
}

.badge-error {
    background: #ef4444;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="notifications-container">
    <!-- Notification Channels -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">üì°</span> Notification Channels</h3>
        </div>
        <div class="detail-card-body">
            <!-- Telegram -->
            <div class="channel-section">
                <div class="channel-header">
                    <div class="channel-title">
                        <div>
                            <h4>üì± Telegram</h4>
                            <div class="channel-description">Send alerts via Telegram Bot</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="telegram-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div id="telegram-config" style="display: none;">
                    <div class="form-row">
                        <label class="form-label">Bot Token</label>
                        <input type="text" class="form-input" id="telegram-bot-token" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                        <small class="form-hint">Get your bot token from <a href="https://t.me/BotFather" target="_blank">@BotFather</a></small>
                    </div>
                    
                    <div class="form-row">
                        <label class="form-label">Chat ID</label>
                        <input type="text" class="form-input" id="telegram-chat-id" placeholder="123456789">
                        <small class="form-hint">Send a message to your bot, then visit https://api.telegram.org/bot&lt;YOUR_BOT_TOKEN&gt;/getUpdates</small>
                    </div>
                    
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="saveTelegram()" aria-label="Save Telegram configuration">Save</button>
                        <button class="btn btn-secondary" onclick="testTelegram()" aria-label="Send test notification to Telegram">Send Test</button>
                    </div>
                </div>
            </div>
            
            <!-- Discord -->
            <div class="channel-section">
                <div class="channel-header">
                    <div class="channel-title">
                        <div>
                            <h4>üí¨ Discord</h4>
                            <div class="channel-description">Send alerts via Discord Webhook</div>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="discord-enabled">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                
                <div id="discord-config" style="display: none;">
                    <div class="form-row">
                        <label class="form-label">Webhook URL</label>
                        <input type="text" class="form-input" id="discord-webhook-url" placeholder="https://discord.com/api/webhooks/...">
                        <small class="form-hint">Create a webhook in your Discord server settings ‚Üí Integrations ‚Üí Webhooks</small>
                    </div>
                    
                    <div class="button-row">
                        <button class="btn btn-primary" onclick="saveDiscord()" aria-label="Save Discord configuration">Save</button>
                        <button class="btn btn-secondary" onclick="testDiscord()" aria-label="Send test notification to Discord">Send Test</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alert Types -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">‚ö†Ô∏è</span> Alert Types</h3>
        </div>
        <div class="detail-card-body">
            <div id="alert-types-container"></div>
        </div>
    </div>
    
    <!-- Recent Notifications -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">üìú</span> Recent Notifications</h3>
        </div>
        <div class="detail-card-body">
            <div class="table-container">
                <table id="notifications-log">
                    <thead>
                        <tr>
                            <th scope="col">Time</th>
                            <th scope="col">Channel</th>
                            <th scope="col">Alert Type</th>
                            <th scope="col">Message</th>
                            <th scope="col">Status</th>
                        </tr>
                    </thead>
                    <tbody id="notifications-log-body">
                        <tr>
                            <td colspan="5" style="text-align: center;">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: var(--bg-hover);
    transition: 0.3s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #10b981;
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}
</style>

<script>
// Default alert types
const DEFAULT_ALERTS = [
    { alert_type: 'high_temperature', label: 'High Temperature', description: 'Alert when temperature exceeds threshold', config: { threshold_celsius: 75 } },
    { alert_type: 'block_found', label: 'üéâ Block Found', description: 'Alert when any block is found (Solopool, etc.)', config: {} }
];

// Load notification channels
async function loadChannels() {
    try {
        const response = await fetch('/api/notifications/channels');
        const channels = await response.json();
        
        // Load Telegram
        const telegram = channels.find(c => c.channel_type === 'telegram');
        if (telegram) {
            document.getElementById('telegram-enabled').checked = telegram.enabled;
            document.getElementById('telegram-bot-token').value = telegram.config.bot_token || '';
            document.getElementById('telegram-chat-id').value = telegram.config.chat_id || '';
            if (telegram.enabled) {
                document.getElementById('telegram-config').style.display = 'block';
            }
        }
        
        // Load Discord
        const discord = channels.find(c => c.channel_type === 'discord');
        if (discord) {
            document.getElementById('discord-enabled').checked = discord.enabled;
            document.getElementById('discord-webhook-url').value = discord.config.webhook_url || '';
            if (discord.enabled) {
                document.getElementById('discord-config').style.display = 'block';
            }
        }
    } catch (error) {
        console.error('Failed to load channels:', error);
    }
}

// Toggle visibility of config sections
document.getElementById('telegram-enabled').addEventListener('change', function() {
    document.getElementById('telegram-config').style.display = this.checked ? 'block' : 'none';
});

document.getElementById('discord-enabled').addEventListener('change', function() {
    document.getElementById('discord-config').style.display = this.checked ? 'block' : 'none';
});

// Save Telegram config
async function saveTelegram() {
    const enabled = document.getElementById('telegram-enabled').checked;
    const botToken = document.getElementById('telegram-bot-token').value;
    const chatId = document.getElementById('telegram-chat-id').value;
    
    if (enabled && (!botToken || !chatId)) {
        alert('Please enter both Bot Token and Chat ID');
        return;
    }
    
    try {
        const response = await fetch('/api/notifications/channels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                channel_type: 'telegram',
                enabled: enabled,
                config: {
                    bot_token: botToken,
                    chat_id: chatId
                }
            })
        });
        
        if (response.ok) {
            alert('Telegram configuration saved successfully');
        } else {
            const error = await response.json();
            alert('Failed to save: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error saving configuration: ' + error.message);
    }
}

// Save Discord config
async function saveDiscord() {
    const enabled = document.getElementById('discord-enabled').checked;
    const webhookUrl = document.getElementById('discord-webhook-url').value;
    
    if (enabled && !webhookUrl) {
        alert('Please enter Webhook URL');
        return;
    }
    
    try {
        const response = await fetch('/api/notifications/channels', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                channel_type: 'discord',
                enabled: enabled,
                config: {
                    webhook_url: webhookUrl
                }
            })
        });
        
        if (response.ok) {
            alert('Discord configuration saved successfully');
        } else {
            const error = await response.json();
            alert('Failed to save: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error saving configuration: ' + error.message);
    }
}

// Test notifications
async function testTelegram() {
    try {
        const response = await fetch('/api/notifications/test/telegram', { method: 'POST' });
        if (response.ok) {
            alert('Test message sent to Telegram! Check your bot.');
        } else {
            const error = await response.json();
            alert('Failed to send: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function testDiscord() {
    try {
        const response = await fetch('/api/notifications/test/discord', { method: 'POST' });
        if (response.ok) {
            alert('Test message sent to Discord! Check your channel.');
        } else {
            const error = await response.json();
            alert('Failed to send: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Load alert types
async function loadAlertTypes() {
    try {
        const response = await fetch('/api/notifications/alerts');
        let alerts = await response.json();
        
        // If no alerts exist, initialize with defaults
        if (alerts.length === 0) {
            for (const alert of DEFAULT_ALERTS) {
                await fetch('/api/notifications/alerts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(alert)
                });
            }
            alerts = DEFAULT_ALERTS.map((a, idx) => ({ ...a, id: idx + 1, enabled: true }));
        }
        
        const container = document.getElementById('alert-types-container');
        container.innerHTML = alerts.map(alert => {
            const defaultAlert = DEFAULT_ALERTS.find(d => d.alert_type === alert.alert_type);
            const label = defaultAlert ? defaultAlert.label : alert.alert_type;
            const description = defaultAlert ? defaultAlert.description : '';
            
            return `
                <div class="alert-item">
                    <div class="alert-info">
                        <strong>${label}</strong>
                        <div class="alert-description">${description}</div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" ${alert.enabled ? 'checked' : ''} 
                               onchange="toggleAlert('${alert.alert_type}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `;
        }).join('');
    } catch (error) {
        console.error('Failed to load alert types:', error);
    }
}

// Toggle alert
async function toggleAlert(alertType, enabled) {
    try {
        const response = await fetch(`/api/notifications/alerts/${alertType}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: enabled })
        });
        
        if (!response.ok) {
            alert('Failed to update alert configuration');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

// Load notification logs
async function loadLogs() {
    try {
        const response = await fetch('/api/notifications/logs?limit=50');
        const logs = await response.json();
        
        const tbody = document.getElementById('notifications-log-body');
        
        if (logs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No notifications sent yet</td></tr>';
            return;
        }
        
        tbody.innerHTML = logs.map(log => {
            const timestamp = new Date(log.timestamp).toLocaleString();
            const statusBadge = log.success 
                ? '<span class="badge badge-success">Sent</span>' 
                : '<span class="badge badge-error">Failed</span>';
            
            return `
                <tr>
                    <td>${timestamp}</td>
                    <td>${log.channel_type}</td>
                    <td>${log.alert_type}</td>
                    <td>${log.message.substring(0, 50)}${log.message.length > 50 ? '...' : ''}</td>
                    <td>${statusBadge}</td>
                </tr>
            `;
        }).join('');
    } catch (error) {
        console.error('Failed to load logs:', error);
        document.getElementById('notifications-log-body').innerHTML = 
            '<tr><td colspan="5" style="text-align: center; color: red;">Failed to load logs</td></tr>';
    }
}

// Initialize
loadChannels();
loadAlertTypes();
loadLogs();

// Auto-refresh logs every 30 seconds
setInterval(loadLogs, 30000);
</script>
{% endblock %}
