{% extends "base.html" %}

{% block extra_head %}
<style>
.audit-container {
    padding: 1.5rem;
}

.audit-filters {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.filters-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.audit-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-box {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-top: 0.25rem;
}

.audit-table {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    overflow: hidden;
}

.audit-table table {
    width: 100%;
    border-collapse: collapse;
}

.audit-table th {
    background: var(--card-header);
    padding: 0.75rem 1rem;
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid var(--border-color);
}

.audit-table td {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border-color);
}

.audit-table tr:last-child td {
    border-bottom: none;
}

.audit-table tr:hover {
    background: var(--bg-hover);
}

.action-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.action-create { background: #10b981; color: white; }
.action-update { background: #3b82f6; color: white; }
.action-delete { background: #ef4444; color: white; }
.action-execute { background: #f59e0b; color: white; }
.action-enable { background: #8b5cf6; color: white; }
.action-disable { background: #6b7280; color: white; }

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-success { background: #10b981; color: white; }
.status-failure { background: #ef4444; color: white; }

.changes-btn {
    background: var(--info);
    color: white;
    border: none;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.75rem;
}

.changes-btn:hover {
    opacity: 0.8;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 10000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: var(--card-bg);
    border-radius: 8px;
    padding: 2rem;
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    position: relative;
}

.modal-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
}

.changes-display {
    font-family: monospace;
    font-size: 0.875rem;
    white-space: pre-wrap;
}
</style>
{% endblock %}

{% block content %}
<div class="audit-container">
    <h1>ðŸ“‹ Audit Logs</h1>
    <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">Track all configuration changes and system actions</p>
    
    <div class="audit-stats" id="stats">
        <div class="stat-box">
            <div class="stat-value" id="total-events">-</div>
            <div class="stat-label">Total Events</div>
        </div>
        <div class="stat-box">
            <div class="stat-value" id="success-rate">-</div>
            <div class="stat-label">Success Rate</div>
        </div>
    </div>
    
    <div class="audit-filters">
        <div class="filters-grid">
            <div class="form-group">
                <label>Resource Type</label>
                <select id="resource-type">
                    <option value="">All Types</option>
                    <option value="miner">Miner</option>
                    <option value="pool">Pool</option>
                    <option value="strategy">Strategy</option>
                    <option value="automation">Automation</option>
                    <option value="discovery">Discovery</option>
                    <option value="profile">Profile</option>
                </select>
            </div>
            <div class="form-group">
                <label>Action</label>
                <select id="action">
                    <option value="">All Actions</option>
                    <option value="create">Create</option>
                    <option value="update">Update</option>
                    <option value="delete">Delete</option>
                    <option value="execute">Execute</option>
                    <option value="enable">Enable</option>
                    <option value="disable">Disable</option>
                </select>
            </div>
            <div class="form-group">
                <label>Time Range</label>
                <select id="days">
                    <option value="1">Last 24 hours</option>
                    <option value="7" selected>Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 90 days</option>
                </select>
            </div>
        </div>
        <button class="btn btn-primary" onclick="loadLogs()">Apply Filters</button>
    </div>
    
    <div class="audit-table">
        <table>
            <thead>
                <tr>
                    <th scope="col">Timestamp</th>
                    <th scope="col">Action</th>
                    <th scope="col">Resource</th>
                    <th scope="col">User</th>
                    <th scope="col">IP Address</th>
                    <th scope="col">Status</th>
                    <th scope="col">Changes</th>
                </tr>
            </thead>
            <tbody id="logs-table">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 2rem;">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal" id="changes-modal" onclick="closeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeModal()">Ã—</button>
        <h2>Change Details</h2>
        <div class="changes-display" id="changes-content"></div>
    </div>
</div>

<script>
let currentLogs = [];

async function loadLogs() {
    const resourceType = document.getElementById('resource-type').value;
    const action = document.getElementById('action').value;
    const days = document.getElementById('days').value;
    
    const params = new URLSearchParams({ days });
    if (resourceType) params.append('resource_type', resourceType);
    if (action) params.append('action', action);
    
    try {
        const response = await fetch(`/api/audit/logs?${params}`);
        currentLogs = await response.json();
        renderLogs(currentLogs);
    } catch (error) {
        console.error('Error loading logs:', error);
        document.getElementById('logs-table').innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--danger);">Failed to load logs</td></tr>';
    }
}

async function loadStats() {
    const days = document.getElementById('days').value;
    
    try {
        const response = await fetch(`/api/audit/stats?days=${days}`);
        const stats = await response.json();
        
        document.getElementById('total-events').textContent = stats.total_events;
        document.getElementById('success-rate').textContent = `${stats.success_rate.toFixed(1)}%`;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

function renderLogs(logs) {
    const tbody = document.getElementById('logs-table');
    
    if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No audit logs found</td></tr>';
        return;
    }
    
    tbody.innerHTML = logs.map(log => `
        <tr>
            <td>${new Date(log.timestamp).toLocaleString()}</td>
            <td><span class="action-badge action-${log.action}">${log.action}</span></td>
            <td>
                <strong>${log.resource_type}</strong>
                ${log.resource_name ? `<br><small style="color: var(--text-secondary);">${log.resource_name}</small>` : ''}
            </td>
            <td>${log.user}</td>
            <td>${log.ip_address || '-'}</td>
            <td><span class="status-badge status-${log.status}">${log.status}</span></td>
            <td>
                ${log.changes ? `<button class="changes-btn" onclick="showChanges(${log.id})">View</button>` : '-'}
            </td>
        </tr>
    `).join('');
}

function showChanges(logId) {
    const log = currentLogs.find(l => l.id === logId);
    if (!log || !log.changes) return;
    
    const content = JSON.stringify(log.changes, null, 2);
    document.getElementById('changes-content').textContent = content;
    document.getElementById('changes-modal').classList.add('active');
}

function closeModal() {
    document.getElementById('changes-modal').classList.remove('active');
}

// Load data on page load
loadLogs();
loadStats();

// Reload when time range changes
document.getElementById('days').addEventListener('change', () => {
    loadLogs();
    loadStats();
});
</script>
{% endblock %}
