{% extends "base.html" %}

{% block content %}
<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Miners</div>
        <div class="stat-value" id="total-miners">{{ miners_count }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total Hashrate</div>
        <div class="stat-value" id="total-hashrate">0 GH/s</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Current Energy Price</div>
        <div class="stat-value" id="energy-price">-- p/kWh</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">24h Total Cost</div>
        <div class="stat-value" id="total-cost-24h">£0.00</div>
    </div>
</div>

<!-- Miners Overview -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Miners Overview</h2>
    </div>
    <div class="table-container" id="miners-table">
        <p class="text-muted">Loading miners...</p>
    </div>
</div>

<!-- Recent Events -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Recent Events</h2>
    </div>
    <div id="events-list">
        <p class="text-muted">No recent events</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load dashboard data
async function loadDashboard() {
    try {
        // Single optimized API call that returns everything
        const response = await fetch('/api/dashboard/all');
        const data = await response.json();
        
        // Update stats
        const stats = data.stats;
        document.getElementById('total-miners').textContent = stats.total_miners;
        document.getElementById('total-hashrate').textContent = formatHashrate(stats.total_hashrate_ghs);
        document.getElementById('energy-price').textContent = 
            stats.current_energy_price_pence ? stats.current_energy_price_pence.toFixed(2) + ' p/kWh' : '-- p/kWh';
        document.getElementById('total-cost-24h').textContent = 
            stats.total_cost_24h_pounds !== undefined ? '£' + stats.total_cost_24h_pounds.toFixed(2) : '£0.00';
        
        // Update miners table
        const miners = data.miners;
        const minersTable = document.getElementById('miners-table');
        if (miners.length === 0) {
            minersTable.innerHTML = '<p class="text-muted">No miners configured</p>';
        } else {
            // Desktop table view
            const tableHTML = `
                <table class="desktop-only">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Hashrate</th>
                            <th>Power</th>
                            <th>Pool</th>
                            <th>24h Cost</th>
                            <th>Status</th>
                            <th>Mode</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${miners.map(m => `
                            <tr>
                                <td><a href="/miners/${m.id}">${m.name}</a></td>
                                <td>${m.miner_type}</td>
                                <td>${formatHashrate(m.hashrate)}</td>
                                <td>${m.power > 0 ? m.power.toFixed(1) + ' W' : '--'}</td>
                                <td>${m.pool}</td>
                                <td>£${m.cost_24h.toFixed(2)}</td>
                                <td><span class="badge ${m.enabled ? 'badge-success' : 'badge-error'}">${m.enabled ? 'Enabled' : 'Disabled'}</span></td>
                                <td>${m.current_mode || '--'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            // Mobile card view
            const cardsHTML = `
                <div class="mobile-cards">
                    ${miners.map(m => `
                        <div class="mobile-card">
                            <div class="mobile-card-header">
                                <a href="/miners/${m.id}" class="mobile-card-title">${m.name}</a>
                                <span class="badge ${m.enabled ? 'badge-success' : 'badge-error'}">${m.enabled ? 'Enabled' : 'Disabled'}</span>
                            </div>
                            <div class="mobile-card-body">
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Type:</span>
                                    <span>${m.miner_type}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Hashrate:</span>
                                    <span>${formatHashrate(m.hashrate)}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Power:</span>
                                    <span>${m.power > 0 ? m.power.toFixed(1) + ' W' : '--'}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Pool:</span>
                                    <span>${m.pool}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">24h Cost:</span>
                                    <span>£${m.cost_24h.toFixed(2)}</span>
                                </div>
                                <div class="mobile-card-row">
                                    <span class="mobile-card-label">Mode:</span>
                                    <span>${m.current_mode || '--'}</span>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            minersTable.innerHTML = tableHTML + cardsHTML;
        }
        
        // Update recent events
        const events = data.events;
        
        const eventsList = document.getElementById('events-list');
        if (!events || events.length === 0) {
            eventsList.innerHTML = '<p class="text-muted">No recent events</p>';
        } else {
            // Desktop table view
            const tableHTML = `
                <table class="desktop-only">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Source</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${events.map(e => {
                            const date = new Date(e.timestamp);
                            const typeClass = e.event_type === 'error' ? 'badge-error' : 
                                            e.event_type === 'warning' ? 'badge-warning' :
                                            e.event_type === 'alert' ? 'badge-warning' : 'badge-info';
                            return `
                                <tr>
                                    <td>${date.toLocaleString()}</td>
                                    <td><span class="badge ${typeClass}">${e.event_type}</span></td>
                                    <td>${e.source}</td>
                                    <td>${e.message}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            
            // Mobile card view
            const cardsHTML = `
                <div class="mobile-cards">
                    ${events.map(e => {
                        const date = new Date(e.timestamp);
                        const typeClass = e.event_type === 'error' ? 'badge-error' : 
                                        e.event_type === 'warning' ? 'badge-warning' :
                                        e.event_type === 'alert' ? 'badge-warning' : 'badge-info';
                        return `
                            <div class="mobile-card">
                                <div class="mobile-card-header">
                                    <span class="mobile-card-title">${date.toLocaleString()}</span>
                                    <span class="badge ${typeClass}">${e.event_type}</span>
                                </div>
                                <div class="mobile-card-body">
                                    <div class="mobile-card-row">
                                        <span class="mobile-card-label">Source:</span>
                                        <span>${e.source}</span>
                                    </div>
                                    <div class="mobile-card-row">
                                        <span class="mobile-card-label">Message:</span>
                                        <span>${e.message}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            eventsList.innerHTML = tableHTML + cardsHTML;
        }
    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

loadDashboard();
setInterval(loadDashboard, 30000); // Refresh every 30s
</script>
{% endblock %}
