{% extends "base.html" %}

{% block content %}
<!-- Stats Grid -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-label">Total Miners</div>
        <div class="stat-value" id="total-miners">{{ miners_count }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Total Hashrate</div>
        <div class="stat-value" id="total-hashrate">0 GH/s</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Current Energy Price</div>
        <div class="stat-value" id="energy-price">-- p/kWh</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">24h Total Cost</div>
        <div class="stat-value" id="total-cost-24h">£0.00</div>
    </div>
</div>

<!-- Miners Overview -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Miners Overview</h2>
    </div>
    <div class="table-container" id="miners-table">
        <p class="text-muted">Loading miners...</p>
    </div>
</div>

<!-- Recent Events -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Recent Events</h2>
    </div>
    <div id="events-list">
        <p class="text-muted">No recent events</p>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load dashboard data
async function loadDashboard() {
    try {
        // Load stats
        const statsRes = await fetch('/api/dashboard/stats');
        const stats = await statsRes.json();
        
        document.getElementById('total-miners').textContent = stats.total_miners;
        document.getElementById('energy-price').textContent = 
            stats.current_energy_price_pence ? stats.current_energy_price_pence.toFixed(2) + ' p/kWh' : '-- p/kWh';
        document.getElementById('total-cost-24h').textContent = 
            stats.total_cost_24h_pounds !== undefined ? '£' + stats.total_cost_24h_pounds.toFixed(2) : '£0.00';
        
        // Load miners
        const minersRes = await fetch('/api/miners/');
        const miners = await minersRes.json();
        
        // Load pools for name mapping
        const poolsRes = await fetch('/api/pools/');
        const pools = await poolsRes.json();
        
        const minersTable = document.getElementById('miners-table');
        if (miners.length === 0) {
            minersTable.innerHTML = '<p class="text-muted">No miners configured</p>';
        } else {
            // Fetch telemetry and cost for each miner
            const minersWithData = await Promise.all(miners.map(async (m) => {
                try {
                    const telemetryRes = await fetch(`/api/miners/${m.id}/telemetry`);
                    const telemetry = await telemetryRes.json();
                    
                    const costRes = await fetch(`/api/miners/${m.id}/cost/24h`);
                    const costData = await costRes.json();
                    
                    // Match pool URL to pool name
                    let poolDisplay = telemetry?.pool_in_use || '--';
                    if (poolDisplay !== '--') {
                        // Extract hostname and port from pool_in_use
                        // Formats: "stratum+tcp://host:port" or "host:port"
                        let poolHost = poolDisplay;
                        let poolPort = null;
                        
                        // Remove protocol if present
                        if (poolHost.includes('://')) {
                            poolHost = poolHost.split('://')[1];
                        }
                        
                        // Extract port
                        if (poolHost.includes(':')) {
                            const parts = poolHost.split(':');
                            poolHost = parts[0];
                            poolPort = parseInt(parts[1]);
                        }
                        
                        // Find matching pool by URL and port
                        const matchedPool = pools.find(p => {
                            const urlMatch = p.url === poolHost;
                            const portMatch = poolPort ? p.port === poolPort : true;
                            return urlMatch && portMatch;
                        });
                        
                        if (matchedPool) {
                            poolDisplay = matchedPool.name;
                        }
                    }
                    
                    return {
                        ...m,
                        hashrate: telemetry?.hashrate || 0,
                        pool: poolDisplay,
                        cost_24h: costData?.cost_pounds || 0
                    };
                } catch (e) {
                    return {
                        ...m,
                        hashrate: 0,
                        pool: '--',
                        cost_24h: 0
                    };
                }
            }));
            
            // Calculate total hashrate from live telemetry data
            const totalHashrate = minersWithData.reduce((sum, m) => sum + (m.hashrate || 0), 0);
            document.getElementById('total-hashrate').textContent = formatHashrate(totalHashrate);
            
            minersTable.innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Hashrate</th>
                            <th>Stratum Name</th>
                            <th>Cost per 24hr</th>
                            <th>Status</th>
                            <th>Mode</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${minersWithData.map(m => `
                            <tr>
                                <td><a href="/miners/${m.id}">${m.name}</a></td>
                                <td>${m.miner_type}</td>
                                <td>${formatHashrate(m.hashrate)}</td>
                                <td>${m.pool}</td>
                                <td>£${m.cost_24h.toFixed(2)}</td>
                                <td><span class="badge ${m.enabled ? 'badge-success' : 'badge-error'}">${m.enabled ? 'Enabled' : 'Disabled'}</span></td>
                                <td>${m.current_mode || '--'}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }
    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

loadDashboard();
setInterval(loadDashboard, 30000); // Refresh every 30s
</script>
{% endblock %}
