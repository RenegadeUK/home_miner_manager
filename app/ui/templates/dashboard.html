{% extends "base.html" %}

{% block content %}
<script>
// Check for default dashboard preference and redirect if needed
(function() {
    const defaultDashboard = localStorage.getItem('defaultDashboard');
    if (defaultDashboard && defaultDashboard.startsWith('custom-')) {
        const dashboardId = defaultDashboard.replace('custom-', '');
        window.location.href = `/dashboards/${dashboardId}`;
    }
})();
</script>

<style>
/* Tab Navigation */
.dashboard-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
    border-bottom: 2px solid var(--border-color);
}

.dashboard-tab {
    padding: 0.75rem 1.5rem;
    background: none;
    border: none;
    border-bottom: 3px solid transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    transition: all 0.2s;
}

.dashboard-tab:hover {
    color: var(--text-primary);
    background: var(--bg-hover);
}

.dashboard-tab.active {
    color: var(--info);
    border-bottom-color: var(--info);
}

.tab-content {
    display: none;
}

.tab-content.active {
    display: block;
}

.stats-grid { gap: 0.5rem !important; margin-bottom: 0 !important; }
.stats-grid + .stats-grid { margin-top: 0.5rem !important; }
.compact-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }

/* Pool tiles styling */
#braiins-stats > .stats-grid:first-child,
#supportxmr-stats > .stats-grid:first-child,
#solopool-stats > .stats-grid:first-child,
#p2pool-stats > .stats-grid:first-child,
#monero-solo-stats > .stats-grid:first-child,
#ckpool-stats > .stats-grid:first-child { margin-top: 0 !important; }

#braiins-stats .stats-grid,
#supportxmr-stats .stats-grid,
#solopool-stats .stats-grid,
#p2pool-stats .stats-grid,
#monero-solo-stats .stats-grid,
#ckpool-stats .stats-grid { grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); }

#braiins-stats .stat-card,
#supportxmr-stats .stat-card,
#solopool-stats .stat-card,
#p2pool-stats .stat-card,
#monero-solo-stats .stat-card,
#ckpool-stats .stat-card { padding: 0.35rem 0.5rem !important; }

#braiins-stats .stat-label,
#supportxmr-stats .stat-label,
#solopool-stats .stat-label,
#p2pool-stats .stat-label,
#monero-solo-stats .stat-label,
#ckpool-stats .stat-label { font-size: 0.7rem !important; margin-bottom: 0.15rem !important; }

#braiins-stats .stat-value,
#supportxmr-stats .stat-value,
#solopool-stats .stat-value,
#p2pool-stats .stat-value,
#monero-solo-stats .stat-value,
#ckpool-stats .stat-value { font-size: 1rem !important; line-height: 1.3 !important; }
</style>

<!-- Tab Navigation -->
<div class="dashboard-tabs">
    <button class="dashboard-tab active" data-tab="pools" onclick="switchTab('pools')">‚õèÔ∏è Pools</button>
    <button class="dashboard-tab" data-tab="asic" onclick="switchTab('asic')">‚ö° ASIC Mining</button>
    <button class="dashboard-tab" data-tab="cpu" onclick="switchTab('cpu')">üíª CPU Mining</button>
    <button class="dashboard-tab" data-tab="agile" onclick="switchTab('agile')">üéØ Agile Strategy</button>
</div>

<!-- Pools Tab -->
<div id="tab-pools" class="tab-content active">
    <!-- Overview Stats Grid -->
    <div class="stats-grid compact-grid">
        <div class="stat-card" onclick="window.location.href='/miners'" style="cursor: pointer;">
            <div class="stat-label">Total Miners</div>
            <div class="stat-value" id="total-miners">{{ miners_count }}</div>
        </div>
        <div class="stat-card" onclick="window.location.href='/miners'" style="cursor: pointer;">
            <div class="stat-label">Total Hashrate</div>
            <div class="stat-value" id="total-hashrate">0 GH/s</div>
        </div>
        <div class="stat-card" onclick="window.location.href='/miners'" style="cursor: pointer;">
            <div class="stat-label">Offline Miners</div>
            <div class="stat-value" id="offline-miners">0</div>
        </div>
        <div class="stat-card" onclick="window.location.href='/pools'" style="cursor: pointer;">
            <div class="stat-label">Avg Pool Health</div>
            <div class="stat-value" id="avg-pool-health">--</div>
        </div>
    </div>

    <!-- Additional Stats Grid -->
    <div class="stats-grid compact-grid">
        <div class="stat-card" onclick="window.location.href='/settings/energy'" style="cursor: pointer;">
            <div class="stat-label">Current Energy Price</div>
            <div class="stat-value" id="energy-price">-- p/kWh</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">24h Total Cost</div>
            <div class="stat-value" id="total-cost-24h">¬£0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">24h Earnings</div>
            <div class="stat-value" id="earnings-24h">¬£0.00</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">24h P/L</div>
            <div class="stat-value" id="pl-24h">¬£0.00</div>
        </div>
    </div>

    <!-- Braiins Pool Stats -->
    <div id="braiins-stats" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- SupportXMR Pool Stats -->
    <div id="supportxmr-stats" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- Solopool Stats -->
    <div id="solopool-stats" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- P2Pool Stats -->
    <div id="p2pool-stats" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- Monero Solo Mining Stats -->
    <div id="monero-solo-stats" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- CKPool Stats -->
    <div id="ckpool-stats" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- Message if no pools configured -->
    <div id="no-pools-message" style="display: none; text-align: center; padding: 3rem; color: var(--text-secondary);">
        <p style="font-size: 1.25rem; margin-bottom: 1rem;">üì≠ No Pool Integrations Active</p>
        <p>Configure pool integrations in <a href="/settings/pools" style="color: var(--info);">Settings ‚Üí Pool Integrations</a></p>
    </div>
</div>

<!-- ASIC Mining Tab -->
<div id="tab-asic" class="tab-content">
    <!-- Braiins Pool Stats (ASIC) -->
    <div id="braiins-stats-asic" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- Solopool Stats (ASIC) -->
    <div id="solopool-stats-asic" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- CKPool Stats (ASIC) -->
    <div id="ckpool-stats-asic" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- Message if no ASIC pools active -->
    <div id="no-asic-pools-message" style="display: none; text-align: center; padding: 3rem; color: var(--text-secondary);">
        <p style="font-size: 1.25rem; margin-bottom: 1rem;">‚ö° No ASIC Pool Integrations Active</p>
        <p>Configure pool integrations in <a href="/settings/pools" style="color: var(--info);">Settings ‚Üí Pool Integrations</a></p>
    </div>
</div>

<!-- CPU Mining Tab -->
<div id="tab-cpu" class="tab-content">
    <!-- Solopool Stats (CPU - XMR) -->
    <div id="solopool-stats-cpu" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- SupportXMR Pool Stats (CPU) -->
    <div id="supportxmr-stats-cpu" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- P2Pool Stats (CPU) -->
    <div id="p2pool-stats-cpu" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- Monero Solo Mining Stats (CPU) -->
    <div id="monero-solo-stats-cpu" style="display: none; margin-top: 0.5rem;"></div>
    
    <!-- Message if no CPU pools active -->
    <div id="no-cpu-pools-message" style="display: none; text-align: center; padding: 3rem; color: var(--text-secondary);">
        <p style="font-size: 1.25rem; margin-bottom: 1rem;">üíª No CPU Pool Integrations Active</p>
        <p>Configure pool integrations in <a href="/settings/pools" style="color: var(--info);">Settings ‚Üí Pool Integrations</a></p>
    </div>
</div>

<!-- Agile Solo Strategy Tab -->
<div id="tab-agile" class="tab-content">
    <div id="agile-stats-container">
        <p style="text-align: center; padding: 3rem; color: var(--text-secondary);">Loading Agile Solo Strategy stats...</p>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
// Load Braiins Pool stats
async function loadBraiinsStats() {
    try {
        const response = await fetch('/api/settings/braiins/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('braiins-stats');
        
        if (!data.enabled || !data.stats) {
            statsDiv.style.display = 'none';
            return;
        }
        
        // Hide if no workers are online
        const stats = data.stats;
        if (stats.workers_online === 0) {
            statsDiv.style.display = 'none';
            return;
        }
        
        statsDiv.style.display = 'block';
        
        // Fetch BTC price in GBP from our backend
        let btcPriceGBP = 0;
        let cacheAgeIndicator = '';
        
        // Helper function to get cache age indicator with color
        const getCacheIndicator = (ageMinutes) => {
            if (!ageMinutes && ageMinutes !== 0) return '';
            let color = '#28a745'; // green
            if (ageMinutes >= 120) color = '#dc3545'; // red
            else if (ageMinutes >= 30) color = '#ffc107'; // amber
            return `<span style="font-size: 0.7rem; color: ${color}; margin-left: 4px;">‚óè</span>`;
        };
        
        try {
            const priceResponse = await fetch('/api/settings/crypto-prices');
            const priceData = await priceResponse.json();
            if (priceData.success) {
                btcPriceGBP = priceData.bitcoin || 0;
                cacheAgeIndicator = getCacheIndicator(priceData.age_minutes);
            } else {
                console.error('Failed to fetch BTC price:', priceData.error);
            }
        } catch (error) {
            console.error('Failed to fetch BTC price:', error);
        }
        
        // Braiins logo SVG (official logo)
        const braiinsLogo = `<svg width="20" height="20" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><rect width="512" height="512" fill="#000000"/><path fill="#FFFFFF" d="M128 128h85.33v42.67H128zm0 85.33h85.33v42.67H128zm85.33 85.34H128v42.66h85.33zM384 128h-85.33v42.67H384zm-85.33 85.33H384v42.67h-85.33zm0 85.34H384v42.66h-85.33zM213.33 170.67h85.34v42.66h-85.34zm0 85.33h85.34v42.67h-85.34z"/></svg>`;
        
        const todayBTC = stats.today_reward / 100000000;
        const todayGBP = btcPriceGBP > 0 ? (todayBTC * btcPriceGBP).toFixed(2) : '0.00';
        
        const balanceBTC = stats.current_balance / 100000000;
        const balanceGBP = btcPriceGBP > 0 ? (balanceBTC * btcPriceGBP).toFixed(2) : '0.00';
        
        const allTimeBTC = stats.all_time_reward / 100000000;
        const allTimeGBP = btcPriceGBP > 0 ? (allTimeBTC * btcPriceGBP).toFixed(2) : '0.00';
        
        const braiinsUsername = data.username || '';
        const braiinsUrl = braiinsUsername ? `https://pool.braiins.com/mining/overview/${braiinsUsername}` : '#';
        const clickableStyle = braiinsUsername ? 'cursor: pointer;' : '';
        const onclickAttr = braiinsUsername ? `onclick="window.open('${braiinsUrl}', '_blank')"` : '';
        
        const tilesHTML = `
            <div class="stats-grid">
                <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                    <div class="stat-label">${braiinsLogo}Workers (Braiins)</div>
                    <div class="stat-value" style="font-size: 1.5rem;">
                        ${stats.workers_online || 0} / ${stats.workers_offline || 0}
                        ${stats.hashrate_5m ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">${stats.hashrate_5m}</small>` : ''}
                    </div>
                </div>
                <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                    <div class="stat-label">${braiinsLogo}Today's Reward</div>
                    <div class="stat-value" style="font-size: 1.25rem;">${todayBTC.toFixed(8)} BTC<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${todayGBP}${cacheAgeIndicator}</span></div>
                </div>
                <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                    <div class="stat-label">${braiinsLogo}Current Balance</div>
                    <div class="stat-value" style="font-size: 1.25rem;">${balanceBTC.toFixed(8)} BTC<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${balanceGBP}${cacheAgeIndicator}</span></div>
                </div>
                <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                    <div class="stat-label">${braiinsLogo}All Time Reward</div>
                    <div class="stat-value" style="font-size: 1.25rem;">${allTimeBTC.toFixed(8)} BTC<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${allTimeGBP}${cacheAgeIndicator}</span></div>
                </div>
            </div>
        `;
        
        statsDiv.innerHTML = tilesHTML;
    } catch (error) {
        console.error('Failed to load Braiins stats:', error);
        document.getElementById('braiins-stats').style.display = 'none';
    }
}

// Load SupportXMR stats
async function loadSupportXMRStats() {
    try {
        const response = await fetch('/api/settings/supportxmr/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('supportxmr-stats');
        
        if (!data.enabled || !data.wallets || data.wallets.length === 0) {
            statsDiv.style.display = 'none';
            return;
        }
        
        // Check if there are any active workers across all wallets
        const totalWorkers = data.wallets.reduce((sum, wallet) => sum + (wallet.worker_count || 0), 0);
        if (totalWorkers === 0) {
            statsDiv.style.display = 'none';
            return;
        }
        
        statsDiv.style.display = 'block';
        
        // Get XMR price in GBP with cache age indicator
        let xmrPriceGBP = 0;
        let xmrCacheAgeIndicator = '';
        
        // Helper function to get cache age indicator with color
        const getCacheIndicator = (ageMinutes) => {
            if (!ageMinutes && ageMinutes !== 0) return '';
            let color = '#28a745'; // green
            if (ageMinutes >= 120) color = '#dc3545'; // red
            else if (ageMinutes >= 30) color = '#ffc107'; // amber
            return `<span style="font-size: 0.7rem; color: ${color}; margin-left: 4px;">‚óè</span>`;
        };
        
        try {
            const priceResponse = await fetch('/api/settings/crypto-prices');
            if (priceResponse.ok) {
                const priceData = await priceResponse.json();
                if (priceData.success) {
                    xmrPriceGBP = priceData.monero || 0;
                    xmrCacheAgeIndicator = getCacheIndicator(priceData.age_minutes);
                }
            }
        } catch (e) {
            console.error('Failed to fetch XMR price:', e);
        }
        
        // SupportXMR logo (using XMR symbol)
        const supportXMRLogo = '<span style="color: #ff6600; font-weight: bold; margin-right: 4px;">‚ü†</span>';
        
        // Create tile sections for each wallet
        const walletSectionsHTML = data.wallets.map(wallet => {
            const address = wallet.address || '';
            const last4Digits = address.length >= 4 ? address.substring(address.length - 4) : address;
            
            // Calculate GBP values
            const todayRewardsXMR = parseFloat(wallet.today_rewards);
            const todayRewardsGBP = xmrPriceGBP > 0 ? (todayRewardsXMR * xmrPriceGBP).toFixed(2) : '0.00';
            const amountDueXMR = parseFloat(wallet.amount_due);
            const amountDueGBP = xmrPriceGBP > 0 ? (amountDueXMR * xmrPriceGBP).toFixed(2) : '0.00';
            const amountPaidXMR = parseFloat(wallet.amount_paid);
            const amountPaidGBP = xmrPriceGBP > 0 ? (amountPaidXMR * xmrPriceGBP).toFixed(2) : '0.00';
            
            // Create clickable link to SupportXMR dashboard
            const supportXMRUrl = address ? `https://supportxmr.com/#/dashboard` : '#';
            const onclickAttr = address ? `onclick="window.open('${supportXMRUrl}', '_blank')"` : '';
            const clickableStyle = address ? 'cursor: pointer;' : '';
            
            return `
                <div class="stats-grid">
                    <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                        <div class="stat-label">${supportXMRLogo}Workers - ${last4Digits}</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${wallet.worker_count || 0}
                            ${wallet.hashrate ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">${wallet.hashrate}</small>` : ''}
                        </div>
                    </div>
                    <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                        <div class="stat-label">${supportXMRLogo}Today's Reward</div>
                        <div class="stat-value" style="font-size: 1.25rem;">${todayRewardsXMR.toFixed(6)} XMR<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${todayRewardsGBP}${xmrCacheAgeIndicator}</span></div>
                    </div>
                    <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                        <div class="stat-label">${supportXMRLogo}Amount Due</div>
                        <div class="stat-value" style="font-size: 1.25rem;">${wallet.amount_due} XMR<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${amountDueGBP}${xmrCacheAgeIndicator}</span></div>
                    </div>
                    <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                        <div class="stat-label">${supportXMRLogo}Total Paid</div>
                        <div class="stat-value" style="font-size: 1.25rem;">${wallet.amount_paid} XMR<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${amountPaidGBP}${xmrCacheAgeIndicator}</span></div>
                    </div>
                </div>
            `;
        }).join('');
        
        statsDiv.innerHTML = walletSectionsHTML;
    } catch (error) {
        console.error('Failed to load SupportXMR stats:', error);
        document.getElementById('supportxmr-stats').style.display = 'none';
    }
}

// Load Solopool stats
async function loadSolopoolStats() {
    try {
        // Check if Agile Solo Strategy is enabled
        const agileResp = await fetch('/api/settings/agile-solo-strategy');
        const agileData = await agileResp.json();
        const agileEnabled = agileData.enabled || false;
        
        const response = await fetch('/api/settings/solopool/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('solopool-stats');
        
        // Safely check arrays with fallbacks
        const bchMiners = data.bch_miners || [];
        const dgbMiners = data.dgb_miners || [];
        const btcMiners = data.btc_miners || [];
        const xmrMiners = data.xmr_miners || [];
        const xmrPools = data.xmr_pools || [];
        
        // If Agile Solo Strategy enabled, always show BTC/BCH/DGB sections (even if no miners)
        const hasSolopoolCoins = agileEnabled || (bchMiners.length > 0 || dgbMiners.length > 0 || btcMiners.length > 0);
        const hasXMR = xmrMiners.length > 0 || xmrPools.length > 0;
        
        if (!data.enabled || (!hasSolopoolCoins && !hasXMR)) {
            statsDiv.style.display = 'none';
            return;
        }
        
        statsDiv.style.display = 'block';
        
        // Fetch crypto prices in GBP from our backend (which logs errors properly)
        let bchPriceGBP = 0;
        let dgbPriceGBP = 0;
        let btcPriceGBP = 0;
        let xmrPriceGBP = 0;
        let cacheAgeIndicator = '';
        
        // Helper function to get cache age indicator with color
        const getCacheIndicator = (ageMinutes) => {
            if (!ageMinutes && ageMinutes !== 0) return '';
            let color = '#28a745'; // green
            if (ageMinutes >= 120) color = '#dc3545'; // red
            else if (ageMinutes >= 30) color = '#ffc107'; // amber
            return `<span style="font-size: 0.7rem; color: ${color}; margin-left: 4px;">‚óè</span>`;
        };
        
        try {
            const priceResponse = await fetch('/api/settings/crypto-prices');
            const priceData = await priceResponse.json();
            if (priceData.success) {
                bchPriceGBP = priceData['bitcoin-cash'] || 0;
                dgbPriceGBP = priceData.digibyte || 0;
                btcPriceGBP = priceData.bitcoin || 0;
                xmrPriceGBP = priceData.monero || 0;
                cacheAgeIndicator = getCacheIndicator(priceData.age_minutes);
            } else {
                console.error('Failed to fetch crypto prices:', priceData.error);
            }
        } catch (error) {
            console.error('Failed to fetch crypto prices:', error);
        }
        
        // BCH logo SVG
        const bchLogo = `<svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><circle cx="16" cy="16" r="16" fill="#8dc351"/><path fill="#fff" d="M21.207 10.534c-.776-1.93-2.84-2.535-4.684-2.191l-.455-2.316-1.48.292.447 2.27c-.392.078-.794.159-1.19.239l-.451-2.282-1.479.292.455 2.317c-.323.064-.64.127-.95.19l-.002-.008-2.04.403.322 1.672s1.097-.223 1.077-.211c.599-.118.948.062 1.119.476l.546 2.78c.035-.009.08-.02.13-.031l-.132.033.767 3.896c-.024.172-.11.417-.439.49.024.02-1.076.212-1.076.212l-.087 1.791 1.925-.379c.357-.07.712-.143 1.06-.212l.462 2.345 1.479-.291-.455-2.311c.396-.085.783-.164 1.161-.247l.452 2.297 1.48-.291-.461-2.343c1.872-.397 3.301-1.187 3.598-3.168.239-1.59-.318-2.405-1.398-2.868.805-.464 1.346-1.193 1.141-2.433zm-1.018 4.388c.318 2.034-2.764 2.55-3.96 2.843l-.718-3.651c1.197-.296 4.363-1.322 4.678.808zm-1.18-3.365c.29 1.854-2.373 2.305-3.408 2.565l-.651-3.314c1.035-.257 3.724-1.03 4.059.749z"/></svg>`;
        
        // XMR logo SVG
        const xmrLogo = `<svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><circle cx="16" cy="16" r="16" fill="#ff6600"/><path fill="#fff" d="M16 5L6 15v6h3v-6l7-7 7 7v6h3v-6l-10-10z"/><path fill="#fff" d="M13 18v8h6v-8l-3-3-3 3z"/></svg>`;
        
        // DGB logo SVG
        const dgbLogo = `<svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><circle cx="16" cy="16" r="16" fill="#006ad2"/><path fill="#fff" d="M16 4L7 9v7l9 5 9-5V9l-9-5zm6 11.3l-6 3.3-6-3.3V10l6-3.3L22 10v5.3z"/><path fill="#fff" d="M16 11l-3 1.7v3.5l3 1.7 3-1.7v-3.5L16 11z"/></svg>`;
        
        // BTC logo SVG
        const btcLogo = `<svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><circle cx="16" cy="16" r="16" fill="#f7931a"/><path fill="#fff" d="M23.189 14.02c.314-2.096-1.283-3.223-3.465-3.975l.708-2.84-1.728-.43-.69 2.765c-.454-.114-.92-.22-1.385-.326l.695-2.783L15.596 6l-.708 2.839c-.376-.086-.746-.17-1.104-.26l.002-.009-2.384-.595-.46 1.846s1.283.294 1.256.312c.7.175.826.638.805 1.006l-.806 3.235c.048.012.11.03.18.057l-.183-.045-1.13 4.532c-.086.212-.303.531-.793.41.018.025-1.256-.313-1.256-.313l-.858 1.978 2.25.561c.418.105.828.215 1.231.318l-.715 2.872 1.727.43.708-2.84c.472.127.93.245 1.378.357l-.706 2.828 1.728.43.715-2.866c2.948.558 5.164.333 6.097-2.333.752-2.146-.037-3.385-1.588-4.192 1.13-.26 1.98-1.003 2.207-2.538zm-3.95 5.538c-.533 2.147-4.148.986-5.32.695l.95-3.805c1.172.293 4.929.872 4.37 3.11zm.535-5.569c-.487 1.953-3.495.96-4.47.717l.86-3.45c.975.243 4.118.696 3.61 2.733z"/></svg>`;
        
        const luckFormat = (luck) => Math.round(luck || 0) + '%';
        
        // Format time since last share (using central helper)
        const formatTimeSince = (timestamp) => {
            if (!timestamp) return 'Never';
            const secondsAgo = Math.floor(Date.now() / 1000) - timestamp;
            const formatted = formatTimeElapsed(secondsAgo);
            return formatted ? `${formatted} ago` : 'Never';
        };
        
        // Get color based on time since last share
        const getTimeSinceColor = (timestamp) => {
            if (!timestamp) return '#999';
            const secondsAgo = Math.floor(Date.now() / 1000) - timestamp;
            const minutesAgo = secondsAgo / 60;
            if (minutesAgo < 15) return '#28a745'; // green
            if (minutesAgo < 30) return '#ff8c00'; // orange
            return '#dc3545'; // red
        };
        
        // Get color for time since last block based on ETTB
        const getBlockTimeColor = (timeSinceBlock, ettbSeconds) => {
            if (!ettbSeconds || timeSinceBlock === null) return '#666';
            const ratio = timeSinceBlock / ettbSeconds;
            if (ratio <= 1) return '#10b981'; // green
            if (ratio <= 2) return '#fbbf24'; // yellow
            if (ratio <= 3) return '#f59e0b'; // orange
            return '#ef4444'; // red
        };
        
        // Create stats tiles for BCH miners
        const bchTilesHTML = bchMiners.map(m => {
            const stats = m.stats;
            const paidBCH = stats.paid ? (stats.paid / 100000000) : 0;
            const paidGBP = bchPriceGBP > 0 ? (paidBCH * bchPriceGBP).toFixed(2) : '0.00';
            const currentShares = stats.shares || 0;
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">${bchLogo}Workers Online</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${stats.workers || 0} / ${stats.workersTotal || 0}
                            ${stats.hashrate ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">${stats.hashrate}</small>` : ''}
                        </div>
                    </div>
                    <div class="stat-card" onclick="window.open('https://bch.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                        <div class="stat-label">${bchLogo}Current Round Luck</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${luckFormat(stats.current_luck)}
                            ${stats.ettb ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">ETTB: ${stats.ettb.formatted} - ${stats.lastBlockTimestamp ? `<span style="color: ${getBlockTimeColor((Math.floor(Date.now() / 1000) - stats.lastBlockTimestamp), stats.ettb.seconds)};">${formatTimeSince(stats.lastBlockTimestamp)}</span>` : `<span style="color: var(--text-secondary);">‚àû</span>`}</small>` : ''}
                        </div>
                    </div>
                    <div class="stat-card" onclick="window.open('https://bch.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                        <div class="stat-label">${bchLogo}Blocks (24h/7d/30d)</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${stats.blocks_24h || 0} / ${stats.blocks_7d || 0} / ${stats.blocks_30d || 0}
                            <br><small style="color: var(--text-secondary); font-size: 0.875rem;">Shares: ${currentShares.toLocaleString()}${stats.lastShare ? ` - <span style="font-size: 0.75rem; color: ${getTimeSinceColor(stats.lastShare)};">${formatTimeSince(stats.lastShare)}</span>` : ''}</small>
                        </div>
                    </div>
                    <div class="stat-card" onclick="window.open('https://bch.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                        <div class="stat-label">${bchLogo}Total Paid</div>
                        <div class="stat-value" style="font-size: 1.25rem;">${paidBCH.toFixed(8)} BCH<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${paidGBP}${cacheAgeIndicator}</span></div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Create stats tiles for DGB miners
        const dgbTilesHTML = dgbMiners.map(m => {
            const stats = m.stats;
            const paidDGB = stats.paid ? (stats.paid / 1000000000) : 0;  // DGB uses 9 decimals
            const paidGBP = dgbPriceGBP > 0 ? (paidDGB * dgbPriceGBP).toFixed(2) : '0.00';
            const currentShares = stats.shares || 0;
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">${dgbLogo}Workers Online</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${stats.workers || 0} / ${stats.workersTotal || 0}
                            ${stats.hashrate ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">${stats.hashrate}</small>` : ''}
                        </div>
                    </div>
                    <div class="stat-card" onclick="window.open('https://dgb-sha.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                        <div class="stat-label">${dgbLogo}Current Round Luck</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${luckFormat(stats.current_luck)}
                            ${stats.ettb ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">ETTB: ${stats.ettb.formatted} - ${stats.lastBlockTimestamp ? `<span style="color: ${getBlockTimeColor((Math.floor(Date.now() / 1000) - stats.lastBlockTimestamp), stats.ettb.seconds)};">${formatTimeSince(stats.lastBlockTimestamp)}</span>` : `<span style="color: var(--text-secondary);">‚àû</span>`}</small>` : ''}
                        </div>
                    </div>
                    <div class="stat-card" onclick="window.open('https://dgb-sha.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                        <div class="stat-label">${dgbLogo}Blocks (24h/7d/30d)</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${stats.blocks_24h || 0} / ${stats.blocks_7d || 0} / ${stats.blocks_30d || 0}
                            <br><small style="color: var(--text-secondary); font-size: 0.875rem;">Shares: ${currentShares.toLocaleString()}${stats.lastShare ? ` - <span style="font-size: 0.75rem; color: ${getTimeSinceColor(stats.lastShare)};">${formatTimeSince(stats.lastShare)}</span>` : ''}</small>
                        </div>
                    </div>
                    <div class="stat-card" onclick="window.open('https://dgb-sha.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                        <div class="stat-label">${dgbLogo}Total Paid</div>
                        <div class="stat-value" style="font-size: 1.25rem;">${paidDGB.toFixed(8)} DGB<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${paidGBP}${cacheAgeIndicator}</span></div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Create stats tiles for BTC miners
        const btcTilesHTML = btcMiners.map(m => {
            const stats = m.stats;
            const paidBTC = stats.paid ? (stats.paid / 100000000) : 0;
            const paidGBP = btcPriceGBP > 0 ? (paidBTC * btcPriceGBP).toFixed(2) : '0.00';
            const currentShares = stats.shares || 0;
            
            return `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">${btcLogo}Workers Online</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${stats.workers || 0} / ${stats.workersTotal || 0}
                            ${stats.hashrate ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">${stats.hashrate}</small>` : ''}
                        </div>
                    </div>
                    <div class="stat-card" onclick="window.open('https://btc.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                        <div class="stat-label">${btcLogo}Current Round Luck</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${luckFormat(stats.current_luck)}
                            ${stats.ettb ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">ETTB: ${stats.ettb.formatted} - ${stats.lastBlockTimestamp ? `<span style="color: ${getBlockTimeColor((Math.floor(Date.now() / 1000) - stats.lastBlockTimestamp), stats.ettb.seconds)};">${formatTimeSince(stats.lastBlockTimestamp)}</span>` : `<span style="color: var(--text-secondary);">‚àû</span>`}</small>` : ''}
                        </div>
                    </div>
                    <div class="stat-card" onclick="window.open('https://btc.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                        <div class="stat-label">${btcLogo}Blocks (24h/7d/30d)</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${stats.blocks_24h || 0} / ${stats.blocks_7d || 0} / ${stats.blocks_30d || 0}
                            <br><small style="color: var(--text-secondary); font-size: 0.875rem;">Shares: ${currentShares.toLocaleString()}${stats.lastShare ? ` - <span style="font-size: 0.75rem; color: ${getTimeSinceColor(stats.lastShare)};">${formatTimeSince(stats.lastShare)}</span>` : ''}</small>
                        </div>
                    </div>
                    <div class="stat-card" onclick="window.open('https://btc.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                        <div class="stat-label">${btcLogo}Total Paid</div>
                        <div class="stat-value" style="font-size: 1.25rem;">${paidBTC.toFixed(8)} BTC<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${paidGBP}${cacheAgeIndicator}</span></div>
                    </div>
                </div>
            `;
        }).join('');
        
        // Create stats tiles for XMR miners
        // Filter out miners with 0 workers
        const activeXmrMiners = xmrMiners.filter(m => {
            const workers = m.stats?.workers || 0;
            return workers > 0;
        });
        
        let xmrTilesHTML = '';
        if (activeXmrMiners.length > 0) {
            xmrTilesHTML = activeXmrMiners.map(m => {
                const stats = m.stats || {};
                const paidXMR = stats.paid ? (stats.paid / 1000000000000) : 0;
                const paidGBP = xmrPriceGBP > 0 ? (paidXMR * xmrPriceGBP).toFixed(2) : '0.00';
                const currentShares = stats.shares || 0;
                
                return `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-label">${xmrLogo}Workers Online</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                ${stats.workers || 0} / ${stats.workersTotal || 0}
                                ${stats.hashrate ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">${stats.hashrate}</small>` : ''}
                            </div>
                        </div>
                        <div class="stat-card" onclick="window.open('https://xmr.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${xmrLogo}Current Round Luck</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                ${luckFormat(stats.current_luck)}
                                ${stats.ettb ? `<br><small style="color: var(--text-secondary); font-size: 0.875rem;">ETTB: ${stats.ettb.formatted} - ${stats.lastBlockTimestamp ? `<span style="color: ${getBlockTimeColor((Math.floor(Date.now() / 1000) - stats.lastBlockTimestamp), stats.ettb.seconds)};">${formatTimeSince(stats.lastBlockTimestamp)}</span>` : `<span style="color: var(--text-secondary);">‚àû</span>`}</small>` : ''}
                            </div>
                        </div>
                        <div class="stat-card" onclick="window.open('https://xmr.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${xmrLogo}Blocks (24h/7d/30d)</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                ${stats.blocks_24h || 0} / ${stats.blocks_7d || 0} / ${stats.blocks_30d || 0}
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">Shares: ${currentShares.toLocaleString()}${stats.lastShare ? ` - <span style="font-size: 0.75rem; color: ${getTimeSinceColor(stats.lastShare)};">${formatTimeSince(stats.lastShare)}</span>` : ''}</small>
                            </div>
                        </div>
                        <div class="stat-card" onclick="window.open('https://xmr.solopool.org/account/${m.username}', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${xmrLogo}Total Paid</div>
                            <div class="stat-value" style="font-size: 1.25rem;">${paidXMR.toFixed(12)} XMR<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£${paidGBP}${cacheAgeIndicator}</span></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // If Agile Solo Strategy enabled, show placeholder tiles for coins with no miners
        let bchPlaceholderHTML = '';
        let dgbPlaceholderHTML = '';
        let btcPlaceholderHTML = '';
        
        if (agileEnabled) {
            if (bchMiners.length === 0) {
                bchPlaceholderHTML = `
                    <div class="stats-grid">
                        <div class="stat-card" style="opacity: 0.6;">
                            <div class="stat-label">${bchLogo}Workers Online</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                0 / 0
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">0 H/s</small>
                            </div>
                        </div>
                        <div class="stat-card" style="opacity: 0.6;" onclick="window.open('https://bch.solopool.org/', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${bchLogo}Current Round Luck</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                0%
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">No active mining</small>
                            </div>
                        </div>
                        <div class="stat-card" style="opacity: 0.6;" onclick="window.open('https://bch.solopool.org/', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${bchLogo}Blocks (24h/7d/30d)</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                0 / 0 / 0
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">Shares: 0</small>
                            </div>
                        </div>
                        <div class="stat-card" style="opacity: 0.6;" onclick="window.open('https://bch.solopool.org/', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${bchLogo}Total Paid</div>
                            <div class="stat-value" style="font-size: 1.25rem;">0.00000000 BCH<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£0.00${cacheAgeIndicator}</span></div>
                        </div>
                    </div>
                `;
            }
            
            if (dgbMiners.length === 0) {
                dgbPlaceholderHTML = `
                    <div class="stats-grid">
                        <div class="stat-card" style="opacity: 0.6;">
                            <div class="stat-label">${dgbLogo}Workers Online</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                0 / 0
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">0 H/s</small>
                            </div>
                        </div>
                        <div class="stat-card" style="opacity: 0.6;" onclick="window.open('https://dgb-sha.solopool.org/', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${dgbLogo}Current Round Luck</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                0%
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">No active mining</small>
                            </div>
                        </div>
                        <div class="stat-card" style="opacity: 0.6;" onclick="window.open('https://dgb-sha.solopool.org/', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${dgbLogo}Blocks (24h/7d/30d)</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                0 / 0 / 0
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">Shares: 0</small>
                            </div>
                        </div>
                        <div class="stat-card" style="opacity: 0.6;" onclick="window.open('https://dgb-sha.solopool.org/', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${dgbLogo}Total Paid</div>
                            <div class="stat-value" style="font-size: 1.25rem;">0.00000000 DGB<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£0.00${cacheAgeIndicator}</span></div>
                        </div>
                    </div>
                `;
            }
            
            if (btcMiners.length === 0) {
                btcPlaceholderHTML = `
                    <div class="stats-grid">
                        <div class="stat-card" style="opacity: 0.6;">
                            <div class="stat-label">${btcLogo}Workers Online</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                0 / 0
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">0 H/s</small>
                            </div>
                        </div>
                        <div class="stat-card" style="opacity: 0.6;" onclick="window.open('https://btc.solopool.org/', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${btcLogo}Current Round Luck</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                0%
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">No active mining</small>
                            </div>
                        </div>
                        <div class="stat-card" style="opacity: 0.6;" onclick="window.open('https://btc.solopool.org/', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${btcLogo}Blocks (24h/7d/30d)</div>
                            <div class="stat-value" style="font-size: 1.5rem;">
                                0 / 0 / 0
                                <br><small style="color: var(--text-secondary); font-size: 0.875rem;">Shares: 0</small>
                            </div>
                        </div>
                        <div class="stat-card" style="opacity: 0.6;" onclick="window.open('https://btc.solopool.org/', '_blank')" style="cursor: pointer;">
                            <div class="stat-label">${btcLogo}Total Paid</div>
                            <div class="stat-value" style="font-size: 1.25rem;">0.00000000 BTC<br><span style="font-size: 0.9rem; color: var(--text-secondary);">¬£0.00${cacheAgeIndicator}</span></div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Use actual tiles if they exist, otherwise use placeholders (for Agile Solo Strategy)
        const finalBchHTML = bchTilesHTML || bchPlaceholderHTML;
        const finalDgbHTML = dgbTilesHTML || dgbPlaceholderHTML;
        const finalBtcHTML = btcTilesHTML || btcPlaceholderHTML;
        
        statsDiv.innerHTML = finalBchHTML + finalDgbHTML + finalBtcHTML + xmrTilesHTML;
    } catch (error) {
        console.error('Failed to load Solopool stats:', error);
        document.getElementById('solopool-stats').style.display = 'none';
    }
}

// Load P2Pool stats
async function loadP2PoolStats() {
    try {
        const response = await fetch('/api/settings/p2pool/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('p2pool-stats');
        
        if (!data.enabled) {
            statsDiv.style.display = 'none';
            return;
        }
        
        // Check if there are any workers before showing the tile
        if (data.api_enabled && (data.workers === null || data.workers === 0)) {
            statsDiv.style.display = 'none';
            return;
        }
        
        statsDiv.style.display = 'block';
        
        // Fetch XMR price in GBP from our backend
        let xmrPriceGBP = 0;
        let cacheAgeIndicator = '';
        
        const getCacheIndicator = (ageMinutes) => {
            if (!ageMinutes && ageMinutes !== 0) return '';
            let color = '#28a745'; // green
            if (ageMinutes >= 120) color = '#dc3545'; // red
            else if (ageMinutes >= 30) color = '#ffc107'; // amber
            return `<span style="font-size: 0.7rem; color: ${color}; margin-left: 4px;">‚óè</span>`;
        };
        
        try {
            const priceResponse = await fetch('/api/settings/crypto-prices');
            const priceData = await priceResponse.json();
            if (priceData.success) {
                xmrPriceGBP = priceData.monero || 0;
                cacheAgeIndicator = getCacheIndicator(priceData.age_minutes);
            }
        } catch (error) {
            console.error('Failed to fetch XMR price:', error);
        }
        
        // P2Pool logo (Monero icon)
        const p2poolLogo = `<svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><circle cx="16" cy="16" r="16" fill="#ff6600"/><path fill="#fff" d="M16 5L6 15v6h3v-6l7-7 7 7v6h3v-6l-10-10z"/><path fill="#fff" d="M13 18v8h6v-8l-3-3-3 3z"/></svg>`;
        
        const todayGBP = xmrPriceGBP > 0 ? ((data.earnings_24h_xmr || 0) * xmrPriceGBP).toFixed(2) : '0.00';
        const balanceGBP = xmrPriceGBP > 0 ? ((data.balance_xmr || 0) * xmrPriceGBP).toFixed(2) : '0.00';
        
        // Prepare P2Pool observer URL if wallet address available
        const p2poolUrl = data.full_wallet_address ? `https://mini.p2pool.observer/miner/${data.full_wallet_address}` : null;
        const clickableStyle = p2poolUrl ? 'cursor: pointer;' : '';
        const onclickAttr = p2poolUrl ? `onclick="window.open('${p2poolUrl}', '_blank')"` : '';
        
        // Build tiles based on what's enabled - max 4 tiles
        let tilesHTML = '';
        
        // Tile 1: Workers (if API enabled)
        if (data.api_enabled && data.workers !== null) {
            tilesHTML += `
                <div class="stat-card">
                    <div class="stat-label">${p2poolLogo}Workers</div>
                    <div class="stat-value">${data.workers || 0}<br><small style="color: var(--text-secondary);">${data.local_hashrate_formatted || '0 H/s'}</small></div>
                </div>
            `;
        }
        
        // Tile 2: Current Round Luck (if API enabled)
        if (data.api_enabled && data.current_effort !== null) {
            const luckPercent = Math.round(data.current_effort || 0);
            const sharesFound = data.shares_found || 0;
            
            // Time since last share with color coding
            let timeSinceShareHTML = '';
            if (data.last_share_timestamp) {
                const timeSinceShare = Math.floor(Date.now() / 1000) - data.last_share_timestamp;
                const hoursElapsed = timeSinceShare / 3600;
                
                // Color coding based on absolute hours
                let shareColor = '#666';
                if (hoursElapsed < 5) {
                    shareColor = '#28a745';      // Green - 0-5 hours
                } else if (hoursElapsed < 6) {
                    shareColor = '#fd7e14';      // Orange - 5-6 hours
                } else {
                    shareColor = '#dc3545';      // Red - over 6 hours
                }
                
                // Format time since (using central helper)
                const timeStr = formatTimeElapsed(timeSinceShare);
                
                timeSinceShareHTML = timeStr ? ` - <span style="color: ${shareColor};">${timeStr} ago</span>` : '';
            }
            
            tilesHTML += `
                <div class="stat-card">
                    <div class="stat-label">${p2poolLogo}Current Round Luck</div>
                    <div class="stat-value" style="font-size: 1.5rem;">${luckPercent}%<br><small style="color: var(--text-secondary);">Shares: ${sharesFound}${timeSinceShareHTML}</small></div>
                </div>
            `;
        }
        
        // Tile 3: Today's Reward (if wallet enabled)
        if (data.wallet_enabled) {
            tilesHTML += `
                <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                    <div class="stat-label">${p2poolLogo}Today's Reward</div>
                    <div class="stat-value">${(data.earnings_24h_xmr || 0).toFixed(6)} XMR<br><small style="color: var(--text-secondary);">¬£${todayGBP}${cacheAgeIndicator}</small></div>
                </div>
            `;
        }
        
        // Tile 4: All-time Reward (if wallet enabled) - sum of all incoming transactions
        if (data.wallet_enabled) {
            const totalReceivedGBP = xmrPriceGBP > 0 ? ((data.total_received_xmr || 0) * xmrPriceGBP).toFixed(2) : '0.00';
            tilesHTML += `
                <div class="stat-card" ${onclickAttr} style="${clickableStyle}">
                    <div class="stat-label">${p2poolLogo}All-time Reward</div>
                    <div class="stat-value">${(data.total_received_xmr || 0).toFixed(6)} XMR<br><small style="color: var(--text-secondary);">¬£${totalReceivedGBP}${cacheAgeIndicator}</small></div>
                </div>
            `;
        }
        
        statsDiv.innerHTML = `
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                ${tilesHTML}
            </div>
        `;
    } catch (error) {
        console.error('Failed to load P2Pool stats:', error);
        document.getElementById('p2pool-stats').style.display = 'none';
    }
}

// Load Monero Solo Mining stats
async function loadMoneroSoloStats() {
    try {
        const response = await fetch('/api/settings/monero-solo/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('monero-solo-stats');
        
        // Only show if enabled and has workers
        if (!data.enabled || data.xmrig_workers === 0) {
            statsDiv.style.display = 'none';
            return;
        }
        
        statsDiv.style.display = 'block';
        
        // Fetch XMR price in GBP from our backend
        let xmrPriceGBP = 0;
        let cacheAgeIndicator = '';
        
        const getCacheIndicator = (ageMinutes) => {
            if (!ageMinutes && ageMinutes !== 0) return '';
            let color = '#28a745'; // green
            if (ageMinutes >= 120) color = '#dc3545'; // red
            else if (ageMinutes >= 30) color = '#ffc107'; // amber
            return `<span style="font-size: 0.7rem; color: ${color}; margin-left: 4px;">‚óè</span>`;
        };
        
        try {
            const priceResponse = await fetch('/api/settings/crypto-prices');
            const priceData = await priceResponse.json();
            if (priceData.success) {
                xmrPriceGBP = priceData.monero || 0;
                cacheAgeIndicator = getCacheIndicator(priceData.age_minutes);
            }
        } catch (error) {
            console.error('Failed to fetch XMR price:', error);
        }
        
        // Monero Solo Mining logo
        const moneroSoloLogo = `<svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><circle cx="16" cy="16" r="16" fill="#ff6600"/><path fill="#fff" d="M16 5L6 15v6h3v-6l7-7 7 7v6h3v-6l-10-10z"/><path fill="#fff" d="M13 18v8h6v-8l-3-3-3 3z"/></svg>`;
        
        const todayGBP = xmrPriceGBP > 0 ? ((data.earnings_24h_xmr || 0) * xmrPriceGBP).toFixed(2) : '0.00';
        const allTimeGBP = xmrPriceGBP > 0 ? ((data.total_earned_xmr || 0) * xmrPriceGBP).toFixed(2) : '0.00';
        
        let tilesHTML = '';
        
        // Tile 1: Workers & Hashrate
        tilesHTML += `
            <div class="stat-card" onclick="window.location.href='/analytics/monero-solo'" style="cursor: pointer;">
                <div class="stat-label">${moneroSoloLogo}Solo XMR Workers</div>
                <div class="stat-value">${data.xmrig_workers || 0}<br><small style="color: var(--text-secondary);">${data.total_hashrate_formatted || '0 H/s'}</small></div>
            </div>
        `;
        
        // Tile 2: Current Effort
        const effortPercent = (data.current_effort_percent || 0).toFixed(2);
        let effortColor = '#28a745'; // green
        if (data.current_effort_percent > 200) {
            effortColor = '#dc3545'; // red
        } else if (data.current_effort_percent > 100) {
            effortColor = '#f59e0b'; // orange
        }
        
        tilesHTML += `
            <div class="stat-card" onclick="window.location.href='/analytics/monero-solo'" style="cursor: pointer;">
                <div class="stat-label">${moneroSoloLogo}Current Effort</div>
                <div class="stat-value" style="color: ${effortColor};">${effortPercent}%<br><small style="color: var(--text-secondary);">Blocks: ${data.blocks_found || 0}</small></div>
            </div>
        `;
        
        // Tile 3: Today's Reward
        tilesHTML += `
            <div class="stat-card" onclick="window.location.href='/analytics/monero-solo'" style="cursor: pointer;">
                <div class="stat-label">${moneroSoloLogo}Today's Reward</div>
                <div class="stat-value">${(data.earnings_24h_xmr || 0).toFixed(6)} XMR<br><small style="color: var(--text-secondary);">¬£${todayGBP}${cacheAgeIndicator}</small></div>
            </div>
        `;
        
        // Tile 4: All-time Reward
        tilesHTML += `
            <div class="stat-card" onclick="window.location.href='/analytics/monero-solo'" style="cursor: pointer;">
                <div class="stat-label">${moneroSoloLogo}All-time Reward</div>
                <div class="stat-value">${(data.total_earned_xmr || 0).toFixed(6)} XMR<br><small style="color: var(--text-secondary);">¬£${allTimeGBP}${cacheAgeIndicator}</small></div>
            </div>
        `;
        
        statsDiv.innerHTML = `
            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
                ${tilesHTML}
            </div>
        `;
    } catch (error) {
        console.error('Failed to load Monero Solo stats:', error);
        document.getElementById('monero-solo-stats').style.display = 'none';
    }
}

async function loadCKPoolStats() {
    try {
        const statsDiv = document.getElementById('ckpool-stats');
        
        // Check if any CKPool pools exist by fetching widget data
        const workersResp = await fetch('/api/widgets/widgets/ckpool-workers');
        const workersData = await workersResp.json();
        
        if (workersData.status === 'offline' || workersData.workers === 0 || workersData.hashrate_1m_gh === 0) {
            statsDiv.style.display = 'none';
            return;
        }
        
        statsDiv.style.display = 'block';
        
        // Fetch crypto price with cache age indicator
        let cacheAgeIndicator = '';
        
        const getCacheIndicator = (ageMinutes) => {
            if (!ageMinutes && ageMinutes !== 0) return '';
            let color = '#28a745'; // green
            if (ageMinutes >= 120) color = '#dc3545'; // red
            else if (ageMinutes >= 30) color = '#ffc107'; // amber
            return `<span style="font-size: 0.7rem; color: ${color}; margin-left: 4px;">‚óè</span>`;
        };
        
        try {
            const priceResponse = await fetch('/api/settings/crypto-prices');
            const priceData = await priceResponse.json();
            if (priceData.success) {
                cacheAgeIndicator = getCacheIndicator(priceData.age_minutes);
            }
        } catch (error) {
            console.error('Failed to fetch crypto prices:', error);
        }
        
        // First, get list of all configured CKPool coins
        const coinsResp = await fetch('/api/widgets/widgets/ckpool-coins');
        const coinsData = await coinsResp.json();
        
        if (!coinsData.coins || coinsData.coins.length === 0) {
            statsDiv.style.display = 'none';
            return;
        }
        
        // For each coin, build stat cards (only if workers > 0)
        let coinGridsHtml = '';
        
        for (const coinType of coinsData.coins) {
            // Fetch stats for this specific coin
            const [workersResp, effortResp, blocksResp, rewardResp] = await Promise.all([
                fetch(`/api/widgets/widgets/ckpool-workers?coin=${coinType}`),
                fetch(`/api/widgets/widgets/ckpool-effort?coin=${coinType}`),
                fetch(`/api/widgets/widgets/ckpool-blocks?coin=${coinType}`),
                fetch(`/api/widgets/widgets/ckpool-reward?coin=${coinType}`)
            ]);
            
            const workersData = await workersResp.json();
            const effortData = await effortResp.json();
            const blocksData = await blocksResp.json();
            const rewardData = await rewardResp.json();
            
            // Skip if no workers connected or no hashrate for this coin
            if (workersData.workers === 0 || workersData.hashrate_1m_gh === 0) {
                continue;
            }
        
            
            // Coin-specific logos
            let coinLogo = '';
            
            if (coinType === 'BTC') {
                coinLogo = `<svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><circle cx="16" cy="16" r="16" fill="#f7931a"/><path fill="#fff" d="M23.189 14.02c.314-2.096-1.283-3.223-3.465-3.975l.708-2.84-1.728-.43-.69 2.765c-.454-.113-.92-.22-1.385-.326l.695-2.783L15.596 6l-.708 2.839c-.376-.086-.746-.17-1.104-.26l.002-.009-2.384-.595-.46 1.846s1.283.294 1.256.312c.7.175.826.638.805 1.006l-.806 3.235c.048.012.11.03.18.057l-.183-.045-1.13 4.532c-.086.212-.303.531-.793.41.018.025-1.256-.313-1.256-.313l-.858 1.978 2.25.561c.418.105.828.215 1.231.318l-.715 2.872 1.727.43.708-2.84c.472.127.93.245 1.378.357l-.706 2.828 1.728.43.715-2.866c2.948.558 5.164.333 6.097-2.333.752-2.146-.037-3.385-1.588-4.192 1.13-.26 1.98-1.003 2.207-2.538zm-3.95 5.538c-.533 2.147-4.148.986-5.32.695l.95-3.805c1.172.293 4.929.872 4.37 3.11zm.535-5.569c-.487 1.953-3.495.96-4.47.717l.86-3.45c.975.243 4.118.696 3.61 2.733z"/></svg>`;
            } else if (coinType === 'BCH') {
                coinLogo = `<svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><circle cx="16" cy="16" r="16" fill="#8dc351"/><path fill="#fff" d="M23.189 14.02c.314-2.096-1.283-3.223-3.465-3.975l.708-2.84-1.728-.43-.69 2.765c-.454-.113-.92-.22-1.385-.326l.695-2.783L15.596 6l-.708 2.839c-.376-.086-.746-.17-1.104-.26l.002-.009-2.384-.595-.46 1.846s1.283.294 1.256.312c.7.175.826.638.805 1.006l-.806 3.235c.048.012.11.03.18.057l-.183-.045-1.13 4.532c-.086.212-.303.531-.793.41.018.025-1.256-.313-1.256-.313l-.858 1.978 2.25.561c.418.105.828.215 1.231.318l-.715 2.872 1.727.43.708-2.84c.472.127.93.245 1.378.357l-.706 2.828 1.728.43.715-2.866c2.948.558 5.164.333 6.097-2.333.752-2.146-.037-3.385-1.588-4.192 1.13-.26 1.98-1.003 2.207-2.538zm-3.95 5.538c-.533 2.147-4.148.986-5.32.695l.95-3.805c1.172.293 4.929.872 4.37 3.11zm.535-5.569c-.487 1.953-3.495.96-4.47.717l.86-3.45c.975.243 4.118.696 3.61 2.733z"/></svg>`;
            } else if (coinType === 'DGB') {
                coinLogo = `<svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 6px;"><circle cx="16" cy="16" r="16" fill="#006AD2"/><path fill="#fff" d="M16 6l-8 4v12l8 4 8-4V10l-8-4zm5.5 14.5l-5.5 2.75-5.5-2.75v-9l5.5-2.75 5.5 2.75v9z"/></svg>`;
            }
            
            // Create a separate grid for this coin's 4 stat cards
            coinGridsHtml += `
                <div class="stats-grid">
                    <a href="/analytics/ckpool?coin=${coinType}" class="stat-card" style="text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-label">${coinLogo}Workers Online</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${workersData.workers}
                            <br><small style="color: var(--text-secondary); font-size: 0.875rem;">${workersData.hashrate_display}</small>
                        </div>
                    </a>
                    <a href="/analytics/ckpool?coin=${coinType}" class="stat-card" style="text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-label">${coinLogo}Mining Effort</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${effortData.effort_display}
                            <br><small style="color: var(--text-secondary); font-size: 0.875rem;">${effortData.time_since_last_block || 'Unknown'}</small>
                        </div>
                    </a>
                    <a href="/analytics/ckpool?coin=${coinType}" class="stat-card" style="text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-label">${coinLogo}Blocks (24h/7d/30d)</div>
                        <div class="stat-value" style="font-size: 1.5rem;">
                            ${blocksData.blocks_1d} / ${blocksData.blocks_7d} / ${blocksData.blocks_28d}
                            <br><small style="color: var(--text-secondary); font-size: 0.875rem;">${blocksData.value_display}${cacheAgeIndicator}</small>
                        </div>
                    </a>
                    <a href="/analytics/ckpool?coin=${coinType}" class="stat-card" style="text-decoration: none; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-4px)'" onmouseout="this.style.transform='translateY(0)'">
                        <div class="stat-label">${coinLogo}Total Paid</div>
                        <div class="stat-value" style="font-size: 1.25rem;">${rewardData.coins_display}<br><span style="font-size: 0.9rem; color: var(--text-secondary);">${rewardData.value_display}${cacheAgeIndicator}</span></div>
                    </a>
                </div>
            `;
        }
        
        // Hide section if no active workers on any coin
        if (coinGridsHtml === '') {
            statsDiv.style.display = 'none';
            return;
        }
        
        statsDiv.innerHTML = coinGridsHtml;
    } catch (error) {
        console.error('Failed to load CKPool stats:', error);
        document.getElementById('ckpool-stats').style.display = 'none';
    }
}

// Load dashboard data
async function loadDashboard() {
    try {
        // Single optimized API call that returns everything
        const response = await fetch('/api/dashboard/all', {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        });
        const data = await response.json();
        
        // Update stats
        const stats = data.stats;
        document.getElementById('total-miners').textContent = stats.total_miners;
        document.getElementById('total-hashrate').textContent = formatHashrate(stats.total_hashrate_ghs);
        
        // Update offline miners count with color coding
        const offlineCount = stats.offline_miners || 0;
        const offlineElement = document.getElementById('offline-miners');
        offlineElement.textContent = offlineCount;
        
        // Style the stat card based on offline count
        const offlineCard = offlineElement.closest('.stat-card');
        if (offlineCount > 0) {
            offlineCard.style.backgroundColor = 'rgba(249, 115, 22, 0.1)';
            offlineCard.style.borderColor = '#f97316';
            offlineElement.style.color = '#f97316';
        } else {
            offlineCard.style.backgroundColor = '';
            offlineCard.style.borderColor = '';
            offlineElement.style.color = '#10b981'; // green when all online
        }
        
        // Update energy price with color coding
        const priceElement = document.getElementById('energy-price');
        if (stats.current_energy_price_pence !== null && stats.current_energy_price_pence !== undefined) {
            const price = stats.current_energy_price_pence;
            priceElement.textContent = price.toFixed(2) + ' p/kWh';
            
            // Color code: blue (<0), green (0-20), orange (20-30), red (30+)
            if (price < 0) {
                priceElement.style.color = '#3b82f6'; // blue
            } else if (price < 20) {
                priceElement.style.color = '#10b981'; // green
            } else if (price < 30) {
                priceElement.style.color = '#f59e0b'; // orange
            } else {
                priceElement.style.color = '#ef4444'; // red
            }
        } else {
            priceElement.textContent = '-- p/kWh';
            priceElement.style.color = ''; // reset to default
        }
        
        document.getElementById('total-cost-24h').textContent = 
            stats.total_cost_24h_pounds !== undefined ? '¬£' + stats.total_cost_24h_pounds.toFixed(2) : '¬£0.00';
        
        // Update new stats
        document.getElementById('earnings-24h').textContent = 
            stats.earnings_24h_pounds !== undefined ? '¬£' + stats.earnings_24h_pounds.toFixed(2) : '¬£0.00';
        
        const plValue = stats.pl_24h_pounds !== undefined ? stats.pl_24h_pounds : 0;
        const plElement = document.getElementById('pl-24h');
        plElement.textContent = '¬£' + plValue.toFixed(2);
        // Color code P/L: green if positive, red if negative
        if (plValue > 0) {
            plElement.style.color = '#10b981'; // green
        } else if (plValue < 0) {
            plElement.style.color = '#ef4444'; // red
        } else {
            plElement.style.color = ''; // default
        }
        
        // Update pool health with color coding
        const poolHealthElement = document.getElementById('avg-pool-health');
        if (stats.avg_pool_health !== undefined && stats.avg_pool_health !== null) {
            const health = stats.avg_pool_health;
            poolHealthElement.textContent = health.toFixed(0) + '/100';
            // Color code: red (<60), orange (60-79), green (80+)
            if (health < 60) {
                poolHealthElement.style.color = '#ef4444'; // red
            } else if (health < 80) {
                poolHealthElement.style.color = '#f59e0b'; // orange
            } else {
                poolHealthElement.style.color = '#10b981'; // green
            }
        } else {
            poolHealthElement.textContent = '--';
            poolHealthElement.style.color = ''; // default
        }

        // Load pool integration stats
        await loadBraiinsStats();
        await loadSupportXMRStats();
        await loadSolopoolStats();
        await loadP2PoolStats();
        await loadMoneroSoloStats();
        await loadCKPoolStats();
        
        // Check if any pools are visible
        checkPoolsVisibility();
    } catch (error) {
        console.error('Failed to load dashboard:', error);
    }
}

// Tab switching
function switchTab(tabName) {
    // Update tab buttons
    document.querySelectorAll('.dashboard-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Find and activate the clicked tab button
    const clickedButton = document.querySelector(`.dashboard-tab[data-tab="${tabName}"]`);
    if (clickedButton) {
        clickedButton.classList.add('active');
    }
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    document.getElementById(`tab-${tabName}`).classList.add('active');
    
    // Load content for specific tabs (wait for pool tiles to be loaded first)
    if (tabName === 'asic' && !window.asicStatsLoaded) {
        // Wait a bit for pool tiles to render, then load ASIC
        setTimeout(() => {
            loadASICStats();
            window.asicStatsLoaded = true;
        }, 100);
    } else if (tabName === 'cpu' && !window.cpuStatsLoaded) {
        // Wait a bit for pool tiles to render, then load CPU
        setTimeout(() => {
            loadCPUStats();
            window.cpuStatsLoaded = true;
        }, 100);
    } else if (tabName === 'agile' && !window.agileStatsLoaded) {
        loadAgileStrategyStats();
        window.agileStatsLoaded = true;
    }
    
    // Save preference
    localStorage.setItem('dashboardActiveTab', tabName);
}

// Check if any pool tiles are visible
function checkPoolsVisibility() {
    const braiins = document.getElementById('braiins-stats').style.display !== 'none';
    const supportxmr = document.getElementById('supportxmr-stats').style.display !== 'none';
    const solopool = document.getElementById('solopool-stats').style.display !== 'none';
    const p2pool = document.getElementById('p2pool-stats').style.display !== 'none';
    const moneroSolo = document.getElementById('monero-solo-stats').style.display !== 'none';
    const ckpool = document.getElementById('ckpool-stats').style.display !== 'none';
    
    const anyVisible = braiins || supportxmr || solopool || p2pool || moneroSolo || ckpool;
    document.getElementById('no-pools-message').style.display = anyVisible ? 'none' : 'block';
}

// Load ASIC Mining stats (Braiins, Solopool, CKPool)
async function loadASICStats() {
    try {
        // Load all ASIC pool integrations
        const pools = await Promise.all([
            loadBraiinsStatsASIC(),
            loadSolopoolStatsASIC(),
            loadCKPoolStatsASIC()
        ]);
        
        // Sort tiles by worker count
        sortPoolTiles('tab-asic', pools);
        
        // Check if any ASIC pools are visible
        checkASICPoolsVisibility();
    } catch (error) {
        console.error('Failed to load ASIC stats:', error);
    }
}

// Check if any ASIC pool tiles are visible
function checkASICPoolsVisibility() {
    const braiins = document.getElementById('braiins-stats-asic').style.display !== 'none';
    const solopool = document.getElementById('solopool-stats-asic').style.display !== 'none';
    const ckpool = document.getElementById('ckpool-stats-asic').style.display !== 'none';
    
    const anyVisible = braiins || solopool || ckpool;
    document.getElementById('no-asic-pools-message').style.display = anyVisible ? 'none' : 'block';
}

// Load Braiins stats for ASIC tab
async function loadBraiinsStatsASIC() {
    try {
        const response = await fetch('/api/settings/braiins/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('braiins-stats-asic');
        const workers = (data.enabled && data.stats) ? (data.stats.workers_online || 0) : 0;
        statsDiv.setAttribute('data-worker-count', workers);
        
        // Copy content from Pools tab if source exists and has content
        const sourceDiv = document.getElementById('braiins-stats');
        if (sourceDiv && sourceDiv.innerHTML.trim()) {
            statsDiv.innerHTML = sourceDiv.innerHTML;
            statsDiv.style.display = sourceDiv.style.display;
        } else {
            statsDiv.style.display = 'none';
        }
        
        return { id: 'braiins-stats-asic', workers: workers };
    } catch (error) {
        console.error('Failed to load Braiins stats for ASIC tab:', error);
        return { id: 'braiins-stats-asic', workers: 0 };
    }
}

// Load Solopool stats for ASIC tab
async function loadSolopoolStatsASIC() {
    try {
        const response = await fetch('/api/settings/solopool/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('solopool-stats-asic');
        const workers = (data.enabled && data.stats) ? (data.stats.workers_online || 0) : 0;
        statsDiv.setAttribute('data-worker-count', workers);
        
        // Copy content from Pools tab if source exists and has content
        const sourceDiv = document.getElementById('solopool-stats');
        if (sourceDiv && sourceDiv.innerHTML.trim()) {
            statsDiv.innerHTML = sourceDiv.innerHTML;
            statsDiv.style.display = sourceDiv.style.display;
        } else {
            statsDiv.style.display = 'none';
        }
        
        return { id: 'solopool-stats-asic', workers: workers };
    } catch (error) {
        console.error('Failed to load Solopool stats for ASIC tab:', error);
        return { id: 'solopool-stats-asic', workers: 0 };
    }
}

// Load CKPool stats for ASIC tab
async function loadCKPoolStatsASIC() {
    try {
        const response = await fetch('/api/widgets/widgets/ckpool-workers');
        const data = await response.json();
        
        const statsDiv = document.getElementById('ckpool-stats-asic');
        const workers = data.workers_online || 0;
        statsDiv.setAttribute('data-worker-count', workers);
        
        // Copy content from Pools tab if source exists and has content
        const sourceDiv = document.getElementById('ckpool-stats');
        if (sourceDiv && sourceDiv.innerHTML.trim()) {
            statsDiv.innerHTML = sourceDiv.innerHTML;
            statsDiv.style.display = sourceDiv.style.display;
        } else {
            statsDiv.style.display = 'none';
        }
        
        return { id: 'ckpool-stats-asic', workers: workers };
    } catch (error) {
        console.error('Failed to load CKPool stats for ASIC tab:', error);
        return { id: 'ckpool-stats-asic', workers: 0 };
    }
}

// Load CPU Mining stats
async function loadCPUStats() {
    try {
        // Load all CPU pool integrations
        const pools = await Promise.all([
            loadSolopoolStatsCPU(),
            loadSupportXMRStatsCPU(),
            loadP2PoolStatsCPU(),
            loadMoneroSoloStatsCPU()
        ]);
        
        // Sort tiles by worker count
        sortPoolTiles('tab-cpu', pools);
        
        // Check if any CPU pools are visible
        checkCPUPoolsVisibility();
    } catch (error) {
        console.error('Failed to load CPU stats:', error);
    }
}

// Check if any CPU pool tiles are visible
function checkCPUPoolsVisibility() {
    const solopool = document.getElementById('solopool-stats-cpu').style.display !== 'none';
    const supportxmr = document.getElementById('supportxmr-stats-cpu').style.display !== 'none';
    const p2pool = document.getElementById('p2pool-stats-cpu').style.display !== 'none';
    const moneroSolo = document.getElementById('monero-solo-stats-cpu').style.display !== 'none';
    
    const anyVisible = solopool || supportxmr || p2pool || moneroSolo;
    document.getElementById('no-cpu-pools-message').style.display = anyVisible ? 'none' : 'block';
}

// Load Solopool stats for CPU tab (XMR)
async function loadSolopoolStatsCPU() {
    try {
        const response = await fetch('/api/settings/solopool/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('solopool-stats-cpu');
        const workers = (data.enabled && data.stats) ? (data.stats.workers_online || 0) : 0;
        statsDiv.setAttribute('data-worker-count', workers);
        
        // Copy content from Pools tab if source exists and has content
        const sourceDiv = document.getElementById('solopool-stats');
        if (sourceDiv && sourceDiv.innerHTML.trim()) {
            statsDiv.innerHTML = sourceDiv.innerHTML;
            statsDiv.style.display = sourceDiv.style.display;
        } else {
            statsDiv.style.display = 'none';
        }
        
        return { id: 'solopool-stats-cpu', workers: workers };
    } catch (error) {
        console.error('Failed to load Solopool stats for CPU tab:', error);
        return { id: 'solopool-stats-cpu', workers: 0 };
    }
}

// Load SupportXMR stats for CPU tab
async function loadSupportXMRStatsCPU() {
    try {
        const response = await fetch('/api/settings/supportxmr/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('supportxmr-stats-cpu');
        const workers = (data.enabled && data.stats) ? (data.stats.workers_online || 0) : 0;
        statsDiv.setAttribute('data-worker-count', workers);
        
        // Copy content from Pools tab if source exists and has content
        const sourceDiv = document.getElementById('supportxmr-stats');
        if (sourceDiv && sourceDiv.innerHTML.trim()) {
            statsDiv.innerHTML = sourceDiv.innerHTML;
            statsDiv.style.display = sourceDiv.style.display;
        } else {
            statsDiv.style.display = 'none';
        }
        
        return { id: 'supportxmr-stats-cpu', workers: workers };
    } catch (error) {
        console.error('Failed to load SupportXMR stats for CPU tab:', error);
        return { id: 'supportxmr-stats-cpu', workers: 0 };
    }
}

// Load P2Pool stats for CPU tab
async function loadP2PoolStatsCPU() {
    try {
        const response = await fetch('/api/settings/p2pool/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('p2pool-stats-cpu');
        const workers = (data.enabled && data.stats) ? (data.stats.workers_online || 0) : 0;
        statsDiv.setAttribute('data-worker-count', workers);
        
        // Copy content from Pools tab if source exists and has content
        const sourceDiv = document.getElementById('p2pool-stats');
        if (sourceDiv && sourceDiv.innerHTML.trim()) {
            statsDiv.innerHTML = sourceDiv.innerHTML;
            statsDiv.style.display = sourceDiv.style.display;
        } else {
            statsDiv.style.display = 'none';
        }
        
        return { id: 'p2pool-stats-cpu', workers: workers };
    } catch (error) {
        console.error('Failed to load P2Pool stats for CPU tab:', error);
        return { id: 'p2pool-stats-cpu', workers: 0 };
    }
}

// Load Monero Solo stats for CPU tab
async function loadMoneroSoloStatsCPU() {
    try {
        const response = await fetch('/api/settings/monero-solo/stats');
        const data = await response.json();
        
        const statsDiv = document.getElementById('monero-solo-stats-cpu');
        const workers = (data.enabled && data.stats) ? (data.stats.workers_online || 0) : 0;
        statsDiv.setAttribute('data-worker-count', workers);
        
        // Copy content from Pools tab if source exists and has content
        const sourceDiv = document.getElementById('monero-solo-stats');
        if (sourceDiv && sourceDiv.innerHTML.trim()) {
            statsDiv.innerHTML = sourceDiv.innerHTML;
            statsDiv.style.display = sourceDiv.style.display;
        } else {
            statsDiv.style.display = 'none';
        }
        
        return { id: 'monero-solo-stats-cpu', workers: workers };
    } catch (error) {
        console.error('Failed to load Monero Solo stats for CPU tab:', error);
        return { id: 'monero-solo-stats-cpu', workers: 0 };
    }
}

// Sort pool tiles by worker count (highest first)
function sortPoolTiles(tabId, pools) {
    const tab = document.getElementById(tabId);
    if (!tab) return;
    
    // Sort pools by worker count descending
    pools.sort((a, b) => b.workers - a.workers);
    
    // Reorder DOM elements
    pools.forEach(pool => {
        const element = document.getElementById(pool.id);
        if (element && element.parentNode === tab) {
            tab.appendChild(element);
        }
    });
}

// Load Agile Solo Strategy stats
async function loadAgileStrategyStats() {
    const container = document.getElementById('agile-stats-container');
    
    try {
        const response = await fetch('/api/settings/agile-solo-strategy');
        const data = await response.json();
        
        if (!data.enabled) {
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                    <p style="font-size: 1.25rem; margin-bottom: 1rem;">üéØ Agile Solo Strategy Disabled</p>
                    <p>Enable the strategy in <a href="/settings/agile-solo-strategy" style="color: var(--info);">Settings ‚Üí Agile Solo Strategy</a></p>
                </div>
            `;
            return;
        }
        
        const enrolledCount = data.enrolled_miners.length;
        const currentBand = data.current_price_band || 'Unknown';
        const lastPrice = data.last_price_checked !== null ? data.last_price_checked.toFixed(2) + ' p/kWh' : 'N/A';
        const lastAction = data.last_action_time ? new Date(data.last_action_time).toLocaleString() : 'Never';
        
        // Band colors
        const bandColors = {
            'off': '#6b7280',
            'dgb_high': '#10b981',
            'dgb_med': '#3b82f6',
            'bch': '#f59e0b',
            'btc': '#ef4444'
        };
        
        const bandColor = bandColors[currentBand] || '#6b7280';
        
        container.innerHTML = `
            <div class="stats-grid compact-grid">
                <div class="stat-card" onclick="window.location.href='/settings/agile-solo-strategy'" style="cursor: pointer;">
                    <div class="stat-label">Strategy Status</div>
                    <div class="stat-value" style="color: #10b981;">‚úì Enabled</div>
                </div>
                <div class="stat-card" onclick="window.location.href='/settings/agile-solo-strategy'" style="cursor: pointer;">
                    <div class="stat-label">Enrolled Miners</div>
                    <div class="stat-value">${enrolledCount}</div>
                </div>
                <div class="stat-card" onclick="window.location.href='/settings/agile-solo-strategy'" style="cursor: pointer;">
                    <div class="stat-label">Current Price Band</div>
                    <div class="stat-value" style="color: ${bandColor};">${currentBand.toUpperCase()}</div>
                </div>
                <div class="stat-card" onclick="window.location.href='/settings/agile-solo-strategy'" style="cursor: pointer;">
                    <div class="stat-label">Last Price</div>
                    <div class="stat-value">${lastPrice}</div>
                </div>
            </div>
            
            <div style="margin-top: 1rem;">
                <h3 style="font-size: 1.1rem; margin-bottom: 0.75rem; color: var(--text-primary);">Enrolled Miners</h3>
                <div class="stats-grid">
                    ${data.enrolled_miners.map(miner => `
                        <a href="/miners/${miner.id}" class="stat-card" style="text-decoration: none; cursor: pointer;">
                            <div class="stat-label">
                                ${miner.type === 'bitaxe' ? '‚ö°' : miner.type === 'nerdqaxe' ? 'üîß' : 'üèîÔ∏è'} ${miner.name}
                            </div>
                            <div class="stat-value" style="font-size: 1rem;">
                                ${miner.type}
                            </div>
                        </a>
                    `).join('')}
                </div>
            </div>
            
            <div style="margin-top: 1rem; padding: 1rem; background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 8px;">
                <p style="margin: 0; color: var(--text-secondary); font-size: 0.875rem;">
                    <strong>Last Action:</strong> ${lastAction}
                </p>
            </div>
        `;
        
    } catch (error) {
        console.error('Failed to load Agile Strategy stats:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                <p style="color: #ef4444;">‚ùå Failed to load Agile Solo Strategy stats</p>
            </div>
        `;
    }
}

// Wait for app.js to load before initializing dashboard
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDashboard);
} else {
    initDashboard();
}

function initDashboard() {
    // Restore active tab preference
    const savedTab = localStorage.getItem('dashboardActiveTab') || 'pools';
    if (savedTab !== 'pools') {
        switchTab(savedTab);
    }
    
    loadDashboard();
    setInterval(loadDashboard, 60000); // Refresh every 60s
}
</script>
{% endblock %}
