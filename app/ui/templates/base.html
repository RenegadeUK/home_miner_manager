<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Home Miner Manager{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Manage and monitor your ASIC miners with real-time telemetry and automation">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Miner Control">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <link rel="stylesheet" href="/static/style.css?v=8">
    <style>
        /* Theme Variables */
        :root[data-theme="dark"], :root:not([data-theme]) {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #374151;
            --bg-hover: #4a5568;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4a5568;
            --card-bg: #2d3748;
            --card-header: #374151;
            --input-bg: #1f2937;
            --input-border: #4a5568;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        
        :root[data-theme="light"] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --bg-hover: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: var(--text-secondary);
            --card-bg: #ffffff;
            --card-header: #f3f4f6;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        
        /* Apply theme variables */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .sidebar {
            background: var(--bg-secondary);
            border-right-color: var(--border-color);
        }
        
        .sidebar-nav a {
            color: var(--text-secondary);
        }
        
        .sidebar-nav a:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .sidebar-nav a.active {
            background: var(--info);
            color: white;
        }
        
        .card, .stat-card, .tile {
            background: var(--card-bg);
            border-color: var(--border-color);
        }
        
        .card-header {
            background: var(--card-header);
            border-bottom-color: var(--border-color);
        }
        
        input, select, textarea {
            background: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--info);
        }
        
        .breadcrumbs {
            color: var(--text-secondary);
        }
        
        .breadcrumbs a {
            color: var(--text-secondary);
        }
        
        .breadcrumbs a:hover {
            color: var(--text-primary);
        }
    </style>
    {% block extra_head %}{% endblock %}
    <script>
        // Apply theme immediately on page load (before render)
        (function() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === null || darkMode === 'true') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <h1>‚õèÔ∏è Miner Controller</h1>
            </div>
            <nav>
                <ul class="sidebar-nav">
                    <li><a href="/" class="{% if request.url.path == '/' %}active{% endif %}">
                        üìä Dashboard
                    </a></li>
                    <li><a href="/miners" class="{% if '/miners' in request.url.path %}active{% endif %}">
                        üñ•Ô∏è Miners
                    </a></li>
                    <li><a href="/pools" class="{% if '/pools' in request.url.path %}active{% endif %}">
                        üåä Pools
                    </a></li>
                    <li><a href="/analytics" class="{% if '/analytics' in request.url.path %}active{% endif %}">
                        üìä Analytics
                    </a></li>
                    <li><a href="/settings" class="{% if '/settings' in request.url.path %}active{% endif %}">
                        ‚öôÔ∏è Settings
                    </a></li>
                    <li><a href="/faq" class="{% if '/faq' in request.url.path %}active{% endif %}">
                        ‚ùì FAQ
                    </a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="https://danvic.dev" target="_blank" rel="noopener noreferrer" class="danvic-logo">
                    <svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
                        <!-- D -->
                        <path d="M10 15 L10 45 L25 45 C35 45 40 40 40 30 C40 20 35 15 25 15 Z M17 22 L24 22 C29 22 32 25 32 30 C32 35 29 38 24 38 L17 38 Z" fill="#3b82f6"/>
                        <!-- A -->
                        <path d="M50 45 L55 35 L70 35 L75 45 L83 45 L68 15 L57 15 L42 45 Z M58 28 L62.5 18 L67 28 Z" fill="#3b82f6"/>
                        <!-- N -->
                        <path d="M90 15 L90 45 L97 45 L97 25 L112 45 L119 45 L119 15 L112 15 L112 35 L97 15 Z" fill="#3b82f6"/>
                        <!-- V -->
                        <path d="M130 15 L140 40 L150 15 L158 15 L143 48 L137 48 L122 15 Z" fill="#3b82f6"/>
                        <!-- I -->
                        <path d="M168 15 L168 45 L175 45 L175 15 Z" fill="#3b82f6"/>
                        <!-- C -->
                        <path d="M185 22 C190 17 195 17 198 20 L198 27 C195 24 190 24 187 27 C184 30 184 35 187 38 C190 41 195 41 198 38 L198 45 C195 48 190 48 185 43 C180 38 180 27 185 22 Z" fill="#3b82f6"/>
                        <!-- .dev -->
                        <text x="10" y="55" font-family="monospace" font-size="10" fill="#a0a0a0">.dev</text>
                    </svg>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Breadcrumbs -->
            {% if breadcrumbs %}
            <div class="breadcrumbs">
                {% for crumb in breadcrumbs %}
                    {% if not loop.last %}
                        <a href="{{ crumb.url }}">{{ crumb.label }}</a>
                        <span>/</span>
                    {% else %}
                        <span>{{ crumb.label }}</span>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Page Header -->
            <div class="page-header">
                <h1>{{ page_title }}</h1>
                <div id="price-ticker" class="price-ticker"></div>
            </div>

            <!-- Page Content -->
            {% block content %}{% endblock %}
        </main>
    </div>

    <script src="/static/app.js"></script>
    <script>
        // Load crypto prices ticker
        async function loadPriceTicker() {
            try {
                const response = await fetch('/api/settings/crypto-prices');
                const data = await response.json();
                
                if (!data.success) return;
                
                const getCacheIndicator = (ageMinutes) => {
                    if (!ageMinutes && ageMinutes !== 0) return '';
                    let color = '#28a745';
                    if (ageMinutes >= 120) color = '#dc3545';
                    else if (ageMinutes >= 30) color = '#ffc107';
                    return `<span style="font-size: 0.65rem; color: ${color}; margin-left: 2px;">‚óè</span>`;
                };
                
                const cacheIndicator = getCacheIndicator(data.age_minutes);
                
                const prices = [];
                if (data.bitcoin > 0) prices.push(`BTC ¬£${data.bitcoin.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}${cacheIndicator}`);
                if (data['bitcoin-cash'] > 0) prices.push(`BCH ¬£${data['bitcoin-cash'].toFixed(0)}${cacheIndicator}`);
                if (data.digibyte > 0) prices.push(`DGB ¬£${data.digibyte.toFixed(4)}${cacheIndicator}`);
                if (data.monero > 0) prices.push(`XMR ¬£${data.monero.toFixed(0)}${cacheIndicator}`);
                
                if (prices.length > 0) {
                    document.getElementById('price-ticker').innerHTML = prices.join('<span style="margin: 0 8px; color: #666;">|</span>');
                }
            } catch (error) {
                console.error('Failed to load price ticker:', error);
            }
        }
        
        // Load prices on page load and refresh every 30 seconds
        loadPriceTicker();
        setInterval(loadPriceTicker, 30000);
        
        // Mobile menu functionality
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');
        
        // Initialize sidebar as open on desktop
        if (window.innerWidth > 768) {
            sidebar.classList.add('active');
            document.body.classList.add('sidebar-open');
        }
        
        function toggleMobileMenu() {
            sidebar.classList.toggle('active');
            
            // Update body class for desktop layout
            if (window.innerWidth > 768) {
                document.body.classList.toggle('sidebar-open');
            } else {
                mobileOverlay.classList.toggle('active');
            }
        }
        
        mobileMenuToggle.addEventListener('click', toggleMobileMenu);
        mobileOverlay.addEventListener('click', toggleMobileMenu);
        
        // Close menu when clicking a link
        const sidebarLinks = sidebar.querySelectorAll('a');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleMobileMenu();
                }
            });
        });
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then((registration) => {
                        console.log('PWA: Service Worker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('PWA: New version available! Reload to update.');
                                    // Could show a toast here to notify user
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('PWA: Service Worker registration failed:', error);
                    });
            });
            
            // Handle install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('PWA: Install prompt available');
                // Could show custom install button here
            });
            
            // Track installation
            window.addEventListener('appinstalled', () => {
                console.log('PWA: App installed successfully');
                deferredPrompt = null;
            });
        }
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
