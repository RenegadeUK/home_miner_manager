<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}HMM Local{% endblock %}</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Manage and monitor your ASIC miners with real-time telemetry and automation">
    <meta name="theme-color" content="#3b82f6">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Miner Control">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="/static/favicon.svg">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="apple-touch-icon" href="/static/icons/icon-192x192.png">
    
    <link rel="stylesheet" href="/static/style.css?v=19">
    <style>
        /* Theme Variables */
        :root[data-theme="dark"], :root:not([data-theme]) {
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #374151;
            --bg-hover: #4a5568;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --border-color: #4a5568;
            --card-bg: #2d3748;
            --card-header: #374151;
            --input-bg: #1f2937;
            --input-border: #4a5568;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        
        :root[data-theme="light"] {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f3f4f6;
            --bg-hover: #e5e7eb;
            --text-primary: #111827;
            --text-secondary: #4b5563;
            --border-color: var(--text-secondary);
            --card-bg: #ffffff;
            --card-header: #f3f4f6;
            --input-bg: #ffffff;
            --input-border: #d1d5db;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
        }
        
        /* Apply theme variables */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .sidebar {
            background: var(--bg-secondary);
            border-right-color: var(--border-color);
        }
        
        .sidebar-nav a {
            color: var(--text-secondary);
        }
        
        .sidebar-nav a:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }
        
        .sidebar-nav a.active {
            background: var(--info);
            color: white;
        }
        
        .card, .stat-card, .tile {
            background: var(--card-bg);
            border-color: var(--border-color);
        }
        
        .card-header {
            background: var(--card-header);
            border-bottom-color: var(--border-color);
        }
        
        input, select, textarea {
            background: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-primary);
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--info);
        }
        
        .breadcrumbs {
            color: var(--text-secondary);
        }
        
        .breadcrumbs a {
            color: var(--text-secondary);
        }
        
        .breadcrumbs a:hover {
            color: var(--text-primary);
        }
    </style>
    {% block extra_head %}{% endblock %}
    <script>
        // Apply theme immediately on page load (before render)
        (function() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === null || darkMode === 'true') {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
</head>
<body>
    <!-- Skip to main content link -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <!-- ARIA live region for status announcements -->
    <div aria-live="polite" aria-atomic="true" class="sr-only" id="status-announcer"></div>
    
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobile-menu-toggle" aria-label="Toggle navigation menu">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
        </svg>
    </button>
    
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay"></div>
    
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <h1>HMM<sup style="color: #f59e0b; font-size: 0.6em; font-weight: 900; margin-left: 4px;">Local</sup></h1>
                <div style="font-size: 0.65rem; color: var(--text-secondary); margin-top: 4px; font-family: monospace; opacity: 0.7;">
                    {{ git_commit|default('dev') }}
                </div>
            </div>
            <nav>
                <ul class="sidebar-nav">
                    <li id="nav-asic-dashboard"><a href="/" class="{% if request.url.path == '/' %}active{% endif %}">
                        ‚ö° ASIC Dashboard
                    </a></li>
                    <li id="nav-cpu-dashboard"><a href="/dashboard/cpu" class="{% if request.url.path == '/dashboard/cpu' %}active{% endif %}">
                        üñ•Ô∏è CPU Dashboard
                    </a></li>
                    <li><a href="/leaderboard" class="{% if '/leaderboard' in request.url.path %}active{% endif %}">
                        üèÜ Leaderboard
                    </a></li>
                    <li class="nav-separator"><a href="/miners" class="{% if '/miners' in request.url.path %}active{% endif %}">
                        üñ•Ô∏è Miners
                    </a></li>
                    <li><a href="/pools" class="{% if '/pools' in request.url.path %}active{% endif %}">
                        üåä Pools
                    </a></li>
                    <li><a href="/settings" class="{% if '/settings' in request.url.path %}active{% endif %}">
                        ‚öôÔ∏è Settings
                    </a></li>
                    <li class="nav-separator">
                        <a href="#" id="sam-trigger" class="nav-sam" title="Sam - AI Assistant">
                            ü§ñ Sam
                            <span class="sam-status-dot" id="sam-status-dot"></span>
                        </a>
                    </li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <a href="https://danvic.dev" target="_blank" rel="noopener noreferrer" class="danvic-logo">
                    <svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg">
                        <!-- D -->
                        <path d="M10 15 L10 45 L25 45 C35 45 40 40 40 30 C40 20 35 15 25 15 Z M17 22 L24 22 C29 22 32 25 32 30 C32 35 29 38 24 38 L17 38 Z" fill="#3b82f6"/>
                        <!-- A -->
                        <path d="M50 45 L55 35 L70 35 L75 45 L83 45 L68 15 L57 15 L42 45 Z M58 28 L62.5 18 L67 28 Z" fill="#3b82f6"/>
                        <!-- N -->
                        <path d="M90 15 L90 45 L97 45 L97 25 L112 45 L119 45 L119 15 L112 15 L112 35 L97 15 Z" fill="#3b82f6"/>
                        <!-- V -->
                        <path d="M130 15 L140 40 L150 15 L158 15 L143 48 L137 48 L122 15 Z" fill="#3b82f6"/>
                        <!-- I -->
                        <path d="M168 15 L168 45 L175 45 L175 15 Z" fill="#3b82f6"/>
                        <!-- C -->
                        <path d="M185 22 C190 17 195 17 198 20 L198 27 C195 24 190 24 187 27 C184 30 184 35 187 38 C190 41 195 41 198 38 L198 45 C195 48 190 48 185 43 C180 38 180 27 185 22 Z" fill="#3b82f6"/>
                        <!-- .dev -->
                        <text x="10" y="55" font-family="monospace" font-size="10" fill="#a0a0a0">.dev</text>
                    </svg>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <!-- Crypto Price Ticker at Top -->
            <div style="display: flex; justify-content: flex-end; margin-bottom: 1rem;">
                <div id="price-ticker" class="price-ticker"></div>
            </div>
            
            <!-- Breadcrumbs -->
            {% if breadcrumbs %}
            <div class="breadcrumbs">
                {% for crumb in breadcrumbs %}
                    {% if not loop.last %}
                        <a href="{{ crumb.url }}">{{ crumb.label }}</a>
                        <span>/</span>
                    {% else %}
                        <span>{{ crumb.label }}</span>
                    {% endif %}
                {% endfor %}
            </div>
            {% endif %}

            <!-- Page Content -->
            {% block content %}{% endblock %}
        </main>
    </div>

    <script src="/static/app.js"></script>
    <script>
        // Load crypto prices ticker
        async function loadPriceTicker() {
            try {
                const response = await fetch('/api/settings/crypto-prices');
                const data = await response.json();
                
                if (!data.success) return;
                
                const getCacheIndicator = (ageMinutes) => {
                    if (!ageMinutes && ageMinutes !== 0) return '';
                    let color = '#28a745';
                    if (ageMinutes >= 120) color = '#dc3545';
                    else if (ageMinutes >= 30) color = '#ffc107';
                    return `<span style="font-size: 0.65rem; color: ${color}; margin-left: 2px;">‚óè</span>`;
                };
                
                const cacheIndicator = getCacheIndicator(data.age_minutes);
                
                const prices = [];
                
                // Fetch energy price from dashboard API
                try {
                    const dashboardResponse = await fetch('/api/dashboard/all?dashboard_type=all');
                    const dashboardData = await dashboardResponse.json();
                    const energyPrice = dashboardData.stats.current_energy_price_pence;
                    
                    if (energyPrice !== null && energyPrice !== undefined) {
                        // Color code energy price: blue (<0), green (0-20), orange (20-30), red (30+)
                        let color = '#10b981'; // green
                        if (energyPrice < 0) color = '#3b82f6'; // blue
                        else if (energyPrice >= 30) color = '#ef4444'; // red
                        else if (energyPrice >= 20) color = '#f59e0b'; // orange
                        
                        prices.push(`<span style="color: ${color};">${energyPrice.toFixed(2)}p/kWh</span>`);
                    }
                } catch (error) {
                    console.error('Failed to load energy price:', error);
                }
                
                if (data.bitcoin > 0) prices.push(`BTC ¬£${data.bitcoin.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",")}${cacheIndicator}`);
                if (data['bitcoin-cash'] > 0) prices.push(`BCH ¬£${data['bitcoin-cash'].toFixed(0)}${cacheIndicator}`);
                if (data.bellscoin > 0) prices.push(`BC2 ¬£${data.bellscoin.toFixed(6)}${cacheIndicator}`);
                if (data.digibyte > 0) prices.push(`DGB ¬£${data.digibyte.toFixed(4)}${cacheIndicator}`);
                if (data.monero > 0) prices.push(`XMR ¬£${data.monero.toFixed(0)}${cacheIndicator}`);
                
                if (prices.length > 0) {
                    document.getElementById('price-ticker').innerHTML = prices.join('<span style="margin: 0 8px; color: #666;">|</span>');
                }
            } catch (error) {
                console.error('Failed to load price ticker:', error);
            }
        }
        
        // Load prices on page load and refresh every 30 seconds
        loadPriceTicker();
        setInterval(loadPriceTicker, 30000);
        
        // Mobile menu functionality
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const mobileOverlay = document.getElementById('mobile-overlay');
        
        // Restore sidebar state from localStorage (defaults to open on desktop)
        const sidebarOpen = localStorage.getItem('sidebarOpen');
        if (window.innerWidth > 768) {
            if (sidebarOpen === null || sidebarOpen === 'true') {
                sidebar.classList.add('active');
                document.body.classList.add('sidebar-open');
            }
        }
        
        function toggleMobileMenu() {
            sidebar.classList.toggle('active');
            
            // Update body class for desktop layout
            if (window.innerWidth > 768) {
                document.body.classList.toggle('sidebar-open');
                // Save state to localStorage
                const isOpen = sidebar.classList.contains('active');
                localStorage.setItem('sidebarOpen', isOpen);
            } else {
                mobileOverlay.classList.toggle('active');
            }
        }
        
        mobileMenuToggle.addEventListener('click', toggleMobileMenu);
        mobileOverlay.addEventListener('click', toggleMobileMenu);
        
        // Close menu when clicking a link
        const sidebarLinks = sidebar.querySelectorAll('a');
        sidebarLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768) {
                    toggleMobileMenu();
                }
            });
        });
    </script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/static/service-worker.js')
                    .then((registration) => {
                        console.log('PWA: Service Worker registered:', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('PWA: New version available! Reload to update.');
                                    // Could show a toast here to notify user
                                }
                            });
                        });
                    })
                    .catch((error) => {
                        console.log('PWA: Service Worker registration failed:', error);
                    });
            });
            
            // Handle install prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                console.log('PWA: Install prompt available');
                // Could show custom install button here
            });
            
            // Track installation
            window.addEventListener('appinstalled', () => {
                console.log('PWA: App installed successfully');
                deferredPrompt = null;
            });
        }
        
        // Apply dashboard visibility settings
        (function() {
            const asicEnabled = localStorage.getItem('dashboard.asic.enabled');
            const cpuEnabled = localStorage.getItem('dashboard.cpu.enabled');
            
            // Default: ASIC enabled, CPU disabled
            if (asicEnabled === 'false') {
                const asicNav = document.getElementById('nav-asic-dashboard');
                if (asicNav) asicNav.style.display = 'none';
            }
            
            if (cpuEnabled !== 'true') {
                const cpuNav = document.getElementById('nav-cpu-dashboard');
                if (cpuNav) cpuNav.style.display = 'none';
            }
        })();
    </script>
    
    <!-- Sam AI Assistant Floating Chat Widget -->
    <div id="sam-chat-widget" class="sam-chat-widget sam-minimized">
        <div class="sam-chat-header">
            <div class="sam-chat-title">
                <span class="sam-avatar">ü§ñ</span>
                <div>
                    <div class="sam-name">Sam</div>
                    <div class="sam-subtitle">AI Assistant</div>
                </div>
            </div>
            <div class="sam-chat-controls">
                <button id="sam-minimize-btn" class="sam-control-btn" title="Minimize">
                    <span class="minimize-icon">‚àí</span>
                    <span class="maximize-icon">‚ñ°</span>
                </button>
                <button id="sam-close-btn" class="sam-control-btn" title="Close">√ó</button>
            </div>
        </div>
        <div class="sam-chat-body">
            <div id="sam-messages" class="sam-messages">
                <div class="sam-message sam-system">
                    üëã Hi! I'm Sam, your AI mining assistant. Ask me anything about your miners, pools, blocks, or energy optimization!
                </div>
            </div>
            <div class="sam-chat-input-container">
                <textarea id="sam-input" class="sam-input" placeholder="Ask Sam anything..." rows="1"></textarea>
                <button id="sam-send-btn" class="sam-send-btn" title="Send">
                    ‚ñ∂
                </button>
            </div>
        </div>
        <div class="sam-chat-error" id="sam-error" style="display: none;">
            <span class="sam-error-icon">‚ö†Ô∏è</span>
            <span class="sam-error-text" id="sam-error-text"></span>
        </div>
    </div>
    
    <style>
        /* Sam Chat Widget Styles */
        .sam-chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 420px;
            max-height: 650px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            z-index: 9999;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .sam-chat-widget.sam-minimized {
            max-height: 60px;
            width: 200px;
        }
        
        .sam-chat-widget.sam-hidden {
            transform: translateY(calc(100% + 20px));
            opacity: 0;
            pointer-events: none;
        }
        
        .sam-chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            border-radius: 16px 16px 0 0;
            cursor: pointer;
            user-select: none;
        }
        
        .sam-minimized .sam-chat-header {
            border-radius: 16px;
        }
        
        .sam-chat-title {
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
        }
        
        .sam-avatar {
            font-size: 28px;
            line-height: 1;
        }
        
        .sam-name {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        .sam-subtitle {
            font-size: 12px;
            opacity: 0.9;
            font-weight: 400;
        }
        
        .sam-chat-controls {
            display: flex;
            gap: 8px;
        }
        
        .sam-control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 300;
            transition: background 0.2s;
        }
        
        .sam-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .sam-minimized .minimize-icon {
            display: none;
        }
        
        .sam-minimized .maximize-icon {
            display: inline;
        }
        
        .minimize-icon {
            display: inline;
        }
        
        .maximize-icon {
            display: none;
        }
        
        .sam-chat-body {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow: hidden;
            background: var(--bg-color);
        }
        
        .sam-minimized .sam-chat-body {
            display: none;
        }
        
        .sam-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--bg-color);
        }
        
        .sam-message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .sam-message.sam-user {
            background: #3b82f6;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .sam-message.sam-assistant {
            background: var(--card-bg);
            color: var(--text-color);
            align-self: flex-start;
            border: 1px solid var(--border-color);
            line-height: 1.6;
        }
        
        .sam-message.sam-assistant strong {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .sam-message.sam-system {
            background: rgba(59, 130, 246, 0.1);
            color: var(--text-secondary);
            align-self: center;
            font-size: 14px;
            text-align: center;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        .sam-message.sam-loading {
            background: var(--card-bg);
            color: var(--text-secondary);
            align-self: flex-start;
            border: 1px solid var(--border-color);
        }
        
        .sam-typing-indicator {
            display: flex;
            gap: 4px;
        }
        
        .sam-typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typingBounce 1.4s infinite;
        }
        
        .sam-typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .sam-typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes typingBounce {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-8px);
            }
        }
        
        .sam-chat-input-container {
            display: flex;
            gap: 12px;
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: var(--card-bg);
            border-radius: 0 0 16px 16px;
        }
        
        .sam-input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--bg-color);
            color: var(--text-color);
            resize: none;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.5;
            max-height: 120px;
            overflow-y: auto;
        }
        
        .sam-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .sam-send-btn {
            background: #3b82f6;
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
            flex-shrink: 0;
        }
        
        .sam-send-btn:hover:not(:disabled) {
            background: #2563eb;
        }
        
        .sam-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .sam-chat-error {
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border-top: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sam-status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #6b7280;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }
        
        .sam-status-dot.sam-configured {
            background: #10b981;
        }
        
        .sam-status-dot.sam-error {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .nav-sam {
            position: relative;
        }
        
        /* Mobile responsive */
        @media (max-width: 768px) {
            .sam-chat-widget {
                width: calc(100vw - 40px);
                max-width: 420px;
                bottom: 10px;
                right: 10px;
            }
            
            .sam-chat-widget.sam-minimized {
                width: 180px;
            }
        }
    </style>
    
    <script>
        // Sam Chat Widget JavaScript
        (function() {
            const widget = document.getElementById('sam-chat-widget');
            const trigger = document.getElementById('sam-trigger');
            const minimizeBtn = document.getElementById('sam-minimize-btn');
            const closeBtn = document.getElementById('sam-close-btn');
            const sendBtn = document.getElementById('sam-send-btn');
            const input = document.getElementById('sam-input');
            const messages = document.getElementById('sam-messages');
            const errorDiv = document.getElementById('sam-error');
            const errorText = document.getElementById('sam-error-text');
            const statusDot = document.getElementById('sam-status-dot');
            
            let isConfigured = false;
            let isProcessing = false;
            let conversationHistory = [];
            
            // Format Sam's responses for better readability
            function formatSamResponse(text) {
                // Convert markdown-style formatting to HTML
                let formatted = text
                    // Bold text: **text** -> <strong>text</strong>
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    // Numbered lists: "1. " -> line break + number
                    .replace(/(\d+)\.\s/g, '<br><br><strong>$1.</strong> ')
                    // Bullet points: "- " -> line break + bullet
                    .replace(/\n-\s/g, '<br>‚Ä¢ ')
                    // Double line breaks for paragraphs
                    .replace(/\n\n/g, '<br><br>')
                    // Single line breaks
                    .replace(/\n/g, '<br>');
                
                // Clean up leading breaks
                formatted = formatted.replace(/^(<br>)+/, '');
                
                return formatted;
            }
            
            // Check Sam configuration status
            async function checkStatus() {
                try {
                    const response = await fetch('/api/ai/status');
                    const data = await response.json();
                    isConfigured = data.configured;
                    
                    if (isConfigured) {
                        statusDot.classList.add('sam-configured');
                        statusDot.classList.remove('sam-error');
                    } else {
                        statusDot.classList.remove('sam-configured');
                        statusDot.classList.add('sam-error');
                    }
                    
                    return isConfigured;
                } catch (error) {
                    console.error('Failed to check Sam status:', error);
                    statusDot.classList.remove('sam-configured');
                    statusDot.classList.add('sam-error');
                    return false;
                }
            }
            
            // Show error message
            function showError(message) {
                errorText.textContent = message;
                errorDiv.style.display = 'flex';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
            
            // Add message to chat
            function addMessage(text, type = 'assistant') {
                const messageDiv = document.createElement('div');
                messageDiv.className = `sam-message sam-${type}`;
                messageDiv.textContent = text;
                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
                return messageDiv;
            }
            
            // Show typing indicator
            function showTyping() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'sam-message sam-loading';
                typingDiv.id = 'sam-typing';
                typingDiv.innerHTML = '<div class="sam-typing-indicator"><div class="sam-typing-dot"></div><div class="sam-typing-dot"></div><div class="sam-typing-dot"></div></div>';
                messages.appendChild(typingDiv);
                messages.scrollTop = messages.scrollHeight;
            }
            
            // Remove typing indicator
            function hideTyping() {
                const typing = document.getElementById('sam-typing');
                if (typing) typing.remove();
            }
            
            // Send message to Sam
            async function sendMessage() {
                const message = input.value.trim();
                if (!message || isProcessing) return;
                
                // Check if Sam is configured
                if (!isConfigured) {
                    showError('Sam is not configured. Please set up your OpenAI API key in Settings.');
                    return;
                }
                
                // Add user message
                addMessage(message, 'user');
                conversationHistory.push({ role: 'user', content: message });
                
                // Clear input
                input.value = '';
                input.style.height = 'auto';
                
                // Show typing indicator
                showTyping();
                isProcessing = true;
                sendBtn.disabled = true;
                
                try {
                    const response = await fetch('/api/ai/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            conversation_history: conversationHistory.slice(-10) // Last 10 messages
                        })
                    });
                    
                    hideTyping();
                    
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    
                    // Handle streaming response
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let assistantMessage = '';
                    let messageDiv = null;
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        const lines = chunk.split('\n');
                        
                        for (const line of lines) {
                            if (line.startsWith('data: ')) {
                                const data = line.slice(6);
                                if (data === '[DONE]') break;
                                
                                try {
                                    const json = JSON.parse(data);
                                    if (json.content) {
                                        assistantMessage += json.content;
                                        
                                        if (!messageDiv) {
                                            messageDiv = addMessage('', 'assistant');
                                        }
                                        
                                        // Format and display with HTML
                                        messageDiv.innerHTML = formatSamResponse(assistantMessage);
                                    }
                                } catch (e) {
                                    // Ignore parse errors for incomplete chunks
                                }
                            }
                        }
                    }
                    
                    // Add to conversation history
                    conversationHistory.push({ role: 'assistant', content: assistantMessage });
                    
                    // Keep only last 20 messages (10 exchanges)
                    if (conversationHistory.length > 20) {
                        conversationHistory = conversationHistory.slice(-20);
                    }
                    
                } catch (error) {
                    console.error('Error sending message:', error);
                    hideTyping();
                    showError('Failed to get response from Sam. Please try again.');
                } finally {
                    isProcessing = false;
                    sendBtn.disabled = false;
                }
            }
            
            // Event listeners
            trigger.addEventListener('click', (e) => {
                e.preventDefault();
                widget.classList.toggle('sam-hidden');
                if (!widget.classList.contains('sam-hidden')) {
                    widget.classList.remove('sam-minimized');
                    input.focus();
                }
            });
            
            minimizeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                widget.classList.toggle('sam-minimized');
            });
            
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                widget.classList.add('sam-hidden');
            });
            
            sendBtn.addEventListener('click', sendMessage);
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            input.addEventListener('input', () => {
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 120) + 'px';
            });
            
            // Allow header click to toggle minimize
            document.querySelector('.sam-chat-header').addEventListener('click', (e) => {
                if (e.target.closest('.sam-control-btn')) return;
                widget.classList.toggle('sam-minimized');
            });
            
            // Initialize
            widget.classList.add('sam-hidden'); // Start hidden
            checkStatus(); // Check configuration status
            
            // Re-check status every 30 seconds
            setInterval(checkStatus, 30000);
        })();
    </script>
    
    {% block extra_scripts %}{% endblock %}
</body>
</html>
