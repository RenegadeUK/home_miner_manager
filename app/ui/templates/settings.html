{% extends "base.html" %}

{% block extra_head %}
<style>
.settings-card {
    display: block;
    padding: 1.5rem;
    background: var(--bg-secondary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
}

.settings-card:hover {
    background: var(--bg-hover);
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.settings-card-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.settings-card-title {
    font-weight: 600;
    font-size: 1.125rem;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
}

.settings-card-desc {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.4;
}
</style>
{% endblock %}

{% block content %}
<div class="card" style="margin-bottom: 1.5rem;">
    <div class="card-header">
        <h2 class="card-title">Settings</h2>
    </div>
    
    <div style="padding: 1.5rem;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem;">
            <a href="/settings/discovery" class="settings-card">
                <div class="settings-card-icon">üîç</div>
                <div class="settings-card-title">Network Discovery</div>
                <div class="settings-card-desc">Configure automatic miner discovery and network scanning</div>
            </a>
            <a href="#mqtt-settings" class="settings-card" onclick="event.preventDefault(); document.getElementById('mqtt-settings').scrollIntoView({behavior: 'smooth'});">
                <div class="settings-card-icon">üì°</div>
                <div class="settings-card-title">MQTT Configuration</div>
                <div class="settings-card-desc">Configure MQTT broker for telemetry export</div>
            </a>
        </div>
    </div>
</div>

<div class="card" id="mqtt-settings">
    <div class="card-header">
        <h2 class="card-title">MQTT Configuration</h2>
    </div>
    
    <h3 style="margin-bottom: 1rem;">MQTT Broker Settings</h3>
    
    <div class="form-group">
        <label class="form-label">Enable MQTT</label>
        <select class="form-select" id="mqtt_enabled">
            <option value="false">Disabled</option>
            <option value="true">Enabled</option>
        </select>
    </div>
    
    <div class="form-group">
        <label class="form-label">MQTT Broker</label>
        <input type="text" class="form-input" id="mqtt_broker" placeholder="localhost">
    </div>
    
    <div class="form-group">
        <label class="form-label">MQTT Port</label>
        <input type="number" class="form-input" id="mqtt_port" placeholder="1883">
    </div>
    
    <div class="form-group">
        <label class="form-label">Topic Prefix</label>
        <input type="text" class="form-input" id="mqtt_topic_prefix" placeholder="miner">
    </div>
    
    <div class="form-group">
        <label class="form-label">Username (optional)</label>
        <input type="text" class="form-input" id="mqtt_username" placeholder="Leave blank if no authentication required">
    </div>
    
    <div class="form-group">
        <label class="form-label">Password (optional)</label>
        <input type="password" class="form-input" id="mqtt_password" placeholder="Leave blank if no authentication required">
    </div>
    
    <button class="btn btn-primary mt-4" onclick="saveSettings()">Save Settings</button>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">‚õèÔ∏è Solo Mining Integration</h2>
    </div>
    
    <h3 style="margin-bottom: 1rem;">
        Solopool.org Integration
        <button class="btn btn-secondary btn-sm" onclick="showSolopoolHelp()" style="margin-left: 1rem;">
            <span style="font-size: 1.2rem;">‚ÑπÔ∏è</span> Help
        </button>
    </h3>
    
    <div class="form-group">
        <label class="form-label">
            <input type="checkbox" id="solopool_enabled" style="margin-right: 0.5rem;">
            Enable Solopool.org Integration
        </label>
        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
            Track your miners and blocks on Solopool.org
        </p>
    </div>
    
    <button class="btn btn-primary mt-4" onclick="saveSolopoolSettings()">Save Settings</button>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">‚õèÔ∏è Braiins Pool Integration</h2>
    </div>
    
    <h3 style="margin-bottom: 1rem;">
        Braiins Pool (Slush Pool)
        <button class="btn btn-secondary btn-sm" onclick="showBraiinsHelp()" style="margin-left: 1rem;">
            <span style="font-size: 1.2rem;">‚ÑπÔ∏è</span> Help
        </button>
    </h3>
    
    <div class="form-group">
        <label class="form-label">
            <input type="checkbox" id="braiins_enabled" style="margin-right: 0.5rem;">
            Enable Braiins Pool Integration
        </label>
        <p style="color: var(--text-secondary); font-size: 0.875rem; margin-top: 0.5rem;">
            Track your workers and statistics via Braiins Pool API
        </p>
    </div>
    
    <div class="form-group">
        <label class="form-label">API Token</label>
        <input type="password" class="form-input" id="braiins_api_token" placeholder="Enter your Braiins Pool API token">
        <small>Get your API token from Braiins Pool account settings</small>
    </div>
    
    <button class="btn btn-primary mt-4" onclick="saveBraiinsSettings()">Save Settings</button>
</div>

<!-- Braiins Help Modal -->
<div id="braiinsHelpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-primary); border-radius: 8px; padding: 2rem; max-width: 600px; margin: 2rem; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;">Braiins Pool Integration</h2>
            <button class="btn btn-secondary btn-sm" onclick="closeBraiinsHelp()" style="padding: 0.25rem 0.75rem;">‚úï</button>
        </div>
        
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
            Braiins Pool (formerly Slush Pool) is the world's longest-running Bitcoin mining pool since 2010. 
            This integration allows you to monitor your workers and view detailed statistics.
        </p>
        
        <h3 style="margin-bottom: 1rem; color: var(--primary);">Getting Your API Token</h3>
        <ol style="color: var(--text-secondary); line-height: 1.8; margin-bottom: 1.5rem;">
            <li>Log in to your Braiins Pool account at <a href="https://pool.braiins.com" target="_blank" style="color: var(--accent);">pool.braiins.com</a></li>
            <li>Navigate to <strong>Settings</strong> ‚Üí <strong>Access Management</strong></li>
            <li>Click <strong>Create New Access Profile</strong></li>
            <li>Select permissions (read-only for monitoring)</li>
            <li>Generate the API token and copy it</li>
            <li>Paste the token in the field above</li>
        </ol>
        
        <h3 style="margin-bottom: 1rem; color: var(--primary);">Pool Information</h3>
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
            <p style="margin: 0.5rem 0; font-family: monospace; color: var(--text-secondary);">
                <strong>Pool URL:</strong> stratum+tcp://stratum.braiins.com<br>
                <strong>Ports:</strong> 3333 (standard), 3334 (SSL)<br>
                <strong>Coin:</strong> Bitcoin (BTC)<br>
                <strong>Reward:</strong> FPPS (Full Pay Per Share)<br>
                <strong>Fees:</strong> 0%
            </p>
        </div>
        
        <h3 style="margin-bottom: 1rem; color: var(--primary);">API Authentication</h3>
        <p style="color: var(--text-secondary); margin-bottom: 1rem;">
            All API calls require authentication using Bearer token:
        </p>
        <pre style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px; overflow-x: auto; margin-bottom: 1.5rem; color: var(--text-primary); font-family: monospace; font-size: 0.875rem;">Authorization: Bearer YOUR_API_TOKEN</pre>
        
        <h3 style="margin-bottom: 1rem; color: var(--primary);">What Will Be Displayed</h3>
        <ul style="color: var(--text-secondary); line-height: 1.8;">
            <li>Active workers and their status</li>
            <li>Hashrate (5min, 1hr, 24hr averages)</li>
            <li>Shares submitted and accepted</li>
            <li>Estimated earnings</li>
            <li>Recent blocks found by the pool</li>
        </ul>
        
        <button class="btn btn-primary" onclick="closeBraiinsHelp()" style="width: 100%; margin-top: 1rem;">Got It!</button>
    </div>
</div>

<!-- Solopool Help Modal -->
<div id="solopoolHelpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: var(--bg-primary); border-radius: 8px; padding: 2rem; max-width: 600px; margin: 2rem; max-height: 80vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;">Solopool.org Integration</h2>
            <button class="btn btn-secondary btn-sm" onclick="closeSolopoolHelp()" style="padding: 0.25rem 0.75rem;">‚úï</button>
        </div>
        
        <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
            This integration automatically monitors miners using Solopool.org pools and displays statistics on your dashboard.
        </p>
        
        <h3 style="margin-bottom: 1rem; color: var(--primary);">Supported Coins & Pools</h3>
        
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0; display: flex; align-items: center;">
                <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><circle cx="16" cy="16" r="16" fill="#8dc351"/><path fill="#fff" d="M21.207 10.534c-.776-1.93-2.84-2.535-4.684-2.191l-.455-2.316-1.48.292.447 2.27c-.392.078-.794.159-1.19.239l-.451-2.282-1.479.292.455 2.317c-.323.064-.64.127-.95.19l-.002-.008-2.04.403.322 1.672s1.097-.223 1.077-.211c.599-.118.948.062 1.119.476l.546 2.78c.035-.009.08-.02.13-.031l-.132.033.767 3.896c-.024.172-.11.417-.439.49.024.02-1.076.212-1.076.212l-.087 1.791 1.925-.379c.357-.07.712-.143 1.06-.212l.462 2.345 1.479-.291-.455-2.311c.396-.085.783-.164 1.161-.247l.452 2.297 1.48-.291-.461-2.343c1.872-.397 3.301-1.187 3.598-3.168.239-1.59-.318-2.405-1.398-2.868.805-.464 1.346-1.193 1.141-2.433zm-1.018 4.388c.318 2.034-2.764 2.55-3.96 2.843l-.718-3.651c1.197-.296 4.363-1.322 4.678.808zm-1.18-3.365c.29 1.854-2.373 2.305-3.408 2.565l-.651-3.314c1.035-.257 3.724-1.03 4.059.749z"/></svg>
                Bitcoin Cash (BCH)
            </h4>
            <p style="margin: 0.5rem 0; font-family: monospace; color: var(--text-secondary);">
                <strong>Pools:</strong> eu2.solopool.org, us1.solopool.org<br>
                <strong>Port:</strong> 8002<br>
                <strong>API:</strong> https://bch.solopool.org/api/accounts/
            </p>
        </div>
        
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px; margin-bottom: 1rem;">
            <h4 style="margin: 0 0 0.5rem 0; display: flex; align-items: center;">
                <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><circle cx="16" cy="16" r="16" fill="#006ad2"/><path fill="#fff" d="M16 4L7 9v7l9 5 9-5V9l-9-5zm6 11.3l-6 3.3-6-3.3V10l6-3.3L22 10v5.3z"/><path fill="#fff" d="M16 11l-3 1.7v3.5l3 1.7 3-1.7v-3.5L16 11z"/></svg>
                DigiByte (DGB)
            </h4>
            <p style="margin: 0.5rem 0; font-family: monospace; color: var(--text-secondary);">
                <strong>Pools:</strong> eu1.solopool.org, us1.solopool.org<br>
                <strong>Port:</strong> 8004<br>
                <strong>API:</strong> https://dgb-sha.solopool.org/api/accounts/
            </p>
        </div>
        
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; display: flex; align-items: center;">
                <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><circle cx="16" cy="16" r="16" fill="#f7931a"/><path fill="#fff" d="M23.189 14.02c.314-2.096-1.283-3.223-3.465-3.975l.708-2.84-1.728-.43-.69 2.765c-.454-.114-.92-.22-1.385-.326l.695-2.783L15.596 6l-.708 2.839c-.376-.086-.746-.17-1.104-.26l.002-.009-2.384-.595-.46 1.846s1.283.294 1.256.312c.7.175.826.638.805 1.006l-.806 3.235c.048.012.11.03.18.057l-.183-.045-1.13 4.532c-.086.212-.303.531-.793.41.018.025-1.256-.313-1.256-.313l-.858 1.978 2.25.561c.418.105.828.215 1.231.318l-.715 2.872 1.727.43.708-2.84c.472.127.93.245 1.378.357l-.706 2.828 1.728.43.715-2.866c2.948.558 5.164.333 6.097-2.333.752-2.146-.037-3.385-1.588-4.192 1.13-.26 1.98-1.003 2.207-2.538zm-3.95 5.538c-.533 2.147-4.148.986-5.32.695l.95-3.805c1.172.293 4.929.872 4.37 3.11zm.535-5.569c-.487 1.953-3.495.96-4.47.717l.86-3.45c.975.243 4.118.696 3.61 2.733z"/></svg>
                Bitcoin (BTC)
            </h4>
            <p style="margin: 0.5rem 0; font-family: monospace; color: var(--text-secondary);">
                <strong>Pool:</strong> eu3.solopool.org<br>
                <strong>Port:</strong> 8005<br>
                <strong>API:</strong> https://btc.solopool.org/api/accounts/
            </p>
        </div>
        
        <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
            <h4 style="margin: 0 0 0.5rem 0; display: flex; align-items: center;">
                <svg width="20" height="20" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><circle cx="16" cy="16" r="16" fill="#ff6600"/><path fill="#fff" d="M15.97 5.235c5.985 0 10.825 4.84 10.825 10.825s-4.84 10.825-10.825 10.825S5.145 21.985 5.145 16s4.84-10.825 10.825-10.825zM14.1 9.05v4.47H9.628L14.1 9.05zm3.74 0l4.47 4.47h-4.47V9.05zm-3.74 13.9v-4.47H9.628l4.472 4.47zm3.74 0l4.47-4.47h-4.47v4.47zm-1.87-6.34h4.532l-4.532 4.532v-4.532zm0-1.87v-4.533l4.532 4.533h-4.532zm-1.87 0H9.568l4.532-4.533v4.533zm0 1.87v4.532l-4.532-4.532H14.1z"/></svg>
                Monero (XMR)
            </h4>
            <p style="margin: 0.5rem 0; font-family: monospace; color: var(--text-secondary);">
                <strong>Pool:</strong> eu1.solopool.org<br>
                <strong>Port:</strong> 8010<br>
                <strong>API:</strong> https://xmr.solopool.org/api/accounts/
            </p>
        </div>
        
        <h3 style="margin-bottom: 1rem; color: var(--primary);">How It Works</h3>
        <ol style="color: var(--text-secondary); line-height: 1.8;">
            <li>Configure your miner to use one of the supported Solopool pools</li>
            <li>Enable this integration in settings</li>
            <li>Stats will automatically appear on your dashboard showing:
                <ul style="margin-top: 0.5rem;">
                    <li>Workers Online</li>
                    <li>Blocks Found (24h/7d/30d)</li>
                    <li>Luck Percentage (24h/7d/30d)</li>
                    <li>Total Paid</li>
                </ul>
            </li>
        </ol>
        
        <button class="btn btn-primary" onclick="closeSolopoolHelp()" style="width: 100%; margin-top: 1rem;">Got It!</button>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">System Information</h2>
    </div>
    
    <table>
        <tr>
            <td><strong>Version</strong></td>
            <td>0.1.0</td>
        </tr>
        <tr>
            <td><strong>Config Directory</strong></td>
            <td>/config</td>
        </tr>
        <tr>
            <td><strong>Database</strong></td>
            <td>/config/data.db</td>
        </tr>
        <tr>
            <td><strong>Web Port</strong></td>
            <td id="web-port">8080</td>
        </tr>
    </table>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
async function loadSolopoolSettings() {
    try {
        const response = await fetch('/api/settings/solopool');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('solopool_enabled').checked = data.enabled || false;
        }
    } catch (error) {
        console.error('Failed to load Solopool settings:', error);
    }
}

async function saveSolopoolSettings() {
    const enabled = document.getElementById('solopool_enabled').checked;
    
    try {
        const response = await fetch('/api/settings/solopool', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                enabled: enabled
            })
        });
        
        if (response.ok) {
            alert('Solopool settings saved successfully!');
        } else {
            alert('Failed to save Solopool settings');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function loadBraiinsSettings() {
    try {
        const response = await fetch('/api/settings/braiins');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('braiins_enabled').checked = data.enabled || false;
            document.getElementById('braiins_api_token').value = data.api_token || '';
        }
    } catch (error) {
        console.error('Failed to load Braiins settings:', error);
    }
}

async function saveBraiinsSettings() {
    const enabled = document.getElementById('braiins_enabled').checked;
    const apiToken = document.getElementById('braiins_api_token').value.trim();
    
    if (enabled && !apiToken) {
        alert('Please enter an API token to enable Braiins Pool integration');
        return;
    }
    
    try {
        const response = await fetch('/api/settings/braiins', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                enabled: enabled,
                api_token: apiToken
            })
        });
        
        if (response.ok) {
            alert('Braiins Pool settings saved successfully!');
        } else {
            const error = await response.json();
            alert('Failed to save Braiins settings: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

async function loadMQTTSettings() {
    try {
        const response = await fetch('/api/settings/mqtt');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('mqtt_enabled').value = data.enabled ? 'true' : 'false';
            document.getElementById('mqtt_broker').value = data.broker || 'localhost';
            document.getElementById('mqtt_port').value = data.port || 1883;
            document.getElementById('mqtt_topic_prefix').value = data.topic_prefix || 'miner';
            document.getElementById('mqtt_username').value = data.username || '';
            document.getElementById('mqtt_password').value = data.password || '';
        }
    } catch (error) {
        console.error('Failed to load MQTT settings:', error);
    }
}

async function saveSettings() {
    const enabled = document.getElementById('mqtt_enabled').value === 'true';
    const broker = document.getElementById('mqtt_broker').value;
    const port = parseInt(document.getElementById('mqtt_port').value);
    const topicPrefix = document.getElementById('mqtt_topic_prefix').value;
    const username = document.getElementById('mqtt_username').value;
    const password = document.getElementById('mqtt_password').value;
    
    try {
        const response = await fetch('/api/settings/mqtt', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                enabled: enabled,
                broker: broker,
                port: port,
                topic_prefix: topicPrefix,
                username: username,
                password: password
            })
        });
        
        if (response.ok) {
            alert('MQTT settings saved successfully!\n\nRestart the container for changes to take effect.');
        } else {
            alert('Failed to save MQTT settings');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function showSolopoolHelp() {
    const modal = document.getElementById('solopoolHelpModal');
    modal.style.display = 'flex';
}

function closeSolopoolHelp() {
    const modal = document.getElementById('solopoolHelpModal');
    modal.style.display = 'none';
}

function showBraiinsHelp() {
    const modal = document.getElementById('braiinsHelpModal');
    modal.style.display = 'flex';
}

function closeBraiinsHelp() {
    const modal = document.getElementById('braiinsHelpModal');
    modal.style.display = 'none';
}

// Close modals when clicking outside
document.addEventListener('click', function(event) {
    const solopoolModal = document.getElementById('solopoolHelpModal');
    const braiinsModal = document.getElementById('braiinsHelpModal');
    
    if (event.target === solopoolModal) {
        closeSolopoolHelp();
    }
    if (event.target === braiinsModal) {
        closeBraiinsHelp();
    }
});

// Load settings on page load
loadMQTTSettings();
loadSolopoolSettings();
loadBraiinsSettings();
</script>
{% endblock %}
