{% extends "base.html" %}

{% block extra_head %}
<style>
.analytics-container {
    max-width: 1200px;
    margin: 0 auto;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 1.5rem;
}

.detail-card-header {
    background: var(--card-header);
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
}

.detail-card-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.detail-card-icon {
    font-size: 1.75rem;
}

.detail-card-body {
    padding: 2rem;
}

.health-grid {
    display: grid;
    gap: 1rem;
    margin-bottom: 1rem;
}

.health-metric {
    display: grid;
    grid-template-columns: minmax(120px, 150px) 1fr minmax(50px, 60px);
    align-items: center;
    gap: 1rem;
}

.health-label {
    font-weight: 500;
    color: var(--text-primary);
}

.health-bar {
    height: 24px;
    background: var(--input-bg);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
}

.health-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, #10b981, #34d399);
    transition: width 0.3s ease, background 0.3s ease;
    border-radius: 12px;
}

.health-value {
    text-align: right;
    font-weight: 600;
    color: var(--text-primary);
}

.health-info {
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
    text-align: center;
    color: var(--text-secondary);
}

.health-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 1rem;
    font-weight: 600;
}

.health-badge.excellent {
    background: #10b981;
    color: white;
}

.health-badge.good {
    background: #34d399;
    color: white;
}

.health-badge.fair {
    background: #f59e0b;
    color: #111827;
}

.health-badge.poor {
    background: #ef4444;
    color: white;
}

.stats-table table {
    width: 100%;
    border-collapse: collapse;
}

.stats-table tr {
    border-bottom: 1px solid var(--border-color);
}

.stats-table tr:last-child {
    border-bottom: none;
}

.stats-table td {
    padding: 1rem;
    color: var(--text-primary);
}

.stats-table td:first-child {
    color: var(--text-secondary);
    width: 30%;
}

.time-selector {
    display: flex;
    gap: 0.5rem;
}

.time-selector .btn {
    padding: 0.5rem 1rem;
    background: var(--card-header);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    cursor: pointer;
    border-radius: 6px;
}

.time-selector .btn.active {
    background: #10b981;
    border-color: #10b981;
}

.charts-grid {
    display: grid;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

canvas {
    max-width: 100% !important;
    height: auto !important;
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
<!-- Health Score -->
<div class="detail-card" id="health-section" style="display: none;">
    <div class="detail-card-header">
        <h3><span class="detail-card-icon">‚ù§Ô∏è</span> Health Score</h3>
        <span class="health-badge" id="health-badge">-</span>
    </div>
    <div class="detail-card-body">
        <div class="health-grid">
            <div class="health-metric">
                <div class="health-label">Overall</div>
                <div class="health-bar">
                    <div class="health-bar-fill" id="overall-bar"></div>
                </div>
                <div class="health-value" id="overall-score">-</div>
            </div>
            <div class="health-metric">
                <div class="health-label">Uptime</div>
                <div class="health-bar">
                    <div class="health-bar-fill" id="uptime-bar"></div>
                </div>
                <div class="health-value" id="uptime-score">-</div>
            </div>
            <div class="health-metric">
                <div class="health-label">Temperature</div>
                <div class="health-bar">
                    <div class="health-bar-fill" id="temperature-bar"></div>
                </div>
                <div class="health-value" id="temperature-score">-</div>
            </div>
            <div class="health-metric">
                <div class="health-label">Hashrate Stability</div>
                <div class="health-bar">
                    <div class="health-bar-fill" id="hashrate-bar"></div>
                </div>
                <div class="health-value" id="hashrate-score">-</div>
            </div>
            <div class="health-metric">
                <div class="health-label">Reject Rate</div>
                <div class="health-bar">
                    <div class="health-bar-fill" id="reject-bar"></div>
                </div>
                <div class="health-value" id="reject-score">-</div>
            </div>
        </div>
        <div class="health-info">
            <small>Based on <span id="data-points">-</span> data points over <span id="period-hours">-</span> hours</small>
        </div>
    </div>
</div>

<!-- Telemetry Stats -->
<div class="detail-card" id="stats-section" style="display: none;">
    <div class="detail-card-header">
        <h3><span class="detail-card-icon">üìä</span> Performance Statistics</h3>
        <div class="time-selector">
            <button class="btn btn-sm" onclick="changeTimeRange(6)">6h</button>
            <button class="btn btn-sm active" onclick="changeTimeRange(24)">24h</button>
            <button class="btn btn-sm" onclick="changeTimeRange(72)">3d</button>
            <button class="btn btn-sm" onclick="changeTimeRange(168)">7d</button>
        </div>
    </div>
    <div class="detail-card-body">
        <div class="stats-table">
            <table>
                <tr>
                    <td><strong>Hashrate</strong></td>
                    <td>
                        Avg: <span id="avg-hashrate">-</span> GH/s<br>
                        Min: <span id="min-hashrate">-</span> GH/s<br>
                        Max: <span id="max-hashrate">-</span> GH/s
                    </td>
                </tr>
                <tr>
                    <td><strong>Temperature</strong></td>
                    <td>
                        Avg: <span id="avg-temp">-</span> ¬∞C<br>
                        Max: <span id="max-temp">-</span> ¬∞C
                    </td>
                </tr>
                <tr>
                    <td><strong>Power</strong></td>
                    <td>
                        Avg: <span id="avg-power">-</span> W<br>
                        Total Energy: <span id="total-energy">-</span> kWh
                    </td>
                </tr>
                <tr>
                    <td><strong>Shares</strong></td>
                    <td>
                        Accepted: <span id="total-accepted">-</span><br>
                        Rejected: <span id="total-rejected">-</span><br>
                        Reject Rate: <span id="reject-rate">-</span>%
                    </td>
                </tr>
                <tr>
                    <td><strong>Uptime</strong></td>
                    <td><span id="uptime-percent">-</span>%</td>
                </tr>
            </table>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="charts-grid" id="charts-section" style="display: none;">
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">üìà</span> Hashrate Trend</h3>
        </div>
        <div class="detail-card-body">
            <canvas id="hashrate-chart"></canvas>
        </div>
    </div>
    
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">üå°Ô∏è</span> Temperature Trend</h3>
        </div>
        <div class="detail-card-body">
            <canvas id="temperature-chart"></canvas>
        </div>
    </div>
    
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">‚ö°</span> Power Consumption</h3>
        </div>
        <div class="detail-card-body">
            <canvas id="power-chart"></canvas>
        </div>
    </div>
    
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">üíö</span> Health Score Trend (7 Days)</h3>
        </div>
        <div class="detail-card-body">
            <canvas id="health-trend-chart"></canvas>
        </div>
    </div>
</div>

<!-- Export Options -->
<div class="detail-card" id="export-section" style="display: none;">
    <div class="detail-card-header">
        <h3><span class="detail-card-icon">üì•</span> Export Data</h3>
    </div>
    <div class="detail-card-body">
        <button class="btn btn-primary" onclick="exportCSV()">üì• Export CSV (24h)</button>
    </div>
</div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
let currentMinerId = null;
let currentTimeRange = 24;
let charts = {};

// Format hashrate with appropriate unit
function formatHashrate(hashrate) {
    if (hashrate >= 1000) {
        return `${(hashrate / 1000).toFixed(2)} TH/s`;
    }
    return `${hashrate.toFixed(2)} GH/s`;
}

// Get miner ID from URL
const pathParts = window.location.pathname.split('/');
const minerId = parseInt(pathParts[pathParts.length - 1]);

// Load miner info and analytics on page load
async function initPage() {
    if (!minerId || isNaN(minerId)) {
        console.error('Invalid miner ID:', minerId);
        window.location.href = '/analytics';
        return;
    }
    
    // Load analytics directly - miner name already in page title from server
    await loadAnalytics(minerId);
}

initPage();

// Change time range
function changeTimeRange(hours) {
    currentTimeRange = hours;
    document.querySelectorAll('.time-selector .btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    if (currentMinerId) {
        loadAnalytics(currentMinerId);
    }
}

// Load analytics for selected miner
async function loadAnalytics(minerId) {
    currentMinerId = minerId;
    
    try {
        // Show sections
        document.getElementById('health-section').style.display = 'block';
        document.getElementById('stats-section').style.display = 'block';
        document.getElementById('charts-section').style.display = 'block';
        document.getElementById('export-section').style.display = 'block';
        
        // Load all data
        await Promise.all([
            loadHealth(minerId),
            loadStats(minerId),
            loadCharts(minerId)
        ]);
    } catch (error) {
        console.error('Error loading analytics:', error);
        alert(`Failed to load analytics data: ${error.message}`);
    }
}

// Load health score
async function loadHealth(minerId) {
    try {
        const response = await fetch(`/api/analytics/miners/${minerId}/health?hours=${currentTimeRange}&_=${Date.now()}`, {
            cache: 'no-cache'
        });
        const data = await response.json();
        
        // Update scores
        updateHealthBar('overall', data.overall_score);
        updateHealthBar('uptime', data.uptime_score);
        updateHealthBar('temperature', data.temperature_score);
        updateHealthBar('hashrate', data.hashrate_score);
        updateHealthBar('reject', data.reject_rate_score);
        
        // Update badge
        const badge = document.getElementById('health-badge');
        const score = data.overall_score;
        badge.textContent = `${score.toFixed(1)}/100`;
        
        if (score >= 90) {
            badge.className = 'badge health-badge excellent';
        } else if (score >= 75) {
            badge.className = 'badge health-badge good';
        } else if (score >= 60) {
            badge.className = 'badge health-badge fair';
        } else if (score >= 40) {
            badge.className = 'badge health-badge poor';
        } else {
            badge.className = 'badge health-badge critical';
        }
        
        // Update info
        document.getElementById('data-points').textContent = data.data_points;
        document.getElementById('period-hours').textContent = data.period_hours;
        
    } catch (error) {
        console.error('Error loading health:', error);
    }
}

// Update health bar
function updateHealthBar(name, score) {
    const bar = document.getElementById(`${name}-bar`);
    const value = document.getElementById(`${name}-score`);
    
    bar.style.width = `${score}%`;
    value.textContent = score.toFixed(1);
    
    // Color based on score
    if (score >= 80) {
        bar.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
    } else if (score >= 60) {
        bar.style.background = 'linear-gradient(90deg, #FFC107, #FFD54F)';
    } else {
        bar.style.background = 'linear-gradient(90deg, #F44336, #E57373)';
    }
}

// Load telemetry stats
async function loadStats(minerId) {
    try {
        const response = await fetch(`/api/analytics/miners/${minerId}/telemetry/stats?hours=${currentTimeRange}&_=${Date.now()}`, {
            cache: 'no-cache'
        });
        const data = await response.json();
        
        // Format hashrate values with independent units
        const avgHashrate = data.avg_hashrate;
        const minHashrate = data.min_hashrate;
        const maxHashrate = data.max_hashrate;
        
        if (avgHashrate) {
            // Format each value independently with its own unit
            const avgFormatted = avgHashrate >= 1000 ? `${(avgHashrate / 1000).toFixed(2)} TH/s` : `${avgHashrate.toFixed(2)} GH/s`;
            const minFormatted = minHashrate >= 1000 ? `${(minHashrate / 1000).toFixed(2)} TH/s` : `${minHashrate.toFixed(2)} GH/s`;
            const maxFormatted = maxHashrate >= 1000 ? `${(maxHashrate / 1000).toFixed(2)} TH/s` : `${maxHashrate.toFixed(2)} GH/s`;
            
            // Update display with independent units, preserving IDs
            document.querySelector('#avg-hashrate').parentElement.innerHTML = 
                `Avg: <span id="avg-hashrate">${avgFormatted}</span><br>` +
                `Min: <span id="min-hashrate">${minFormatted}</span><br>` +
                `Max: <span id="max-hashrate">${maxFormatted}</span>`;
        } else {
            document.getElementById('avg-hashrate').textContent = '-';
            document.getElementById('min-hashrate').textContent = '-';
            document.getElementById('max-hashrate').textContent = '-';
        }
        
        document.getElementById('avg-temp').textContent = data.avg_temperature?.toFixed(1) || '-';
        document.getElementById('max-temp').textContent = data.max_temperature?.toFixed(1) || '-';
        document.getElementById('avg-power').textContent = data.avg_power?.toFixed(1) || '-';
        
        // Calculate total energy consumption: avg power (W) * hours / 1000 = kWh
        if (data.avg_power) {
            const totalEnergyKwh = (data.avg_power * currentTimeRange) / 1000;
            document.getElementById('total-energy').textContent = totalEnergyKwh.toFixed(3);
        } else {
            document.getElementById('total-energy').textContent = '-';
        }
        
        document.getElementById('total-accepted').textContent = data.total_accepted || '-';
        document.getElementById('total-rejected').textContent = data.total_rejected || '-';
        document.getElementById('reject-rate').textContent = data.reject_rate || '-';
        document.getElementById('uptime-percent').textContent = data.uptime_percent || '-';
        
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Load charts
async function loadCharts(minerId) {
    await Promise.all([
        loadTimeseriesChart(minerId, 'hashrate', 'hashrate-chart', 'Hashrate (GH/s)', '#007bff'),
        loadTimeseriesChart(minerId, 'temperature', 'temperature-chart', 'Temperature (¬∞C)', '#F44336'),
        loadTimeseriesChart(minerId, 'power', 'power-chart', 'Power (W)', '#FFC107'),
        loadHealthTrendChart(minerId)
    ]);
}

// Load timeseries chart
async function loadTimeseriesChart(minerId, metric, canvasId, label, color) {
    try {
        const response = await fetch(`/api/analytics/miners/${minerId}/telemetry/timeseries?hours=${currentTimeRange}&metric=${metric}&_=${Date.now()}`, {
            cache: 'no-cache'
        });
        const data = await response.json();
        
        const ctx = document.getElementById(canvasId);
        
        // Destroy existing chart
        if (charts[canvasId]) {
            charts[canvasId].destroy();
        }
        
        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.data.map(d => new Date(d.timestamp).toLocaleTimeString()),
                datasets: [{
                    label: label,
                    data: data.data.map(d => d.value),
                    borderColor: color,
                    backgroundColor: color + '20',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            maxTicksLimit: 12
                        }
                    },
                    y: {
                        beginAtZero: false
                    }
                }
            }
        });
    } catch (error) {
        console.error(`Error loading ${metric} chart:`, error);
    }
}

// Load health trend chart
async function loadHealthTrendChart(minerId) {
    try {
        const response = await fetch(`/api/analytics/miners/${minerId}/health/trend?days=7`);
        const data = await response.json();
        
        const ctx = document.getElementById('health-trend-chart');
        
        // Destroy existing chart
        if (charts['health-trend-chart']) {
            charts['health-trend-chart'].destroy();
        }
        
        charts['health-trend-chart'] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.trend.map(d => new Date(d.timestamp).toLocaleDateString()),
                datasets: [{
                    label: 'Overall Score',
                    data: data.trend.map(d => d.overall_score),
                    borderColor: '#4CAF50',
                    backgroundColor: '#4CAF5020',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading health trend:', error);
    }
}

// Export CSV
async function exportCSV() {
    if (!currentMinerId) return;
    
    window.location.href = `/api/analytics/miners/${currentMinerId}/export/csv?hours=${currentTimeRange}`;
}

// Initialize on page load
window.addEventListener('DOMContentLoaded', function() {
    initPage();
    setInterval(loadMinerTelemetry, 30000); // Refresh every 30s
});
</script>
{% endblock %}
