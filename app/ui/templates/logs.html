{% extends "base.html" %}

{% block content %}
<!-- Recent Events -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">Recent Events</h2>
        <button class="btn btn-secondary btn-sm" onclick="clearEvents()" aria-label="Clear all events">Clear All</button>
    </div>
    
    <!-- Filter Tiles -->
    <div class="filter-tiles">
        <button class="filter-tile active" onclick="filterEvents('all')" data-filter="all" aria-label="Show all events">
            <div class="filter-tile-label">All</div>
            <div class="filter-tile-count" id="count-all">0</div>
        </button>
        <button class="filter-tile" onclick="filterEvents('info')" data-filter="info" aria-label="Filter by info events">
            <div class="filter-tile-label">Info</div>
            <div class="filter-tile-count" id="count-info">0</div>
        </button>
        <button class="filter-tile" onclick="filterEvents('success')" data-filter="success" aria-label="Filter by success events">
            <div class="filter-tile-label">Success</div>
            <div class="filter-tile-count" id="count-success">0</div>
        </button>
        <button class="filter-tile" onclick="filterEvents('warning')" data-filter="warning" aria-label="Filter by warning events">
            <div class="filter-tile-label">Warning</div>
            <div class="filter-tile-count" id="count-warning">0</div>
        </button>
        <button class="filter-tile" onclick="filterEvents('error')" data-filter="error" aria-label="Filter by error events">
            <div class="filter-tile-label">Error</div>
            <div class="filter-tile-count" id="count-error">0</div>
        </button>
    </div>
    
    <div id="events-list">
        <p class="text-muted">Loading events...</p>
    </div>
    
    <!-- Pagination -->
    <div class="pagination" id="pagination" style="display: none;">
        <button class="btn btn-secondary btn-sm" id="prev-page" onclick="changePage(-1)" aria-label="Go to previous page">← Previous</button>
        <span id="page-info" style="margin: 0 1rem; color: var(--text-primary);"></span>
        <button class="btn btn-secondary btn-sm" id="next-page" onclick="changePage(1)" aria-label="Go to next page">Next →</button>
    </div>
</div>

<style>
.filter-tiles {
    display: flex;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    flex-wrap: wrap;
}

.filter-tile {
    flex: 1;
    min-width: 100px;
    padding: 0.75rem;
    border: 2px solid var(--border-color);
    border-radius: 8px;
    background-color: var(--bg-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: center;
}

.filter-tile:hover {
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.filter-tile.active {
    border-color: var(--primary-color);
    background-color: rgba(59, 130, 246, 0.1);
}

.filter-tile-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 0.25rem;
}

.filter-tile-count {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

@media (max-width: 768px) {
    .filter-tiles {
        padding: 0.75rem;
    }
    
    .filter-tile {
        min-width: 80px;
        padding: 0.5rem;
    }
    
    .filter-tile-count {
        font-size: 1.25rem;
    }
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 1.5rem;
    border-top: 1px solid var(--border-color);
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
let allEvents = [];
let currentFilter = 'all';
let currentPage = 1;
const EVENTS_PER_PAGE = 200;

// Map event_type to badge color and category
const getBadgeClass = (eventType) => {
    if (eventType === 'error' || eventType === 'api_error') return 'danger';
    if (eventType === 'warning' || eventType === 'api_warning') return 'warning';
    if (eventType === 'info') return 'info';
    return 'success';
};

const getEventCategory = (eventType) => {
    if (eventType === 'error' || eventType === 'api_error') return 'error';
    if (eventType === 'warning' || eventType === 'api_warning') return 'warning';
    if (eventType === 'info') return 'info';
    return 'success';
};

// Update filter counts
function updateFilterCounts() {
    const counts = {
        all: allEvents.length,
        info: allEvents.filter(e => getEventCategory(e.event_type) === 'info').length,
        success: allEvents.filter(e => getEventCategory(e.event_type) === 'success').length,
        warning: allEvents.filter(e => getEventCategory(e.event_type) === 'warning').length,
        error: allEvents.filter(e => getEventCategory(e.event_type) === 'error').length
    };
    
    Object.keys(counts).forEach(key => {
        const el = document.getElementById(`count-${key}`);
        if (el) el.textContent = counts[key];
    });
}

// Filter events
function filterEvents(category) {
    currentFilter = category;
    currentPage = 1; // Reset to first page
    
    // Update active state
    document.querySelectorAll('.filter-tile').forEach(tile => {
        tile.classList.remove('active');
    });
    document.querySelector(`[data-filter="${category}"]`).classList.add('active');
    
    // Filter and render
    const filtered = category === 'all' 
        ? allEvents 
        : allEvents.filter(e => getEventCategory(e.event_type) === category);
    
    renderEventsWithPagination(filtered);
}

// Change page
function changePage(delta) {
    const filtered = currentFilter === 'all' 
        ? allEvents 
        : allEvents.filter(e => getEventCategory(e.event_type) === currentFilter);
    
    const totalPages = Math.ceil(filtered.length / EVENTS_PER_PAGE);
    const newPage = currentPage + delta;
    
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderEventsWithPagination(filtered);
    }
}

// Render events with pagination
function renderEventsWithPagination(filteredEvents) {
    const totalPages = Math.ceil(filteredEvents.length / EVENTS_PER_PAGE);
    const startIdx = (currentPage - 1) * EVENTS_PER_PAGE;
    const endIdx = startIdx + EVENTS_PER_PAGE;
    const pageEvents = filteredEvents.slice(startIdx, endIdx);
    
    renderEvents(pageEvents);
    updatePagination(filteredEvents.length, totalPages);
}

// Update pagination controls
function updatePagination(totalEvents, totalPages) {
    const pagination = document.getElementById('pagination');
    const pageInfo = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    
    if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
    }
    
    pagination.style.display = 'flex';
    pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalEvents} events)`;
    
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
}

// Render events to DOM
function renderEvents(events) {
    const eventsList = document.getElementById('events-list');
    
    if (events.length === 0) {
        eventsList.innerHTML = '<p class="text-muted" style="padding: 1.5rem;">No events found</p>';
        return;
    }
    
    // Desktop table view
    const tableHTML = `
        <div class="desktop-only">
        <table>
            <thead>
                <tr>
                    <th scope="col">Time</th>
                    <th scope="col">Miner</th>
                    <th scope="col">Event</th>
                    <th scope="col">Details</th>
                </tr>
            </thead>
            <tbody>
                ${events.map(e => `
                    <tr>
                        <td>${new Date(e.timestamp).toLocaleString()}</td>
                        <td>${e.miner_name || 'System'}</td>
                        <td><span class="badge badge-${getBadgeClass(e.event_type)}">${e.event_type}</span></td>
                        <td>${e.message}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        </div>
    `;
    
    // Mobile cards view
    const cardsHTML = `
        <div class="mobile-cards">
            ${events.map(e => `
                <div class="mobile-card">
                    <div class="mobile-card-header">
                        <span class="mobile-card-title">${e.miner_name || 'System'}</span>
                        <span class="badge badge-${getBadgeClass(e.event_type)}">${e.event_type}</span>
                    </div>
                    <div class="mobile-card-body">
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Time:</span>
                            <span>${new Date(e.timestamp).toLocaleString()}</span>
                        </div>
                        <div class="mobile-card-row">
                            <span class="mobile-card-label">Details:</span>
                            <span>${e.message}</span>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
    
    eventsList.innerHTML = tableHTML + cardsHTML;
}

// Load events
async function loadEvents() {
    try {
        const response = await fetch('/api/dashboard/all');
        const data = await response.json();
        
        allEvents = data.events || [];
        
        updateFilterCounts();
        
        // Filter and paginate
        const filtered = currentFilter === 'all' 
            ? allEvents 
            : allEvents.filter(e => getEventCategory(e.event_type) === currentFilter);
        
        renderEventsWithPagination(filtered);
    } catch (error) {
        console.error('Failed to load events:', error);
        document.getElementById('events-list').innerHTML = '<p class="text-muted">Failed to load events</p>';
    }
}

async function clearEvents() {
    if (!confirm('Clear all events? This cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/dashboard/events', {
            method: 'DELETE'
        });
        
        if (response.ok) {
            await loadEvents(); // Reload to show empty events
        } else {
            alert('Failed to clear events');
        }
    } catch (error) {
        console.error('Failed to clear events:', error);
        alert('Failed to clear events');
    }
}

loadEvents();

// Auto-refresh every 30 seconds
setInterval(loadEvents, 30000);
</script>
{% endblock %}
