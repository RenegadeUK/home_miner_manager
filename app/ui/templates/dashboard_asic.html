{% extends "dashboard_base.html" %}

{% block dashboard_tiles %}
<!-- ASIC-Specific Stats Grid -->
<div class="stats-grid compact-grid">
    <div class="stat-card" onclick="window.location.href='/miners'" style="cursor: pointer;">
        <div class="stat-label">Workers Online</div>
        <div class="stat-value" id="workers-online">0</div>
        <div class="stat-subtext">
            <div id="pool-hashrate">Pool: Unavailable</div>
            <div id="pool-efficiency" style="font-size: 0.65rem;">⚡ Unavailable</div>
        </div>
    </div>
    <div class="stat-card" onclick="window.location.href='/miners'" style="cursor: pointer;">
        <div class="stat-label">Power Use</div>
        <div class="stat-value" id="total-power">0 W</div>
        <div class="stat-subtext">
            <div id="power-efficiency">Efficiency: Unavailable</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Cost (24h)</div>
        <div class="stat-value" id="total-cost-24h">£0.00</div>
        <div class="stat-subtext">
            <div id="avg-price-per-kwh">Avg: Unavailable</div>
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-label">Best Share (24h) <span id="best-share-coin-pill" class="coin-pill"></span></div>
        <div class="stat-value" id="best-share-percentage">0%</div>
        <div class="stat-subtext">
            <div id="best-share-network-diff">Network diff: Unavailable</div>
            <div id="best-share-time-ago" style="font-size: 0.65rem;">Unavailable</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script>
// ASIC Dashboard - Load data and update tiles
async function loadDashboard() {
    try {
        // Reset pool hashrate counter
        totalPoolHashrateRaw = 0;
        
        // Get dashboard type from template
        const dashboardType = '{{ dashboard_type }}';
        
        // Single optimized API call that returns everything
        const response = await fetch(`/api/dashboard/all?dashboard_type=${dashboardType}`, {
            cache: 'no-cache',
            headers: {
                'Cache-Control': 'no-cache, no-store, must-revalidate',
                'Pragma': 'no-cache'
            }
        });
        const data = await response.json();
        
        // Update stats
        const stats = data.stats;
        document.getElementById('workers-online').textContent = stats.online_miners || 0;
        
        // Store current energy price globally for solopool stats calculation
        window.currentEnergyPrice = stats.current_energy_price_pence;
        
        // Store miner hashrate globally for pool efficiency calculation
        window.currentMinerHashrate = stats.total_hashrate_ghs || 0;
        
        // Update power use
        const totalPower = stats.total_power_watts || 0;
        document.getElementById('total-power').textContent = totalPower > 0 ? `${Math.round(totalPower)} W` : '0 W';
        
        // Update efficiency
        const efficiencyEl = document.getElementById('power-efficiency');
        if (stats.avg_efficiency_wth && stats.avg_efficiency_wth > 0) {
            efficiencyEl.textContent = `Efficiency: ${stats.avg_efficiency_wth.toFixed(1)} J/TH`;
        } else {
            efficiencyEl.textContent = 'Efficiency: Unavailable';
        }
        
        document.getElementById('total-cost-24h').textContent = 
            stats.total_cost_24h_pounds !== undefined ? '£' + stats.total_cost_24h_pounds.toFixed(2) : '£0.00';
        
        // Update average price per kWh
        const avgPriceEl = document.getElementById('avg-price-per-kwh');
        if (stats.avg_price_per_kwh_pence && stats.avg_price_per_kwh_pence > 0) {
            avgPriceEl.textContent = `Avg: ${stats.avg_price_per_kwh_pence.toFixed(1)}p / kWh`;
        } else {
            avgPriceEl.textContent = 'Avg: Unavailable';
        }
        
        // Update best share (24h) - ASIC dashboard only
        if (stats.best_share_24h) {
            const bestShare = stats.best_share_24h;
            const pill = document.getElementById('best-share-coin-pill');
            const percentage = document.getElementById('best-share-percentage');
            const networkDiff = document.getElementById('best-share-network-diff');
            const timeAgo = document.getElementById('best-share-time-ago');
            
            // Update percentage
            percentage.textContent = bestShare.percentage + '%';
            
            // Update coin pill
            if (bestShare.coin) {
                pill.textContent = bestShare.coin;
                pill.className = `coin-pill ${bestShare.coin.toLowerCase()}`;
            } else {
                pill.textContent = 'None';
                pill.className = 'coin-pill none';
            }
            
            // Format network difficulty
            if (bestShare.network_difficulty) {
                const diff = bestShare.network_difficulty;
                let diffFormatted;
                if (diff >= 1_000_000_000) {
                    diffFormatted = (diff / 1_000_000_000).toFixed(1) + 'B';
                } else if (diff >= 1_000_000) {
                    diffFormatted = (diff / 1_000_000).toFixed(0) + 'M';
                } else {
                    diffFormatted = diff.toFixed(0);
                }
                networkDiff.textContent = `Network diff: ${diffFormatted}`;
            } else {
                networkDiff.textContent = 'Network diff: Unavailable';
            }
            
            // Format time ago
            if (bestShare.time_ago_seconds !== null) {
                const seconds = bestShare.time_ago_seconds;
                let timeStr;
                if (seconds < 60) {
                    timeStr = `${seconds}s ago`;
                } else if (seconds < 3600) {
                    const mins = Math.floor(seconds / 60);
                    const secs = seconds % 60;
                    timeStr = `${mins}m ${secs}s ago`;
                } else if (seconds < 86400) {
                    const hours = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    timeStr = `${hours}h ${mins}m ago`;
                } else {
                    const days = Math.floor(seconds / 86400);
                    timeStr = `${days}d ago`;
                }
                timeAgo.textContent = timeStr;
            } else {
                timeAgo.textContent = 'Unavailable';
            }
        }

        // Load ASIC pool integration stats (SHA256 pools only)
        await loadBraiinsStats();
        await loadSolopoolStats('asic');  // BTC, BCH, DGB only
    } catch (error) {
        console.error('Failed to load ASIC dashboard:', error);
    }
}
</script>
{% endblock %}
