{% extends "base.html" %}

{% block extra_head %}
<style>
.automation-container {
    padding: 1.5rem;
}

.automation-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
    gap: 2rem;
}

.rule-tile {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}

.rule-tile:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.rule-tile-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    background: var(--card-header);
    border-bottom: 1px solid var(--border-color);
}

.rule-tile-icon {
    font-size: 2rem;
    flex-shrink: 0;
}

.rule-tile-info {
    flex: 1;
    min-width: 0;
}

.rule-tile-name {
    font-weight: 600;
    font-size: 1.125rem;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
}

.rule-tile-priority {
    font-size: 0.875rem;
    color: #d1d5db;
}

.rule-tile-body {
    padding: 1.25rem;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.25rem;
    background: var(--card-bg);
}

.rule-tile-stat {
    background: var(--input-bg);
    padding: 0.875rem;
    border-radius: 8px;
    border: 1px solid #374151;
}

.rule-tile-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.5rem;
}

.rule-tile-value {
    font-weight: 600;
    font-size: 1rem;
    color: var(--text-primary);
}

.rule-tile-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
    padding: 1rem 1.25rem;
    background: var(--input-bg);
    border-top: 1px solid var(--border-color);
}

.add-rule-tile {
    background: var(--card-bg);
    border: 2px dashed #4a5568;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    min-height: 300px;
}

.add-rule-tile:hover {
    background: var(--card-header);
    border-color: #60a5fa;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.add-rule-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: var(--text-secondary);
}

.add-rule-text {
    font-size: 1.25rem;
    font-weight: 600;
    color: #e5e7eb;
    margin-bottom: 0.5rem;
}

.add-rule-subtitle {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

@media (max-width: 768px) {
    .automation-grid {
        grid-template-columns: 1fr;
    }
    
    .rule-tile-body {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="automation-container">
    <div class="automation-grid">
        {% for rule in rules %}
        <div class="rule-tile">
            <div class="rule-tile-header">
                <div class="rule-tile-icon">⚡</div>
                <div class="rule-tile-info">
                    <div class="rule-tile-name">{{ rule.name }}</div>
                    <div class="rule-tile-priority">Priority: {{ rule.priority }}</div>
                </div>
                <span class="badge {% if rule.enabled %}badge-success{% else %}badge-error{% endif %}">
                    {{ 'Enabled' if rule.enabled else 'Disabled' }}
                </span>
            </div>
            <div class="rule-tile-body">
                <div class="rule-tile-stat">
                    <div class="rule-tile-label">Trigger</div>
                    <div class="rule-tile-value">{{ rule.trigger_type }}</div>
                </div>
                <div class="rule-tile-stat">
                    <div class="rule-tile-label">Action</div>
                    <div class="rule-tile-value">{{ rule.action_type }}</div>
                </div>
            </div>
            <div class="rule-tile-actions">
                <button class="btn btn-secondary btn-sm" onclick="window.location.href='/automation/edit/{{ rule.id }}'">Edit</button>
                <button class="btn btn-secondary btn-sm" onclick="duplicateRule({{ rule.id }}, '{{ rule.name }}')">Duplicate</button>
                <button class="btn btn-warning btn-sm" onclick="toggleRule({{ rule.id }}, {{ 'false' if rule.enabled else 'true' }})">
                    {{ 'Pause' if rule.enabled else 'Enable' }}
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteRule({{ rule.id }}, '{{ rule.name }}')">Delete</button>
            </div>
        </div>
        {% endfor %}
        
        <a href="/automation/add" class="add-rule-tile">
            <div class="add-rule-icon">➕</div>
            <div class="add-rule-text">Add Rule</div>
            <div class="add-rule-subtitle">Create a new automation rule</div>
        </a>
    </div>
</div>

<script>
async function toggleRule(ruleId, enabled) {
    const action = enabled ? 'enable' : 'pause';
    if (!confirm(`Are you sure you want to ${action} this rule?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/automation/${ruleId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ enabled: enabled })
        });
        
        if (!response.ok) {
            throw new Error('Failed to toggle rule');
        }
        
        window.location.reload();
    } catch (error) {
        alert('Error toggling rule: ' + error.message);
    }
}

async function duplicateRule(ruleId, ruleName) {
    if (!confirm(`Duplicate "${ruleName}"?`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/automation/${ruleId}/duplicate`, {
            method: 'POST'
        });
        
        if (!response.ok) {
            throw new Error('Failed to duplicate rule');
        }
        
        const duplicatedRule = await response.json();
        window.location.href = `/automation/edit/${duplicatedRule.id}`;
    } catch (error) {
        alert('Error duplicating rule: ' + error.message);
    }
}

async function deleteRule(ruleId, ruleName) {
    if (!confirm(`Are you sure you want to delete "${ruleName}"? This cannot be undone.`)) {
        return;
    }
    
    try {
        const response = await fetch(`/api/automation/${ruleId}`, {
            method: 'DELETE'
        });
        
        if (!response.ok) {
            throw new Error('Failed to delete rule');
        }
        
        window.location.reload();
    } catch (error) {
        alert('Error deleting rule: ' + error.message);
    }
}
</script>
{% endblock %}
