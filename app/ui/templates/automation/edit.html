{% extends "base.html" %}

{% block extra_head %}
<style>
.automation-container {
    max-width: 800px;
    margin: 0 auto;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
}

.detail-card-header {
    background: var(--card-header);
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.detail-card-header h3 {
    margin: 0;
    font-size: 1.5rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.detail-card-icon {
    font-size: 1.75rem;
}

.detail-card-body {
    padding: 2rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    font-weight: 500;
}

.form-input,
.form-select {
    width: 100%;
    padding: 0.75rem;
    background: var(--card-header);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 1rem;
}

.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: #10b981;
}

small {
    display: block;
    margin-top: 0.375rem;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.form-error {
    display: block;
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.375rem;
}

.button-row {
    display: flex;
    gap: 0.75rem;
    margin-top: 2rem;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.checkbox-group input[type="checkbox"] {
    width: auto;
}

.checkbox-group label {
    margin: 0;
    color: var(--text-primary);
}

.loading {
    text-align: center;
    padding: 2rem;
    color: var(--text-secondary);
}
</style>
{% endblock %}

{% block content %}
<div class="automation-container">
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">⚙️</span> Edit Automation Rule</h3>
        </div>
        <div class="detail-card-body">
            <div id="loading" class="loading">Loading rule...</div>
            
            <form id="edit-rule-form" style="display: none;">
        <div class="form-group">
            <label class="form-label">Rule Name</label>
            <input type="text" class="form-input" id="name" required placeholder="e.g., Low price mode">
        </div>
        
        <div class="form-group">
            <label class="form-label">Trigger Type</label>
            <select class="form-select" id="trigger_type" required>
                <option value="">Select trigger...</option>
                <option value="price_threshold">Energy Price Threshold</option>
                <option value="time_window">Time Window</option>
            </select>
        </div>
        
        <div id="trigger-fields"></div>
        
        <div class="form-group">
            <label class="form-label">Action Type</label>
            <select class="form-select" id="action_type" required>
                <option value="">Select action...</option>
                <option value="apply_mode">Apply Miner Mode</option>
                <option value="switch_pool">Switch Mining Pool</option>
                <option value="send_alert">Send Alert</option>
                <option value="log_event">Log Event</option>
            </select>
        </div>
        
        <div id="action-fields"></div>
        
        <div class="form-group">
            <label class="form-label">Priority</label>
            <input type="number" class="form-input" id="priority" value="0">
        </div>
        
        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="enabled">
                <label for="enabled">Enabled</label>
            </div>
        </div>
        
        <div class="button-row">
            <button type="submit" class="btn btn-primary">Update Rule</button>
            <a href="/automation" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
const ruleId = {{ rule_id }};
let loadedRule = null;
let miners = [];
let pools = [];

// Load miners and pools for dropdowns
async function loadOptions() {
    try {
        const [minersRes, poolsRes] = await Promise.all([
            fetch('/api/miners/'),
            fetch('/api/pools/')
        ]);
        miners = await minersRes.json();
        pools = await poolsRes.json();
    } catch (error) {
        console.error('Failed to load options:', error);
    }
}

// Build trigger fields based on type
function buildTriggerFields(triggerType, config = {}) {
    const container = document.getElementById('trigger-fields');
    container.innerHTML = '';
    
    if (triggerType === 'price_threshold') {
        container.innerHTML = `
            <div class="form-group">
                <label class="form-label">Condition</label>
                <select class="form-select" id="trigger_condition" required>
                    <option value="above" ${config.condition === 'above' ? 'selected' : ''}>Above threshold</option>
                    <option value="below" ${config.condition === 'below' ? 'selected' : ''}>Below threshold</option>
                    <option value="between" ${config.condition === 'between' ? 'selected' : ''}>Between two thresholds</option>
                    <option value="outside" ${config.condition === 'outside' ? 'selected' : ''}>Outside two thresholds</option>
                </select>
            </div>
            <div id="threshold-fields">
                <div class="form-group">
                    <label class="form-label">Price Threshold (p/kWh)</label>
                    <input type="number" step="0.01" class="form-input" id="trigger_threshold" required 
                           value="${config.threshold || ''}" placeholder="e.g., 10.00">
                </div>
            </div>
        `;
        
        // Add change listener for condition
        document.getElementById('trigger_condition').addEventListener('change', function() {
            const condition = this.value;
            const fieldsContainer = document.getElementById('threshold-fields');
            
            if (condition === 'between' || condition === 'outside') {
                fieldsContainer.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Minimum Price Threshold (p/kWh)</label>
                        <input type="number" step="0.01" class="form-input" id="trigger_threshold_min" required 
                               value="${config.threshold_min || ''}" placeholder="e.g., 5.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Maximum Price Threshold (p/kWh)</label>
                        <input type="number" step="0.01" class="form-input" id="trigger_threshold_max" required 
                               value="${config.threshold_max || ''}" placeholder="e.g., 15.00">
                    </div>
                `;
            } else {
                fieldsContainer.innerHTML = `
                    <div class="form-group">
                        <label class="form-label">Price Threshold (p/kWh)</label>
                        <input type="number" step="0.01" class="form-input" id="trigger_threshold" required 
                               value="${config.threshold || ''}" placeholder="e.g., 10.00">
                    </div>
                `;
            }
        });
        
        // Initialize fields based on current condition
        const initialCondition = config.condition || 'above';
        if (initialCondition === 'between' || initialCondition === 'outside') {
            const fieldsContainer = document.getElementById('threshold-fields');
            fieldsContainer.innerHTML = `
                <div class="form-group">
                    <label class="form-label">Minimum Price Threshold (p/kWh)</label>
                    <input type="number" step="0.01" class="form-input" id="trigger_threshold_min" required 
                           value="${config.threshold_min || ''}" placeholder="e.g., 5.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Maximum Price Threshold (p/kWh)</label>
                    <input type="number" step="0.01" class="form-input" id="trigger_threshold_max" required 
                           value="${config.threshold_max || ''}" placeholder="e.g., 15.00">
                </div>
            `;
        }
    } else if (triggerType === 'time_window') {
        container.innerHTML = `
            <div class="form-group">
                <label class="form-label">Start Time</label>
                <input type="time" class="form-input" id="trigger_start_time" required value="${config.start_time || ''}">
            </div>
            <div class="form-group">
                <label class="form-label">End Time</label>
                <input type="time" class="form-input" id="trigger_end_time" required value="${config.end_time || ''}">
            </div>
            <div class="form-group">
                <label class="form-label">Days of Week</label>
                <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                    ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map((day, i) => `
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" class="trigger-day" value="${i}" 
                                   ${(config.days || []).includes(i) ? 'checked' : ''}>
                            ${day}
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (triggerType === 'miner_offline') {
        container.innerHTML = `
            <div class="form-group">
                <label class="form-label">Miner</label>
                <select class="form-select" id="trigger_miner_id" required>
                    <option value="">Select miner...</option>
                    ${miners.map(m => `<option value="${m.id}" ${config.miner_id === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Timeout (seconds)</label>
                <input type="number" class="form-input" id="trigger_timeout" required 
                       value="${config.timeout || 300}" placeholder="300">
                <small>Trigger if miner is offline for this many seconds</small>
            </div>
        `;
    } else if (triggerType === 'miner_overheat') {
        container.innerHTML = `
            <div class="form-group">
                <label class="form-label">Miner</label>
                <select class="form-select" id="trigger_miner_id" required>
                    <option value="">Select miner...</option>
                    ${miners.map(m => `<option value="${m.id}" ${config.miner_id === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Temperature Threshold (°C)</label>
                <input type="number" class="form-input" id="trigger_temp_threshold" required 
                       value="${config.temp_threshold || 80}" placeholder="80">
            </div>
        `;
    } else if (triggerType === 'pool_failure') {
        container.innerHTML = `
            <div class="form-group">
                <label class="form-label">Miner</label>
                <select class="form-select" id="trigger_miner_id" required>
                    <option value="">Select miner...</option>
                    ${miners.map(m => `<option value="${m.id}" ${config.miner_id === m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Pool</label>
                <select class="form-select" id="trigger_pool_id">
                    <option value="">Any pool</option>
                    ${pools.map(p => `<option value="${p.id}" ${config.pool_id === p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                </select>
            </div>
        `;
    }
}

// Build action fields based on type
function buildActionFields(actionType, config = {}) {
    const container = document.getElementById('action-fields');
    container.innerHTML = '';
    
    if (actionType === 'apply_mode') {
        // Group miners by type
        const minersByType = {};
        miners.forEach(m => {
            if (!minersByType[m.miner_type]) {
                minersByType[m.miner_type] = [];
            }
            minersByType[m.miner_type].push(m);
        });
        
        // Build grouped options
        let minerOptions = '<option value="">Select miner or group...</option>';
        
        // Add type groups if there are multiple miners of that type
        Object.keys(minersByType).forEach(type => {
            const minersOfType = minersByType[type];
            if (minersOfType.length > 1) {
                const typeLabel = type === 'bitaxe' ? 'Bitaxe' : 
                                 type === 'avalon_nano' ? 'Avalon Nano' : 
                                 type === 'nerdqaxe' ? 'NerdQaxe' : 
                                 type === 'nmminer' ? 'NMMiner' : type;
                minerOptions += `<option value="type:${type}" ${config.miner_id === `type:${type}` ? 'selected' : ''}>All ${typeLabel} Miners (${minersOfType.length})</option>`;
            }
        });
        
        // Add individual miners
        miners.forEach(m => {
            minerOptions += `<option value="${m.id}" ${config.miner_id === m.id ? 'selected' : ''}>${m.name}</option>`;
        });
        
        container.innerHTML = `
            <div class="form-group">
                <label class="form-label">Target Miner(s)</label>
                <select class="form-select" id="action_miner_id" required>
                    ${minerOptions}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Mode</label>
                <select class="form-select" id="action_mode" required>
                    <option value="">Select miner first...</option>
                </select>
            </div>
        `;
        
        // Add change listener to load modes when miner is selected
        document.getElementById('action_miner_id').addEventListener('change', async function() {
            const value = this.value;
            const modeSelect = document.getElementById('action_mode');
            
            if (!value) {
                modeSelect.innerHTML = '<option value="">Select miner first...</option>';
                return;
            }
            
            try {
                let modes = [];
                
                // If it's a type group, get modes from first miner of that type
                if (value.startsWith('type:')) {
                    const type = value.split(':')[1];
                    const firstMinerOfType = minersByType[type][0];
                    const response = await fetch(`/api/miners/${firstMinerOfType.id}/modes`);
                    const data = await response.json();
                    modes = data.modes || [];
                } else {
                    // Single miner
                    const response = await fetch(`/api/miners/${value}/modes`);
                    const data = await response.json();
                    modes = data.modes || [];
                }
                
                modeSelect.innerHTML = modes.map(mode => 
                    `<option value="${mode}" ${config.mode === mode ? 'selected' : ''}>${mode.charAt(0).toUpperCase() + mode.slice(1)}</option>`
                ).join('');
                
                // If we have a config mode, try to select it
                if (config.mode) {
                    modeSelect.value = config.mode;
                }
            } catch (error) {
                console.error('Failed to load modes:', error);
                modeSelect.innerHTML = '<option value="">Error loading modes</option>';
            }
        });
        
        // If we have a pre-selected miner, load its modes
        if (config.miner_id) {
            document.getElementById('action_miner_id').dispatchEvent(new Event('change'));
        }
    } else if (actionType === 'switch_pool') {
        // Group miners by type
        const minersByType = {};
        miners.forEach(m => {
            if (!minersByType[m.miner_type]) {
                minersByType[m.miner_type] = [];
            }
            minersByType[m.miner_type].push(m);
        });
        
        // Build grouped options
        let minerOptions = '<option value="">Select miner or group...</option>';
        
        // Add type groups if there are multiple miners of that type
        Object.keys(minersByType).forEach(type => {
            const minersOfType = minersByType[type];
            if (minersOfType.length > 1) {
                const typeLabel = type === 'bitaxe' ? 'Bitaxe' : 
                                 type === 'avalon_nano' ? 'Avalon Nano' : 
                                 type === 'nerdqaxe' ? 'NerdQaxe' : 
                                 type === 'nmminer' ? 'NMMiner' : type;
                minerOptions += `<option value="type:${type}" ${config.miner_id === `type:${type}` ? 'selected' : ''}>All ${typeLabel} Miners (${minersOfType.length})</option>`;
            }
        });
        
        // Add individual miners
        miners.forEach(m => {
            minerOptions += `<option value="${m.id}" ${config.miner_id === m.id ? 'selected' : ''}>${m.name}</option>`;
        });
        
        container.innerHTML = `
            <div class="form-group">
                <label class="form-label">Target Miner(s)</label>
                <select class="form-select" id="action_miner_id" required>
                    ${minerOptions}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Pool</label>
                <select class="form-select" id="action_pool_id" required>
                    <option value="">Select pool...</option>
                    ${pools.map(p => `<option value="${p.id}" ${config.pool_id === p.id ? 'selected' : ''}>${p.name} (${p.url}:${p.port})</option>`).join('')}
                </select>
                <small>Note: For Avalon Nano, the pool must be pre-configured in one of the 3 device slots</small>
            </div>
        `;
    } else if (actionType === 'send_alert') {
        container.innerHTML = `
            <div class="form-group">
                <label class="form-label">Alert Message</label>
                <textarea class="form-input" id="action_message" rows="3" required placeholder="e.g., Energy price is high!">${config.message || ''}</textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Alert Level</label>
                <select class="form-select" id="action_level" required>
                    <option value="info" ${config.level === 'info' ? 'selected' : ''}>Info</option>
                    <option value="warning" ${config.level === 'warning' ? 'selected' : ''}>Warning</option>
                    <option value="error" ${config.level === 'error' ? 'selected' : ''}>Error</option>
                </select>
            </div>
        `;
    } else if (actionType === 'log_event') {
        container.innerHTML = `
            <div class="form-group">
                <label class="form-label">Event Message</label>
                <textarea class="form-input" id="action_message" rows="3" required placeholder="e.g., Automation rule triggered">${config.message || ''}</textarea>
            </div>
        `;
    }
}

// Get trigger config from fields
function getTriggerConfig(triggerType) {
    const config = {};
    
    if (triggerType === 'price_threshold') {
        config.condition = document.getElementById('trigger_condition').value;
        
        if (config.condition === 'between' || config.condition === 'outside') {
            config.threshold_min = parseFloat(document.getElementById('trigger_threshold_min').value);
            config.threshold_max = parseFloat(document.getElementById('trigger_threshold_max').value);
        } else {
            config.threshold = parseFloat(document.getElementById('trigger_threshold').value);
        }
    } else if (triggerType === 'time_window') {
        config.start_time = document.getElementById('trigger_start_time').value;
        config.end_time = document.getElementById('trigger_end_time').value;
        config.days = Array.from(document.querySelectorAll('.trigger-day:checked')).map(cb => parseInt(cb.value));
    } else if (triggerType === 'miner_offline') {
        config.miner_id = parseInt(document.getElementById('trigger_miner_id').value);
        config.timeout = parseInt(document.getElementById('trigger_timeout').value);
    } else if (triggerType === 'miner_overheat') {
        config.miner_id = parseInt(document.getElementById('trigger_miner_id').value);
        config.temp_threshold = parseInt(document.getElementById('trigger_temp_threshold').value);
    } else if (triggerType === 'pool_failure') {
        config.miner_id = parseInt(document.getElementById('trigger_miner_id').value);
        const poolId = document.getElementById('trigger_pool_id').value;
        if (poolId) config.pool_id = parseInt(poolId);
    }
    
    return config;
}

// Get action config from fields
function getActionConfig(actionType) {
    const config = {};
    
    if (actionType === 'apply_mode') {
        const value = document.getElementById('action_miner_id').value;
        // Store the value as-is (either numeric ID or "type:typename")
        config.miner_id = value.startsWith('type:') ? value : parseInt(value);
        config.mode = document.getElementById('action_mode').value;
    } else if (actionType === 'switch_pool') {
        const value = document.getElementById('action_miner_id').value;
        // Store the value as-is (either numeric ID or "type:typename")
        config.miner_id = value.startsWith('type:') ? value : parseInt(value);
        config.pool_id = parseInt(document.getElementById('action_pool_id').value);
    } else if (actionType === 'send_alert') {
        config.message = document.getElementById('action_message').value;
        config.level = document.getElementById('action_level').value;
    } else if (actionType === 'log_event') {
        config.message = document.getElementById('action_message').value;
    }
    
    return config;
}

// Handle trigger type change
document.getElementById('trigger_type').addEventListener('change', function() {
    buildTriggerFields(this.value);
});

// Handle action type change
document.getElementById('action_type').addEventListener('change', function() {
    buildActionFields(this.value);
});

// Load rule data
async function loadRule() {
    try {
        // Load options first
        await loadOptions();
        
        const response = await fetch(`/api/automation/${ruleId}`);
        
        if (!response.ok) {
            throw new Error('Rule not found');
        }
        
        loadedRule = await response.json();
        
        // Populate form
        document.getElementById('name').value = loadedRule.name;
        document.getElementById('trigger_type').value = loadedRule.trigger_type;
        document.getElementById('action_type').value = loadedRule.action_type;
        document.getElementById('priority').value = loadedRule.priority;
        document.getElementById('enabled').checked = loadedRule.enabled;
        
        // Build dynamic fields with loaded config
        buildTriggerFields(loadedRule.trigger_type, loadedRule.trigger_config);
        buildActionFields(loadedRule.action_type, loadedRule.action_config);
        
        // Show form
        document.getElementById('loading').style.display = 'none';
        document.getElementById('edit-rule-form').style.display = 'block';
        
    } catch (error) {
        document.getElementById('loading').innerHTML = `<div class="text-error">Error loading rule: ${error.message}</div>`;
    }
}

// Handle form submission
document.getElementById('edit-rule-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    try {
        const triggerType = document.getElementById('trigger_type').value;
        const actionType = document.getElementById('action_type').value;
        
        const data = {
            name: document.getElementById('name').value,
            trigger_type: triggerType,
            trigger_config: getTriggerConfig(triggerType),
            action_type: actionType,
            action_config: getActionConfig(actionType),
            priority: parseInt(document.getElementById('priority').value),
            enabled: document.getElementById('enabled').checked
        };
        
        const res = await fetch(`/api/automation/${ruleId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (res.ok) {
            window.location.href = '/automation';
        } else {
            const error = await res.json();
            alert('Failed to update rule: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
});

// Load rule on page load
loadRule();
</script>
{% endblock %}
