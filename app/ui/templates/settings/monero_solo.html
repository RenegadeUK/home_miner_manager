{% extends "base.html" %}

{% block extra_head %}
<style>
.monero-container {
    max-width: 900px;
    margin: 0 auto;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    margin-bottom: 1.5rem;
}

.detail-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    background: var(--card-header);
    border-bottom: 1px solid var(--border-color);
}

.detail-card-icon {
    font-size: 2rem;
    margin-right: 1rem;
    color: #ff6600;
}

.detail-card-header h3 {
    flex: 1;
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
}

.detail-card-body {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.form-input,
.form-select {
    width: 100%;
    max-width: 500px;
    padding: 0.625rem;
    background: var(--card-header);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.9375rem;
}

.form-input:focus,
.form-select:focus {
    outline: none;
    border-color: #ff6600;
}

.form-input::placeholder {
    color: var(--text-secondary);
}

.form-checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.form-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

.form-checkbox-label {
    font-weight: 600;
    color: var(--text-primary);
    cursor: pointer;
}

.help-text {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.btn-group {
    display: flex;
    gap: 1rem;
    margin-top: 1.5rem;
}

.btn {
    padding: 0.625rem 1.25rem;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9375rem;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-secondary {
    background: var(--card-header);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--border-color);
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 600;
    margin-top: 0.5rem;
}

.status-success {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
}

.status-error {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.status-warning {
    background: rgba(251, 191, 36, 0.1);
    color: #fbbf24;
}

.wallet-address {
    font-family: monospace;
    font-size: 0.85rem;
    background: var(--card-header);
    padding: 0.5rem;
    border-radius: 4px;
    margin-top: 0.5rem;
    word-break: break-all;
}

.info-box {
    background: rgba(59, 130, 246, 0.1);
    border-left: 4px solid #3b82f6;
    padding: 1rem;
    border-radius: 6px;
    margin-top: 1rem;
}

.info-box-title {
    font-weight: 600;
    color: #3b82f6;
    margin-bottom: 0.5rem;
}

.info-box-text {
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.6;
}
</style>
{% endblock %}

{% block content %}
<div class="monero-container">
    <!-- Info Box -->
    <div class="info-box">
        <div class="info-box-title">‚ÑπÔ∏è About Monero Solo Mining</div>
        <div class="info-box-text">
            Solo mining lets you mine Monero directly against the network without a pool. Configure your wallet RPC below to track rewards. 
            Make sure your Monero node and wallet-rpc are running. XMRig miners pointed to your node will be automatically detected and tracked.
        </div>
    </div>

    <!-- Main Settings Card -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>
                <span class="detail-card-icon">‚ü†</span>
                Monero Solo Mining Configuration
            </h3>
        </div>
        <div class="detail-card-body">
            <form id="monero-solo-form">
                <!-- Enable Toggle -->
                <div class="form-group">
                    <div class="form-checkbox-wrapper">
                        <input type="checkbox" id="enabled" class="form-checkbox">
                        <label for="enabled" class="form-checkbox-label">
                            Enable Monero Solo Mining Tracking
                        </label>
                    </div>
                    <div class="help-text">
                        Enable this to track your solo mining rewards and display dashboard tiles
                    </div>
                </div>

                <!-- Wallet RPC Settings -->
                <div style="border-top: 1px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--text-primary);">Wallet RPC Settings</h4>

                    <div class="form-group">
                        <label for="wallet-rpc-ip" class="form-label">Wallet RPC IP Address</label>
                        <input type="text" id="wallet-rpc-ip" class="form-input" placeholder="192.168.1.100 or localhost">
                        <div class="help-text">IP address or hostname of your monero-wallet-rpc instance</div>
                    </div>

                    <div class="form-group">
                        <label for="wallet-rpc-port" class="form-label">Wallet RPC Port</label>
                        <input type="number" id="wallet-rpc-port" class="form-input" value="18083">
                        <div class="help-text">Port for wallet RPC (default: 18083)</div>
                    </div>

                    <div class="form-group">
                        <label for="wallet-rpc-user" class="form-label">Username (Optional)</label>
                        <input type="text" id="wallet-rpc-user" class="form-input" placeholder="Leave blank if not using authentication">
                        <div class="help-text">RPC username if authentication is enabled</div>
                    </div>

                    <div class="form-group">
                        <label for="wallet-rpc-pass" class="form-label">Password (Optional)</label>
                        <input type="password" id="wallet-rpc-pass" class="form-input" placeholder="Leave blank if not using authentication">
                        <div class="help-text">RPC password if authentication is enabled</div>
                    </div>

                    <!-- Test Connection Button -->
                    <button type="button" id="test-wallet-btn" class="btn btn-secondary">
                        üîå Test Wallet Connection
                    </button>
                    <div id="wallet-status" style="display: none;"></div>
                </div>

                <!-- Wallet Address Display -->
                <div id="wallet-address-section" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                    <h4 style="margin-bottom: 0.5rem; color: var(--text-primary);">Wallet Address</h4>
                    <div id="wallet-address-display" class="wallet-address"></div>
                </div>

                <!-- Action Buttons -->
                <div class="btn-group">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="window.location.reload()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let currentSettings = null;

// Load settings on page load
async function loadSettings() {
    try {
        const response = await fetch('/api/settings/monero-solo');
        if (!response.ok) throw new Error('Failed to load settings');
        
        currentSettings = await response.json();
        
        // Populate form
        document.getElementById('enabled').checked = currentSettings.enabled || false;
        document.getElementById('wallet-rpc-ip').value = currentSettings.wallet_rpc_ip || '';
        document.getElementById('wallet-rpc-port').value = currentSettings.wallet_rpc_port || 18083;
        document.getElementById('wallet-rpc-user').value = currentSettings.wallet_rpc_user || '';
        document.getElementById('wallet-rpc-pass').value = currentSettings.wallet_rpc_pass || '';
        
        // Show wallet address if available
        if (currentSettings.wallet_address) {
            document.getElementById('wallet-address-display').textContent = currentSettings.wallet_address;
            document.getElementById('wallet-address-section').style.display = 'block';
        }
    } catch (error) {
        console.error('Failed to load settings:', error);
        alert('Failed to load settings: ' + error.message);
    }
}

// Test wallet connection
document.getElementById('test-wallet-btn').addEventListener('click', async () => {
    const ip = document.getElementById('wallet-rpc-ip').value;
    const port = document.getElementById('wallet-rpc-port').value;
    const username = document.getElementById('wallet-rpc-user').value;
    const password = document.getElementById('wallet-rpc-pass').value;
    
    if (!ip) {
        alert('Please enter wallet RPC IP address');
        return;
    }
    
    const statusDiv = document.getElementById('wallet-status');
    statusDiv.style.display = 'block';
    statusDiv.className = 'status-indicator status-warning';
    statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing connection...';
    
    try {
        const response = await fetch('/api/settings/monero-solo/test-wallet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ip, port: parseInt(port), username, password })
        });
        
        const result = await response.json();
        
        if (result.success) {
            statusDiv.className = 'status-indicator status-success';
            statusDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${result.message}`;
            
            if (result.address) {
                document.getElementById('wallet-address-display').textContent = result.address;
                document.getElementById('wallet-address-section').style.display = 'block';
            }
        } else {
            statusDiv.className = 'status-indicator status-error';
            statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${result.message}`;
        }
    } catch (error) {
        statusDiv.className = 'status-indicator status-error';
        statusDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> Connection failed: ${error.message}`;
    }
});

// Save settings
document.getElementById('monero-solo-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const data = {
        enabled: document.getElementById('enabled').checked,
        wallet_rpc_ip: document.getElementById('wallet-rpc-ip').value || null,
        wallet_rpc_port: parseInt(document.getElementById('wallet-rpc-port').value),
        wallet_rpc_user: document.getElementById('wallet-rpc-user').value || null,
        wallet_rpc_pass: document.getElementById('wallet-rpc-pass').value || null
    };
    
    try {
        const response = await fetch('/api/settings/monero-solo', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Failed to save settings');
        }
        
        const result = await response.json();
        
        // Show success message
        const statusDiv = document.getElementById('wallet-status');
        statusDiv.style.display = 'block';
        statusDiv.className = 'status-indicator status-success';
        statusDiv.innerHTML = '<i class="fas fa-check-circle"></i> Settings saved successfully!';
        
        // Update wallet address if returned
        if (result.wallet_address) {
            document.getElementById('wallet-address-display').textContent = result.wallet_address;
            document.getElementById('wallet-address-section').style.display = 'block';
        }
        
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 3000);
        
    } catch (error) {
        alert('Error saving settings: ' + error.message);
    }
});

// Load settings when page loads
loadSettings();
</script>
{% endblock %}
