{% extends "base.html" %}

{% block title %}Home Assistant Integration{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h1>üè† Home Assistant Integration</h1>
            <p class="text-muted">Connect HMM to Home Assistant to control smart devices (switches, plugs, lights) based on electricity pricing and automation rules.</p>
        </div>
    </div>

    <!-- Configuration Card -->
    <div class="row mt-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">‚öôÔ∏è Configuration</h5>
                    <span id="connectionStatus" class="badge bg-secondary">Not Configured</span>
                </div>
                <div class="card-body">
                    <form id="haConfigForm">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" value="Home Assistant" required>
                            <small class="text-muted">Friendly name for this integration</small>
                        </div>

                        <div class="mb-3">
                            <label for="base_url" class="form-label">Base URL</label>
                            <input type="url" class="form-control" id="base_url" name="base_url" placeholder="http://homeassistant.local:8123" required>
                            <small class="text-muted">Your Home Assistant URL (include http:// or https://)</small>
                        </div>

                        <div class="mb-3">
                            <label for="access_token" class="form-label">Access Token</label>
                            <input type="password" class="form-control" id="access_token" name="access_token" placeholder="Your Long-Lived Access Token">
                            <small class="text-muted">
                                Get from HA: Profile ‚Üí Long-Lived Access Tokens ‚Üí Create Token. Leave blank to keep existing token.
                                <a href="#" onclick="document.getElementById('access_token').type = (document.getElementById('access_token').type === 'password' ? 'text' : 'password'); return false;">üëÅÔ∏è Show/Hide</a>
                            </small>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="enabled" name="enabled" checked>
                            <label class="form-check-label" for="enabled">
                                Enable integration
                            </label>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="keepalive_enabled" name="keepalive_enabled">
                            <label class="form-check-label" for="keepalive_enabled">
                                Keep Alive Notification
                            </label>
                            <small class="text-muted d-block">Monitor HA connectivity every minute. Sends alerts if HA goes offline (at 1, 5, and 15 minutes) and when it recovers.</small>
                        </div>

                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">üíæ Save Configuration</button>
                            <button type="button" class="btn btn-secondary" id="testConnectionBtn">üîå Test Connection</button>
                            <button type="button" class="btn btn-danger" id="deleteConfigBtn" style="display: none;">üóëÔ∏è Delete Configuration</button>
                        </div>
                    </form>

                    <div id="testResult" class="mt-3" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card bg-light">
                <div class="card-body">
                    <h6>üìò Setup Guide</h6>
                    <ol class="small">
                        <li>Open Home Assistant</li>
                        <li>Click your profile (bottom left)</li>
                        <li>Scroll to "Long-Lived Access Tokens"</li>
                        <li>Click "Create Token"</li>
                        <li>Give it a name (e.g., "HMM")</li>
                        <li>Copy the token</li>
                        <li>Paste it above and save</li>
                    </ol>

                    <h6 class="mt-3">üéØ Use Cases</h6>
                    <ul class="small">
                        <li>Turn off miner power when electricity is expensive</li>
                        <li>Turn on mining when prices are cheap</li>
                        <li>Emergency shutdown on overheat</li>
                        <li>Control via automation rules</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Devices Card -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üì± Miner Power Switches</h5>
                    <div class="d-flex gap-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="showAllDevices" onchange="loadDevices()">
                            <label class="form-check-label small" for="showAllDevices">Show all devices</label>
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" id="discoverDevicesBtn" disabled>
                            üîç Discover Devices
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <strong>üí° Tip:</strong> Only enroll the switches that control miner power. Link each switch to its miner so automation can turn them on/off.
                    </div>
                    <div id="devicesContainer">
                        <p class="text-muted text-center py-4">Configure Home Assistant above, then discover devices.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Link Device Modal -->
    <div class="modal fade" id="linkDeviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üîó Link Device to Miner</h5>
                    <button type="button" class="btn-close" onclick="closeModal()"></button>
                </div>
                <div class="modal-body">
                    <p><strong id="linkDeviceName"></strong></p>
                    <div class="mb-3">
                        <label for="minerSelect" class="form-label">Select Miner</label>
                        <select class="form-select" id="minerSelect">
                            <option value="">-- No Link --</option>
                        </select>
                        <small class="text-muted">Link this switch to control a specific miner's power</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveLinkage()">Save Link</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let haConfigured = false;
    let allMiners = [];
    let currentLinkDeviceId = null;

    // Load configuration on page load
    async function loadConfig() {
        try {
            const response = await fetch('/api/integrations/homeassistant/config');
            const data = await response.json();
            console.log('HA Config loaded:', data);

            if (data.configured) {
                haConfigured = true;
                document.getElementById('name').value = data.name;
                document.getElementById('base_url').value = data.base_url;
                document.getElementById('enabled').checked = data.enabled;
                document.getElementById('keepalive_enabled').checked = data.keepalive_enabled || false;
                document.getElementById('deleteConfigBtn').style.display = 'inline-block';
                document.getElementById('discoverDevicesBtn').disabled = false;
                
                // Show placeholder for existing token (don't display actual token)
                document.getElementById('access_token').placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                document.getElementById('access_token').value = '';  // Don't show real token

                // Update status badge
                const statusBadge = document.getElementById('connectionStatus');
                if (data.last_test_success === true) {
                    statusBadge.textContent = '‚úÖ Connected';
                    statusBadge.className = 'badge bg-success';
                } else if (data.last_test_success === false) {
                    statusBadge.textContent = '‚ùå Connection Failed';
                    statusBadge.className = 'badge bg-danger';
                } else {
                    statusBadge.textContent = '‚ö†Ô∏è Not Tested';
                    statusBadge.className = 'badge bg-warning';
                }

                // Load devices
                await loadDevices();
            } else {
                console.log('HA not configured');
            }
        } catch (error) {
            console.error('Failed to load config:', error);
        }
    }

    // Save configuration
    document.getElementById('haConfigForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = {
            name: document.getElementById('name').value,
            base_url: document.getElementById('base_url').value,
            access_token: document.getElementById('access_token').value || null,
            enabled: document.getElementById('enabled').checked,
            keepalive_enabled: document.getElementById('keepalive_enabled').checked
        };

        try {
            const response = await fetch('/api/integrations/homeassistant/config', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(formData)
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', '‚úÖ Configuration saved successfully!');
                await loadConfig();
            } else {
                showAlert('danger', '‚ùå ' + (data.message || 'Failed to save configuration'));
            }
        } catch (error) {
            showAlert('danger', '‚ùå Error: ' + error.message);
        }
    });

    // Test connection
    document.getElementById('testConnectionBtn').addEventListener('click', async () => {
        if (!haConfigured && !document.getElementById('base_url').value) {
            showAlert('warning', '‚ö†Ô∏è Please save configuration first');
            return;
        }

        const btn = document.getElementById('testConnectionBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Testing...';

        try {
            const response = await fetch('/api/integrations/homeassistant/test', {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', '‚úÖ ' + data.message);
                await loadConfig();
            } else {
                showAlert('danger', '‚ùå ' + data.message);
            }
        } catch (error) {
            showAlert('danger', '‚ùå Error: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîå Test Connection';
        }
    });

    // Delete configuration
    document.getElementById('deleteConfigBtn').addEventListener('click', async () => {
        if (!confirm('Are you sure you want to delete the Home Assistant configuration?')) {
            return;
        }

        try {
            const response = await fetch('/api/integrations/homeassistant/config', {
                method: 'DELETE'
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', '‚úÖ Configuration deleted');
                window.location.reload();
            } else {
                showAlert('danger', '‚ùå Failed to delete configuration');
            }
        } catch (error) {
            showAlert('danger', '‚ùå Error: ' + error.message);
        }
    });

    // Discover devices
    document.getElementById('discoverDevicesBtn').addEventListener('click', async () => {
        const btn = document.getElementById('discoverDevicesBtn');
        btn.disabled = true;
        btn.textContent = '‚è≥ Discovering...';

        try {
            const response = await fetch('/api/integrations/homeassistant/discover', {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', `‚úÖ ${data.message}`);
                await loadDevices();
            } else {
                showAlert('danger', '‚ùå ' + data.message);
            }
        } catch (error) {
            showAlert('danger', '‚ùå Error: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîç Discover Devices';
        }
    });

    // Load miners for linking
    async function loadMiners() {
        try {
            const response = await fetch('/api/miners/');
            const data = await response.json();
            allMiners = data || [];
        } catch (error) {
            console.error('Failed to load miners:', error);
        }
    }

    // Load devices
    async function loadDevices() {
        try {
            const showAll = document.getElementById('showAllDevices').checked;
            const url = showAll ? '/api/integrations/homeassistant/devices' : '/api/integrations/homeassistant/devices?enrolled_only=true';
            
            const response = await fetch(url);
            const data = await response.json();

            const container = document.getElementById('devicesContainer');

            // Filter to only show switches
            const switches = data.devices ? data.devices.filter(device => device.domain === 'switch') : [];

            if (!switches || switches.length === 0) {
                if (showAll) {
                    container.innerHTML = '<p class="text-muted text-center py-4">No switches discovered yet. Click "Discover Devices" above.</p>';
                } else {
                    container.innerHTML = '<p class="text-muted text-center py-4">No enrolled switches. Enable "Show all devices" to see discovered switches and enroll them.</p>';
                }
                return;
            }

            // Build devices table
            let html = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>Entity ID</th>
                                <th>State</th>
                                <th>Linked Miner</th>
                                <th>Control</th>
                                <th>Enrolled</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            switches.forEach(device => {
                const stateClass = device.current_state === 'on' ? 'success' : device.current_state === 'off' ? 'secondary' : 'warning';
                const icon = getDomainIcon(device.domain);
                const linkedMiner = device.miner_id ? allMiners.find(m => m.id === device.miner_id) : null;

                html += `
                    <tr ${device.enrolled ? 'class="table-primary"' : ''}>
                        <td style="max-width: 200px; word-wrap: break-word; word-break: break-word;">
                            <div class="d-flex align-items-center gap-2">
                                <span>${icon}</span>
                                <strong>${device.name}</strong>
                            </div>
                        </td>
                        <td style="max-width: 200px; word-wrap: break-word; word-break: break-all;">
                            <small class="text-muted">${device.entity_id}</small>
                        </td>
                        <td>
                            ${device.current_state ? `<span class="badge bg-${stateClass}">${device.current_state}</span>` : '<span class="text-muted">Unknown</span>'}
                        </td>
                        <td>
                            ${linkedMiner ? `<span class="badge bg-success">${linkedMiner.name}</span>` : '<span class="text-muted">Not linked</span>'}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" style="display: inline-flex;">
                                <button class="btn btn-outline-success" style="width: 35px; height: 24px; padding: 0; font-size: 0.7rem; display: inline-flex; align-items: center; justify-content: center;" onclick="controlDevice(${device.id}, 'turn_on')" data-bs-toggle="tooltip" data-bs-placement="top" title="Turn On">ON</button>
                                <button class="btn btn-outline-secondary" style="width: 35px; height: 24px; padding: 0; font-size: 0.7rem; display: inline-flex; align-items: center; justify-content: center;" onclick="controlDevice(${device.id}, 'turn_off')" data-bs-toggle="tooltip" data-bs-placement="top" title="Turn Off">OFF</button>
                                <button class="btn btn-outline-info" style="width: 35px; height: 24px; padding: 0; font-size: 0.8rem; display: inline-flex; align-items: center; justify-content: center;" onclick="refreshState(${device.id})" data-bs-toggle="tooltip" data-bs-placement="top" title="Refresh State">üîÑ</button>
                            </div>
                            <button class="btn btn-sm btn-outline-primary ms-1" style="width: 35px; height: 24px; padding: 0; font-size: 0.8rem; display: inline-flex; align-items: center; justify-content: center;" onclick="openLinkModal(${device.id}, '${device.name}', ${device.miner_id})" data-bs-toggle="tooltip" data-bs-placement="top" title="Link to Miner">
                                üîó
                            </button>
                        </td>
                        <td>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" ${device.enrolled ? 'checked' : ''} 
                                       onchange="toggleEnrollment(${device.id}, this.checked)">
                            </div>
                        </td>
                    </tr>
                `;
            });

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            container.innerHTML = html;
            
            // Initialize Bootstrap tooltips
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });
        } catch (error) {
            console.error('Failed to load devices:', error);
        }
    }

    // Open link modal
    function openLinkModal(deviceId, deviceName, currentMinerId) {
        currentLinkDeviceId = deviceId;
        document.getElementById('linkDeviceName').textContent = deviceName;
        
        // Populate miner dropdown
        const select = document.getElementById('minerSelect');
        select.innerHTML = '<option value="">-- No Link --</option>';
        
        allMiners.forEach(miner => {
            const option = document.createElement('option');
            option.value = miner.id;
            option.textContent = `${miner.name} (${miner.miner_type})`;
            if (miner.id === currentMinerId) {
                option.selected = true;
            }
            select.appendChild(option);
        });
        
        // Show modal using vanilla JS
        const modalEl = document.getElementById('linkDeviceModal');
        modalEl.classList.add('show');
        modalEl.style.display = 'block';
        modalEl.setAttribute('aria-modal', 'true');
        modalEl.removeAttribute('aria-hidden');
        
        // Add backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'linkModalBackdrop';
        document.body.appendChild(backdrop);
        document.body.classList.add('modal-open');
    }

    // Save linkage
    // Save linkage
    async function saveLinkage() {
        const minerId = document.getElementById('minerSelect').value;
        
        try {
            const response = await fetch(`/api/integrations/homeassistant/devices/${currentLinkDeviceId}/link`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    miner_id: minerId ? parseInt(minerId) : null
                })
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', `‚úÖ ${data.message}`, 2000);
                closeModal();
                await loadDevices();
            } else {
                showAlert('danger', '‚ùå Failed to link device');
            }
        } catch (error) {
            showAlert('danger', '‚ùå Error: ' + error.message);
        }
    }

    // Close modal helper
    function closeModal() {
        const modalEl = document.getElementById('linkDeviceModal');
        modalEl.classList.remove('show');
        modalEl.style.display = 'none';
        modalEl.setAttribute('aria-hidden', 'true');
        modalEl.removeAttribute('aria-modal');
        
        const backdrop = document.getElementById('linkModalBackdrop');
        if (backdrop) {
            backdrop.remove();
        }
        document.body.classList.remove('modal-open');
    }

    // Control device
    async function controlDevice(deviceId, action) {
        try {
            const response = await fetch(`/api/integrations/homeassistant/devices/${deviceId}/control?action=${action}`, {
                method: 'POST'
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', `‚úÖ ${data.message}`, 2000);
                await loadDevices();
            } else {
                showAlert('danger', '‚ùå ' + data.message);
            }
        } catch (error) {
            showAlert('danger', '‚ùå Error: ' + error.message);
        }
    }

    // Refresh device state
    async function refreshState(deviceId) {
        try {
            const response = await fetch(`/api/integrations/homeassistant/devices/${deviceId}/state`);
            const data = await response.json();

            if (data.success) {
                showAlert('success', `‚úÖ State: ${data.state}`, 2000);
                await loadDevices();
            } else {
                showAlert('danger', '‚ùå Failed to get state');
            }
        } catch (error) {
            showAlert('danger', '‚ùå Error: ' + error.message);
        }
    }

    // Toggle enrollment
    async function toggleEnrollment(deviceId, enrolled) {
        try {
            const response = await fetch(`/api/integrations/homeassistant/devices/${deviceId}/enroll`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({enrolled})
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', `‚úÖ ${data.message}`, 2000);
            } else {
                showAlert('danger', '‚ùå Failed to update enrollment');
            }
        } catch (error) {
            showAlert('danger', '‚ùå Error: ' + error.message);
        }
    }

    // Helper: Get domain icon
    function getDomainIcon(domain) {
        const icons = {
            'switch': 'üîå',
            'light': 'üí°',
            'climate': 'üå°Ô∏è',
            'fan': 'üåÄ',
            'cover': 'üö™',
            'lock': 'üîí',
            'media_player': 'üì∫',
            'sensor': 'üìä',
            'binary_sensor': '‚ö°',
            'camera': 'üì∑'
        };
        return icons[domain] || 'üì±';
    }

    // Helper: Show alert
    function showAlert(type, message, timeout = 5000) {
        const resultDiv = document.getElementById('testResult');
        resultDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">${message}</div>`;
        resultDiv.style.display = 'block';

        if (timeout) {
            setTimeout(() => {
                resultDiv.style.display = 'none';
            }, timeout);
        }
    }

    // Load config and miners on page load
    loadConfig();
    loadMiners();
    
    // Auto-refresh device states every 30 seconds
    setInterval(() => {
        loadDevices();
    }, 30000);
</script>
{% endblock %}
