{% extends "base.html" %}

{% block extra_head %}
<style>
.p2pool-container {
    max-width: 800px;
    margin: 0 auto;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    margin-bottom: 2rem;
}

.detail-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem;
    background: var(--card-header);
    border-bottom: 1px solid var(--border-color);
}

.detail-card-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.detail-card-header h3 {
    flex: 1;
    margin: 0;
    font-size: 1.25rem;
    color: var(--text-primary);
    display: flex;
    align-items: center;
}

.detail-card-body {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
}

.form-label input[type="checkbox"] {
    margin-right: 0.5rem;
}

.form-hint {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.form-input {
    width: 100%;
    padding: 0.625rem;
    background: var(--card-header);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    color: var(--text-primary);
    font-size: 0.9375rem;
    font-family: monospace;
}

.form-input:focus {
    outline: none;
    border-color: #3b82f6;
}

.form-input::placeholder {
    color: var(--text-secondary);
}

.security-notice {
    background: rgba(249, 115, 22, 0.1);
    border: 1px solid #f97316;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.security-notice-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 600;
    color: #f97316;
    margin-bottom: 0.5rem;
}

.info-box {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid #3b82f6;
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.info-box-title {
    font-weight: 600;
    color: #3b82f6;
    margin-bottom: 0.5rem;
}

.info-box ul {
    margin: 0.5rem 0 0 1.5rem;
    color: var(--text-secondary);
}

.success-message {
    background: rgba(16, 185, 129, 0.1);
    border: 1px solid #10b981;
    border-radius: 6px;
    padding: 1rem;
    margin-top: 1rem;
    display: none;
    color: #10b981;
}

.error-message {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid #ef4444;
    border-radius: 6px;
    padding: 1rem;
    margin-top: 1rem;
    display: none;
    color: #ef4444;
}
</style>
{% endblock %}

{% block content %}
<div class="p2pool-container">
    <div class="detail-card">
        <div class="detail-card-header">
            <h3><span class="detail-card-icon">‚ü†</span> P2Pool Monero Wallet Tracking</h3>
        </div>
        <div class="detail-card-body">
            <div class="info-box">
                <div class="info-box-title">‚ÑπÔ∏è What is this?</div>
                <p style="color: var(--text-secondary); margin: 0.5rem 0;">
                    Track your Monero mining earnings from P2Pool or any other Monero pool by monitoring your wallet address.
                    This works with <strong>any Monero mining pool</strong> - not just P2Pool!
                </p>
                <ul>
                    <li>View all incoming mining payouts</li>
                    <li>Calculate 24h earnings automatically</li>
                    <li>Track balance and payout history</li>
                    <li>Display on dashboard alongside other pools</li>
                </ul>
            </div>

            <div class="security-notice">
                <div class="security-notice-title">
                    <span>üîí</span> Security & Privacy
                </div>
                <p style="color: var(--text-secondary); margin: 0; font-size: 0.875rem;">
                    The <strong>private view key</strong> is read-only and <strong>cannot spend your funds</strong>. 
                    It only allows viewing incoming transactions and balances. Your view key is stored encrypted 
                    in your local database and never sent to external services.
                </p>
            </div>

            <div class="info-box" style="background: rgba(139, 92, 246, 0.1); border-color: #8b5cf6;">
                <div class="info-box-title" style="color: #8b5cf6;">üìä Local P2Pool Statistics</div>
                <p style="color: var(--text-secondary); margin: 0.5rem 0; font-size: 0.875rem;">
                    For detailed local P2Pool mining statistics (hashrate, shares, pool info), you can run the 
                    <strong>P2Pool API</strong> service alongside your P2Pool node. This provides real-time stats 
                    directly from your local P2Pool instance.
                </p>
                <p style="margin: 0.5rem 0;">
                    <a href="https://github.com/RenegadeUK/p2pool-api" target="_blank" style="color: #8b5cf6; text-decoration: none; font-weight: 600;">
                        ‚Üí View P2Pool API on GitHub
                    </a>
                </p>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="p2pool_enabled">
                    Enable Monero Wallet Tracking
                </label>
                <p class="form-hint">
                    Track mining earnings from your Monero wallet
                </p>
            </div>

            <div class="form-group">
                <label class="form-label">Monero Wallet Address</label>
                <input 
                    type="text" 
                    id="wallet_address" 
                    class="form-input" 
                    placeholder="Your 95-character Monero wallet address"
                    maxlength="95"
                >
                <p class="form-hint">Standard Monero address starting with 4 (95 characters total)</p>
            </div>

            <div class="form-group">
                <label class="form-label">Private View Key (Secret View Key)</label>
                <input 
                    type="password" 
                    id="view_key" 
                    class="form-input" 
                    placeholder="64-character hexadecimal secret view key"
                    maxlength="64"
                >
                <p class="form-hint">
                    Read-only key for viewing incoming transactions. Get from wallet: <code>Settings ‚Üí Show Keys ‚Üí Secret View Key</code>
                </p>
            </div>

            <div class="form-group">
                <label class="form-label">Monero Node RPC URL</label>
                <input 
                    type="text" 
                    id="node_url" 
                    class="form-input" 
                    placeholder="http://your-node-ip:18081"
                >
                <p class="form-hint">
                    URL of your Monero daemon RPC endpoint (default port: 18081). Can be local or remote synchronized node.
                </p>
            </div>

            <hr style="margin: 2rem 0; border: none; border-top: 1px solid var(--border-color);">

            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">P2Pool API Integration (Optional)</h4>
            <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.875rem;">
                Enable real-time mining statistics from your local P2Pool node (workers, hashrate, shares, effort).
            </p>

            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" id="p2pool_api_enabled">
                    Enable P2Pool API Integration
                </label>
                <p class="form-hint">
                    Show live mining stats on dashboard
                </p>
            </div>

            <div class="form-group">
                <label class="form-label">P2Pool API URL</label>
                <input 
                    type="text" 
                    id="api_url" 
                    class="form-input" 
                    placeholder="http://your-p2pool-api-ip:5000"
                >
                <p class="form-hint">
                    URL of your P2Pool API service (see GitHub link above for setup)
                </p>
            </div>

            <div id="success-message" class="success-message">
                ‚úì Settings saved successfully! Wallet tracking is now active.
            </div>
            
            <div id="error-message" class="error-message">
                Failed to save settings. Please check your inputs and try again.
            </div>

            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
            <button class="btn btn-secondary" onclick="testConnection()">Test Monero Node</button>
            <button class="btn btn-secondary" onclick="testApiConnection()">Test P2Pool API</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load existing settings
async function loadSettings() {
    try {
        const response = await fetch('/api/settings/p2pool');
        const data = await response.json();
        
        if (data.success) {
            document.getElementById('p2pool_enabled').checked = data.enabled || false;
            document.getElementById('wallet_address').value = data.wallet_address || '';
            document.getElementById('node_url').value = data.node_url || '';
            document.getElementById('p2pool_api_enabled').checked = data.api_enabled || false;
            document.getElementById('api_url').value = data.api_url || '';
            // Don't populate view key for security - user must re-enter
        }
    } catch (error) {
        console.error('Failed to load settings:', error);
    }
}

// Save settings
async function saveSettings() {
    const enabled = document.getElementById('p2pool_enabled').checked;
    const walletAddress = document.getElementById('wallet_address').value.trim();
    const viewKey = document.getElementById('view_key').value.trim();
    const nodeUrl = document.getElementById('node_url').value.trim();
    const apiEnabled = document.getElementById('p2pool_api_enabled').checked;
    const apiUrl = document.getElementById('api_url').value.trim();
    
    // Validation
    if (enabled) {
        if (!walletAddress || walletAddress.length !== 95) {
            showError('Please enter a valid 95-character Monero wallet address');
            return;
        }
        
        if (!viewKey || viewKey.length !== 64) {
            showError('Please enter a valid 64-character private view key');
            return;
        }
        
        if (!nodeUrl || !nodeUrl.startsWith('http')) {
            showError('Please enter a valid node URL (http:// or https://)');
            return;
        }
    }
    
    if (apiEnabled) {
        if (!apiUrl || !apiUrl.startsWith('http')) {
            showError('Please enter a valid P2Pool API URL (http:// or https://)');
            return;
        }
    }
    
    try {
        const response = await fetch('/api/settings/p2pool', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                enabled,
                wallet_address: walletAddress,
                view_key: viewKey,
                node_url: nodeUrl,
                api_enabled: apiEnabled,
                api_url: apiUrl
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showSuccess();
        } else {
            showError(data.error || 'Failed to save settings');
        }
    } catch (error) {
        console.error('Failed to save settings:', error);
        showError('Network error: ' + error.message);
    }
}

// Test connection to node
async function testConnection() {
    const nodeUrl = document.getElementById('node_url').value.trim();
    
    if (!nodeUrl) {
        showError('Please enter a node URL first');
        return;
    }
    
    try {
        const response = await fetch('/api/settings/p2pool/test', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ node_url: nodeUrl })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úì Connection successful!\n\nNode Height: ${data.height}\nStatus: ${data.status}\nSynced: ${data.synchronized ? 'Yes' : 'No'}`);
        } else {
            showError('Connection failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        showError('Connection test failed: ' + error.message);
    }
}

// Test connection to P2Pool API
async function testApiConnection() {
    const apiUrl = document.getElementById('api_url').value.trim();
    
    if (!apiUrl) {
        showError('Please enter a P2Pool API URL first');
        return;
    }
    
    try {
        const response = await fetch('/api/settings/p2pool/test-api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ api_url: apiUrl })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úì P2Pool API Connection successful!\n\nStatus: ${data.status}\nLog Count: ${data.log_count}\nAPI Version: Online`);
        } else {
            showError('API connection failed: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        showError('API connection test failed: ' + error.message);
    }
}

function showSuccess() {
    const success = document.getElementById('success-message');
    const error = document.getElementById('error-message');
    error.style.display = 'none';
    success.style.display = 'block';
    setTimeout(() => { success.style.display = 'none'; }, 5000);
}

function showError(message) {
    const success = document.getElementById('success-message');
    const error = document.getElementById('error-message');
    success.style.display = 'none';
    error.textContent = message;
    error.style.display = 'block';
    setTimeout(() => { error.style.display = 'none'; }, 8000);
}

// Load on page load
loadSettings();
</script>
{% endblock %}
