{% extends "base.html" %}

{% block extra_head %}
<style>
.strategy-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 1.5rem;
}

.detail-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.detail-card-header {
    padding: 1.25rem;
    background: var(--card-header);
    border-bottom: 1px solid var(--border-color);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.detail-card-header h3 {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.detail-card-body {
    padding: 1.5rem;
}

.miner-type-section {
    margin-bottom: 2rem;
}

.miner-type-header {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 1rem;
    color: var(--text-primary);
    border-bottom: 2px solid var(--info);
    padding-bottom: 0.5rem;
}

.miner-checkboxes {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 0.75rem;
}

.miner-checkbox-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s;
}

.miner-checkbox-item:hover {
    background: var(--bg-hover);
    border-color: var(--info);
}

.miner-checkbox-item input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.miner-checkbox-item label {
    cursor: pointer;
    user-select: none;
    flex: 1;
    margin: 0;
}

.price-band-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.price-band-table th,
.price-band-table td {
    padding: 0.75rem;
    text-align: left;
    border: 1px solid var(--border-color);
}

.price-band-table th {
    background: var(--card-header);
    font-weight: 600;
    color: var(--text-primary);
}

.price-band-table td {
    background: var(--card-bg);
}

.price-band-table tr:hover td {
    background: var(--bg-hover);
}

.band-dropdown {
    width: 100%;
    padding: 0.4rem;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-primary);
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.2s;
}

.band-dropdown:hover {
    border-color: var(--info);
    background: var(--bg-hover);
}

.band-dropdown:focus {
    outline: none;
    border-color: var(--info);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.toggle-switch {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.toggle-label {
    font-weight: 600;
    color: var(--text-primary);
}

.btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: var(--info);
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
}

.btn-secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--bg-hover);
}

.status-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.875rem;
    font-weight: 600;
}

.status-enabled {
    background: rgba(16, 185, 129, 0.2);
    color: var(--success);
}

.status-disabled {
    background: rgba(107, 114, 128, 0.2);
    color: var(--text-secondary);
}

.info-box {
    background: rgba(59, 130, 246, 0.1);
    border: 1px solid rgba(59, 130, 246, 0.3);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.info-box h4 {
    margin: 0 0 0.5rem 0;
    color: var(--info);
    font-size: 1rem;
}

.info-box p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
}

.warning-box {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid rgba(239, 68, 68, 0.3);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
}

.warning-box h4 {
    margin: 0 0 0.5rem 0;
    color: var(--danger);
    font-size: 1rem;
}

.warning-box p {
    margin: 0;
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
}
</style>
{% endblock %}

{% block content %}
<div class="strategy-container">
    <!-- Strategy Overview -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>üéØ Agile Solo Strategy Overview</h3>
            <span id="strategy-status" class="status-badge status-disabled">Disabled</span>
        </div>
        <div class="detail-card-body">
            <div class="info-box">
                <h4>üìä What is the Agile Solo Strategy?</h4>
                <p>
                    A variance-driven, solo-only mining strategy optimised for Octopus Agile UK pricing.
                    Automatically switches between DigiByte, Bitcoin Cash, and Bitcoin based on energy prices,
                    with aggressive mode tuning during cheap electricity windows. NO pooled mining allowed.
                </p>
            </div>
            
            <div class="warning-box">
                <h4>‚ö†Ô∏è Important: Solo Mining Only</h4>
                <p>
                    This strategy ONLY works with solo pools (Solopool.org). It will automatically disable
                    if any enrolled miner is pointed at a pooled mining pool. Variance is intentional‚Äîexpect long
                    dry spells between wins.
                </p>
            </div>
            
            <div class="info-box">
                <h4>üîå OFF State (‚â•20p/kWh)</h4>
                <p>
                    When prices reach ‚â•20p/kWh, the strategy detects the OFF band but does NOT disable miners.
                    Miner shutdown at high prices is managed through external automation. The strategy will resume
                    normal operation when prices drop below 20p.
                </p>
            </div>
            
            <div class="warning-box" style="border-color: rgba(245, 158, 11, 0.3); background: rgba(245, 158, 11, 0.1);">
                <h4 style="color: var(--warning);">‚ö†Ô∏è Automation Rule Conflicts</h4>
                <p>
                    When the Agile Solo Strategy is enabled, it will automatically manage pool switching and mode changes
                    for enrolled miners. Any automation rules that affect these miners may conflict with the strategy.
                    Consider disabling conflicting automation rules before enabling this strategy.
                </p>
            </div>
            
            <div class="toggle-switch">
                <input type="checkbox" id="strategy-enabled" style="width: 40px; height: 24px;">
                <label for="strategy-enabled" class="toggle-label">Enable Agile Solo Strategy</label>
            </div>
        </div>
    </div>

    <!-- Miner Selection -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>üñ•Ô∏è Enroll Miners</h3>
        </div>
        <div class="detail-card-body">
            <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">
                Select which miners should participate in the Agile Solo Strategy. Only enabled miners are shown.
            </p>
            
            <!-- Bitaxe Miners -->
            <div class="miner-type-section" id="bitaxe-section" style="display: none;">
                <div class="miner-type-header">‚ö° Bitaxe Miners</div>
                <div class="miner-checkboxes" id="bitaxe-miners"></div>
            </div>
            
            <!-- NerdQaxe Miners -->
            <div class="miner-type-section" id="nerdqaxe-section" style="display: none;">
                <div class="miner-type-header">üîß NerdQaxe++ Miners</div>
                <div class="miner-checkboxes" id="nerdqaxe-miners"></div>
            </div>
            
            <!-- Avalon Nano Miners -->
            <div class="miner-type-section" id="avalon-section" style="display: none;">
                <div class="miner-type-header">üèîÔ∏è Avalon Nano Miners</div>
                <div class="miner-checkboxes" id="avalon-miners"></div>
            </div>
            
            <!-- NMMiner ESP32 Miners -->
            <div class="miner-type-section" id="nmminer-section" style="display: none;">
                <div class="miner-type-header">üé∞ NMMiner ESP32 (Lottery Miners)</div>
                <div class="miner-checkboxes" id="nmminer-miners"></div>
            </div>
            
            <div id="no-miners-message" style="display: none; text-align: center; padding: 2rem; color: var(--text-secondary);">
                No miners available. Please add miners first.
            </div>
        </div>
    </div>

    <!-- Price Band Strategy Table -->
    <div class="detail-card">
        <div class="detail-card-header">
            <h3>üìà Price Band Strategy</h3>
            <button class="btn btn-secondary" onclick="resetBandsToDefaults()" style="padding: 0.5rem 1rem;">
                Reset to Defaults
            </button>
        </div>
        <div class="detail-card-body">
            <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                Automatic coin and mode selection based on Octopus Agile energy pricing (p/kWh).
                Click on a dropdown to customize the strategy for each price band.
            </p>
            
            <table class="price-band-table" id="bands-table">
                <thead>
                    <tr>
                        <th>Price Band (p/kWh)</th>
                        <th>Coin</th>
                        <th>Bitaxe Mode</th>
                        <th>NerdQaxe Mode</th>
                        <th>Avalon Nano Mode</th>
                        <th>Strategy</th>
                    </tr>
                </thead>
                <tbody id="bands-tbody">
                    <!-- Will be populated dynamically -->
                </tbody>
            </table>
        </div>
    </div>
            
            <div style="margin-top: 1.5rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 6px;">
                <h4 style="margin: 0 0 0.5rem 0; font-size: 0.95rem;">‚è±Ô∏è Hysteresis Rules</h4>
                <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-secondary); font-size: 0.875rem;">
                    <li>Look-ahead confirmation: only upgrades to better bands if NEXT slot also qualifies (prevents single-slot oscillation)</li>
                    <li>Immediate downgrade when price worsens</li>
                    <li>Strategy executes every 30 minutes</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div style="text-align: center;">
        <button class="btn btn-primary" onclick="saveSettings()" style="min-width: 200px;">
            üíæ Save Strategy Settings
        </button>
    </div>
</div>

<script>
let currentSettings = null;

async function loadSettings() {
    try {
        const response = await fetch('/api/settings/agile-solo-strategy');
        const data = await response.json();
        
        currentSettings = data;
        
        // Update status badge
        const statusBadge = document.getElementById('strategy-status');
        if (data.enabled) {
            statusBadge.textContent = 'Enabled';
            statusBadge.className = 'status-badge status-enabled';
        } else {
            statusBadge.textContent = 'Disabled';
            statusBadge.className = 'status-badge status-disabled';
        }
        
        // Set enabled checkbox
        document.getElementById('strategy-enabled').checked = data.enabled;
        
        // Populate miners
        populateMiners(data.miners_by_type);
        
    } catch (error) {
        console.error('Failed to load settings:', error);
        alert('‚ùå Failed to load strategy settings');
    }
}

function populateMiners(minersByType) {
    const bitaxeSection = document.getElementById('bitaxe-section');
    const nerdqaxeSection = document.getElementById('nerdqaxe-section');
    const avalonSection = document.getElementById('avalon-section');
    const nmminerSection = document.getElementById('nmminer-section');
    const noMinersMessage = document.getElementById('no-miners-message');
    
    const bitaxeContainer = document.getElementById('bitaxe-miners');
    const nerdqaxeContainer = document.getElementById('nerdqaxe-miners');
    const avalonContainer = document.getElementById('avalon-miners');
    const nmminerContainer = document.getElementById('nmminer-miners');
    
    // Clear containers
    bitaxeContainer.innerHTML = '';
    nerdqaxeContainer.innerHTML = '';
    avalonContainer.innerHTML = '';
    nmminerContainer.innerHTML = '';
    
    let hasMiners = false;
    
    // Bitaxe miners
    if (minersByType.bitaxe && minersByType.bitaxe.length > 0) {
        hasMiners = true;
        bitaxeSection.style.display = 'block';
        minersByType.bitaxe.forEach(miner => {
            const item = createMinerCheckbox(miner);
            bitaxeContainer.appendChild(item);
        });
    } else {
        bitaxeSection.style.display = 'none';
    }
    
    // NerdQaxe miners
    if (minersByType.nerdqaxe && minersByType.nerdqaxe.length > 0) {
        hasMiners = true;
        nerdqaxeSection.style.display = 'block';
        minersByType.nerdqaxe.forEach(miner => {
            const item = createMinerCheckbox(miner);
            nerdqaxeContainer.appendChild(item);
        });
    } else {
        nerdqaxeSection.style.display = 'none';
    }
    
    // Avalon miners
    if (minersByType.avalon_nano && minersByType.avalon_nano.length > 0) {
        hasMiners = true;
        avalonSection.style.display = 'block';
        minersByType.avalon_nano.forEach(miner => {
            const item = createMinerCheckbox(miner);
            avalonContainer.appendChild(item);
        });
    } else {
        avalonSection.style.display = 'none';
    }
    
    // NMMiner ESP32 miners
    if (minersByType.nmminer && minersByType.nmminer.length > 0) {
        hasMiners = true;
        nmminerSection.style.display = 'block';
        minersByType.nmminer.forEach(miner => {
            const item = createMinerCheckbox(miner);
            nmminerContainer.appendChild(item);
        });
    } else {
        nmminerSection.style.display = 'none';
    }
    
    noMinersMessage.style.display = hasMiners ? 'none' : 'block';
}

function createMinerCheckbox(miner) {
    const div = document.createElement('div');
    div.className = 'miner-checkbox-item';
    
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.id = `miner-${miner.id}`;
    checkbox.value = miner.id;
    checkbox.checked = miner.enrolled;
    
    const label = document.createElement('label');
    label.htmlFor = `miner-${miner.id}`;
    label.textContent = miner.name;
    
    div.appendChild(checkbox);
    div.appendChild(label);
    
    // Make whole div clickable
    div.addEventListener('click', (e) => {
        if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
        }
    });
    
    return div;
}

async function saveSettings() {
    const enabled = document.getElementById('strategy-enabled').checked;
    
    // Collect selected miner IDs
    const checkboxes = document.querySelectorAll('.miner-checkbox-item input[type="checkbox"]:checked');
    const minerIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
    
    const settings = {
        enabled: enabled,
        miner_ids: minerIds
    };
    
    try {
        const response = await fetch('/api/settings/agile-solo-strategy', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            // Immediately update status badge to reflect saved state
            const statusBadge = document.getElementById('strategy-status');
            if (enabled) {
                statusBadge.textContent = 'Enabled';
                statusBadge.className = 'status-badge status-enabled';
            } else {
                statusBadge.textContent = 'Disabled';
                statusBadge.className = 'status-badge status-disabled';
            }
            
            alert(`‚úÖ ${result.message}\n\nStatus: ${enabled ? 'Enabled' : 'Disabled'}\nEnrolled: ${result.enrolled_count} miners`);
            await loadSettings(); // Reload to ensure sync
        } else {
            const error = await response.json();
            alert('‚ùå Failed to save settings: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    }
}

// Load and display price bands
async function loadBands() {
    try {
        const response = await fetch('/api/settings/agile-solo-strategy/bands');
        const data = await response.json();
        
        const tbody = document.getElementById('bands-tbody');
        tbody.innerHTML = '';
        
        const descriptions = [
            'Capital preservation (external automation)',
            'Frequent wins, low regret',
            'Baseline probability',
            'Meaningful upside',
            'Jackpot probability'
        ];
        
        data.bands.forEach((band, index) => {
            const row = document.createElement('tr');
            
            // Format price range
            let priceRange = '';
            if (band.min_price !== null && band.max_price !== null) {
                priceRange = `${band.min_price}‚Äì${band.max_price}p`;
            } else if (band.max_price !== null) {
                priceRange = `< ${band.max_price}p`;
            } else if (band.min_price !== null) {
                priceRange = `‚â• ${band.min_price}p`;
            }
            
            // Special styling for OFF and BTC bands
            let rowStyle = '';
            if (band.target_coin === 'OFF') {
                rowStyle = 'background: rgba(107, 114, 128, 0.1);';
            } else if (band.target_coin === 'BTC') {
                rowStyle = 'background: rgba(59, 130, 246, 0.1);';
            }
            
            row.style.cssText = rowStyle;
            
            // If OFF, show managed externally colspan
            if (band.target_coin === 'OFF') {
                row.innerHTML = `
                    <td>${priceRange}</td>
                    <td>${createCoinDropdown(band)}</td>
                    <td colspan="3" style="text-align: center; font-style: italic; color: var(--text-secondary);">Managed Externally</td>
                    <td>${descriptions[index] || ''}</td>
                `;
            } else {
                row.innerHTML = `
                    <td>${priceRange}</td>
                    <td>${createCoinDropdown(band)}</td>
                    <td>${createModeDropdown(band, 'bitaxe')}</td>
                    <td>${createModeDropdown(band, 'nerdqaxe')}</td>
                    <td>${createModeDropdown(band, 'avalon_nano')}</td>
                    <td>${descriptions[index] || ''}</td>
                `;
            }
            
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Failed to load bands:', error);
    }
}

// Create coin dropdown
function createCoinDropdown(band) {
    const coins = ['OFF', 'DGB', 'BCH', 'BTC'];
    const displayNames = {
        'OFF': 'OFF',
        'DGB': 'DGB Solo',
        'BCH': 'BCH Solo',
        'BTC': 'BTC Solo'
    };
    
    let html = `<select class="band-dropdown" onchange="updateBand(${band.id}, 'target_coin', this.value)" ${band.target_coin === 'OFF' ? 'style="font-weight: bold;"' : ''}>`;
    coins.forEach(coin => {
        const selected = coin === band.target_coin ? 'selected' : '';
        html += `<option value="${coin}" ${selected}>${displayNames[coin]}</option>`;
    });
    html += '</select>';
    return html;
}

// Create mode dropdown
function createModeDropdown(band, minerType) {
    let modes = [];
    let currentMode = '';
    
    if (minerType === 'bitaxe' || minerType === 'nerdqaxe') {
        modes = ['managed_externally', 'eco', 'std', 'turbo', 'oc'];
        currentMode = band[`${minerType}_mode`];
    } else if (minerType === 'avalon_nano') {
        modes = ['managed_externally', 'low', 'med', 'high'];
        currentMode = band.avalon_nano_mode;
    }
    
    const displayNames = {
        'managed_externally': 'External',
        'eco': 'Eco',
        'std': 'Std',
        'turbo': 'Turbo',
        'oc': 'OC',
        'low': 'Low',
        'med': 'Med',
        'high': 'High'
    };
    
    let html = `<select class="band-dropdown" onchange="updateBand(${band.id}, '${minerType}_mode', this.value)">`;
    modes.forEach(mode => {
        const selected = mode === currentMode ? 'selected' : '';
        html += `<option value="${mode}" ${selected}>${displayNames[mode]}</option>`;
    });
    html += '</select>';
    return html;
}

// Update a band setting
async function updateBand(bandId, field, value) {
    try {
        const update = {};
        update[field] = value;
        
        const response = await fetch(`/api/settings/agile-solo-strategy/bands/${bandId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(update)
        });
        
        if (response.ok) {
            // Reload bands to reflect any auto-adjustments (e.g., OFF forcing managed_externally)
            await loadBands();
        } else {
            const error = await response.json();
            alert('‚ùå Failed to update: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    }
}

// Reset bands to defaults
async function resetBandsToDefaults() {
    if (!confirm('‚ö†Ô∏è Reset all price bands to default configuration?\n\nThis will overwrite any customizations you have made.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/settings/agile-solo-strategy/bands/reset', {
            method: 'POST'
        });
        
        if (response.ok) {
            alert('‚úÖ Bands reset to defaults');
            await loadBands();
        } else {
            const error = await response.json();
            alert('‚ùå Failed to reset: ' + (error.detail || 'Unknown error'));
        }
    } catch (error) {
        alert('‚ùå Error: ' + error.message);
    }
}

// Load settings and bands on page load
loadSettings();
loadBands();
</script>
{% endblock %}
